<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>05-05.SampleApplication(5) | Programming is Fun | Still waters run deep. When the well&#39;s dry, we know the worth of water.</title>

  
  <meta name="author" content="ykyoon">
  

  
  <meta name="description" content="SampleApplication(5) - using SpringDao지금까지 우리는 Template-callback 구조의 SqlExecutor와 Connection을 처리하는 ConnectionFactory를 이용한 Dao 객체들을 구성하였습니다. 지금까지 만든 Da">
  

  
  
  <meta name="keywords" content="study,java,spring">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="05-05.SampleApplication(5)"/>

  <meta property="og:site_name" content="Programming is Fun"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Programming is Fun" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Programming is Fun</a>
    </h1>
    <p class="site-description">Still waters run deep. When the well&#39;s dry, we know the worth of water.</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>05-05.SampleApplication(5)</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/02/05/05-05-sample-app/" rel="bookmark">
        <time class="entry-date published" datetime="2018-02-05T00:06:39.000Z">
          2018-02-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="SampleApplication-5-using-SpringDao"><a href="#SampleApplication-5-using-SpringDao" class="headerlink" title="SampleApplication(5) - using SpringDao"></a>SampleApplication(5) - using SpringDao</h1><p>지금까지 우리는 Template-callback 구조의 SqlExecutor와 Connection을 처리하는 ConnectionFactory를 이용한 Dao 객체들을 구성하였습니다. 지금까지 만든 Dao 객체들을 Spring에서 제공하는 Jdbc객체들을 이용해서 변환시키는 과정을 한번 알아보도록 하겠습니다.</p>
<h2 id="Spring-JDBC를-이용한-DAO의-개발"><a href="#Spring-JDBC를-이용한-DAO의-개발" class="headerlink" title="Spring JDBC를 이용한 DAO의 개발"></a>Spring JDBC를 이용한 DAO의 개발</h2><p>Spring JDBC는 지금까지 이야기한 모든 기능들이 다 포함되어있습니다.</p>
<ul>
<li>Template, callback 구조</li>
<li>DataSource를 이용한 ConnectionFactory 구현</li>
<li>Checked Exception을 Runtime Exception으로 변경</li>
</ul>
<p>먼저, <code>build.gradle</code>에 다음 dependency를 추가합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-jdbc'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br></pre></td></tr></table></figure>
<h3 id="ConnectionFactory-gt-DataSource"><a href="#ConnectionFactory-gt-DataSource" class="headerlink" title="ConnectionFactory -&gt; DataSource"></a>ConnectionFactory -&gt; DataSource</h3><p>ConnectionFactory를 대신할 객체로 Spring에서는 <code>DataSource</code> 인터페이스를 구현한 <code>DriverManagerDataSource</code>를 제공합니다. <code>@Configuration</code>에서 다음과 같이 정의할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">    dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">    dataSource.setUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">    dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">    dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>참고삼아, <code>JNDI</code>를 이용한 <code>DataSource</code>의 경우에는 다음과 같이 구성 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">jndiDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JndiDataSourceLookup lookup = <span class="keyword">new</span> JndiDataSourceLookup();</span><br><span class="line">    lookup.setResourceRef(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> lookup.getDataSource(jndiName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SqlExecutor-gt-JdbcTemplate"><a href="#SqlExecutor-gt-JdbcTemplate" class="headerlink" title="SqlExecutor -&gt; JdbcTemplate"></a>SqlExecutor -&gt; JdbcTemplate</h3><p>구현된 <code>SqlExecutor</code>에서 제공되는 Template, Callback을 이용한 객체를 <code>Spring</code>에서는 <code>JdbcTemplate</code>로 제공하고 있습니다. 객체 Bean은 다음과 같이 등록이 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>JdbcTemplate</code>은 다음 method들을 가지고 있습니다.</p>
<ul>
<li>queryForList: select에 의해서 List return이 발생할 때 사용됩니다.</li>
<li>queryForObject: 한개의 객체를 return하는 method입니다.</li>
<li>update: insert/update/delete query에서 사용됩니다. return값은 영향 받는 row의 갯수를 반환합니다.</li>
</ul>
<p>기존 코드를 이제 <code>JdbcTemplate</code>를 이용해서 모두 변경해보도록 하겠습니다. 기존 <code>BookDao</code>는 다음과 같이 변경이 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDao</span> <span class="keyword">implements</span> <span class="title">BookStoreDao</span>&lt;<span class="title">Book</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookDao</span><span class="params">(JdbcTemplate jdbcTemplate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">countAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">"select count(*) from books"</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.queryForObject(sql, Integer.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">"delete from books"</span>;</span><br><span class="line">        jdbcTemplate.update(sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">"select id, name, author, status, rentUserId, comment, publishDate from books"</span>;</span><br><span class="line">        List&lt;Book&gt; books = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; maps = jdbcTemplate.queryForList(sql);</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; map : maps) &#123;</span><br><span class="line">            books.add(convertBookFromResultSet(map));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> books;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">"select id, name, author, publishDate, comment, status, rentUserId from books where id=?"</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.queryForObject(sql, <span class="keyword">new</span> Object[] &#123;id&#125;, (rs, rowNum) -&gt; convertBookFromResultSet(rs));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">update</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">"update books set name = ?, author = ?, publishDate = ?, comment = ?, status = ?, rentUserId =? "</span> +</span><br><span class="line">            <span class="string">"where id = ?"</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.update(sql,</span><br><span class="line">            book.getName(), book.getAuthor(),</span><br><span class="line">            <span class="keyword">new</span> java.sql.Date(book.getPublishDate().getTime()),</span><br><span class="line">            book.getComment(),</span><br><span class="line">            book.getBookStatus().value(),</span><br><span class="line">            book.getRentUserId(),</span><br><span class="line">            book.getId()) == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">"insert books(name, author, publishDate, comment, status, rentUserId) values(?, ?, ?, ?, ?, ?)"</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.update(sql,</span><br><span class="line">            book.getName(), book.getAuthor(),</span><br><span class="line">            <span class="keyword">new</span> java.sql.Date(book.getPublishDate().getTime()),</span><br><span class="line">            book.getComment(),</span><br><span class="line">            book.getBookStatus().value(),</span><br><span class="line">            book.getRentUserId()) == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(Book entity)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">"delete from books where id = ?"</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.update(sql, entity.getId()) == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Book <span class="title">convertBookFromResultSet</span><span class="params">(Map rs)</span> </span>&#123;</span><br><span class="line">        Book book = <span class="keyword">new</span> Book();</span><br><span class="line">        book.setId((<span class="keyword">int</span>) rs.get(<span class="string">"id"</span>));</span><br><span class="line">        book.setName((String) rs.get(<span class="string">"name"</span>));</span><br><span class="line">        book.setAuthor((String) rs.get(<span class="string">"author"</span>));</span><br><span class="line">        book.setPublishDate((Timestamp) rs.get(<span class="string">"publishDate"</span>));</span><br><span class="line">        book.setBookStatus(BookStatus.parse((<span class="keyword">int</span>) rs.get(<span class="string">"status"</span>)));</span><br><span class="line">        Integer rentUserId = (Integer) rs.get(<span class="string">"rentUserId"</span>);</span><br><span class="line">        book.setRentUserId(rentUserId);</span><br><span class="line">        book.setComment((String) rs.get(<span class="string">"comment"</span>));</span><br><span class="line">        <span class="keyword">return</span> book;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Book <span class="title">convertBookFromResultSet</span><span class="params">(ResultSet rs)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        Book book = <span class="keyword">new</span> Book();</span><br><span class="line">        book.setId(rs.getInt(<span class="string">"id"</span>));</span><br><span class="line">        book.setName(rs.getString(<span class="string">"name"</span>));</span><br><span class="line">        book.setAuthor(rs.getString(<span class="string">"author"</span>));</span><br><span class="line">        java.util.Date date = <span class="keyword">new</span> java.util.Date(rs.getDate(<span class="string">"publishDate"</span>).getTime());</span><br><span class="line">        book.setPublishDate(date);</span><br><span class="line">        book.setBookStatus(BookStatus.parse(rs.getInt(<span class="string">"status"</span>)));</span><br><span class="line">        Integer rentUserId = (Integer) rs.getObject(<span class="string">"rentUserId"</span>);</span><br><span class="line">        book.setRentUserId(rentUserId);</span><br><span class="line">        book.setComment(rs.getString(<span class="string">"comment"</span>));</span><br><span class="line">        <span class="keyword">return</span> book;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Bean의-등록"><a href="#Bean의-등록" class="headerlink" title="Bean의 등록"></a>Bean의 등록</h2><p><code>BookDao</code>, <code>UserDao</code>, <code>HistoryDao</code>를 각각 <code>ApplicationContext</code>에 등록하게 되면 다음과 같이 구성됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BookDao <span class="title">bookDao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BookDao(jdbcTemplate());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDao <span class="title">userDao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserDao(jdbcTemplate());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HistoryDao <span class="title">historyDao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HistoryDao(jdbcTemplate());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>만약 <code>Dao</code> 객체들이 여러개가 된다면 이러한 코드 패턴을 여러개를 계속해서 만들어줘야지 됩니다. 이를 간단하게 처리할 수 있는 방법으로 <code>ComponentScan</code>을 제공합니다. <code>ComponentScan</code>은 다음과 같이 사용 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.dao"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>해당되는 <code>package</code>안의 객체들을 자동으로 <code>ApplicationContext</code>에 등록하게 되는데, 이는 annotation을 기준으로 갖습니다. Spring에서 <code>ComponentScan</code>에 의하여 자동 등록되는 기준 annotation은 다음과 같습니다.</p>
<table>
<thead>
<tr>
<th>종류</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Component</td>
<td>일반적인 객체에 사용됩니다.</td>
</tr>
<tr>
<td>@Repository</td>
<td>DB에 접근되는 객체에 사용됩니다. 일반적으로 <code>DAO</code>, <code>Repository</code> 객체에 적용이 됩니다.</td>
</tr>
<tr>
<td>@Service</td>
<td>Business Logic이 구성되는 Service 객체에 사용됩니다. BL은 여러개의 Repository의 구성으로 만들어집니다.</td>
</tr>
<tr>
<td>@Controller</td>
<td>WebMVC에서 사용되는 객체입니다. Url Request와 연결되는 객체를 지정할 때 사용됩니다.</td>
</tr>
</tbody>
</table>
<p>그리고, 자동등록이 지정된 객체들에 자동으로 추가되어야지 될 내용들을 어떻게 지정해주어야지 될까요? 지금 <code>Dao</code> 객체들은 생성자에 <code>JdbcTemplate</code>이 <code>ApplicationContext</code>에 등록된 객체를 사용할 수 있도록 지정해야 합니다. 이럴때 <code>@Autowired</code>를 이용합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDao</span> <span class="keyword">implements</span> <span class="title">BookStoreDao</span>&lt;<span class="title">Book</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookDao</span><span class="params">(JdbcTemplate jdbcTemplate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@Autowired</code>가 지정된 객체들은 <code>ApplicationContext</code>에서 생성될 순서가 뒤로 밀리게 됩니다. 우선 다른 객체들의 dependency가 없는 객체들부터 우선 생성하고, <code>@Autowired</code>가 지정된 객체들을 찾아서 처리하게 됩니다. 이때, 지정된 객체를 찾는 것은 다음과 같은 순서를 갖습니다.</p>
<ol>
<li><code>@Autowired</code>될 객체의 Bean 이름을 지정한 경우</li>
<li><code>@Autowired</code>될 객체의 type이 동일한 경우</li>
</ol>
<p>위 케이스의 경우, 객체의 type이 동일한 경우입니다. <code>Bean</code>의 이름이 지정되어 있지 않기 때문입니다. 만약에 <code>UserDao</code>, <code>BookDao</code>가 각각 다른 <code>JdbcTemplate</code>를 사용해야지 된다면, <code>@Qualifier</code>를 이용해서 각기 사용할 Bean을 지정해줄 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(<span class="string">"jdbcTemplate"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span>(<span class="string">"jdbcTemplate2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDao</span> <span class="keyword">implements</span> <span class="title">BookStoreDao</span>&lt;<span class="title">Book</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookDao</span><span class="params">(@Qualifier(value = <span class="string">"jdbcTemplate"</span>)</span> JdbcTemplate jdbcTemplate) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span> <span class="keyword">implements</span> <span class="title">BookStoreDao</span>&lt;<span class="title">User</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDao</span><span class="params">(@Qualifier(value = <span class="string">"jdbcTemplate2"</span>)</span> JdbcTemplate jdbcTemplate) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="DataSource의-변경"><a href="#DataSource의-변경" class="headerlink" title="DataSource의 변경"></a>DataSource의 변경</h2><p><code>DriverManagerDataSource</code>는 매우 단순한 <code>DataSource</code>입니다. 1개의 <code>connection</code>에 대한 <code>open</code>/<code>close</code>만을 담당하고 있는 매우 단순한 형태이지요. 실무에서는 절대로 사용되지 않는 형태의 <code>DataSource</code>입니다. 실무에서는 <code>JNDI</code> 또는 <code>Connection Pool</code>을 사용합니다.</p>
<p><code>Connection Pool</code>은 미리 <code>Connection</code>을 준비해두고, <code>DAO</code>에서 사용된 <code>Connection</code>을 <code>Pool</code>에 넣어서 관리하는 형태입니다. 이 방식은 다음과 같은 장점을 갖습니다.</p>
<ul>
<li>DB에 대한 가장 큰 부하인 Connection open / close 횟수를 줄여, System의 부하를 줄일수 있습니다.</li>
<li>Web과 같은 동시접근성이 보장되어야지 되는 시스템에서 Connection의 여유분을 만들어서, 시스템의 성능을 높일 수 있습니다.</li>
<li>DB System에 대한 max connection 숫자를 파악할 수 있기 때문에, DB System에 대한 부하 및 성능에 대한 예측이 가능합니다.</li>
</ul>
<p>주로 사용되는 ConnectionPool Library는 다음 5가지를 볼 수 있습니다.</p>
<ul>
<li>apache common-dhcp</li>
<li>tomcat jdbc</li>
<li>boneCP</li>
<li>HikiriCP</li>
<li>c3p0</li>
</ul>
<p>주로 사용되고 있는 <code>apache common-dhcp</code>는 사용버젼에 주의할 필요가 있습니다. <code>1.4.1</code>이전 버젼의 경우 memoryLeak이 발생합니다. 그런데, <code>1.4.1</code> 정식버젼이 아직 release되고 있지 않습니다. 따라서, 다음 선언을 모두 변경하는 것이 좋습니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'commons-dbcp'</span>, <span class="string">name:</span> <span class="string">'commons-dbcp'</span>, <span class="string">version:</span> <span class="string">'1.4'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.apache.commons'</span>, <span class="string">name:</span> <span class="string">'commons-dbcp2'</span>, <span class="string">version:</span> <span class="string">'2.1.1'</span></span><br></pre></td></tr></table></figure>
<p>개인적으로는 <code>HikariCP</code>를 추천합니다. 성능이 좋습니다.</p>
<p><img src="https://github.com/brettwooldridge/HikariCP/wiki/HikariCP-bench-2.6.0.png" alt=""></p>
<p><code>ConnectionPool</code>은 다음과 같은 일반적인 속성들을 갖습니다.</p>
<ul>
<li>idleConnectionTestPeriodInMinutes : connection이 쉬고 있는 상태인지 확인하는 주기입니다.</li>
<li>idleMaxAgeInMinutes : connection이 유휴상태로 놓어지는 최대시간입니다. 이 시간 이후, connection은 소멸됩니다.</li>
<li>maxConnections : 최대 connection의 갯수입니다.</li>
<li>minConnections : 최소 connection의 갯수입니다.</li>
<li>acquireIncrement : 한번에 connection을 얻어낼 때, 얻어내는 숫자입니다.</li>
</ul>
<p>application의 최대 성능을 높이기 위해서는 <code>maxConnections</code>와 <code>minConnections</code>의 숫자를 일치시키는 것이 강력 권장합니다. <code>HikariCP</code>를 이용하는 경우 DataSource를 변경하면 다음과 같이 <code>@Configuration</code>의 변경이 필요합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">    dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">    dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">    dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">    dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">    dataSource.setMaximumPoolSize(<span class="number">10</span>);</span><br><span class="line">    dataSource.setMinimumIdle(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>DataSourc</code>를 변경한 이후에도 기존 코드에 아무런 변경이 없이 적용이 가능합니다. 이는 <code>DI</code>에 의한 <code>IoC</code>의 대표적인 한 예가 될 수 있습니다.</p>
<h2 id="Repository-Pattern"><a href="#Repository-Pattern" class="headerlink" title="Repository Pattern"></a>Repository Pattern</h2><p><code>Spring</code>에서 Logic의 구성은 일반적으로 <code>Repository Pattern</code>을 따를 것을 권고하고 있습니다. <code>Repository Pattern</code>은 BL(Business Logic)과 데이터의 저장(Repository)에 대한 Layer를 명확히 구분시키는 pattern 입니다. 일반적인 구성은 다음과 같이 만들어집니다.</p>
<p><img src="https://i-msdn.sec.s-msft.com/dynimg/IC340233.png" alt=""></p>
<p>데이터의 검색/저장 영역과 그 데이터를 이용하는 BL을 철저하게 구분합니다. 이는 <code>DAO Pattern</code>과는 구분 됩니다. <code>DAO Pattern</code>의 경우, 데이터에 Access를 어떤 Layer에서나 접근이 가능한 차이를 가지고 있습니다.</p>
<p>그래서, Spring으로 구성된 프로젝트를 보면 다음과 같은 package들로 구성되는 경우가 많습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── config</span><br><span class="line">├── controller</span><br><span class="line">├── entity</span><br><span class="line">├── repository</span><br><span class="line">└── service</span><br></pre></td></tr></table></figure>
<p>이제 몇가지 BL을 가지고 Spring에서의 Service를 구현해보도록 하겠습니다.</p>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>이제 BookStore의 BL을 정의해보도록 하겠습니다.</p>
<ul>
<li>user는 book을 빌리거나 반납할 수 있다.</li>
<li>user가 book을 빌리면, point가 10점씩 쌓인다.</li>
<li>point가 100점이 넘어가면 LEVEL이 READER(1)가 된다.</li>
<li>point가 300점이 넘어가면 MVP(2)가 된다.</li>
<li>point가 100점 이하인 경우, 일반유저(NORMAL)이다.</li>
<li>전체 book을 list up 할 수 있으며, 대출이 가능한 책 우선으로 Sort된다.</li>
<li>book은 대출 가능, 대출중, 분실의 3가지의 상태를 갖는다.</li>
<li>user는 자신이 지금까지 빌린 book들의 기록(대출,반납)을 최신 순으로 볼 수 있다.</li>
<li>user의 RENT/RETURN은 모두 History가 남는다.</li>
</ul>
<p>매우 간단한 BL입니다. 그리고, 이 BL에 대한 Action 주체를 기준으로 다음과 같이 명명한 서비스들을 구상할 수 있습니다.</p>
<ul>
<li>UserService: User가 Action의 주체가 되는 서비스입니다.</li>
<li>BookService: Book이 Action의 주체가 되는 서비스입니다.</li>
</ul>
<p>서비스의 명명법은 일반적으로 영문법을 따르게 되며 다음과 같은 영어 문장과 같은 구성을 갖는것이 좋습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">userService.listupRentHistories();</span><br><span class="line">userService.rentBook(Book book);</span><br><span class="line">userService.returnBook(Book book);</span><br><span class="line">bookService.listup();</span><br></pre></td></tr></table></figure>
<p>이에 대한 서비스는 다음과 같이 설계할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">returnBook</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span></span>;</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">listup</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">List&lt;History&gt; <span class="title">getHistories</span><span class="params">(<span class="keyword">int</span> userId)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">listup</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이와 같이 interface는 단순히 객체에 대한 프로그래밍적 요소로만 사용되는 것이 아닌, 프로그램의 in/out에 대한 설계로서 사용이 가능합니다. 우리가 어떠한 application을 작성을 할때, input/output에 대한 정의를 명확히 할 수 있는 경우, interface를 이용해서 코드를 명확히 구성하는 것이 가능합니다. 이제 interface를 기반으로 서비스를 구현해보면 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    <span class="keyword">private</span> BookDao bookDao;</span><br><span class="line">    <span class="keyword">private</span> HistoryDao historyDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserDao userDao, BookDao bookDao, HistoryDao historyDao)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userDao = userDao;</span><br><span class="line">        <span class="keyword">this</span>.bookDao = bookDao;</span><br><span class="line">        <span class="keyword">this</span>.historyDao = historyDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">        User user = userDao.getById(userId);</span><br><span class="line">        Book book = bookDao.getById(bookId);</span><br><span class="line">        <span class="keyword">if</span> (book.getBookStatus() != BookStatus.CanRent || book.getRentUserId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        user.setPoint(user.getPoint() + <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (user.getPoint() &gt;= <span class="number">100</span> &amp;&amp; user.getPoint() &lt; <span class="number">300</span>) &#123;</span><br><span class="line">            user.setLevel(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (user.getPoint() &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">            user.setLevel(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            user.setLevel(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        book.setRentUserId(userId);</span><br><span class="line">        book.setBookStatus(BookStatus.RentNow);</span><br><span class="line"></span><br><span class="line">        userDao.update(user);</span><br><span class="line">        bookDao.update(book);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//<span class="doctag">NOTE:</span> History 기록</span></span><br><span class="line">        History history = <span class="keyword">new</span> History();</span><br><span class="line">        history.setDate(<span class="keyword">new</span> Date());</span><br><span class="line">        history.setActionType(HistoryActionType.RENT_BOOK);</span><br><span class="line">        history.setUserId(userId);</span><br><span class="line">        history.setBookId(bookId);</span><br><span class="line">        historyDao.add(history);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 구현된 서비스를 <code>@Service</code>로 등록됩니다. 이제 <code>@Configuration</code>에 등록하는 코드를 확인해보겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.dao"</span>,</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.service"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">        dataSource.setMaximumPoolSize(<span class="number">10</span>);</span><br><span class="line">        dataSource.setMinimumIdle(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 정상적으로 등록되었는지 확인해보도록 하겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(classes = BookStoreConfig.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImplTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        UserService userService = applicationContext.getBean(UserService.class);</span><br><span class="line">        assertThat(userService).isNotNull();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doTest01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Service-Code의-테스트-방법"><a href="#Service-Code의-테스트-방법" class="headerlink" title="Service Code의 테스트 방법"></a>Service Code의 테스트 방법</h2><p><code>@Service</code> 객체들을 모두 가져다 사용이 가능한 것을 볼 수 있습니다. 이제 우리는 <code>Repository Pattern</code>으로 개발할 준비가 모두 마쳐진 상태입니다. 그렇다면 이와 같은 코드를 어떻게 테스트를 할 수 있을까요?</p>
<p><code>rent</code> 코드가 정상적으로 동작하는 것을 확인하기 위해서는 다음 상황을 확인할 수 있어야지 됩니다.</p>
<ul>
<li><code>Book</code>의 상태에 따라 대여가 가능하거나 불가능해야지 됩니다.</li>
<li><code>User</code>의 Point 점수에 따라 Level이 변경이 될 수 있어야지 됩니다.</li>
<li><code>History</code>의 추가가 되어야지 됩니다.</li>
</ul>
<p>위 3가지를 확인하기 위해서는 <code>Repository</code>에 올바른 데이터가 입력되어 있어야지 됩니다. 그리고, 테스트가 정상적으로 동작할 수 있도록 데이터를 준비하더라도 테스트가 반복적으로 실행될 수는 없는 구조입니다. <code>User</code>의 상태가 변경되기 때문이지요. 그렇다면 이런 문제를 회피하면서 테스트를 진행하기 위해서는 어떻게 해야지 될까요?</p>
<p>여기서 한번 우리가 기본적으로 알고 있는 <code>OOP</code>에 대해서 다시 생각해볼 필요가 있습니다. 우리의 테스트 코드는 테스트하고자 하는 객체에 대한 테스트를 진행해야지 됩니다. <code>Service</code> 테스트 코드가 굳이 <code>Repository</code>에 대한 테스트를 진행할 필요가 없다는 것입니다. 그렇다면 <code>Repository</code>를 우리가 원하는 객체만을 반환하게 해줘서 테스트를 진행하면 이 문제를 해결할 수 있습니다.</p>
<p>다시한번 위 3가지의 테스트 조건이 어떻게 통과될 수 있는지 확인해보도록 하겠습니다.</p>
<table>
<thead>
<tr>
<th>상황</th>
<th>해결방안</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Book</code>의 상태에 따라 대여가 가능하거나 불가능해야지 됩니다.</td>
<td>bookDao.getById에서 원하는 상태를 갖는 <code>Book</code>을 얻어낼 수 있으면 가능합니다.</td>
</tr>
<tr>
<td><code>User</code>의 Point 점수에 따라 Level이 변경이 될 수 있어야지 됩니다.</td>
<td><code>User.point</code>, <code>User.level</code>이 테스트 하고자 하는 상태를 갖는 <code>User</code>를 얻어낼 수 있으면 가능합니다.</td>
</tr>
<tr>
<td><code>History</code>의 추가가 되어야지 됩니다.</td>
<td><code>historyDao.add</code>가 호출되어야지 됩니다.</td>
</tr>
</tbody>
</table>
<p>이렇게 설정된 값을 반환하는 테스트 객체를 이용하는 테스트를 <code>mockTest</code>라고 합니다. <code>mockTest</code>는 매우 중요합니다. 모든 <code>application</code>은 <code>Dependency</code>를 갖게 되는데 이 <code>Dependency</code>의 영향을 받지 않는 테스트를 구성하지 않으면, 좋은 테스트 코드를 구현할 수 없습니다. <code>mockTest</code>를 구현하기 위해 자주 사용되는 library는 <code>mokito</code>입니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testCompile <span class="string">group:</span> <span class="string">'org.mockito'</span>, <span class="string">name:</span> <span class="string">'mockito-all'</span>, <span class="string">version:</span> <span class="string">'1.10.19'</span></span><br></pre></td></tr></table></figure>
<p>다음은 구성된 테스트 코드입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.assertj.core.api.Assertions.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.Mockito.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockUserServiceImplTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> BOOK상태가_정상적이지_않은_경우_테스트() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Book book = <span class="keyword">new</span> Book();</span><br><span class="line">        <span class="comment">//대여되어 있는 상태</span></span><br><span class="line">        book.setBookStatus(BookStatus.RentNow);</span><br><span class="line"></span><br><span class="line">        BookDao bookDao = mock(BookDao.class);</span><br><span class="line">        when(bookDao.getById(any())).thenReturn(book);</span><br><span class="line">        UserDao userDao = mock(UserDao.class);</span><br><span class="line">        HistoryDao historyDao = mock(HistoryDao.class);</span><br><span class="line"></span><br><span class="line">        UserServiceImpl userService = <span class="keyword">new</span> UserServiceImpl(userDao, bookDao, historyDao);</span><br><span class="line">        assertThat(userService.rent(<span class="number">0</span>, <span class="number">0</span>)).isFalse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> BOOK의_RENTUSERID가_NULL이_아닌경우_테스트() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">int</span> targetUserId = <span class="number">0</span>;</span><br><span class="line">        Book book = <span class="keyword">new</span> Book();</span><br><span class="line">        book.setBookStatus(BookStatus.CanRent);</span><br><span class="line">        book.setRentUserId(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        BookDao bookDao = mock(BookDao.class);</span><br><span class="line">        when(bookDao.getById(any())).thenReturn(book);</span><br><span class="line">        UserDao userDao = mock(UserDao.class);</span><br><span class="line">        HistoryDao historyDao = mock(HistoryDao.class);</span><br><span class="line"></span><br><span class="line">        UserServiceImpl userService = <span class="keyword">new</span> UserServiceImpl(userDao, bookDao, historyDao);</span><br><span class="line">        assertThat(userService.rent(targetUserId, <span class="number">0</span>)).isFalse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> 정상적인_RENT가_되는_경우_사용자Level이_READER가_되는_경우() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//User.point = 90, level이 1로 변경되는 것 확인</span></span><br><span class="line">        testRentWithUserCondition(<span class="number">90</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">//User.point = 290, level이 2로 변경되는 것 확인</span></span><br><span class="line">        testRentWithUserCondition(<span class="number">290</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="comment">//User.point = 50, level이 0으로 유지되는 것 확인</span></span><br><span class="line">        testRentWithUserCondition(<span class="number">50</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">testRentWithUserCondition</span><span class="params">(<span class="keyword">int</span> currentPoint, <span class="keyword">int</span> currentLevel, <span class="keyword">int</span> expectLevel)</span> </span>&#123;</span><br><span class="line">        Book book = <span class="keyword">new</span> Book();</span><br><span class="line">        book.setBookStatus(BookStatus.CanRent);</span><br><span class="line">        book.setRentUserId(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setPoint(currentPoint);</span><br><span class="line">        user.setLevel(currentLevel);</span><br><span class="line"></span><br><span class="line">        BookDao bookDao = mock(BookDao.class);</span><br><span class="line">        when(bookDao.getById(any())).thenReturn(book);</span><br><span class="line">        UserDao userDao = mock(UserDao.class);</span><br><span class="line">        when(userDao.getById(any())).thenReturn(user);</span><br><span class="line">        HistoryDao historyDao = mock(HistoryDao.class);</span><br><span class="line"></span><br><span class="line">        UserServiceImpl userService = <span class="keyword">new</span> UserServiceImpl(userDao, bookDao, historyDao);</span><br><span class="line">        <span class="comment">//Rent가 정상적으로 진행되는 것을 확인</span></span><br><span class="line">        assertThat(userService.rent(<span class="number">0</span>, <span class="number">0</span>)).isTrue();</span><br><span class="line">        <span class="comment">//Rent가 진행된 후, 사용자의 Level이 바뀐것을 확인</span></span><br><span class="line">        assertThat(user.getLevel()).isEqualTo(expectLevel);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//book, user가 update되는 코드가 호출되는 것을 확인</span></span><br><span class="line">        verify(bookDao, times(<span class="number">1</span>)).update(book);</span><br><span class="line">        verify(userDao, times(<span class="number">1</span>)).update(user);</span><br><span class="line">        <span class="comment">//History가 추가 되는것을 확인</span></span><br><span class="line">        verify(historyDao, times(<span class="number">1</span>)).add(any());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mockTest</code>는 의존성을 제거하고 로직을 테스트할 수 있는 좋은 방법입니다. 그렇다고 <code>Repository</code>를 직접 이용하는 테스트 코드가 필요없다는 것은 아닙니다. 어떤 항목을 테스트해야될지 개발자들이 확인할 필요가 있습니다.</p>
<h2 id="Transaction"><a href="#Transaction" class="headerlink" title="Transaction"></a>Transaction</h2><p>지금까지 구현된 Service, Repository Layer는 결정적인 문제를 가지고 있습니다. 예를 들어, rentBook action에서 book의 상태를 업데이트 한 후에, DB의 문제나 application의 exception이 발생했다면 어떤 문제가 발생할까요?<br>지금의 JdbcTemplate은 각 Repository Layer단으로 Connection이 분리 되어 있습니다. 따라서 한쪽에서 Exception이 발생하더라도, 기존 update 사항에 대해서는 DB에 그대로 반영이 되어버립니다. 이건 엄청난 문제를 발생시킵니다. Repository는 우리가 서비스를 만드는 도구이고, 결국은 사용자나 BL의 한개의 action으로 DB의 Transaction이 적용이 되어야지 되는데, 이러한 규칙을 모두 날려버리게 되는 것입니다.</p>
<p>다시 한번 정리하도록 하겠습니다. Service의 method는 BL의 기본 단위가 됩니다. 따라서, Transaction의 단위가 Service의 method 단위가 되어야지 됩니다. 간단히 sudo 코드를 작성한다면 rent method는 다음과 같이 작성되어야지 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">    Transaction.begin();</span><br><span class="line">    User user = userDao.get(userId);</span><br><span class="line">    Book book = bookDao.get(bookId);</span><br><span class="line"></span><br><span class="line">    user.setPoint(user.getPoint() + <span class="number">10</span>);</span><br><span class="line">    user.setLevel(getUserLevel(user.getPoint()));</span><br><span class="line">    book.setRentUserId(user.getId());</span><br><span class="line">    book.setStatus(BookStatus.RentNow);</span><br><span class="line"></span><br><span class="line">    UserHistory history = <span class="keyword">new</span> UserHistory();</span><br><span class="line">    history.setUserId(userId);</span><br><span class="line">    history.setBookId(book.getId());</span><br><span class="line">    history.setAction(HistoryActionType.RENT);</span><br><span class="line"></span><br><span class="line">    userDao.update(user);</span><br><span class="line">    bookDao.update(book);</span><br><span class="line">    userHistoryDao.add(history);</span><br><span class="line"></span><br><span class="line">    Transaction.commit();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Transaction은 매우 골치아픈 개념입니다. 먼저 지금 사용중인 DataSource는 직접적으로 JDBC에 연결되는 Connection입니다. 그런데, 이를 Hibernate의 session 또는 iBatis의 ObjectMapper들을 사용한다면 완전히 다른 Transaction 기술을 사용해야지 됩니다. 지금까지 기술에 종속적이지 않은 <code>Service</code>를 작성하고 있는데, 이제 Transaction에 의한 기술 종속적 코드로 변경이 되어야지 되는 상황이 되어버린것입니다. 그래서, 이 경우를 해결하기 위해서 Transaction의 기술들에 대한 interface를 spring은 제안하고 있습니다. 바로 <code>org.springframework.transaction.PlatformTransactionManager</code>가 바로 그 interface입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PlatformTransactionManager</span> </span>&#123;</span><br><span class="line">    <span class="function">TransactionStatus <span class="title">getTransaction</span><span class="params">(@Nullable TransactionDefinition definition)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Transaction을 얻어내고, Transaction을 commit, rollback하는 간단한 구조로 되어 있습니다. 이러한 기본 구조는 우리가 Dao Layer를 이용해서 Transaction을 사용하는데 충분합니다.<br>PlatformTransactionManager를 이용한 Transaction 구현을 간단한 sudo code로 구현하면 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TransactionStatus status = transactionManager.getTransaction(definition);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ..do something</span></span><br><span class="line">        transactionManager.commit(status);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">        transactionManager.rollback(status)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>전에 보던 Template-callback pattern과 동일한 패턴의 코드가 완성됩니다. TransactionManager의 생성자에는 DataSource interface를 구현하고 있기 때문에 Dao Layer에서 사용하는 Connection을 한번에 묶어서 처리가 가능합니다. Spring Transaction을 이용한 코드는 다음과 같이 구현되어야지 됩니다.</p>
<p>먼저 <code>@Configuration</code>에 다음과 같이 등록합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserService는 다음과 같이 변경되어야지 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">    TransactionStatus transaction = transactionManager.getTransaction(<span class="keyword">new</span> DefaultTransactionDefinition());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        User user = userDao.getById(userId);</span><br><span class="line">        Book book = bookDao.getById(bookId);</span><br><span class="line">        <span class="keyword">if</span> (book.getBookStatus() != BookStatus.CanRent || book.getRentUserId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        user.setPoint(user.getPoint() + <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (user.getPoint() &gt;= <span class="number">100</span> &amp;&amp; user.getPoint() &lt; <span class="number">300</span>) &#123;</span><br><span class="line">            user.setLevel(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (user.getPoint() &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">            user.setLevel(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            user.setLevel(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        book.setRentUserId(userId);</span><br><span class="line">        book.setBookStatus(BookStatus.RentNow);</span><br><span class="line"></span><br><span class="line">        userDao.update(user);</span><br><span class="line">        bookDao.update(book);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//<span class="doctag">NOTE:</span> History 기록</span></span><br><span class="line">        History history = <span class="keyword">new</span> History();</span><br><span class="line">        history.setDate(<span class="keyword">new</span> Date());</span><br><span class="line">        history.setActionType(HistoryActionType.RENT_BOOK);</span><br><span class="line">        history.setUserId(userId);</span><br><span class="line">        history.setBookId(bookId);</span><br><span class="line">        historyDao.add(history);</span><br><span class="line">        transactionManager.commit(transaction);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        transactionManager.rollback(transaction);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 Transaction이 적용된 코드가 완성되었습니다.</p>
<h2 id="annotation을-이용한-Transaction의-구현"><a href="#annotation을-이용한-Transaction의-구현" class="headerlink" title="annotation을 이용한 Transaction의 구현"></a>annotation을 이용한 Transaction의 구현</h2><p>그런데, 지금까지 구현된 코드에는 한가지 문제가 있습니다. Transaction은 기술적인 영역으로 Service 객체에는 어울리지 않는 내용입니다. Service는 BL의 집합이라는 것을 다시 한번 상기해주시길 바랍니다. BL에 기술적인 요소가 들어가게 되면, 기술적인 요소에 따른 BL의 수정이 가해질 수 있습니다. 따라서, Spring에서는 이를 분리하는 것을 제안하고 있으며, 특히 Transaction에서는 @Transactional annotaion을 이용한 분리를 제안하고 있습니다.</p>
<p>@Transactional은 method, class에 모두 적용 가능한 annotation입니다. @Transactional을 사용하기 위해서는 <code>@Configuration</code>이 다음과 같이 변경이 필요합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.dao"</span>,</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.service"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">        dataSource.setMaximumPoolSize(<span class="number">10</span>);</span><br><span class="line">        dataSource.setMinimumIdle(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@EnableTransactionManagement</code>에 주의해주시길 바랍니다. 이제 Transaction을 다음과 같이 적용하면 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">    User user = userDao.getById(userId);</span><br><span class="line">    Book book = bookDao.getById(bookId);</span><br><span class="line">    <span class="keyword">if</span> (book.getBookStatus() != BookStatus.CanRent || book.getRentUserId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"BOOK의 상태가 정상적이지 않습니다."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    user.setPoint(user.getPoint() + <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (user.getPoint() &gt;= <span class="number">100</span> &amp;&amp; user.getPoint() &lt; <span class="number">300</span>) &#123;</span><br><span class="line">        user.setLevel(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (user.getPoint() &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">        user.setLevel(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        user.setLevel(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    book.setRentUserId(userId);</span><br><span class="line">    book.setBookStatus(BookStatus.RentNow);</span><br><span class="line"></span><br><span class="line">    userDao.update(user);</span><br><span class="line">    bookDao.update(book);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//<span class="doctag">NOTE:</span> History 기록</span></span><br><span class="line">    History history = <span class="keyword">new</span> History();</span><br><span class="line">    history.setDate(<span class="keyword">new</span> Date());</span><br><span class="line">    history.setActionType(HistoryActionType.RENT_BOOK);</span><br><span class="line">    history.setUserId(userId);</span><br><span class="line">    history.setBookId(bookId);</span><br><span class="line">    historyDao.add(history);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>이번에는 Spring JDBC를 이용한 DB 접근 방법에 대해서 알아봤습니다. Spring을 사용중이지만, 외부 Library의 도움을 받지 못하는 경우에 매우 좋은 선택입니다. 그리고 DataSource에 대해서도 알아봤습니다. DataSource는 매우 중요한 Library입니다. DB Connection을 관리하고 있기 때문에 이에 대한 세부설정은 전체 솔루션 성능에 큰 영향을 미치게 됩니다. Transaction은 DB를 다룰때 매우 중요한 이슈입니다.</p>
<p>마지막으로 <code>Repository Pattern</code>에 대해서 알아봤습니다. <code>Service</code>, <code>Repository</code>로 만들어지는 구조는 Spring을 사용한 BL Logic을 구성하는 application의 기본 구조이기도합니다. 그리고, <code>Repository Pattern</code>을 테스트하는 방법들 중에서 <code>mockTest</code>에 대해서도 알아봤습니다.</p>
<p>하나하나가 매우 중요한 개념입니다. 몸으로도 개념으로도 익히는 것이 중요합니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/study-java-spring/">study,java,spring</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2018 ykyoon
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>