<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Programming is Fun | Still waters run deep. When the well&#39;s dry, we know the worth of water.</title>

  
  <meta name="author" content="ykyoon">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="Programming is Fun"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Programming is Fun" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Programming is Fun</a>
    </h1>
    <p class="site-description">Still waters run deep. When the well&#39;s dry, we know the worth of water.</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2018/04/10/spring-view/"><span>15. Spring View</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/04/10/spring-view/" rel="bookmark">
        <time class="entry-date published" datetime="2018-04-09T23:17:00.000Z">
          2018-04-10
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>View는 사용자에게 최종적으로 보이는 영역입니다. 이 영역은 우리가 일반적으로 보는 Html이 될 수도 있고, Mobile App에게는 JSON format의 API 결과가 될 수도 있습니다.<br>기본적으로 Spring Servlet/MVC를 기반으로 동작하게 됩니다. View 계층 또는 Presentation 계층이라고 합니다.</p>
<p>Controller가 return한 결과에 대한 표현을 담당하는 영역으로 Controller가 넘겨주는 ModelAndView가 View에서 핵심 객체라고 할 수 있습니다.</p>
<p>기본적인 동작은 DispatcherServlet이 ModelAndView에서 넘어온 값 ViewResolver를 통해서 해석한 결과를 사용자에게 보내줍니다. ViewResolver는 기본적으로 jsp를 기반으로 하고 있고, jsp 이외에 모든 web context가 될 수 있습니다.</p>
<h2 id="View의-구조"><a href="#View의-구조" class="headerlink" title="View의 구조"></a>View의 구조</h2><h3 id="View의-기본-구조"><a href="#View의-기본-구조" class="headerlink" title="View의 기본 구조"></a>View의 기본 구조</h3><p>기본적으로 Spring의 org.springframework.web.servlet.View interface를 구현한 객체를 View로 표현이 가능합니다. 일반적으로 View는 Spring 내부의 View를 확장하거나, pdf, rss, excel과 같은 다른 형태의 View를 표현하기 위해서 class를 확장해서 사용합니다. 또는 외부 View engine을 이용한 View의 표현 역시 가능합니다. 여기서 외부 View engine을 이용하는 것은 <code>velocity</code>, <code>freemarker</code>, <code>tiles</code>와 같은 외부의 View engine과의 연결 interface 및 설정을 구현함으로서 가능합니다.</p>
<h3 id="View의-기본-동작"><a href="#View의-기본-동작" class="headerlink" title="View의 기본 동작"></a>View의 기본 동작</h3><p>Controller가 작업을 마친 후, View정보를 ModelAndView 객체에 담아서 보내주는 DispatcherServlet에 보내주는 것이 기본 동작입니다. 이에 대한 방법은 Spring @MVC는 두가지를 제공하고 있습니다. 첫번째는 View interface를 구현한 객체를 보내주는 방법이고, 다른 하나는 View의 이름만을 보내는 방법입니다. 첫번째 방법의 경우에는 View interface의 구현 방법에 따라 다양한 View를 표시하게 됩니다. DispatcherServlet과 Controller간에는 어떠한 동작도 존재하지 않습니다. 그렇지만 View의 이름만 보내주는 방식은 좀 다르게 동작하게 됩니다.</p>
<p>View의 이름으로 표현되는 논리적인 View를 실질적인 View interface를 구현한 객체로 변경하는 작업이 필요하게되는데요. 이를 담당하는 객체를 ViewResolver라고 합니다.</p>
<p>Spring에서 제공하는 주요 ViewResolver는 다음과 같습니다.</p>
<table>
<thead>
<tr>
<th>ViewResolver 구현 class</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>InternalResourceViewResolver</td>
<td>View Name에서 jsp나 tiles 연동을 위한 View 객체를 반환</td>
</tr>
<tr>
<td>BeanNameViewResolver</td>
<td>Bean name을 기준으로 View 객체를 반환</td>
</tr>
<tr>
<td>ResourceBundlleViewResolver</td>
<td>View 이름과 View 객체간의 mapping 정보를 저장하기 위해서 Resource 파일을 이용</td>
</tr>
<tr>
<td>XmlViewResolver</td>
<td>View 이름과 View 객체간의 mapping 정보를 저장하기 위해서 xml 파일을 이용</td>
</tr>
</tbody>
</table>
<p>기본적으로 만들어지는 ViewResolver의 interface는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewResolver</span> </span>&#123;</span><br><span class="line">    <span class="function">View <span class="title">resolveViewName</span><span class="params">(String viewName, Locale locale)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>다국어 지원을 위한 locale 정보와 View 이름을 이용한 View 객체를 얻어내는 간단한 interface만을 가지고 있습니다. 이를 이용해서 새로운 ViewResolver를 만드는 것 역시 가능합니다.<br>구성되는 View는 다음과 같은 interface를 가지고 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">View</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getContentType</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">render</span><span class="params">(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>들어오게되는 model을 어떻게 render하는지에 대한 interface 선언을 볼 수 있습니다.</p>
<h2 id="View의-표현법-HTML"><a href="#View의-표현법-HTML" class="headerlink" title="View의 표현법 - HTML"></a>View의 표현법 - HTML</h2><p>우리가 일반적으로 보는 브라우져를 이용해서 볼 수 있는 화면을 표시하는 방법입니다.</p>
<h3 id="JSP-amp-JSTL-JSP-Standard-Tag-Library"><a href="#JSP-amp-JSTL-JSP-Standard-Tag-Library" class="headerlink" title="JSP &amp; JSTL(JSP Standard Tag Library)"></a>JSP &amp; JSTL(JSP Standard Tag Library)</h3><p>기본적인 jsp view와 JSTL을 사용하기 위한 View입니다.</p>
<p>jsp와 jstl을 사용하기 위해서는 특별한 View 설정은 필요없지만, 기본적으로 Spring에서 요구되는 View는 WEB-INF 폴더 안에 view file들을 위치시키고, client에서 직접 접근할 수 없도록 하는 것이 일반적입니다. 이때는 기본적으로 <code>InternalResourceViewResolver</code>를 사용해서 View 파일의 위치를 설정하도록 합니다.</p>
<p><em>build.gradle</em></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'javax.servlet.jsp.jstl'</span>, <span class="string">name:</span> <span class="string">'jstl'</span>, <span class="string">version:</span> <span class="string">'1.2'</span></span><br></pre></td></tr></table></figure>
<p><em>applicationContext.xml</em></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"viewResolver"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"viewClass"</span> <span class="attr">value</span>=<span class="string">"org.springframework.web.servlet.view.JstlView"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/views/"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"contentType"</span> <span class="attr">value</span>=<span class="string">"text/html; charset=UTF-8"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><em>@Configuration</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ViewResolver <span class="title">viewResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    InternalResourceViewResolver internalResourceViewResolver = <span class="keyword">new</span> InternalResourceViewResolver();</span><br><span class="line">    internalResourceViewResolver.setPrefix(<span class="string">"/WEB-INF/jsp/"</span>);</span><br><span class="line">    internalResourceViewResolver.setSuffix(<span class="string">".jsp"</span>);</span><br><span class="line">    internalResourceViewResolver.setOrder(<span class="number">1</span>);</span><br><span class="line">    internalResourceViewResolver.setViewClass(JstlView.class);</span><br><span class="line">    <span class="keyword">return</span> internalResourceViewResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JSTL은 다양한 tag를 지원하고 있습니다. 이는 기존 jsp에서 &lt;%= %&gt;에서 빈번하게 만들어지는 code들을 단순화하고 읽기 편한 간단한 언어로 만들기 위해서 제공되고 있습니다.  jsp는 다음과 같은 tag를 선언함으로서 사용할 수 있습니다.</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%<span class="meta">@taglib</span> prefix=<span class="string">"c"</span>uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span>%&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>c:out</code>  - 객체를 출력한다.</li>
</ul>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;c:out value=<span class="string">"$&#123;name&#125;"</span>/&gt;&lt;!--기본 문법--&gt;</span><br><span class="line">&lt;c:out value=<span class="string">"$&#123;age&#125;"</span> <span class="keyword">default</span>=<span class="string">"Null or empty"</span>/&gt; &lt;!--  <span class="keyword">default</span> 속성 : 값이 없을때 기본출력값을 정의--&gt;</span><br><span class="line">&lt;c:out value=<span class="string">"$&#123;name&#125;"</span> escapeXml=<span class="string">"false"</span>/&gt;&lt;!-- escapeXml 속성 : 기본적으로 XML 문자를 escape하는데 Escape 하지 않으려면  <span class="keyword">false</span>로 설정--&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>c:if</code> - 조건문</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--기본문법--&gt;</span><br><span class="line">&lt;c:<span class="keyword">if</span> test=<span class="string">"$&#123;조건&#125;"</span>&gt;</span><br><span class="line">    조건 만족시 이 영역을 수행</span><br><span class="line">&lt;/c:if&gt;</span><br></pre></td></tr></table></figure>
<p>jstl에서 if문은 조금 문제가 있습니다. 그건 else가 존재하지 않는 문제인데요. 우리가 주로 사용하는 if~else 문을 갖추기 위해서는 아래의 choose문을 사용해야지 됩니다.</p>
<ul>
<li><code>c:choose, c:when, c:otherwise</code> - switch 문</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--기본문법--&gt;</span><br><span class="line">&lt;c:choose&gt;</span><br><span class="line">    &lt;c:when test=<span class="string">"$&#123;value == 1&#125;"</span>&gt;</span><br><span class="line">        value가 <span class="number">1</span>이면 이 영역을 수행</span><br><span class="line">    &lt;/c:when&gt;</span><br><span class="line">    &lt;c:when test=<span class="string">"$&#123;value == 2&#125;"</span>&gt;</span><br><span class="line">        value가 <span class="number">2</span>이면 이 영역을 수행</span><br><span class="line">    &lt;/c:when&gt;</span><br><span class="line">    &lt;c:otherwise&gt;</span><br><span class="line">        value가 <span class="number">1</span>,<span class="number">2</span>가 아니면 이 영역을 수행(기본값)</span><br><span class="line">    &lt;/c:otherwise&gt;</span><br><span class="line">&lt;/c:choose&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>c:foreach</code> - 반복문</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--기본문법(<span class="number">0</span>~<span class="number">9</span>까지 출력)--&gt;</span><br><span class="line">&lt;c:forEach begin=<span class="string">"0"</span> end=<span class="string">"9"</span> var=<span class="string">"i"</span>&gt;</span><br><span class="line">    &lt;c:out value=<span class="string">"$&#123;i&#125;"</span>/&gt;</span><br><span class="line">&lt;/c:forEach&gt;</span><br><span class="line">&lt;!-- step 속성 : 정의된 수만큼 증가를 시킨다.(<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">9</span>출력)--&gt;</span><br><span class="line">&lt;c:forEach var=<span class="string">"test"</span> begin=<span class="string">"1"</span> end=<span class="string">"10"</span> step=<span class="string">"2"</span> &gt;</span><br><span class="line">     &lt;b&gt;$&#123;test &#125;&lt;/b&gt;</span><br><span class="line">&lt;/c:forEach&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>c:forTokens</code> - 구분자로 반복문</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--기본문법(변수를 <span class="string">','</span>로 구분하여 출력한다. )--&gt;</span><br><span class="line">&lt;c:forTokens var=<span class="string">"alphabet"</span> items=<span class="string">"a,b,c,d,e,f,g,h,i,j,k"</span> delims=<span class="string">","</span> varStatus=<span class="string">"idx"</span> &gt;</span><br><span class="line">     &lt;b&gt;$&#123;alphabet &#125;&lt;/b&gt;</span><br><span class="line">&lt;/c:forTokens&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>c:url, c:param</code>  - URL을 처리</li>
</ul>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;c:url value=<span class="string">"index.jsp"</span>/&gt;</span><br><span class="line">&lt;!-- value의 속성값이 /로 시작하면 컨텍스트를 포함한다--&gt;</span><br><span class="line">&lt;!--Context가 Root이라면 /Root/index.jsp로 출력--&gt;</span><br><span class="line">&lt;c:url value=<span class="string">"/index.jsp"</span>/&gt;</span><br><span class="line">&lt;!--context 속성 : 다른 컨텍스트로 출력하고자할때 사용--&gt;</span><br><span class="line">&lt;!-- /newRoot/index.jsp로 출력--&gt;</span><br><span class="line">&lt;c:url value=<span class="string">"/index.jsp"</span> context=<span class="string">"/newRoot"</span>/&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>c:import</code> - JSP파일을 인클루드한다.</li>
</ul>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- partialView.jsp의 내용을 출력 --&gt;</span><br><span class="line">&lt;c:<span class="keyword">import</span> url=<span class="string">"partialView.jsp"</span>/&gt;</span><br><span class="line">&lt;!-- charEncoding 속성:   인코딩에 문제가 있을 시 사용 --&gt;</span><br><span class="line">&lt;c:<span class="keyword">import</span> url=<span class="string">"UserForm.jsp"</span> charEncoding=<span class="string">"UTF-8"</span>/&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>c:redirect</code> - 리다이렉션</li>
</ul>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 기본 문법 --&gt;</span><br><span class="line">&lt;c:redirect url=<span class="string">"http://kkams.net"</span>/&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>c:catch</code> - 예외 발생시 처리</li>
</ul>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 기본 문법 --&gt;</span><br><span class="line">&lt;c:<span class="keyword">catch</span> var=<span class="string">"err"</span>&gt;</span><br><span class="line">    &lt;%=<span class="number">10</span> / <span class="number">0</span>%&gt; &lt;!--<span class="number">0</span>으로 나누면 에러 발생--&gt;</span><br><span class="line">&lt;/c:catch&gt;</span><br><span class="line">&lt;!--에러 출력--&gt;</span><br><span class="line">&lt;c:out value=<span class="string">"$&#123;err &#125;"</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>다양해보이지만, 상당히 빈약한 문법과 코드를 가지고 있는 것이 JSTL입니다. 자주 사용되기도 하고, 일단 표준이기 때문에 몰라서는 안되는 View 표현 방법입니다. 앞서 Controller에서 보내지는 Model의 값을 JSTL을 이용해서 표현하게 되는 것이 일반적입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/book/list"</span>, method = RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getBookList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Book&gt; books = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i++) &#123;</span><br><span class="line">        String name = String.format(<span class="string">"책%d"</span>, i);</span><br><span class="line">        String author = String.format(<span class="string">"저자%d"</span>, i);</span><br><span class="line">        String status = <span class="string">"상태"</span>;</span><br><span class="line">        books.add(<span class="keyword">new</span> Book(name, author, status));</span><br><span class="line">    &#125;</span><br><span class="line">    ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">    modelAndView.setViewName(<span class="string">"book/list"</span>);</span><br><span class="line">    modelAndView.addObject(<span class="string">"books"</span>, books);</span><br><span class="line">    <span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib prefix=<span class="string">"c"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span>%&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"spring"</span> uri=<span class="string">"http://www.springframework.org/tags"</span>%&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"form"</span> uri=<span class="string">"http://www.springframework.org/tags/form"</span>%&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"fn"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/functions"</span>%&gt;</span><br><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span> pageEncoding=<span class="string">"UTF-8"</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;Insert title here&lt;/title&gt;</span><br><span class="line">    &lt;link href=<span class="string">"/node_modules/bootstrap/dist/css/bootstrap.min.css"</span> rel=<span class="string">"stylesheet"</span> /&gt;</span><br><span class="line">    &lt;script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h2&gt;jstl test code 입니다.&lt;/h2&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"example-form"</span>&gt;</span><br><span class="line">    &lt;h3&gt;c:forEach example code&lt;/h3&gt;</span><br><span class="line">    &lt;table <span class="class"><span class="keyword">class</span></span>=<span class="string">"table table-striped table-bordered table-hover"</span>&gt;</span><br><span class="line">        &lt;thead&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;th&gt;이름&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;상태&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;저자&lt;/th&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/thead&gt;</span><br><span class="line"></span><br><span class="line">        &lt;tbody&gt;</span><br><span class="line">            &lt;c:forEach var=<span class="string">"book"</span> items=<span class="string">"$&#123;books&#125;"</span>&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;td&gt;$&#123;book.name&#125;&lt;/td&gt;</span><br><span class="line">                    &lt;c:set var=<span class="string">"status"</span> value=<span class="string">"일반"</span> /&gt;</span><br><span class="line">                    &lt;c:choose&gt;</span><br><span class="line">                        &lt;c:when test=<span class="string">"$&#123;book.status eq 'NORMAL'&#125;"</span>&gt;</span><br><span class="line">                            &lt;c:set var=<span class="string">"status"</span> value=<span class="string">"일반"</span> /&gt;</span><br><span class="line">                        &lt;/c:when&gt;</span><br><span class="line">                        &lt;c:when test=<span class="string">"$&#123;book.status eq 'RENTNOW'&#125;"</span>&gt;</span><br><span class="line">                            &lt;c:set var=<span class="string">"status"</span> value=<span class="string">"대여중"</span> /&gt;</span><br><span class="line">                        &lt;/c:when&gt;</span><br><span class="line">                        &lt;c:otherwise&gt;</span><br><span class="line">                            &lt;c:set var=<span class="string">"status"</span> value=<span class="string">"분실중"</span> /&gt;</span><br><span class="line">                        &lt;/c:otherwise&gt;</span><br><span class="line">                    &lt;/c:choose&gt;</span><br><span class="line">                    &lt;td&gt;$&#123;status &#125;&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;$&#123;book.author&#125;&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">            &lt;/c:forEach&gt;</span><br><span class="line">        &lt;/tbody&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="JSTL-fmt를-이용한-데이터의-가공"><a href="#JSTL-fmt를-이용한-데이터의-가공" class="headerlink" title="JSTL fmt를 이용한 데이터의 가공"></a>JSTL fmt를 이용한 데이터의 가공</h3><p>java의 원 데이터를 html로 표시할 때, 우리는 자주 데이터의 모양을 바꿔야지 되는 일들이 발생됩니다. 특히 통화량과 날짜, 소숫점의 표시에서 가장 일반적이라고 할 수 있습니다. 자리수 단락에서 “,”를 추가한다던지, 소숫점 이하의 자리수를 어떻게 표시를 하는지에 대한 문제는 Controller와 같은 기술적인 issue와는 별개로 사용자들에게는 ‘모든 것’이 될 수 있는 문제입니다. 이런 일은 수치데이터를 직접 바꾸는 것이 아니라 수치의 표시를 어떻게 해줄 것인지에 대한 내용입니다. View에서 이런 일들을 해주는 것이 가장 좋습니다.</p>
<p>이 부분에 대해서는 issue가 있습니다. View에서 특정 데이터를 빨간색으로 보여야지 되는 action에 대한 처리를 무엇으로 보느냐에 대한 논쟁입니다. <strong>이것은 보는 방법을 바꾸는 일</strong>이기 때문에 View에서 봐야지 된다는 의견과 보는 방법이 아닌 이것 역시 Business Logic으로 보는 견해도 있습니다. BL이기 때문에 Server Code에서 구동이 되고 테스트가 가능한 방법으로 만들어야지 된다는 것이지요. 가장 좋은 위치는 Controller 영역으로 이야기하고 있습니다. 보여지는 Model을 변경하는 것이기 때문에 가장 좋은 Layer이니까요. 개인적인 의견으로는 View에 대한 영역은 모두 View에 넘기는 것이 좋지 않나. 라는 생각입니다. 저는 개인적으로는 전자의 의견에 좀더 한표를 주고 있는 편입니다. 이 부분에 대해서는 개발자들의 취향과 그 프로젝트의 PM에 따라서 많이 바뀌게 될 내용이라고 생각됩니다.</p>
<p>지금 소개하는 JSTL fmt의 경우에는 View Layer, 즉 JSP에서 보이는 방법을 바꿔주는 방법입니다.</p>
<p>선언 방법은 다음과 같습니다.</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib prefix=<span class="string">"fmt"</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/fmt"</span>%&gt;</span><br></pre></td></tr></table></figure>
<p>선언된 데이터는 다음과 같이 사용이 가능합니다.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"example-form"</span>&gt;</span><br><span class="line">    &lt;fieldset&gt;</span><br><span class="line">        &lt;legend&gt;FMT examples - Date&lt;/legend&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">            &lt;li&gt;&lt;fmt:formatDate value="$&#123;date&#125;" type="DATE" pattern="yyyy/MM/dd" /&gt;&lt;/li&gt;</span><br><span class="line">            &lt;li&gt;&lt;fmt:formatDate value="$&#123;date&#125;" type="DATE" pattern="yyyy년 M월 dd일" /&gt;&lt;/li&gt;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">    &lt;/fieldset&gt;</span><br><span class="line">    &lt;br /&gt;</span><br><span class="line">    &lt;fieldset&gt;</span><br><span class="line">        &lt;legend&gt;FMT example - Number&lt;/legend&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">            &lt;li&gt;orginal : $&#123;number&#125;&lt;/li&gt;</span><br><span class="line">            &lt;li&gt;&lt;fmt:formatNumber value="$&#123;number&#125;" groupingUsed="true" currencySymbol=","/&gt;&lt;/li&gt;</span><br><span class="line">            &lt;li&gt;&lt;fmt:formatNumber value="$&#123;number&#125;" minFractionDigits="5"/&gt;&lt;/li&gt;</span><br><span class="line">            &lt;li&gt;&lt;fmt:formatNumber value="$&#123;number&#125;" type="CURRENCY"/&gt;&lt;/li&gt;</span><br><span class="line">            &lt;li&gt;&lt;fmt:formatNumber value="234.3" pattern="△#,##0.00; ▼#,##0.00" /&gt;&lt;/li&gt;</span><br><span class="line">            &lt;li&gt;&lt;fmt:formatNumber value="-1234.56" pattern="△#,##0.00; ▼#,##0.00" /&gt;&lt;/li&gt;</span><br><span class="line">            &lt;li&gt;&lt;fmt:formatNumber value="0.99" type="percent"/&gt;&lt;/li&gt;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">    &lt;/fieldset&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p><img src="/images/15/01.png" alt=""></p>
<h3 id="Freemarker"><a href="#Freemarker" class="headerlink" title="Freemarker"></a>Freemarker</h3><p>Freemarker는 <code>JSP Tag</code>보다 나은 가독성과 속도를 목적으로 하고 있는 ViewEngine입니다. 다음은 <code>Freemarker</code>로 만든 <code>loop</code>문입니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;#list books as book&gt;</span><br><span class="line">  &lt;tr&gt;</span><br><span class="line">    &lt;td&gt;$&#123;book.name&#125;&lt;/td&gt;</span><br><span class="line">    &lt;#if book.status == &quot;NORMAL&quot;&gt;</span><br><span class="line">        &lt;td&gt;일반&lt;/td&gt;</span><br><span class="line">    &lt;#elseif book.status == &quot;RENTNOW&quot;&gt;</span><br><span class="line">        &lt;td&gt;대여중&lt;/td&gt;</span><br><span class="line">    &lt;#else&gt;</span><br><span class="line">        &lt;td&gt;분실&lt;/td&gt;</span><br><span class="line">    &lt;/#if&gt;</span><br><span class="line">    &lt;td&gt;$&#123;book.author&#125;&lt;/td&gt;</span><br><span class="line">  &lt;/tr&gt;</span><br><span class="line">&lt;/#list&gt;</span><br></pre></td></tr></table></figure>
<p>기존 <code>jsp</code>에서의 문과 비교해보면 가독성이 더 높은 것을 알 수 있습니다.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;c:forEach var=<span class="string">"book"</span> items=<span class="string">"$&#123;books&#125;"</span>&gt;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">        &lt;td&gt;$&#123;book.name&#125;&lt;/td&gt;</span><br><span class="line">        &lt;c:set var=<span class="string">"status"</span> value=<span class="string">"일반"</span> /&gt;</span><br><span class="line">        &lt;c:choose&gt;</span><br><span class="line">            &lt;c:when test=<span class="string">"$&#123;book.status eq 'NORMAL'&#125;"</span>&gt;</span><br><span class="line">                &lt;c:set var=<span class="string">"status"</span> value=<span class="string">"일반"</span> /&gt;</span><br><span class="line">            &lt;/c:when&gt;</span><br><span class="line">            &lt;c:when test=<span class="string">"$&#123;book.status eq 'RENTNOW'&#125;"</span>&gt;</span><br><span class="line">                &lt;c:set var=<span class="string">"status"</span> value=<span class="string">"대여중"</span> /&gt;</span><br><span class="line">            &lt;/c:when&gt;</span><br><span class="line">            &lt;c:otherwise&gt;</span><br><span class="line">                &lt;c:set var=<span class="string">"status"</span> value=<span class="string">"분실중"</span> /&gt;</span><br><span class="line">            &lt;/c:otherwise&gt;</span><br><span class="line">        &lt;/c:choose&gt;</span><br><span class="line">        &lt;td&gt;$&#123;status&#125;&lt;/td&gt;</span><br><span class="line">        &lt;td&gt;$&#123;book.author&#125;&lt;/td&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">&lt;/c:forEach&gt;</span><br></pre></td></tr></table></figure>
<p><code>if</code>, <code>foreach</code>와 같은 제어문이 더 좋습니다. 그리고 기본적으로 <code>HTML</code>과 거의 동일한 문법을 가지고 있기 때문에 좀 더 사용하기 편한 면도 있습니다.</p>
<p><code>freemarker</code>를 사용하기 위한 <code>dependency</code>와 <code>@Configuration</code>은 다음과 같습니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.freemarker'</span>, <span class="string">name:</span> <span class="string">'freemarker'</span>, <span class="string">version:</span> <span class="string">'2.3.23'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"freemarkerConfig"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> FreeMarkerConfigurer <span class="title">freemarkerConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FreeMarkerConfigurer freemarkerConfigurer = <span class="keyword">new</span> FreeMarkerConfigurer();</span><br><span class="line">    freemarkerConfigurer.setTemplateLoaderPath(<span class="string">"/WEB-INF/fmt/"</span>);</span><br><span class="line">    freemarkerConfigurer.setDefaultEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">    freemarkerConfigurer.setPreferFileSystemAccess(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> freemarkerConfigurer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"freeMarkerViewResolver"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> FreeMarkerViewResolver <span class="title">freemarkerViewResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FreeMarkerViewResolver viewResolver = <span class="keyword">new</span> FreeMarkerViewResolver();</span><br><span class="line">    viewResolver.setExposeSpringMacroHelpers(<span class="keyword">true</span>);</span><br><span class="line">    viewResolver.setExposeRequestAttributes(<span class="keyword">true</span>);</span><br><span class="line">    viewResolver.setContentType(<span class="string">"text/html; charset=UTF-8"</span>);</span><br><span class="line">    viewResolver.setCache(<span class="keyword">false</span>);</span><br><span class="line">    viewResolver.setSuffix(<span class="string">".ftl"</span>);</span><br><span class="line">    <span class="keyword">return</span> viewResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="tiles"><a href="#tiles" class="headerlink" title="tiles"></a>tiles</h3><p>Tiles는 기본적으로 JSTL을 이용하지만, JSTL에서 중복되는 html code를 최소화하기 위해서 만들어진 Template Engine입니다. Tile는 기본적인 Html View 가 Composite View Pattern으로 동작할 때, 중복되는 코드들을 공통 요소로 뽑아서 이용가능합니다. 다음은 Tile에 대한 기본 개념의 정의입니다.</p>
<p><img src="/images/15/02.png" alt=""></p>
<p>일반적인 Html Page의 기본 구조입니다. 이 구조에서 페이지가 바뀌게 된다면 Body부분의 Content는 계속해서 바뀌게 되지만, Menu, Header, Footer들은 크게 바뀌지 않는 것이 일반적입니다. 따라서, 각 부분을 재사용할 수 있다면 코드의 양은 매우 줄어들고, 유지보수에 용의함을 알 수 있습니다.</p>
<p>tiles역시 tag를 제공하고 있으며, <code>xml</code>을 통해서 view를 정의합니다.</p>
<p>먼저, 다음과 같이 layout을 만들어줍니다. <code>layout</code>은 <code>insertAttribute</code>를 갖고, 이는 각 <code>Component</code>를 의미합니다.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib prefix=<span class="string">"tiles"</span> uri=<span class="string">"http://tiles.apache.org/tags-tiles"</span>%&gt;</span><br><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span> pageEncoding=<span class="string">"UTF-8"</span>%&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span><br><span class="line">  &lt;title&gt;&lt;tiles:insertAttribute name="title"/&gt;&lt;/title&gt;</span><br><span class="line">  &lt;link href=<span class="string">"/node_modules/bootstrap/dist/css/bootstrap.min.css"</span> rel=<span class="string">"stylesheet"</span> /&gt;</span><br><span class="line">  &lt;script src="/node_modules/jquery/dist/jquery.min.js"&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;tiles:insertAttribute name=<span class="string">"content"</span>/&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>기본적인 content의 attribute를 지정하고, 그 attribute에 원하는 값을 넣어주는 것이 가능합니다. attribute는 String 문자열 또는 jsp 파일이 될 수 있습니다.  이러한 attribute와 view name을 설정하기 위해서 tiles는 설정 xml을 가지게 되는데, 이 xml은 다음과 같이 구성될 수 있습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE tiles-definitions PUBLIC</span></span><br><span class="line"><span class="meta">       "-//Apache Software Foundation//DTD Tiles Configuration 3.0//EN"</span></span><br><span class="line"><span class="meta">       "http://tiles.apache.org/dtds/tiles-config_3_0.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tiles-definitions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">definition</span> <span class="attr">name</span>=<span class="string">"main-layout"</span> <span class="attr">template</span>=<span class="string">"/WEB-INF/tiles/layouts/main-layout.jsp"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">put-attribute</span> <span class="attr">name</span>=<span class="string">"title"</span> <span class="attr">value</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">put-attribute</span> <span class="attr">name</span>=<span class="string">"content"</span> <span class="attr">value</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">definition</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">definition</span> <span class="attr">name</span>=<span class="string">"book/list"</span> <span class="attr">extends</span>=<span class="string">"main-layout"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">put-attribute</span> <span class="attr">name</span>=<span class="string">"title"</span> <span class="attr">value</span>=<span class="string">"BOOK LIST"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">put-attribute</span> <span class="attr">name</span>=<span class="string">"content"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/tiles/book/list.jsp"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">definition</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">definition</span> <span class="attr">name</span>=<span class="string">"book/add"</span> <span class="attr">extends</span>=<span class="string">"main-layout"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">put-attribute</span> <span class="attr">name</span>=<span class="string">"title"</span> <span class="attr">value</span>=<span class="string">"Add BOOK"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">put-attribute</span> <span class="attr">name</span>=<span class="string">"content"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/tiles/book/add.jsp"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">definition</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tiles-definitions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>여기서 각각의 definition name은 ModelAndView의 view name으로 이용됩니다. extends로 선언된 View를 Template로 이용하고, 각각의 View의 조각(tile)을 붙이는 형식으로 사용할 수 있습니다.</p>
<p>여기에서 사용될 <code>book/list.jsp</code> 내용은 다음과 같이 구성될 수 있습니다.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;table <span class="class"><span class="keyword">class</span></span>=<span class="string">"table table-striped table-bordered table-hover"</span>&gt;</span><br><span class="line">        &lt;thead&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;th&gt;이름&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;상태&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;저자&lt;/th&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/thead&gt;</span><br><span class="line"></span><br><span class="line">        &lt;tbody&gt;</span><br><span class="line">            &lt;c:forEach var=<span class="string">"book"</span> items=<span class="string">"$&#123;books&#125;"</span>&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;td&gt;$&#123;book.name&#125;&lt;/td&gt;</span><br><span class="line">                    &lt;c:set var=<span class="string">"status"</span> value=<span class="string">"일반"</span> /&gt;</span><br><span class="line">                    &lt;c:choose&gt;</span><br><span class="line">                        &lt;c:when test=<span class="string">"$&#123;book.status eq 'NORMAL'&#125;"</span>&gt;</span><br><span class="line">                            &lt;c:set var=<span class="string">"status"</span> value=<span class="string">"일반"</span> /&gt;</span><br><span class="line">                        &lt;/c:when&gt;</span><br><span class="line">                        &lt;c:when test=<span class="string">"$&#123;book.status eq 'RENTNOW'&#125;"</span>&gt;</span><br><span class="line">                            &lt;c:set var=<span class="string">"status"</span> value=<span class="string">"대여중"</span> /&gt;</span><br><span class="line">                        &lt;/c:when&gt;</span><br><span class="line">                        &lt;c:otherwise&gt;</span><br><span class="line">                            &lt;c:set var=<span class="string">"status"</span> value=<span class="string">"분실중"</span> /&gt;</span><br><span class="line">                        &lt;/c:otherwise&gt;</span><br><span class="line">                    &lt;/c:choose&gt;</span><br><span class="line">                    &lt;td&gt;$&#123;status &#125;&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;$&#123;book.author&#125;&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">            &lt;/c:forEach&gt;</span><br><span class="line">        &lt;/tbody&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>단순한 HTML의 경우에는 차이가 크지 않지만, HTML이 커질수록 관리면에서 매우큰 장점을 가지고 있습니다.<br><code>tiles</code>를 사용하기 위한 <code>dependency</code>와 <code>@Configuration</code>은 다음과 같습니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.apache.tiles'</span>, <span class="string">name:</span> <span class="string">'tiles-jsp'</span>, <span class="string">version:</span> <span class="string">'3.0.8'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TilesConfigurer <span class="title">tilesConfigurer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TilesConfigurer tilesConfigurer = <span class="keyword">new</span> TilesConfigurer();</span><br><span class="line">    tilesConfigurer.setDefinitions(<span class="string">"/WEB-INF/tiles-configs.xml"</span>);</span><br><span class="line">    <span class="keyword">return</span> tilesConfigurer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TilesViewResolver <span class="title">tilesViewResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TilesViewResolver tilesViewResolver = <span class="keyword">new</span> TilesViewResolver();</span><br><span class="line">    tilesViewResolver.setOrder(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> tilesViewResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="또다른-View-Template-Engine-들"><a href="#또다른-View-Template-Engine-들" class="headerlink" title="또다른 View Template Engine 들.."></a>또다른 View Template Engine 들..</h3><p><code>Sitemesh</code>, <code>thymeleaf</code>, <code>Velocity</code>, <code>Pebble</code> 등의 다양한 <code>View Template Engine</code>이 있습니다.<br>프로젝트를 시작할 때, 어떤 것이 가장 좋은지 비교해보는 노력이 필요합니다.</p>
<p>예전에는 <code>View Template Engine</code>간의 속도차가 분명히 존재했습니다. 그러나, 지금 <code>java</code> 버젼이 높아진 상태에서는 <code>View Template Engine</code>의 속도는 거의 차이가 없습니다. 그러나 <code>java 6</code>이전 버젼의 경우에는 몇몇 <code>View Template</code>간의 속도차가 분명히 존재합니다.</p>
<p>개발자들의 숙련도와 가장 쉬운것이 뭘지를 고민해서 처리하는 것이 좋습니다.</p>
<h2 id="View의-표현법-none-HTML"><a href="#View의-표현법-none-HTML" class="headerlink" title="View의 표현법 - none HTML"></a>View의 표현법 - none HTML</h2><p>우리가 일반적으로 보는 브라우져 이외의 방법들로 보여지는 방법입니다. 그럼 다른 타입의 View는 어떤 것들이 있을까요?<br>먼저, File(excel, pdf) download가 있습니다. 그리고, 최근에는 json 형태로 객체를 표현하여 <code>API</code>를 제공하는 것 역시 <code>View</code>를 통해서 진행됩니다.</p>
<h3 id="Excel"><a href="#Excel" class="headerlink" title="Excel"></a>Excel</h3><p><code>Spring</code>에서는 Excel File을 위해 <code>Apache POI</code>를 이용합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.apache.poi'</span>, <span class="string">name:</span> <span class="string">'poi'</span>, <span class="string">version:</span> <span class="string">'3.17'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.apache.poi'</span>, <span class="string">name:</span> <span class="string">'poi-ooxml'</span>, <span class="string">version:</span> <span class="string">'3.17'</span></span><br></pre></td></tr></table></figure>
<p>Excel 파일을 생성하기 위해서, Spring에서는 <code>AbstractXlsxView</code>를 제공합니다. 선언은 다음과 같이 구성되어 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractXlsxView</span> <span class="keyword">extends</span> <span class="title">AbstractXlsView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractXlsxView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        setContentType(<span class="string">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Workbook <span class="title">createWorkbook</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> XSSFWorkbook();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 이 class를 상속받아 다음과 같이 구성이 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookListExcelView</span> <span class="keyword">extends</span> <span class="title">AbstractXlsxView</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">buildExcelDocument</span><span class="params">(Map&lt;String, Object&gt; model, Workbook workbook,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SimpleDateFormat fileFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd"</span>);</span><br><span class="line">        String fileName = <span class="string">"책리스트"</span> + <span class="string">"-"</span> + fileFormat.format(<span class="keyword">new</span> Date()) + <span class="string">".xlsx"</span>;</span><br><span class="line">        response.setHeader(<span class="string">"Content-Disposition"</span>, String.format(<span class="string">"attachment; filename=\"%s\""</span>, fileName));</span><br><span class="line">        Sheet sheet = workbook.createSheet(<span class="string">"책목록"</span>);</span><br><span class="line"></span><br><span class="line">        Row header = sheet.createRow(<span class="number">0</span>);</span><br><span class="line">        header.createCell(<span class="number">0</span>).setCellValue(<span class="string">"이름"</span>);</span><br><span class="line">        header.createCell(<span class="number">1</span>).setCellValue(<span class="string">"저자"</span>);</span><br><span class="line">        header.createCell(<span class="number">2</span>).setCellValue(<span class="string">"상태"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        List&lt;Book&gt; books = (List&lt;Book&gt;) model.get(<span class="string">"books"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> row = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (Book book : books) &#123;</span><br><span class="line">            Row rowCell = sheet.createRow(row);</span><br><span class="line">            rowCell.createCell(<span class="number">0</span>).setCellValue(book.getName());</span><br><span class="line">            rowCell.createCell(<span class="number">1</span>).setCellValue(book.getAuthor());</span><br><span class="line">            rowCell.createCell(<span class="number">2</span>).setCellValue(book.getStatus());</span><br><span class="line">            row++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 구성된 <code>View</code>를 <code>Controller</code>에서 다음과 같이 사용할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BookListExcelView bookListExcelView;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookController</span><span class="params">(BookListExcelView bookListExcelView)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bookListExcelView = bookListExcelView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/book/excel"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getBookExcel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Book&gt; books = getBooks();</span><br><span class="line">        ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView();</span><br><span class="line"></span><br><span class="line">        modelAndView.setView(<span class="keyword">this</span>.bookListExcelView);</span><br><span class="line">        modelAndView.addObject(<span class="string">"books"</span>, books);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>이에 대한 테스트 코드는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getBookExcel</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    MvcResult mvcResult = mockMvc.perform(get(<span class="string">"/book/excel"</span>))</span><br><span class="line">        .andExpect(status().isOk())</span><br><span class="line">        .andExpect(model().attributeExists(<span class="string">"books"</span>))</span><br><span class="line">        .andDo(MockMvcResultHandlers.print())</span><br><span class="line">        .andReturn();</span><br><span class="line">    assertThat(mvcResult.getModelAndView().getView()).isNotNull().isInstanceOf(BookListExcelView.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PDF-using-iText-2-1-7"><a href="#PDF-using-iText-2-1-7" class="headerlink" title="PDF (using iText 2.1.7)"></a>PDF (using iText 2.1.7)</h3><p><code>Spring</code>에서 PDF는 미묘합니다. java에서 가장 많이 사용되고 있는 <code>iText</code>는 <code>2.1.7</code>까지는 <code>MPL</code>정책을 가지고 있으나, 다음 버젼부터는 <code>AGPL</code>을 따르고 있습니다. <code>AGPL</code>은 매우 강력한 <code>License</code> 정책입니다. 이 정책은 이 library가 사용된 product의 전체 코드를 모두 <code>Open Source</code>로 공개해야지 됩니다. 따라서, 일반적인 Solution이나 Service에서 사용할 수 없습니다. 내부내에서 사용되는 Tool 정도로만 사용 가능합니다.</p>
<p>dependency는 다음과 같습니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'com.lowagie'</span>, <span class="string">name:</span> <span class="string">'itext'</span>, <span class="string">version:</span> <span class="string">'2.1.7'</span></span><br></pre></td></tr></table></figure>
<p>그리고, Spring에서 제공하는 <code>AbstractPdfView</code>를 상속받아 다음과 같이 구성하면 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookListITextPdfView</span> <span class="keyword">extends</span> <span class="title">AbstractPdfView</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">buildPdfDocument</span><span class="params">(Map&lt;String, Object&gt; model, Document document, PdfWriter writer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        setFileNameToResponse(request, response, <span class="string">"bookList.pdf"</span>);</span><br><span class="line">        Chapter chapter = <span class="keyword">new</span> Chapter(<span class="keyword">new</span> Paragraph(<span class="string">"this is english"</span>), <span class="number">1</span>);</span><br><span class="line">        chapter.add(<span class="keyword">new</span> Paragraph(<span class="string">"이건 메세지입니다."</span>));</span><br><span class="line">        document.add(chapter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setFileNameToResponse</span><span class="params">(HttpServletRequest request, HttpServletResponse response, String fileName)</span> </span>&#123;</span><br><span class="line">        String userAgent = request.getHeader(<span class="string">"User-Agent"</span>);</span><br><span class="line">        <span class="keyword">if</span> (userAgent != <span class="keyword">null</span> &amp;&amp; userAgent.contains(<span class="string">"MSIE 5.5"</span>)) &#123;</span><br><span class="line">            response.setContentType(<span class="string">"doesn/matter"</span>);</span><br><span class="line">            response.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"filename=\""</span> + fileName + <span class="string">"\""</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            response.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment; filename=\""</span> + fileName + <span class="string">"\""</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이렇게 구성된 <code>View</code>를 이용한 <code>Controller</code> 코드는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/book/itext2/pdf"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getBookPdf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Book&gt; books = getBooks();</span><br><span class="line">    ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView();</span><br><span class="line"></span><br><span class="line">    modelAndView.setView(<span class="keyword">this</span>.bookListPdfView);</span><br><span class="line">    modelAndView.addObject(<span class="string">"books"</span>, books);</span><br><span class="line">    <span class="keyword">return</span> modelAndView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위와 같이 구성하고 테스트 코드는 다음과 같이 구성될 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getBookItext2Pdf</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    MvcResult mvcResult = mockMvc.perform(get(<span class="string">"/book/itext2/pdf"</span>))</span><br><span class="line">        .andExpect(status().isOk())</span><br><span class="line">        .andExpect(model().attributeExists(<span class="string">"books"</span>))</span><br><span class="line">        .andDo(MockMvcResultHandlers.print())</span><br><span class="line">        .andReturn();</span><br><span class="line">    assertThat(mvcResult.getModelAndView().getView()).isNotNull().isInstanceOf(BookListITextPdfView.class);</span><br><span class="line">    Files.write(Paths.get(<span class="string">"sample.pdf"</span>), mvcResult.getResponse().getContentAsByteArray());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>마지막 라인의 경우, response를 파일로 저장시켜 완성된 pdf 파일을 확인할 수 있습니다. 그런데, 위 결과를 보시면 한글 메세지가 표시되지 않는 것을 확인할 수 있습니다. <code>iText2</code>의 경우, 한글 font가 정상적으로 들어가 있지 않습니다. 한글 메세지를 보기위해서는 다음과 같은 절차가 더 필요합니다.</p>
<p>먼저, 다음 url에서 <code>iTextAsian.jar</code>를 다운 받습니다.</p>
<p><code>http://sourceforge.net/project/showfiles.php?group_id=15255</code></p>
<p>다운받은 <code>jar</code>를 <code>mavenLocal</code> 또는 <code>nexus</code>와 같은 <code>repository storage</code>에 넣어줍니다.<br><code>localMaven()</code>의 경우 다음과 같이 넣어줄 수 있습니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn install:install-file -DgroupId=com.lowagie -DartifactId=itextasian -Dversion=1.0 -Dpackaging=jar -Dfile=/Users/secucen/Downloads/iTextAsian.jar</span><br></pre></td></tr></table></figure>
<p>그리고 <code>dependency</code>를 다음과 같이 수정하면 <code>localMaven</code>에서 위 jar를 참고해서 사용할 수 있습니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">    mavenLocal()</span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    .....</span><br><span class="line">    compile <span class="string">'com.lowagie:itextasian:1.0'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 <code>Font</code>를 사용하도록 코드를 수정합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">buildPdfDocument</span><span class="params">(Map&lt;String, Object&gt; model, Document document, PdfWriter writer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    setFileNameToResponse(request, response, <span class="string">"bookList.pdf"</span>);</span><br><span class="line">    BaseFont objBaseFont = BaseFont.createFont(<span class="string">"HYGoThic-Medium"</span>, <span class="string">"UniKS-UCS2-H"</span>, <span class="keyword">false</span>);</span><br><span class="line">    Font objFont = <span class="keyword">new</span> Font(objBaseFont, <span class="number">12</span>);</span><br><span class="line">    Chapter chapter = <span class="keyword">new</span> Chapter(<span class="keyword">new</span> Paragraph(<span class="string">"this is english"</span>), <span class="number">1</span>);</span><br><span class="line">    chapter.add(<span class="keyword">new</span> Paragraph(<span class="string">"이건 메세지입니다."</span>, objFont));</span><br><span class="line">    document.add(chapter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 한글을 정상적으로 표시할 수 있습니다.</p>
<h3 id="PDF-using-iText-5-higher"><a href="#PDF-using-iText-5-higher" class="headerlink" title="PDF (using iText 5 higher)"></a>PDF (using iText 5 higher)</h3><p>최근에 나온 <code>iText</code>는 모두 <code>APGA</code>라는 매우 강력한 라이센스 정책을 가지고 있습니다. 이 정책의 경우에는 만든 제품의 코드를 공개하지 않으면 안됩니다. 외부에 알려지면 매우 곤란한 일이 발생할 수 있습니다. 그리고 <code>Spring</code>에서 기본적으로 지원하고 있지는 않습니다. 그렇지만, 우리는 기존 <code>AbstractPdfView</code>를 기반으로 해서 새로운 <code>AbstractView</code>를 만들어낼 수 있습니다. 다음과 같이 구성해보도록 하겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractIText5PdfView</span> <span class="keyword">extends</span> <span class="title">AbstractView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbstractIText5PdfView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        setContentType(<span class="string">"application/pdf"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">generatesDownloadContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">renderMergedOutputModel</span><span class="params">(Map&lt;String, Object&gt; model, HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                 HttpServletResponse response)</span> <span class="keyword">throws</span> Exception  </span>&#123;</span><br><span class="line">        ByteArrayOutputStream baos = createTemporaryOutputStream();</span><br><span class="line"></span><br><span class="line">        Document document = <span class="keyword">new</span> Document(PageSize.A4.rotate(), <span class="number">36</span>, <span class="number">36</span>, <span class="number">54</span>, <span class="number">36</span>);</span><br><span class="line">        PdfWriter writer = PdfWriter.getInstance(document, baos);</span><br><span class="line">        prepareWriter(model, writer, request);</span><br><span class="line">        buildPdfMetadata(model, document, request);</span><br><span class="line"></span><br><span class="line">        document.open();</span><br><span class="line">        buildPdfDocument(model, document, writer, request, response);</span><br><span class="line">        document.close();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// make browser to ask for download/display</span></span><br><span class="line">        response.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment"</span>);</span><br><span class="line">        writeToResponse(response, baos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareWriter</span><span class="params">(Map&lt;String, Object&gt; model, PdfWriter writer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 HttpServletRequest request)</span> <span class="keyword">throws</span> DocumentException </span>&#123;</span><br><span class="line">        writer.setViewerPreferences(getViewerPreferences());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getViewerPreferences</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PdfWriter.ALLOW_PRINTING | PdfWriter.PageLayoutSinglePage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildPdfMetadata</span><span class="params">(Map&lt;String, Object&gt; model, Document document, HttpServletRequest request)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">buildPdfDocument</span><span class="params">(Map&lt;String, Object&gt; model, Document document, PdfWriter writer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h3><p>JSON (JavaScript Object Notation)은 경량의 <code>DATA-교환형식</code>이다. 이 형식은 사람이 읽고 쓰기에 용이하며, 기계가 분석하고 생성함에도 용이합니다. JavaScript Programming Language, Standard ECMA-262 3rd Edition - December 1999의 일부에 토대를 두고 있습니다. JSON은 완벽하게 언어로 부터 독립적이지만 C-family 언어 - C, C++, C#, Java, JavaScript, Perl, Python 그외 다수 - 의 프로그래머들에게 친숙한 관습을 사용하는 텍스트 형식을 가지고 있습니다.</p>
<p>JSON은 두개의 구조를 기본으로 가지고 있습니다.</p>
<ul>
<li>name/value 형태의 쌍으로 collection 타입. 다양한 언어들에서, 이는 object, record, struct(구조체), dictionary, hash table, 키가 있는 list, 또는 연상배열로서 구현되었습니다.</li>
<li>값들의 순서화된 리스트. 대부분의 언어들에서, 이는 array, vector, list, 또는 sequence로서 구현되었습니다.</li>
</ul>
<p><code>DATA-교환형식</code>으로서의 <code>JSON</code>은 오늘날의 개발에서 매우 중요한 역활을 가지고 있습니다. 단순히 <code>frontend-backend</code>간의 데이터 교환뿐이 아니라 mongoDb, mySQL의 경우 기본 데이터 형식으로 <code>JSON</code>을 가지고 있습니다.</p>
<p>Spring에서는 JSON을 View로 사용하기 위해서는 다음과 같은 dependency가 필요합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'com.fasterxml.jackson.core'</span>, <span class="string">name:</span> <span class="string">'jackson-databind'</span>, <span class="string">version:</span> <span class="string">'2.9.4'</span></span><br></pre></td></tr></table></figure>
<p>Spring에서는 <code>jackson</code>이 포함되어 있고, method에 <code>@ResponseBody</code>가 지정되어 있는 경우에 <code>JSON</code>으로 변경된 return값을 보내줍니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/book/json"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getBookJson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Book&gt; books = getBooks();</span><br><span class="line">    <span class="keyword">return</span> books;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getBookJson</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    MvcResult mvcResult = mockMvc.perform(get(<span class="string">"/book/json"</span>))</span><br><span class="line">        .andDo(print())</span><br><span class="line">        .andExpect(status().isOk())</span><br><span class="line">        .andReturn();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MockHttpServletResponse:</span><br><span class="line">           Status = 200</span><br><span class="line">    Error message = null</span><br><span class="line">          Headers = &#123;Content-Type=[application/json;charset=UTF-8]&#125;</span><br><span class="line">     Content <span class="built_in">type</span> = application/json;charset=UTF-8</span><br><span class="line">             Body = [&#123;<span class="string">"name"</span>:<span class="string">"책0"</span>,<span class="string">"author"</span>:<span class="string">"저자0"</span>,<span class="string">"status"</span>:<span class="string">"NORMAL"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"책1"</span>,<span class="string">"author"</span>:<span class="string">"저자1"</span>,<span class="string">"status"</span>:<span class="string">"NORMAL"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"책2"</span>,<span class="string">"author"</span>:<span class="string">"저자2"</span>,<span class="string">"status"</span>:<span class="string">"NORMAL"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"책3"</span>,<span class="string">"author"</span>:<span class="string">"저자3"</span>,<span class="string">"status"</span>:<span class="string">"NORMAL"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"책4"</span>,<span class="string">"author"</span>:<span class="string">"저자4"</span>,<span class="string">"status"</span>:<span class="string">"NORMAL"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"책5"</span>,<span class="string">"author"</span>:<span class="string">"저자5"</span>,<span class="string">"status"</span>:<span class="string">"NORMAL"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"책6"</span>,<span class="string">"author"</span>:<span class="string">"저자6"</span>,<span class="string">"status"</span>:<span class="string">"RENTNOW"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"책7"</span>,<span class="string">"author"</span>:<span class="string">"저자7"</span>,<span class="string">"status"</span>:<span class="string">"RENTNOW"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"책8"</span>,<span class="string">"author"</span>:<span class="string">"저자8"</span>,<span class="string">"status"</span>:<span class="string">"NORMAL"</span>&#125;,&#123;<span class="string">"name"</span>:<span class="string">"책9"</span>,<span class="string">"author"</span>:<span class="string">"저자9"</span>,<span class="string">"status"</span>:<span class="string">"NORMAL"</span>&#125;]</span><br><span class="line">    Forwarded URL = null</span><br><span class="line">   Redirected URL = null</span><br><span class="line">          Cookies = []</span><br></pre></td></tr></table></figure>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>Spring은 다양한 View를 제공합니다. 크게 두가지 타입으로 나눈다면 <code>HTML형태로 보여지는 View</code>와 <code>특별한 형태로 변환되는 View</code>로 볼 수 있습니다.<br><code>HTML형태로 보여지는 View</code>는 다양한 View Engine을 이용할 수 있습니다. View Engine 종류로는 <code>tiles</code>, <code>velocity</code>, <code>freemarker</code>를 주로 사용합니다. 여담으로 회사내부에서는 <code>sitemash</code>를 사용하고 있습니다.<br><code>특별한 형태로 변환되는 View</code>는 매우 다양한 형태로 데이터를 표현하는 방식입니다. pdf, excel, json 등 다양한 데이터 형태를 제공하고 있습니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/spring-view-controller-pdf-json/">spring, view, controller, pdf, json</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/03/28/spring-mvc-structure/"><span>14. Spring MVC의 구조</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/03/28/spring-mvc-structure/" rel="bookmark">
        <time class="entry-date published" datetime="2018-03-27T23:19:24.000Z">
          2018-03-28
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="Spring-MVC의-구조"><a href="#Spring-MVC의-구조" class="headerlink" title="Spring MVC의 구조"></a>Spring MVC의 구조</h1><p>지금까지 Spring을 이용한 DB에 대한 접근법과 다루는 법에 대해서 알아보았습니다. 엄밀히 말하면 이 부분은 MVC pattern의 M에 해당되는 내용들입니다. Spring은 구조화된 MVC 구조를 제공하며, Layer 기반의 잘 정형화된 서비스 패턴을 제공합니다. Spring은 MVC를 기반으로 하는 Web Framework를 제공하고 이는 org.springframework.web 안에 제공되어 있습니다.<br>이제부터 사용할 package인 org.springframework.web에서는 C와 V에 대한 내용들을 다루고 있습니다.</p>
<h2 id="Spring-MVC-동작-모델"><a href="#Spring-MVC-동작-모델" class="headerlink" title="Spring MVC 동작 모델"></a>Spring MVC 동작 모델</h2><p><img src="/images/14/01.jpg" alt=""></p>
<h3 id="Front-Controller"><a href="#Front-Controller" class="headerlink" title="Front Controller"></a>Front Controller</h3><p>기존 servlet application 작성시에, url에 각각의 servlet을 등록해서 사용하는 것을 알고 있습니다. 일반적인 MVC 구조의 Web Application은 <code>Front Controller pattern</code>이라고 해서, 가장 최 상단 <code>FrontController</code>가 모든 Web의 Request를 처리합니다. 그리고, 처리된 Request에 따라 맞는 Controller를 찾아서 호출해주는 형식입니다.</p>
<p>Spring에서는 <code>org.springframework.web.servlet.DispatcherServlet</code>에서 <code>FrontController</code>를 담당합니다. 참고로, .NET에서는 ASP .NET MVC에서는 <code>ControllerFactory</code>가 이 일을 합니다.</p>
<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><p><code>org.springframework.web.servlet.DispatcherServlet</code>에서 처리된 request가 전달되는 영역입니다. 여기에서 HTML의 경우, 화면에 보여줄 model을 생성 하고, 또는 REST API의 경우에는 전달될 객체를 결정하게 됩니다.</p>
<p>간단하게 말해서, Controller는 URL과 상호동작하는 Class입니다.<br>/wpwoms/appuser/getshoplist 라는 URL이 호출되었을 때, Http Request가 연결되는 Class를 의미합니다.<br>기술적으로는 굉장히 어려운 영역입니다. 이는 Servlet container의 Http Request가 어떻게 해석이 되며, 이 해석된 Http Request에 따라 어떤 class의 어떤 method를 선택할 지에 대한 복잡한 연결을 계속해서 이어가야지 됩니다.<br>Controller는 기본적으로 다음과 같은 일을 합니다.</p>
<ul>
<li>Servlet이 넘겨주는 HttpServletRequest를 처리한다.</li>
<li>Servlet으로 HttpServletResponse를 보내준다.</li>
<li>Cookie, Session 에 대한 동기화 작업을 지원한다.</li>
</ul>
<h3 id="View"><a href="#View" class="headerlink" title="View"></a>View</h3><p>사용자, Client에게 전달될 내용입니다. Html이 될 수도 있고, JSON이 될 수도 있고, Excel File이 될 수도 있습니다.<br>어찌보면 단순한 영역일수도 있지만… 이 부분이 어마어마한 노가다를 요구하는 부분입니다. ㅠ-ㅠ<br>View는 Controller가 보내주는 데이터를 정해진 포멧으로 변경하여 표현하는 영역이라고 생각하면 됩니다. 일반적으로 <code>HTML</code>, <code>JSON</code>, <code>FILE</code> 등이 있습니다.</p>
<h3 id="model"><a href="#model" class="headerlink" title="model"></a>model</h3><p>MVC에서의 M과는 다른 개념입니다. 기존 MVC에서의 Model은 BL 또는 Persistance Layer의 각 model 또는 entity를 의미하지만, 이곳의 model은 View Model입니다. View에 표시되는 model은 Controller에서 작성이 되는 경우도 있고, Domain Model에서 넘겨온 값을 그대로 이용하는 경우도 있습니다. 기존에 Application의 데이터 흐름에서 이야기한 DTO, VO가 여기에 속하게 됩니다.</p>
<h2 id="Spring-MVC-Web-Request-Process"><a href="#Spring-MVC-Web-Request-Process" class="headerlink" title="Spring MVC Web Request Process"></a>Spring MVC Web Request Process</h2><p>Spring MVC는 Web Request를 다음과 같은 순서로 처리되게 됩니다.</p>
<p><img src="/images/14/02.gif" alt=""></p>
<ul>
<li>Request -&gt; DispatcherServlet : Request가 처음 들어오게 됩니다.</li>
<li>DispatcherServlet -&gt; Handler Mapping : DispatcherServlet은 Request를 분석하고 Mapping 중에서 Request와 동일한 Mapping을 찾아냅니다.</li>
<li>Handler Mapping -&gt; DispatcherServlet : 찾아진 Handler Mapping을 DispatcherServlet에 전달해줍니다.</li>
<li>DispatcherServlet -&gt; Controller : Handler Mapping에서 찾아진 Controller측에 Http Request를 전달해줍니다.</li>
<li>Controller -&gt; DispatcherServlet : ModelAndView 객체를 보내줍니다. ModelAndView객체는 View의 이름과 View에 표시될 데이터를 가지고 있습니다.</li>
<li>DispatcherServlet -&gt; View Resolver : View이름을 가지고 View를 처리하는 View Resolver에 ViewName을 전달합니다.</li>
<li>View Resolver -&gt; DispatcherServlet : 이름에 맞는 View를 return 시켜줍니다.</li>
<li>DispatcherServlet -&gt; View : View에 표시될 데이터를 가지고 있는 model을 보내줍니다.</li>
<li>View -&gt; DispatcherServlet : model을 이용해서 View를 render 시키고, 그 결과를 DispatcherServlet에 보내줍니다.</li>
<li>DispatcherServlet -&gt; Response : View로부터 받은 render된 결과를 Client에게 보내주게 됩니다.</li>
</ul>
<p>위 그림과 순서는 머리에 익혀두고 있어야지 됩니다. Spring이 우리에게 감춰버리는 부분이기 때문에, 개발을 할때에는 자주 쓰이는 부분이 아니지만 디버그나 문제가 발생했을 때, 어떤 영역에서의 문제인지 확인할 필요가 있을 때 사용되는 지식입니다.</p>
<h2 id="Spring-WebApplication에서의-ApplicationContext의-로드"><a href="#Spring-WebApplication에서의-ApplicationContext의-로드" class="headerlink" title="Spring WebApplication에서의 ApplicationContext의 로드"></a>Spring WebApplication에서의 ApplicationContext의 로드</h2><p>먼저, 기본적인 Spring이 적용된 <code>web.xml</code>을 볼 필요가 있습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns:web</span>=<span class="string">"http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">id</span>=<span class="string">"WebApp_ID"</span> <span class="attr">version</span>=<span class="string">"3.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>mvc.spring01<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>ContextLoader<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.do<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>먼저, listener입니다. web application이 실행될 때, 기본 bean들을 load 하기 위한 listener를 등록합니다. 기본적으로 main/webapp/WEB-INF/applicationContext.xml 파일을 읽어 bean들을 load 시켜줍니다.</p>
<p>다음은 servlet 설정입니다. front controller로 spring 이라는 이름으로 DispatcherServlet을 로드하고 있는 것을 볼 수 있습니다.</p>
<p>마지막으로 servlet-mapping입니다. Servlet이 사용될 url path를 설정합니다. 위 xml에서는 /app/* path에서 DispatcherServlet이 실행됨을 지정하고 있습니다. 그리고, DispatcherServlet가 로드될때, 자동으로 spring-servlet.xml bean 정의를 로드합니다. 이는 DispatcherServlet 내부에서 사용할 child appliation context입니다. 파일 이름은 <code>servlet 이름 + &quot;-servlet.xml&quot;</code> 로 자동 결정됩니다.</p>
<p>따라서, 위 설정의 경우 src/main/webapp 폴더는 다음과 같이 구성되게 됩니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">├── META-INF</span><br><span class="line">└── WEB-INF</span><br><span class="line">    ├── applicationContext.xml</span><br><span class="line">    ├── spring-servlet.xml</span><br><span class="line">    └── web.xml</span><br></pre></td></tr></table></figure>
<p>지금보시면 applicationContext가 2개가 등록되게 됩니다. 이 구조는 root context - child context 구조입니다. child 끼리는 서로간에 간섭되지 않는 bean들이 등록될 수 있으며, root의 bean들은 child에서 공유하는 구조입니다. 이런 root-child context 구조는 기존에는 spring application context를 사용하지만, web 기술은 spring @MVC를 하지 않고 structure 와 같은 다른 web framework를 사용하는 경우를 지원하기 위해서 만들어진 구조입니다.</p>
<p>그런데 왜 이렇게 2개의 application context를 가지도록 설계가 되어 있을까요? 그 이유는 Spring은 먼저 ApplicationContext를 제공하는 Spring-core와 Spring-Bean으로 시작했기 때문입니다. spring-mvc의 경우에는 후에 추가가 된 것이고, 초기에는 spring-core, spring-bean을 이용한 DI와 AOP만을 이용하고, web기술은 struct 와 같은 다른 web framework를 이용했기 때문입니다. 그래서 두개의 설정이 나뉘게 되었고, 그게 지금까지 고정되어 사용되고 있는 것입니다.</p>
<h2 id="Hello-WebApplicaiton-Spring-old"><a href="#Hello-WebApplicaiton-Spring-old" class="headerlink" title="Hello WebApplicaiton - Spring(old)"></a>Hello WebApplicaiton - Spring(old)</h2><p>기본적으로 <code>web.xml</code> + <code>applicationContext</code>를 이용한 HelloWorld를 만들어보도록 하겠습니다.<br>시작은 <code>gradle init --type=java-application</code>입니다. 후에 ‘build.gradle’을 이렇게 만들어줍니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'java'</span></span><br><span class="line">apply <span class="string">plugin:</span> <span class="string">'war'</span></span><br><span class="line">apply <span class="string">from:</span> <span class="string">'https://raw.github.com/akhikhl/gretty/master/pluginScripts/gretty.plugin'</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    jcenter()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile <span class="string">'com.google.guava:guava:23.0'</span></span><br><span class="line">    providedCompile <span class="string">group:</span> <span class="string">'javax.servlet'</span>, <span class="string">name:</span> <span class="string">'javax.servlet-api'</span>, <span class="string">version:</span> <span class="string">'4.0.0'</span></span><br><span class="line">    compile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-webmvc'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br><span class="line"></span><br><span class="line">  	testCompile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-test'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br><span class="line">    testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line">    testCompile <span class="string">group:</span> <span class="string">'org.assertj'</span>, <span class="string">name:</span> <span class="string">'assertj-core'</span>, <span class="string">version:</span> <span class="string">'3.9.0'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gretty &#123;</span><br><span class="line">	contextPath = <span class="string">'/'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Controller를 만들어줍니다. 위에 설명드린것처럼, HttpRequest를 처리하는 영역입니다. Spring에서는 <code>org.springframework.web.servlet.mvc.Controller</code>라는 interface를 제공하고 있으며, 이는 <code>HttpServlet</code>과 거의 유사한 기능을 제공합니다. 다음은 <code>Controller</code> 코드입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> <span class="keyword">implements</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">handleRequest</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String name = request.getParameter(<span class="string">"name"</span>);</span><br><span class="line">        String message = <span class="string">"이름이 입력되지 않았습니다."</span>;</span><br><span class="line">        <span class="keyword">if</span> (!Strings.isNullOrEmpty(name)) &#123;</span><br><span class="line">            message = <span class="string">"Hello World!! "</span> + name;</span><br><span class="line">        &#125;</span><br><span class="line">        ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        modelAndView.addObject(<span class="string">"message"</span>, message);</span><br><span class="line">        modelAndView.setViewName(<span class="string">"hello"</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 <code>spring-servlet.xml</code>에 bean들을 등록시켜줘야지 됩니다. <code>applicationContext.xml</code>이 아닌, <code>spring-servlet.xml</code>에 등록시켜야지 된다는 것을 잊지 말아주세요.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-3.2.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"/hello.do"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.web.controller.HomeController"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp/"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>아래 정의된 <code>InternalResourceViewResolver</code>는 추후에 다시 설명하도록 하겠습니다. 지금은 pass 하시지요.<br>이제 controller에서 사용할 jsp 파일을 넣어줍니다. jsp 파일의 위치는 <code>/webapp/WEB-INF/jsp/hello.jsp</code>입니다.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;$&#123;message&#125;&lt;/h1&gt;</span><br></pre></td></tr></table></figure>
<p>이제 마지막으로 rootContext가 될 <code>applicationContext.xml</code>파일을 넣어줍니다. 내용은 다음과 같습니다. 공통 Bean이 하나도 없기 때문에 xml 선언만 들어갑니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">     <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">     <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag">     <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-3.2.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>최종적으로 구성된 <code>webapp</code>의 폴더구조입니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── META-INF</span><br><span class="line">└── WEB-INF</span><br><span class="line">    ├── applicationContext.xml</span><br><span class="line">    ├── jsp</span><br><span class="line">    │   └── hello.jsp</span><br><span class="line">    ├── spring-servlet.xml</span><br><span class="line">    └── web.xml</span><br></pre></td></tr></table></figure>
<p>이제 <code>gradle appRun</code>을 실행시키고, <code>http://localhost:8080/hello.do</code>를 열면 다음과 같은 화면을 보실 수 있습니다.</p>
<p><img src="/images/14/04.png" alt=""></p>
<p>자. 지금까지 옛날 방식의 Spring MVC의 기본 페이지 작성법을 따라가봤습니다. 특이할 점은 딱 하나입니다. <code>spring-servlet.xml</code>파일의 정의입니다. 그리고, 그 중에서 아래 한줄입니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"/hello.do"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.web.controller.HomeController"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>bean을 name으로 정의하고, 그 name이 url과 1:1로 mapping 됩니다. 특이하게 <code>name</code>속성으로 binding하는 것을 주의하면 어려울 것이 없습니다.</p>
<p>여기까지 진행한 후, 다시 이 그림을 보도록 하겠습니다.</p>
<p><img src="/images/14/02.gif" alt=""></p>
<table>
<thead>
<tr>
<th>단계</th>
<th>code</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td>step01</td>
<td>spring-servlet.xml</td>
<td><code>spring-servlet.xml</code>에 지정된 request url과 controller의 matching</td>
</tr>
<tr>
<td>step02</td>
<td>HomeController</td>
<td>controller코드 실행, <code>ModelAndView</code> 반환</td>
</tr>
<tr>
<td>step03</td>
<td>InternalResourceViewResolver</td>
<td><code>ModelAndView</code>의 ViewName을 이용해서 <code>/WEB-INF/jsp/hello.jsp</code>를 반환</td>
</tr>
<tr>
<td>step04</td>
<td>InternalResourceViewResolver</td>
<td><code>View</code>와 <code>Model</code>을 결합시켜 <code>HTML</code>을 만들어서 <code>Response</code>로 보내줌</td>
</tr>
</tbody>
</table>
<h2 id="테스트-WebApplicaiton"><a href="#테스트-WebApplicaiton" class="headerlink" title="테스트 WebApplicaiton"></a>테스트 WebApplicaiton</h2><p>이와같은 web application의 테스트는 어떻게 해야지 될까요? 지금까지 web을 만들고 테스트 하는 것은 web server를 실행시키고, web server의 url을 직접 타이핑을 하던가, 아니면 link를 click-click 해가면서 손으로 테스트를 했습니다. 그런데 이런 테스트 방법은 매우 시간이 많이 걸리고, 개발자들을 불편하게 합니다.<br>이제 다시 한번 테스트를 어떤것을 해야지 되는지 확인해보도록 합시다. 먼저, 지금 HelloController는 /hello.do url로 접근이 가능한지 확인해야지 됩니다. 그리고 Model에 message가 들어있는지 확인되어야지 됩니다. 마지막으로 message가 원하는 값인 Hello + input 임을 확인할 수 있어야지 됩니다.</p>
<p>정리해보겠습니다.  우리가 Controller에서 테스트할 내용은 다음과 같습니다.</p>
<ul>
<li>원하는 url로 접근이 가능한지.</li>
<li>return되는 Model에 필요한 값이 존재하는지.</li>
<li>return된 Model의 값이 원하는 값으로 나오는지 확인</li>
</ul>
<p>이 3가지가 되면 Controller는 테스트가 가능합니다. 그리고 View는 Controller에 의해서 나온 값을 보여주는 영역이기 때문에 특별히 테스트를 하지 않습니다. 최종적으로 View영역도 HTML의 테스트를 하는 것이 필요하지만, 이 부분은 지금 영역을 넘어가기 때문에 다루지 않도록 하겠습니다.<br>이러한 테스트 방법으로 spring은 멋진 솔루션을 제공합니다. Controller에 대한 단위 테스트 코드를 작성하도록 하겠습니다.</p>
<p>다음은 전체 테스트 코드입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(&#123;</span><br><span class="line">    <span class="string">"file:src/main/webapp/WEB-INF/applicationContext.xml"</span>,</span><br><span class="line">    <span class="string">"file:src/main/webapp/WEB-INF/spring-servlet.xml"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@WebAppConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeControllerTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebApplicationContext webApplicationContext;</span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mockMvc = MockMvcBuilders.webAppContextSetup(webApplicationContext).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">helloWithoutNameTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        MvcResult mvcResult = mockMvc.perform(get(<span class="string">"/hello.do"</span>))</span><br><span class="line">                                     .andExpect(status().isOk())</span><br><span class="line">                                     .andReturn();</span><br><span class="line">        ModelAndView modelAndView = mvcResult.getModelAndView();</span><br><span class="line">        assertThat(modelAndView.getViewName()).isEqualTo(<span class="string">"hello"</span>);</span><br><span class="line">        assertThat(modelAndView.getModel().containsKey(<span class="string">"message"</span>)).isTrue();</span><br><span class="line">        assertThat(modelAndView.getModel().get(<span class="string">"message"</span>)).isEqualTo(<span class="string">"이름이 입력되지 않았습니다."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">helloWithNameTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        MvcResult mvcResult = mockMvc.perform(get(<span class="string">"/hello.do"</span>).param(<span class="string">"name"</span>, <span class="string">"윤영권"</span>))</span><br><span class="line">            .andExpect(status().isOk())</span><br><span class="line">            .andReturn();</span><br><span class="line">        ModelAndView modelAndView = mvcResult.getModelAndView();</span><br><span class="line">        assertThat(modelAndView.getViewName()).isEqualTo(<span class="string">"hello"</span>);</span><br><span class="line">        assertThat(modelAndView.getModel().containsKey(<span class="string">"message"</span>)).isTrue();</span><br><span class="line">        assertThat(modelAndView.getModel().get(<span class="string">"message"</span>)).isEqualTo(<span class="string">"Hello World!! 윤영권"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>test code 살펴보면 다음과 같습니다.</p>
<p>먼저 MockMvc라는 servlet container를 가상으로 Spring 내부에서 만들어줍니다. 만들어지는 객체는 tomcat이나 jetty와 동일하게 움직입니다.</p>
<p>mvc.perform method를 통해서 url을 기반으로 접근이 됩니다. 그리고, status값이 200이 나오는지 확인을 하는 구조로 만들어집니다.<br>마지막으로 andReturn을 통해서 Model 과 View값을 얻어내 접근이 가능합니다. 이런 테스트 코드를 이용해서 우리가 만든 Controller가 정상적으로 움직이는지 확인이 가능합니다.</p>
<h2 id="Hello-Application-current"><a href="#Hello-Application-current" class="headerlink" title="Hello Application (current)"></a>Hello Application (current)</h2><p>지금까지 만든 코드는 Spring 2.x 대에서 Controller를 만드는 방법입니다.<br>지금까지 구현해본 코드의 문제점은 다음과 같습니다.</p>
<ul>
<li>특정 interface를 반드시 상속받는 형태여야지 된다.</li>
<li>bean name을 이용한 method - url mapping이 된다.</li>
<li>POST/GET/DELTE/PUT/HEAD 와 같은 http method에 적합하지 않다.</li>
<li>url 당 1개의 Controller 객체가 생성되기 때문에 Enterprise 개발에 적합하지 않다.</li>
</ul>
<p>기존에 Controller Interface를 구현해야지 되었으나, 3.0대의 @MVC는 annotation을 이용해서 @Controller로 객체의 meta 정보를 적는 것으로 해결이 가능합니다.</p>
<p>다음과 같은 코드로 기존과 동일한 Controller가 구현 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/hello.do"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getHello</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String name = request.getParameter(<span class="string">"name"</span>);</span><br><span class="line">        String message = <span class="string">"이름이 입력되지 않았습니다."</span>;</span><br><span class="line">        <span class="keyword">if</span> (!Strings.isNullOrEmpty(name)) &#123;</span><br><span class="line">            message = <span class="string">"Hello World!! "</span> + name;</span><br><span class="line">        &#125;</span><br><span class="line">        ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        modelAndView.addObject(<span class="string">"message"</span>, message);</span><br><span class="line">        modelAndView.setViewName(<span class="string">"hello"</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>URL을 <code>spring-servlet.xml</code>에 정의된 내용들을 변경시켜줘야지 됩니다. <code>name</code> attribute를 제거합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-3.2.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.web.controller.HomeController"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp/"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>이제 테스트를 돌려보면 기존과 동일한 결과를 얻어낼 수 있습니다. <code>old</code> 방법의 경우에는 기존 코드의 유지보수에서만 사용되지, 이제는 사용되지 않는 방법입니다.</p>
<h2 id="URL-Mapping"><a href="#URL-Mapping" class="headerlink" title="URL Mapping"></a>URL Mapping</h2><p>URL Mapping의 기본이 되는 <code>@RequestMapping</code>에 대해서 좀 더 알아보겠습니다.</p>
<h3 id="String-value"><a href="#String-value" class="headerlink" title="String[] value"></a>String[] value</h3><p>URL을 지정해주는 pattern입니다. 예를 들어 다음과 같은 pattern들을 지정해주는 것이 가능합니다.</p>
<ul>
<li>@RequestMapping(“/hello”)</li>
<li>@RequestMapping({“/hello”, “/hello2”})</li>
<li>@RequestMapping(“/hello1”)</li>
</ul>
<p>Path변수를 지정해주는 것이 가능합니다. “/hello/{name}” 과 같이 method의 input을 url에 같이 실어 주는것이 가능합니다.</p>
<ul>
<li>@RequestMapping(“/hello/{name}”)</li>
<li>@RequestMapping(“/hello/{name}/{number}”)</li>
</ul>
<h3 id="method"><a href="#method" class="headerlink" title="method"></a>method</h3><p>RequestMethod를 지정하는 것 역시 가능합니다. GET, POST, DELETE, PUT, HEAD가 사용 가능합니다. 역시 method도 Path와 동일하게 중복 설정이 가능합니다.</p>
<h3 id="params"><a href="#params" class="headerlink" title="params"></a>params</h3><p>url 요청 파라미터의 유무에 따라 호출되는 method를 결정할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/user/edit"</span>, params=<span class="string">"type=admin"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">callWithAdmin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// URL: "/user/edit?type=admin"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/user/edit"</span>, params=<span class="string">"type=member"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">callWithMember</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// URL: "/user/edit?type=member"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>method의 input값에 따라 method내에서의 if문을 만들지 않고 처리가 가능한 유용한 팁입니다.</p>
<h3 id="headers"><a href="#headers" class="headerlink" title="headers"></a>headers</h3><p>HTTP header정보에 따른 mapping역시 가능합니다. request type을 text/html, application/json 각각의 type에 따라 다른 method를 처리 가능합니다.</p>
<h3 id="RequestMapping과-method-parameter와-결합"><a href="#RequestMapping과-method-parameter와-결합" class="headerlink" title="RequestMapping과 method parameter와 결합"></a>RequestMapping과 method parameter와 결합</h3><p>기본적으로 @Controller의 각 method는 다음과 같은 input parameter를 갖을 수 있습니다.</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Annotation</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>URL/POST parameter</td>
<td>@RequestParam</td>
<td>GET/POST/DELETE/PUT 등으로 호출될 때, 넘겨지는 Parameter값</td>
</tr>
<tr>
<td>Path value</td>
<td>@PathVariable</td>
<td>URL 에 포함된 특정 영역 문자열</td>
</tr>
<tr>
<td>Servlet</td>
<td>-</td>
<td>HttpServletRequest, HttpServletResponse를 직접 Handling 하는 기존 Servlet과 같은 코드 역시 사용 가능합니다.</td>
</tr>
<tr>
<td>Cookie</td>
<td>@CookieValue</td>
<td>Cookie 값을 얻거나 설정할 수 있습니다.</td>
</tr>
<tr>
<td>Session</td>
<td>@SessionAttributes</td>
<td>Session 값을 얻거나 설정할 수 있습니다.</td>
</tr>
<tr>
<td>Body</td>
<td>@RequestBody</td>
<td>Request의 Body 부분을 모두 String으로 얻어내는 것이 가능합니다.</td>
</tr>
</tbody>
</table>
<h3 id="return-value"><a href="#return-value" class="headerlink" title="return value"></a>return value</h3><p>action method는 주로 4가지 형태의 Return Type을 사용하게 됩니다.</p>
<ul>
<li>String : view 이름을 return 합니다. 주로 JSP 또는 Veloctiy, Freemarker, tiles와 Html View를 호출 할 때 사용됩니다. String 형태를 보내줄 때는 일반적으로 ViewResolver라는 객체를 applicationContext.xml에 등록하는 것이 일반적입니다.</li>
<li>void : 아무것도 return 하지 않습니다. 이는 method의 이름을 String 형태로 return 하는 것과 동일한 결과를 갖습니다.</li>
<li>Object : REST 형태의 Return값을 사용할 때 이용됩니다. 대체적으로 Object에 대한 Body Response를 덩어내는 것을 주 목적으로 하고 있습니다.</li>
<li>ModelAndView : Spring 2.X 형태로 Model과 View를 return 하는 것이 가능합니다.</li>
</ul>
<h2 id="확장자가-없는-URL"><a href="#확장자가-없는-URL" class="headerlink" title="확장자가 없는 URL"></a>확장자가 없는 URL</h2><p>지금까지의 예시에서는 확장자를 하나씩 붙여서 처리했습니다. 이러한 확장자를 붙여서 처리하는 것은 DispatcherServlet에서 처리할 URL이 어떤 것인지 명확하게 결정해줄 수 있는 장점을 가지고 있습니다. 그렇지만, 이 방법은 조금 애매한 것이 사실입니다. W3C에서 표준한 URL 표준에서, 확장자는 URL을 통해서 얻고 싶은 Response의 protocol을 선택하는 형식입니다. 예를 들어서 다음 URL들의 해석은 다음과 같습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/shop/search.json?name=윤영권</span><br><span class="line">/shop/search.html?name=윤영권</span><br><span class="line">/shop/search.rss?name=윤영권</span><br><span class="line">/shop/search.xml?name=윤영권</span><br></pre></td></tr></table></figure>
<p>다음 4개의 url format은 json/html/rss/xml 형식으로 데이터를 얻어오는 것을 가정하고 있습니다. url의 extension에 dispatcher servlet 을 종속시키는 것은 이제 옛날 방법입니다. 이제는 모든 URL을 dispatcherServlet에 보내게 됩니다. 그리고 dispatcherServlet에서 해석 불가능한 request들을 servlet container에게 넘기는 방식으로 처리하는 것입니다.</p>
<p>여기서 servlet spec에 대해서 한번 알아보도록 하겠습니다. <code>SRV.11.2 Specification of Mappings</code> 에서 servlet container는 다음과 같이 명령을 정의하고 있습니다.</p>
<ul>
<li>A string beginning with a ‘/’ character and ending with a ‘/*’ suffix is used for path mapping.<blockquote>
<p>‘/‘로 시작하고, ‘/*’로 끝나는 mapping의 경우에는 path mapping을 따르게 된다. (path mapping : servlet container에서 정의되어 있는 mapping입니다.)</p>
</blockquote>
</li>
<li>A string beginning with a ‘*.’ prefix is used as an extension mapping.<blockquote>
<p><em>. 으로 시작하는 mapping의 경우에는 확장 mapping을 따르게 된다. 우리가 기존에 사용하는 것을 확인했던 </em>.do와 같은 방법입니다.</p>
</blockquote>
</li>
<li>A string containing only the ’/’ character indicates the “default” servlet of the application. In this case the servlet path is the request URI minus the context path and the path info is null.<blockquote>
<p>‘/‘만 사용하게 되는 경우, 이는 application의 ‘default’ servlet을 의미한다. 이 경우에는 request URI와 context Path가 완전히 일치하게 되고, servlet path는 null이 됩니다.</p>
</blockquote>
</li>
<li>All other strings are used for exact matches only.<blockquote>
<p>모든 request uri가 완전히 일치하는 경우에는 확장 mapping에 지정된 servlet을 사용한다.</p>
</blockquote>
</li>
</ul>
<p>이 4가지 경우중에서 우리가 사용하게 되는 것은 3번으로 모든 request를 동일한 servlet으로 처리하게 됩니다. 이 경우에는 web.xml은 다음과 같이 설정할 수 있습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>그리고, <code>application의 default servlet을 변경</code>하기 위해서 spring에 다음 설정을 추가합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>이제 <code>default-servlet</code>을 변경시켰기 때문에, 각 <code>child-container</code>에 설정을 넣어줄 필요 역시 없어집니다.</p>
<p><code>applicationContext.xml</code>은 다음과 같이 변경될 수 있습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">     <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">     <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag">     <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-3.2.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:default-servlet-handler</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.web.controller.HomeController"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp/"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>spring-servlet.xml</code>은 다음과 같이 변경될 수 있습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-3.2.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="Configuration을-이용한-DispatcherServlet-설정-with-web-xml"><a href="#Configuration을-이용한-DispatcherServlet-설정-with-web-xml" class="headerlink" title="@Configuration을 이용한 DispatcherServlet 설정 (with web.xml)"></a>@Configuration을 이용한 DispatcherServlet 설정 (with web.xml)</h2><p>지금까지 <code>Service</code>를 구성할 때, 주로 사용하던 <code>@Configuration</code>을 어떻게 사용할 수 있는지 알아보도록 하겠습니다.</p>
<p>먼저, 기존 <code>applicationContext.xml</code>에 해당되는 <code>@RootConfiguration</code> 코드는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.web.controller"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RootConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewResolver <span class="title">viewResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        InternalResourceViewResolver internalResourceViewResolver = <span class="keyword">new</span> InternalResourceViewResolver();</span><br><span class="line">        internalResourceViewResolver.setPrefix(<span class="string">"/WEB-INF/jsp/"</span>);</span><br><span class="line">        internalResourceViewResolver.setSuffix(<span class="string">".jsp"</span>);</span><br><span class="line">        internalResourceViewResolver.setOrder(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> internalResourceViewResolver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이를 등록하기 위해서는 기본적으로 사용되는 <code>contextClass</code>를 기본값인  <code>XmlConfigWebApplicationContext</code>에서 <code>AnnotationConfigWebApplicationContext</code>으로 변경해야지 됩니다. 그리고 <code>contextConfigLocation</code>을 <code>@Configuration</code>으로 바꾸어주면 해결할 수 있습니다.</p>
<p>구성된 <code>web.xml</code>은 다음과 같습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xmlns:web</span>=<span class="string">"http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">id</span>=<span class="string">"WebApp_ID"</span> <span class="attr">version</span>=<span class="string">"3.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>mvc.spring01<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>ContextLoader<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextClass<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>org.springframework.web.context.support.AnnotationConfigWebApplicationContext<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>com.xyzlast.web.config.RootConfiguration<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextClass<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>org.springframework.web.context.support.AnnotationConfigWebApplicationContext<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="Configuration을-이용한-DispatcherServlet-설정-without-web-xml"><a href="#Configuration을-이용한-DispatcherServlet-설정-without-web-xml" class="headerlink" title="@Configuration을 이용한 DispatcherServlet 설정 (without web.xml)"></a>@Configuration을 이용한 DispatcherServlet 설정 (without web.xml)</h2><p><code>web.xml</code>에 대해서 이야기하던 내용과 같이 <code>web.xml</code>이 없는 경우에는 어떻게 해야지 되는지 따라가보도록 하겠습니다. 이 방법은 최근에 주로 사용되고 있기 때문에, 이에 대해서도 잘 알아둘 필요가 있습니다.</p>
<p>이 경우에는 <code>WebApplicationInitializer</code>를 통해 설정이 가능합니다. <code>WebApplicationInitializer</code>의 경우, <code>web.xml</code>의 역활을 모두 다 담당할 수 있습니다. 이 interface를 잘 만들어둔 <code>AbstractAnnotationConfigDispatcherServletInitializer</code>를 상속받아서 구현 가능합니다. 구현되는 코드는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebXml</span> <span class="keyword">extends</span> <span class="title">AbstractAnnotationConfigDispatcherServletInitializer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Class&lt;?&gt;[] &#123; RootConfiguration.class &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Class[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String[] getServletMappings() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[] &#123; <span class="string">"/"</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Filter[] getServletFilters() &#123;</span><br><span class="line">        CharacterEncodingFilter characterEncodingFilter = <span class="keyword">new</span> CharacterEncodingFilter();</span><br><span class="line">        characterEncodingFilter.setEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">        characterEncodingFilter.setForceEncoding(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Filter[] &#123; characterEncodingFilter &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>Spring WebMVC의 기본 구조에 대해서 알아봤습니다.</p>
<p>Spring WebMVC에서 사용되는 <code>applicationContext.xml</code>의 구조와 <code>@Configuration</code>에 대한 설명을 드렸습니다. 또한, <code>Controller</code>에 대한 내용들을 같이 이야기했습니다.</p>
<p>너무 많은 내용들이 한 곳에 들어있습니다. Spring WebMVC에서 가장 중요한 부분입니다. 잘 익혀둬야지 됩니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/java-web-spring-mvc/">java, web, spring-mvc</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/03/28/java-web-app/"><span>13.Java Web Application의 구조</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/03/28/java-web-app/" rel="bookmark">
        <time class="entry-date published" datetime="2018-03-27T23:17:31.000Z">
          2018-03-28
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="Java-Web-Application의-구조"><a href="#Java-Web-Application의-구조" class="headerlink" title="Java Web Application의 구조"></a>Java Web Application의 구조</h1><p>java로 개발한 application을 배포를 할때는 주로 jar, war 형태로 배포를 하게 됩니다.<br>이 둘은 완전히 동일한 형식입니다. 다만, war는 web application을 배포하는 형식이고 jar는 library나 일반 application을 배포하는 형식입니다.</p>
<h2 id="Jar-Application"><a href="#Jar-Application" class="headerlink" title="Jar Application"></a>Jar Application</h2><p>build된 jar 파일의 압축을 풀어보면 다음과 같은 폴더 구조를 볼 수 있습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── META-INF</span><br><span class="line">│   └── MANIFEST.MF</span><br><span class="line">└── com</span><br></pre></td></tr></table></figure>
<p><code>com</code>으로 시작되는 폴더는 만들어진 class가 들어가는 위치입니다. 그런데 지금 생성하지 않은 <code>META-INF</code> 폴더가 있는 것을 볼 수 있습니다. 폴더 안에는 build환경에 따라 다른 다양한 파일들이 들어있는데, 주목할 내용은 <code>MANIFEST.MF</code> 입니다.</p>
<p>이 파일은 다음과 같은 정보를 포함합니다.</p>
<ul>
<li>Manifest-Version: Manifest file version</li>
<li>Build-By: Build user</li>
<li>Build-Jdk: jdk version</li>
<li>Created-By: Build tool</li>
<li>Class-Path: 외부 추가 lib를 지정할 수 있습니다. jar내부에 외부 추가 jar를 같이 넣어서 배포가 가능합니다.</li>
<li>Main-Class: 실행 파일 경로 및 파일명을 지정합니다.</li>
</ul>
<p>이 내용은 jar파일에 대한 manual이나 스팩을 기록하는 폴더입니다. 그리고 우리가 web-resource와 같은 정적인 resource를 배포할 때도 역시 META-INF 폴더를 이용하게 됩니다. jar 파일은 자신이 개발한 class를 가질수도 있고, 심지어 jar에 jre까지 포함하는 것까지 가능합니다. 다른 jar 역시 추가하는 것도 가능합니다.</p>
<h2 id="War-Application"><a href="#War-Application" class="headerlink" title="War Application"></a>War Application</h2><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">├── META-INF</span><br><span class="line">│   └── MANIFEST.MF</span><br><span class="line">└── WEB-INF</span><br><span class="line">    ├── classes</span><br><span class="line">    └── lib</span><br></pre></td></tr></table></figure>
<p>war의 기본정보와 static-resource를 저장한 META-INF 폴더의 경우에는 jar와 동일하게 만들어집니다. 그리고 또다른 폴더가 하나더 생깁니다. WEB-INF 폴더가 바로 그것인데요. 이 폴더는 다음 2개의 폴더를 같이 포함합니다.</p>
<ul>
<li>lib - 외부 및 추가 jar가 위치하는 폴더</li>
<li>classes - 개발된 application의 compile된 class 파일이 위치</li>
</ul>
<p>war의 경우에는 ClassLoader에 의해서 로드되는 객체들은 classes 폴더를 기준으로 로드가 이루어지게 됩니다.</p>
<p>그리고, 이 안에는 매우 중요한 파일이 하나 들어가게 됩니다. 그것은 web.xml인데요. java web application의 구성은 기본적으로 WEB-INF/web.xml 에서 결정됩니다. web.xml은 필터, 서블릿, DB소스 등  web container가 구동하는데 이용되는 환경설정파일입니다. 서버가 처음 로딩될때 web.xml파일을 읽어들여 해당 환경설정에 대해 어플리케이션 배치를 하게 됩니다. 다른 말로 web.xml은 배치 서술자(deployment de-scriptor)라고도 합니다.</p>
<h2 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h2><p>web.xml의 기본 환경설정 정보는 다음과 같습니다.</p>
<ul>
<li>필터정보 (매핑 포함)</li>
<li>서블릿정보 (매핑 포함)</li>
<li>웹 애플리케이션 정보</li>
<li>세션정보</li>
<li>세션정보가 소멸, 생성, 수정되는 것을 알려주는 리스너 정보</li>
<li>MIME매핑</li>
<li>welcomefile정보</li>
<li>errorPage 정보</li>
<li>url보호 정보</li>
<li>인터프라이즈 빈의 홈레퍼런스 정보 (로컬 레퍼런스 정보 포함)</li>
</ul>
<h3 id="필터정보"><a href="#필터정보" class="headerlink" title="필터정보"></a>필터정보</h3><p>필터는 요청이 들어오면 URL 패턴을 분석해서 해당 패턴의 요청이 들어오면 해당 요청에 담긴 정보들을 프로그래머가 원하는 형태의 데이터로 가공해서 서버로 요청을 넘길 수 있습니다. servlet과 비슷한 개념으로 계속 요청을 감시하고있습니다가 url패턴에 해당하는 요청이 들어오게되면 해당 요청을 가로채서 원하는 데이터 형태로 가공한뒤 다시 요청을 서버로 보내는 역할을 하게 됩니다.. 따라서 서버내에서 사용될 데이터 또는 화면으로 다시 보낼 데이터의 형태를 프로그래머가 원하는 형태로 단일화 시킬 수 있습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>myRequest<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>myFilter.util.myReqFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>myRequestFilter<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>filterTest<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>필터 이름과 클래스, 초기화 파라미터를 지정하게 됩니다.. myRequest라는 필터는 myFilter.util 페키지 안에 있는 myReqFilter를 호출하며 초기화 파라미터로 myRequestFilter의 이름을 가진 filterTest값을 가지고 filter를 호출할것입니다. filter를 사용할때 사용할 클래스는 반드시 Filter인터페이스를 implenebts받아 doFilter메소드를 반드시 오버라이드 해주어야 하며 메소드 실행순서는 init() -&gt; doFilter() -&gt; destroy() 순으로 구성됩니다. 이는 Servlet의 생명 주기와 동일하게 동작합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>myRequest<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.doFilter<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>위에서 선언한 filter정보를 url패턴과 매핑하는 부분입니다.<br>어떠한 URL의 확장자로 .doFilter가 함께 넘어오면 myRequest필터를 호출하게 되고 해당 필터는 myFilter.util 페키지안에 있는 myReqFilter 를 호출하게 됩니다. url-pattern 대신 servlet-name이 올 수 있습닌다.</p>
<p>servlet-name이 들어오게 되면 해당 패턴에 맞는 모든 filter가 실행되고 나서 servlet을 호출하게 됩니다..<br>filter는 여러겹으로 사용할 수 있는데 필터 체인이라는 용어로 쓰입니다.</p>
<p><img src="/images/13/01.png" alt=""></p>
<h3 id="서블릿-Servlet-정보"><a href="#서블릿-Servlet-정보" class="headerlink" title="서블릿(Servlet) 정보"></a>서블릿(Servlet) 정보</h3><p>필터와 비슷한 맥락의 기능입니다. 그렇지만 큰 차이를 가지고 옵니다. Filter의 경우에는 Response와 Request에 대한 stream의 처리를 담당하고, 이에 대한 실질적인 Action을 담당하는 것이 Servlet입니다. web.xml에 매핑되어져 있는 서블릿들은 해당 요청을 포함하여 url패턴을 분석하고 거기에 매핑되어져 있는 클래스를 호출하여 처리를 하게 됩니다.<br>지정 방법은 다음과 같습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>loginServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>myServlet.util.loginServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>위처럼 하나의 서블릿 클래스를 생성해두고 해당 클래스를 servlet-class라는 element를 지정하게 됩니다..<br>나중에 loginServlet을 호출하면 myServlet.util 페키지 안에있는 loginServlet클래스가 호출될것입니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>loginServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.login<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>url패턴과 해당 해당 패턴에 해당하는 url로 접근시 호출될 servlet을 설정하는 부분입니다.<br>메타문자로 <em>가 올 수 있고 확장자를 설정하게 됩니다..<br>나중에 </em>.login이라는 URL을 서버로 요청하게되면 loginServlet의 이름을 가진 서블릿을 호출하게 됩니다..<br>해당 서블릿은 위에서 myServlet.util.loginServlet 클래스를 매핑해두었으므로 해당 클래스가 호출되는 형태가 될것입니다.</p>
<p>Spring은 이곳에 <code>DispatcherServlet</code>이라는 Spring에서 제공하는 Servlet을 이용해서 Spring MVC에서 Request를 처리합니다. 예를 들어 Naver의 경우에는 <code>*.nhn</code> 이라는 url-pattern에 <code>DispatcherServlet</code>을 연결시켜두는 것이 일반적입니다.<br>인터넷 서핑을 주로 하시다보면 <code>*.do</code> url을 간간히 보게 되는데요. 이것은 Spring의 2.5대 버젼에서 Spring에서 추천하던 url-pattern입니다. web.xml의 설정의 경우에는 개발자들이 copy-paste 신공을 펼치는 경우가 많기 때문에 이것을 계속해서 이용하게 되는 경우도 많지요.</p>
<h3 id="웹-어플리케이션-정보-Web-Application"><a href="#웹-어플리케이션-정보-Web-Application" class="headerlink" title="웹 어플리케이션 정보 (Web Application )"></a>웹 어플리케이션 정보 (Web Application )</h3><p>웹 어플리케이션 정보를 설정하는 부분으로</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">display-name</span>&gt;</span>webApplication<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">description</span>&gt;</span>desc for webApplication<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>으로, Web Application의 정보와 표시 이름을 적을 수 있습니다.</p>
<h3 id="세션정보-Session"><a href="#세션정보-Session" class="headerlink" title="세션정보 ( Session )"></a>세션정보 ( Session )</h3><p>Session의 timeout 및 공유 방법을 결정할 수 있습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">session-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timeout</span>&gt;</span>20<span class="tag">&lt;/<span class="name">timeout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shared</span>&gt;</span>true<span class="tag">&lt;/<span class="name">shared</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">session-config</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="세션-리스너-정보-Session-Listner"><a href="#세션-리스너-정보-Session-Listner" class="headerlink" title="세션 리스너 정보 ( Session Listner )"></a>세션 리스너 정보 ( Session Listner )</h3><p>Session이 연결되고, 제거되는 각각의 event에 연결되는 Listner에 대한 정보를 기술할 수 있습니다. 아래는 servlet에서 기본으로 제공하는 listener입니다.</p>
<h4 id="javax-servlet-ServletContextAttributeListener"><a href="#javax-servlet-ServletContextAttributeListener" class="headerlink" title="javax.servlet.ServletContextAttributeListener"></a>javax.servlet.ServletContextAttributeListener</h4><p>이 리스너는 컨텍스트에 저장된 애트리뷰의 변화가 있었을 때 설정된 이벤트를 엔진이 자동으로 발생시키도록 합니다. 이벤트 감지를 얻어내기 위해서는 여러분들이 직접 작성한 리스너의 implemention클래스를 통해야 하는것은 물론이며, 아래의 리스너 모두 동일하게 설정됩니다.</p>
<h4 id="javax-servlet-ServletContextListener"><a href="#javax-servlet-ServletContextListener" class="headerlink" title="javax.servlet.ServletContextListener"></a>javax.servlet.ServletContextListener</h4><p>당신이 작성한 웹애플리케이션에서 컨텍스트를 이용하여 무언가를 저장하고 이용할 수 있는데 이 리스너의 작동은 그러한 컨텍스트에 대한 변경이 이루어졌을 때 자동으로 엔진이 감지하고 작성한 클래스의 이벤트를 발생시킵니다.</p>
<h4 id="javax-servlet-http-HttpSessionActivationListener"><a href="#javax-servlet-http-HttpSessionActivationListener" class="headerlink" title="javax.servlet.http.HttpSessionActivationListener"></a>javax.servlet.http.HttpSessionActivationListener</h4><p>request.getSession(true)같은 경우처럼 Session에 대한 내용이 새로 생성되어 activate되어졌을 때 발생하는 이벤트를 감지하는 리스너입니다.</p>
<h4 id="javax-servlet-http-HttpSessionAttributeListener"><a href="#javax-servlet-http-HttpSessionAttributeListener" class="headerlink" title="javax.servlet.http.HttpSessionAttributeListener"></a>javax.servlet.http.HttpSessionAttributeListener</h4><p>HttpSession에 대한 애트리뷰트의 변경시 연결되어지는 리스너입니다.</p>
<h4 id="javax-servlet-http-HttpSessionBindingListener"><a href="#javax-servlet-http-HttpSessionBindingListener" class="headerlink" title="javax.servlet.http.HttpSessionBindingListener"></a>javax.servlet.http.HttpSessionBindingListener</h4><p>HttpSession에 대하여 클라이언트 세션정보에 대한 바인딩이 이루어졌을 경우 감지되는 리스너입니다.</p>
<p>이 SessionListener들을 상속받아 구현된 class에 대한 정보를 web.xml에 다음과 같이 등록하여 사용가능합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>SessionListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="MIME-매핑-MIME-Mapping"><a href="#MIME-매핑-MIME-Mapping" class="headerlink" title="MIME 매핑 (MIME Mapping)"></a>MIME 매핑 (MIME Mapping)</h3><p>web server에서 보내지는 각각의 파일 리소스에 대한 정보를 mapping하는 영역입니다. 예를 들어 JSON의 경우 application/json 형태임을 web browser에게 알리는 등의 일을 수행합니다. 이것이 정상적으로 설정되어 있지 않으면 hwp와 같은 파일 포멧을 다운받지 못하고, browser에서 직접 열게 되는 식의 오동작을 발생시키게 됩니다. 아래와 같은 형식으로 설정이 가능합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mime-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">extension</span>&gt;</span>zip<span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mime-type</span>&gt;</span>application/zip<span class="tag">&lt;/<span class="name">mime-type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mime-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mime-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">extension</span>&gt;</span>hwp<span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mime-type</span>&gt;</span>application/unknown<span class="tag">&lt;/<span class="name">mime-type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mime-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="welcomefile-정보-welcomeFile"><a href="#welcomefile-정보-welcomeFile" class="headerlink" title="welcomefile 정보 ( welcomeFile )"></a>welcomefile 정보 ( welcomeFile )</h3><p>welcomeFile은 서버에 접속하면 가장 최초로 보여줄 파일을 지정하는 부분입니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.html<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>서버를 구동한 후 <a href="http://localhost:8080/myWeb/" target="_blank" rel="noopener">http://localhost:8080/myWeb/</a> 로 접속을 하게되면 index.html이 실행될것입니다. html파일이 없다면 index.jsp가 실행됩니다.</p>
<h3 id="errorPage-정보-ErrorPage"><a href="#errorPage-정보-ErrorPage" class="headerlink" title="errorPage 정보( ErrorPage )"></a>errorPage 정보( ErrorPage )</h3><p>특정 요청에 대해 error가 반환될때 해당 페이지를 보여주도록 설정이 가능합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>404<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">location</span>&gt;</span>/errors/404.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>java.lang.NullPointerException<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">location</span>&gt;</span>/errors/badcode.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="url보호-정보-URL-Security"><a href="#url보호-정보-URL-Security" class="headerlink" title="url보호 정보 ( URL Security )"></a>url보호 정보 ( URL Security )</h3><p>로그인 및 각 URL에 대한 접근 정책을 결정할 수 있습니다.  이 때 사용되는 Security 정책은 servlet-container의 정책에 따르게 되기 때문에 Web Application에서 사용하기에는 조금 힘듭니다.<br>tomcat에서는 conf/tomcat-user.xml 에 사용자가 정의되어 있습니다.  tomcat manager에 등록되어 있는 default security 정책은 다음과 같습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security-constraint</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Name String<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">web-resource-name</span>&gt;</span>GETServlet<span class="tag">&lt;/<span class="name">web-resource-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>some description<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/servlet/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">http-method</span>&gt;</span>GET<span class="tag">&lt;/<span class="name">http-method</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">web-resource-collection</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">auth-constraint</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>some description<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">role-name</span>&gt;</span>*<span class="tag">&lt;/<span class="name">role-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">auth-constraint</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">user-data-constraint</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">description</span>&gt;</span>some description<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">transport-guarantee</span>&gt;</span>INTEGRAL<span class="tag">&lt;/<span class="name">transport-guarantee</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">user-data-constraint</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">security-constraint</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">login-config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">auth-method</span>&gt;</span>FORM<span class="tag">&lt;/<span class="name">auth-method</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">realm-name</span>&gt;</span>MemoryRealm<span class="tag">&lt;/<span class="name">realm-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form-login-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form-login-page</span>&gt;</span>login.jsp<span class="tag">&lt;/<span class="name">form-login-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form-error-page</span>&gt;</span>notAuthenticated.jsp<span class="tag">&lt;/<span class="name">form-error-page</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form-login-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">login-config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">security-role</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>some description<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">role-name</span>&gt;</span>administrator<span class="tag">&lt;/<span class="name">role-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">security-role</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="인터프라이즈-빈의-홈레퍼런스-정보-로컬-레퍼런스-정보-포함-Interprize-Bean’s-Home-Reference-Local-Reference"><a href="#인터프라이즈-빈의-홈레퍼런스-정보-로컬-레퍼런스-정보-포함-Interprize-Bean’s-Home-Reference-Local-Reference" class="headerlink" title="인터프라이즈 빈의 홈레퍼런스 정보 (로컬 레퍼런스 정보 포함) ( Interprize Bean’s Home Reference [Local Reference])"></a>인터프라이즈 빈의 홈레퍼런스 정보 (로컬 레퍼런스 정보 포함) ( Interprize Bean’s Home Reference [Local Reference])</h3><p>이제는 과거의 유산이 되어버린 ejb에 대한 설정 정보가 위치하는 곳입니다. ejb에 대한 정보 설정은 다음과 같이 설정됩니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">env-entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>some description<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">env-entry-name</span>&gt;</span>MinimumValue<span class="tag">&lt;/<span class="name">env-entry-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">env-entry-value</span>&gt;</span>5<span class="tag">&lt;/<span class="name">env-entry-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">env-entry-type</span>&gt;</span>java.lang.Integer<span class="tag">&lt;/<span class="name">env-entry-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">env-entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ejb-ref</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>some description<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ejb-ref-name</span>&gt;</span>Employee Bean<span class="tag">&lt;/<span class="name">ejb-ref-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ejb-ref-type</span>&gt;</span>EmployeeBean<span class="tag">&lt;/<span class="name">ejb-ref-type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">home</span>&gt;</span>com.foobar.employee.EmployeeHome<span class="tag">&lt;/<span class="name">home</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">remote</span>&gt;</span>com.foobar.employee.Employee<span class="tag">&lt;/<span class="name">remote</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ejb-ref</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="web-xml-등록법"><a href="#web-xml-등록법" class="headerlink" title="web.xml 등록법"></a>web.xml 등록법</h2><p>servlet의 변화에 따라 web.xml은 많은 확장이 있었습니다. web.xml의 정보는 다음 3가지 방법으로 표현될 수 있습니다.</p>
<ul>
<li>WEB-INF/web.xml 을 이용해서 등록하는 방법</li>
</ul>
<blockquote>
<p>가장 많이 사용되고 있으며, servlet 1.0부터 지금까지 구현된 방법입니다. 가장 대중적입니다.</p>
</blockquote>
<ul>
<li>META-INF/web-fragment.xml 을 이용하는 방법</li>
</ul>
<blockquote>
<p>servlet 3.0 부터 지원되는 방법입니다. web.xml은 web application에 종속되는 방법입니다. web application 뿐 아니라, jar로 개발된 project에서 가지고 있는 META-INF 폴더 안의 web-fragment.xml을 이용해서 web을 구동하는 방법을 지원하고 있습니다. web-fragment.xml은 web.xml과 내용이 동일합니다. 이 방법이 나오게 된 이유는 Servlet 3.0에서부터는 web container를 포함한 설치형 war가 배포가 가능합니다. 지금까지는 web application을 tomcat과 같은 web container에 배포하는 것이 일반적이였지만, web container를 포함한 한개의 web application으로 구동하는 방법을 servlet 3.0에서 이제는 지원하고 있습니다.</p>
</blockquote>
<ul>
<li>javax.servlet.ServletContainerInitializer interface를 구현한 객체를 이용하는 방법</li>
</ul>
<blockquote>
<p>servlet 3.0 부터 지원되는 방법입니다. web.xml이 없이, application에서 작성한 ServletContainerInitializer를 구현하는 것으로 web.xml 대신 페이지를 작성할 수 있도록 지원하고 있습니다.</p>
</blockquote>
<p>3가지 방법중 3번의 방법이 조금 재미있습니다. ServletContainerInitializer를 구현한 객체를 이용하게 되면, 다음과 같은 설정들만 사용 가능합니다.</p>
<ul>
<li>Listener 구성</li>
<li>filter 구성</li>
<li>Session Listener 구성</li>
<li>ejb 구성</li>
</ul>
<p>web.xml의 핵심이 구현되긴하지만, 자주 사용되는 다음 항목들이 제공되지 않습니다.</p>
<ul>
<li>session-config</li>
<li>error-page</li>
</ul>
<p>이 두항목을 사용하기 위해서는 web.xml과 ServletContainerInitializer를 구현한 객체를 같이 사용해주면 됩니다. 그럼 ServletContainer는 web.xml을 먼저 로딩 후, 객체를 로드해서 사용하게 됩니다.</p>
<h2 id="Gradle을-이용한-Hello-World-Web-App"><a href="#Gradle을-이용한-Hello-World-Web-App" class="headerlink" title="Gradle을 이용한 Hello World Web App"></a>Gradle을 이용한 Hello World Web App</h2><p>먼저 기본적으로 기존에 사용하던 <code>java-application</code>으로부터 시작합니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle init --<span class="built_in">type</span>=java-application</span><br></pre></td></tr></table></figure>
<p>구성된 build.gradle에서 다음을 추가합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">plugin:</span> <span class="string">'war'</span></span><br></pre></td></tr></table></figure>
<p>web application을 개발할 예정이기 때문에, <code>war</code>를 추가하는 것이 필요합니다.<br>이제 IntelliJ에서 Project를 open 시킵니다.</p>
<p>먼저 web에서 사용될 resource를 추가하도록 합니다. <code>/src/main/webapp</code> 폴더를 추가합니다. 그리고 내부에 <code>META-INF</code>, <code>WEB-INF</code> 폴더를 생성하여 추가합니다.<br>만들어진 전체 folder구조는 다음과 같습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── build.gradle</span><br><span class="line">├── settings.gradle</span><br><span class="line">└── src</span><br><span class="line">    ├── main</span><br><span class="line">    │   ├── java</span><br><span class="line">    │   │   └── com</span><br><span class="line">    │   │       └── xyzlast</span><br><span class="line">    │   ├── resources</span><br><span class="line">    │   └── webapp</span><br><span class="line">    │       ├── META-INF</span><br><span class="line">    │       ├── WEB-INF</span><br><span class="line">    │       │   ├── jsp</span><br><span class="line">    │       │   └── web.xml</span><br><span class="line">    │       └── index.jsp</span><br><span class="line">    └── test</span><br><span class="line">        ├── java</span><br><span class="line">        └── resources</span><br></pre></td></tr></table></figure>
<p>신규 Servlet을 생성합니다. package는 자신이 원하는대로 넣어주시면 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">4589997486063553833L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        req.setAttribute(<span class="string">"date"</span>, <span class="keyword">new</span> Date());</span><br><span class="line">        req.setAttribute(<span class="string">"message"</span>, <span class="keyword">this</span>.message);</span><br><span class="line">        req.getRequestDispatcher(<span class="string">"/WEB-INF/jsp/hello.jsp"</span>).forward(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.init();</span><br><span class="line">        message = <span class="string">"Hello World from Servlet"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>꼭 <code>HttpServlet</code> 객체를 상속받아 처리해야지 됩니다. 이제 <code>Servlet</code>에서 사용할 <code>jsp</code>파일을 만들어줍니다. 위치는 <code>src/main/webapp/WEB-INF/jsp/hello.jsp</code>입니다.<br>이 jsp 파일은 다음과 같이 구성가능합니다.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;Hello World&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;p&gt;$&#123;message&#125;, $&#123;date&#125;&lt;/p&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>이제 <code>src/main/webapp/WEB-INF</code>안에 <code>web.xml</code>을 넣어줍니다. <code>web.xml</code>은 다음과 같습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/j2ee"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">"2.4"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>HelloWorld Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HelloServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.xyzlast.servlet.HelloWorldServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HelloServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/hello.do<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>web.xml</code>에서는 <code>/hello.do</code>에 <code>HelloWorldServlet</code>을 연결시키는 코드가 있는 것을 볼 수 있습니다.</p>
<p>이제 구성된 web application을 실행시킬 수 있어야지 됩니다. 개발중인 web application을 실행하기 위해서는 여러가지 방법들이 있습니다.<br>다들 가장 많이 알고 계신 방법들이, 지금 실행중인 tomcat의 webapp folder에 war 파일을 배포하여 실행하면 됩니다.</p>
<p>war 파일을 만드는 방법은 다음과 같습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle war</span><br></pre></td></tr></table></figure>
<p><code>BUILD SUCCESS</code>가 나온 후, <code>/build/libs</code>에 보시면 war파일을 확인 할 수 있습니다.</p>
<p>그런데, 이 방법은 너무나 비효율적입니다. Servlet을 하나 추가할때마다 war 파일을 만들고, war 파일을 카피하는 일들을 계속해서 반복해야지 됩니다. 이를 편하게 해주는 plugin을 gradle에서 제공합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="string">from:</span> <span class="string">'https://raw.github.com/akhikhl/gretty/master/pluginScripts/gretty.plugin'</span></span><br><span class="line">gretty &#123;</span><br><span class="line">    contextPath = <span class="string">'/'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>추가 후, <code>grdle appRun</code>을 통해 실행하면 다음과 같은 메세지를 볼 수 있습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">04</span> INFO  Jetty <span class="number">9</span>.<span class="number">2</span>.<span class="number">22</span>.v20170606 started and listening on port <span class="number">8080</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">04</span> INFO  HelloWorld Application runs <span class="built_in">at</span>:</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">04</span> INFO    http://localhost:<span class="number">8080</span>/</span><br><span class="line"></span><br><span class="line">&gt; Task :appRun</span><br><span class="line">Press any key to stop the server.</span><br></pre></td></tr></table></figure>
<p>이제 web browser에서 <code>http://localhost:8080/hello.do</code>로 접근하면 만든 web page를 보실 수 있습니다.</p>
<p><img src="/images/14/03.png" alt=""></p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>Java에서 Web을 표시하는 기본적인 방법에 대해서 알아봤습니다. <code>web.xml</code>의 내용 구성과 개발시에 필요한 <code>build.gradle</code>구성은 익혀두는 것이 필요합니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/java-web-xml/">java, web.xml</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/03/22/db-korean/"><span>12. Model 기술에 대한 논쟁 - 국내 IT 환경</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/03/22/db-korean/" rel="bookmark">
        <time class="entry-date published" datetime="2018-03-21T23:16:34.000Z">
          2018-03-22
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="Model-기술에-대한-논쟁-국내-IT-환경"><a href="#Model-기술에-대한-논쟁-국내-IT-환경" class="headerlink" title="Model 기술에 대한 논쟁 - 국내 IT 환경"></a>Model 기술에 대한 논쟁 - 국내 IT 환경</h1><p>그리고, 지금까지 Jdbc, Hibernate, MyBatis와 같이 DB에 접근하는 다양한 방법에 대해서 알아봤습니다.</p>
<p>각각의 DB를 다루는 기술들은 다양한 장점과 단점을 가지고 있습니다. 특히 myBatis는 기존의 sql의 재사용 또는 sql query만으로 Business Logic을 만들던 개발자들이 쉽게 접근할 수 있다는 장점이 있는것 같습니다. 그리고 Mapper를 이용하는 경우, Dao에 대한 구현 객체 생성을 거의 하지 않아도 된다는 장점을 가지고 있고요. 또 다른 장점은 무엇이 있을까요? 이 부분에 대해서는 코드를 보면서 서로간에 토론을 해보는것도 좋을 것 같습니다.</p>
<p>지금까지 우리는 MVC 모델의 M에 대한 기술적인 접근을 알아봤습니다. DB에 sql적 접근을 하는 Jdbc는 좀 다른 영역이라고 할 수 있고, myBatis와 Hibernate는 결국은 Jdbc를 한번 wrapping 한 형태라고도 할 수 있습니다. 제가 한번 질문을 던져보도록 하겠습니다. myBatis는 ORM일까요?</p>
<p>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.</p>
<p>myBatis는 ORM이 아닙니다. ORM은 DB가 갖는 relation 관계에 대한 객체화에 주목합니다. 그렇지만, myBatis는 DB에 대한 query값에 대한 표현에 주목하고 있는 형태의 query에 대한 관리 포인트에 중점을 두고 있습니다. 이 둘의 차이는 조금 있습니다. 이 부분에 대해서 다시한번 알아보도록 하겠습니다.<br>Hibernate에서 사용된 ORM 객체들은 Entity object라고 불리웁니다. 그렇지만, myBatis의 객체는 VO, DTO라고 불리웁니다.<br>이에 대한 정의는 다음과 같습니다.</p>
<ul>
<li><strong>Entity Object</strong></li>
</ul>
<p>프로세스 상에 존재하는 데이터 개체로 물리적이거나 추상적인 것을 모두 포함합니다. 실제 DB의 코드에서 동작이 가능한 객체입니다. 지금 저희가 만든 예제에서는 Book, User, UserHistory 등이 각 객체로서 동작할 수 있습니다. 객체는 method를 가질 수 있으며, 생명 주기 및 객체간의 관계를 갖습니다.</p>
<ul>
<li><strong>VO(Value Object), DTO(Data Transfer Object)</strong></li>
</ul>
<p>단순히 값을 저장하는 객체입니다. Layer에서 Layer로 값을 전달할 때 주로 사용이 되며, 값에 대한 재 사용이 이루어지지 못합니다. 실제 Object에 대한 Model을 표현하기보다는 데이터를 저장하고, 전달하는데에 초점이 맞춰져 있습니다. VO, DTO를 사용하기 보다는 Map을 이용한 Dictionary 구조의 객체를 사용해도 동일한 결과를 가지고 올 수 있습니다. Entity Object를 화면에 보이기 위해서 또는 DB의 특정 query 결과를 다른 Layer에서 사용하기 위해 주로 사용됩니다.</p>
<p>차이를 아시겠나요? 단순히 Hibernate에서는 DB에 대한 값의 전달 뿐 아니라, 객체의 주기와 객체와 객체간의 관계까지 가지고 있는 Instance되어 있는 객체로서 움직입니다. 그렇지만, VO에서는 단순한 query값에 대한 return값을 의미하게 됩니다. 이 부분의 차이는 매우 큽니다. VO로 주로 작업을 하게 되면 결국은 절차 지향적 프로그래밍으로 동작하게 됩니다. Flow가 흐르듯이 method1 call, method2 call 식으로요. 그렇지만, 객체를 이용하게 되는 경우, 객체간의 상호 동작에 의하여 프로그램이 개발이 되게 됩니다. 이 두 객체의 사용 문제는 국내에서만 뜨거운 감자입니다. 외국은 이미 Entity가 평정을 한 상태이지만, 국내는 무척 말이 많군요. 전에 Daum에서 조사한 결과로는 해외는 8:2, 국내는 2:8 수준이라고 했습니다. 이 부분에 대한 논쟁을 따로 정리해봤습니다. 코드를 한줄 더 짜는 것보다, 이 부분에 대한 내용을 한번 정리해보는 것은 개발자들에게 있어서 굉장히 중요한 시간입니다. 다들 읽어보시고, 같이 이야기해보는 시간을 갖도록 하겠습니다.</p>
<h2 id="Entity-vs-DTO-VO-국내의-myBatis와-Hibernate-사용-논쟁에-대해서"><a href="#Entity-vs-DTO-VO-국내의-myBatis와-Hibernate-사용-논쟁에-대해서" class="headerlink" title="Entity vs DTO, VO - 국내의 myBatis와 Hibernate 사용 논쟁에 대해서."></a>Entity vs DTO, VO - 국내의 myBatis와 Hibernate 사용 논쟁에 대해서.</h2><p>myBatis, Hibernate에 대한 사용빈도를 명확하게 측정할 수는 없지만, 검색 빈도로 간접적으로 사용빈도의 %를 알아볼 수 있습니다.</p>
<p><img src="/images/12/01.png" alt=""></p>
<p>전 세계적으로 <code>myBatis:Hibernate:JPA = 6:55:25</code>의 비율을 보실 수 있습니다.</p>
<p>그럼 국내는 어떨까요?</p>
<p><img src="/images/12/02.png" alt=""></p>
<p><code>myBatis:Hibernate:JPA = 70:7:26</code>의 비율을 보이고 있는 것을 보실 수 있습니다.</p>
<p>이 정도면 해외에서는 myBatis는 거의 죽은 기술입니다. 그런데 왜 국내는? 이라는 것은 상당한 논쟁을 가지고 옵니다.</p>
<p>아래는 토비의 스프링 3.1로 유명한 토비의 글입니다.</p>
<hr>
<p>내가 가장 좋아하고 많이 사용하는 자바 프레임워크는 스프링과 하이버네이트다. 거의 5년전 이 두개의 프레임워크를 처음 접했을 때의 충격과 감동은 지금도 잊혀지지 않는다. 두가지 다 내가 가졌던 오랜 고정관념을 확실히 깨뜨려주었고, 자바 프로그래머로서의 정체성을 다시금 확인할 수 있게 해주었다. 자바가 객체지향언어이며 비록 웹 개발을 한다고 할지라도 구지 ASP인지 JSP인지 구분이 안가는 JSP+스크립트성 자바코드 방식이 아닌 진정한 자바의 객체지향언어로서의 장점을 지키며 개발할 수 있다는 것을 분명 확인할 수 있었다. DB지상주의자들의 오만한 주장처럼 자바(또는 일반 프로그래밍 언어)는 그저 DB를 호출하고 UI랑 연동시켜주는데 사용하는 껍데기 인터페이스 뿐이다라는 수십년된 구닥다리 생각이 얼마나 시대에 뒤떨어지고 무지에서 나온 것인지도 분명히 깨닫게 되었다.</p>
<p>특히 하이버네이트는 당시 10년이 넘도록 매진해온 RDB의 경험과 매력을 사실 한층 더 가치있게 활용하는 법을 알려준 가장 고마운 프레임워크이다. 80년데 DBase시리즈로 출발해서 클리퍼,폭스베이스,폭스프로 등을 경험하다 93년에 처음 오라클7.3을 대형 프로젝트에서 처음 경험 했을 때 알게된 RDB의 매력과 능력이 당시에는 존재하지도 않았던 자바라는 멋진 언어와 이렇게 잘 조화되어서 양쪽의 장점을 다 살려서 빠르고 정확하고 멋지게 개발할 수 있구나라는 생각을 하게 만들어주었다. 당시 하이버네이트는 버전 2.6이었고, Gavin King이 호주 멜번에서 주로 EJB기반의 프로젝트에 참여하던 시절에 그의 매일 밤과 주말 시간을 모두 희생해서 열정적으로 개발하고 지원하던 사실상 1인 개발 프레임워크였던 시절이었다. 그럼에도 I모사의 책상 앞에서만 똑똑한 연구진들이 만들어내, 기업의 덩치로 밀어붙여 억지로 표준기술로 만들어버린 EntityBean이라는 자바역사상 가장 웃음거리가 된 기술보다 백만배쯤 낫다고 느껴졌다. 사용자들의 반응도 뜨거웠다. 결국 Gaving King은 JBoss에 영입되어 하이버네이트 개발을 책임지는 풀타임 오픈소스 개발자가 되었다.</p>
<p>그 당시 Hibernate vs JDBC와 관련된 논쟁이 많이 있었다. 그때 나름 공감을 받던 주장은 이렇다.<br>만약 애플리케이션 개발자가 DB설계를 직접 할 수 있거나, 영향력을 줄 수 있는 위치에 있다면 하이버네이트가 좋고, 아니고 DBA팀을 비롯한 애플리케이션 쪽은 전혀 모르고 DB만 고려하고 설계하거나 이미 오래전에 만들어져서 운영준인 레거시DB라는 JDBC를 선택하는 것이 낫다<br>이유가 뭘까? 왜 같은 DB이고 같은 애플리케이션이 결국 사용할 것인데 개발자들이 직접 DB를 관장하면 하이버네이트에 적합하고, 아니라면 부적합한 것일까? 어떤 이들은 이것을 하이버네이트는 객체DB스타일의 설계가 필요하기 때문에 ODB적인 구조로 DB를 특별하게 만들어야 하기 때문에 객체설계 후 그에 따른 DB스키마 작성이 필요하기 때문이라고 말한다. 하이버네이트의 기본도 모르는 바보들의 주장이다.</p>
<p>하이버네이트는 순수 객체기반 영속성 솔루션인 엔티티빈에 대한 반감과 저항으로 등장한 기술이다. 하이버네이트가 지향하는 것은 진정한 O<em>R</em>M이다. 저 R이 관계형DB의 R이라는 것을 모르지는 않을텐데 말이다. 왜 DB를 써서 ODM이라고 하지 않고 ORM이라고 구지 관계형DB라는 것을 명시했을까? 그 이유는 하이버네이트는 관계형DB와 자바의 매핑이 목적인 프레임워크이기 때문이다. 그 말은 하이버네이트에 적합하게 따로 설계된 DB가 아닌, 가장 관계형DB다운 DB라면 하이버네이트와 완벽하게 연동이 될 수 있다는 말이다.</p>
<p>레거시DB와 하이버네이트 2.x가 함께 사용하기에 부적합했던 이유는 딱 한가지이다. 무식한 DBA나 DB설계자들 탓에 정규화도 제대로 되지 않은 엉망인 구조의 DB들인 경우가 있었기 때문이다. 물론 필요에 따라 비정규화를 한 경우도 있겠지만, 국내 한 유명 DB컨설턴트의 푸념처럼 정규화를 거치지도 안고 처음부터 그냥 생각없이 퍼포먼스를 위해서라는 근거도 없는 명분으로 비정규화부터 하는 식의 엉터리 DB설계들이 판을 치기 때문이라는 것이다. 하이버네티는 2.x조차도 RDB의 바른 설계원칙을 따라 만들어진 DB라면 완벽하게 매핑시킬 수 있다.</p>
<p>또 한가지 주장은 퍼포먼스이다. ORM은 JDBC를 그대로 가져다가 사용하는 것에 비해서 분명 퍼포먼스의 손해가 있다. 하지만 이 가정은 아주 단순한 기본적인 아이디어일 뿐이다. 혹 하이버네이트 1.x라면 들어맞을지도 모르겠다. 하지만 하이버네이트는 수많은 ORM의 퍼포먼스 향상 기법을 도입했고, 단지 매핑된 객체와 하이버네이트의 기반 HQL을 이용해서 거의 완벽에 가깝게 그것이 만들어 내는 SQL을 제어할 수 있다. 초기 ORM기술의 바보같은 n+1 퀴리 문제 같은 것은 더 이상 하이버네이트에서는 아무 문제가 아니다. 모델은 그대로 1tom 이더라도 그 정보를 조인해서 한번에 가져오는 것은 아주 간단한 일이다. 혹 하이버네이트에 무지한 자들이 하이버네이트는 JDBC/SQL을 사용하지 않는 것처럼 착각하는데 하이버네이트도 결국 JDBC를 이용해서 SQL로 DB와 커뮤니케이션 한다. 숙련된 하이버네이트 개발자들은 엔티티 객체를 다루면서 그것이 백그라운드에서 만들어 내는 SQL을 완벽하게 함께 머리로 그릴 수 있는 능력이 있다. 게다가 하이버네이트는 매우 간단한 설정만으로 객체베렐, 퀴리 레벨의 다양한 캐슁을 지원한다. 그것도 분산서버에서 트랜잭션까지 지원하는 캐슁도 아무런 문제없이 지원한다. DB스타일에 따라 캐슁이 적절히 사용되면 별다른 캐슁기술을 적용하지 않은 JDBC코드와 비교해서 훨씬 나은 성능을 보여줄 수도 있다.</p>
<p>JDBC를 이용한 애플리케이션도 이전처럼 ResultSet을 jsp까지 끌어가서 화면에 바로 출력하는 미련한 짓은 하지 않을 것이다. 다 DAO레이어를 만들고, 어떤 스타일이든 DTO를 사용해서 객체에 정보를 담는다. 그런 오버헤드가 사실상 전체 퍼포먼스에 미치는 영향은 극히 미미한데다 그것으로 얻을 수 있는 개발생산성과 버그의 위험도를 줄일 수 있는 가능성등의 장점이 워낙 크기 때문에 당연히 다들 DTO를 사용한다. 그런데 왜 하이버네이트의 매핑은 무슨 엄청난 오버헤드가 있어서 별 대단한 것도 아닌 시스템에서조차 성능때문에 못쓴다라고 하는 것일까?</p>
<p>DB의 성능에 대한 요구는 DB자체의 발전만으로는 커버가 불가능하다. 경험해본 사람들은 DB의 스케일업과 아웃이 얼마나 큰 비용이 드는지는 잘 알것이다. 클러스터링이 가장 어렵고, 된다고 해도 엄청난 비용이 드는 것이 DB이다. 작년엔가 모 금융사에서 메인메모리만 수백G짜리 수십억(백억이 넘던가..) 대의 초대형 DB서버를 구입해서 콘솔리데이션 프로젝트를 했었는데 얼마나 끔찍하게 고생했는지 거기에 참여했던 컨설턴트를 통해서 들은 적이 있다. 그래서 이제는 각종 Data Grid 와 같은 분산 기술들이 자바와 같은 객체지향언어와 결합해서 엄청난 속도로 발전하고 있다. DB의 절대왕좌를 차지하고 있는 오라클 조차 Coherence의 Tangosol을 인수했다는 것을 모르는가? Coherence는 수백대의 클러스터 그리드를 이용해서 미국의 한 금융 벤치마크에서 백만 TPS를 기록했다고도 한다. 국내의 경우에도 리니어하게 스케일링되는 구조에서 노드당 1500TPS이상을 가뿐하게 기록했다고 나와있다. 리니어스케일이 되는 이런 기술들이 하이버네이트와 얼마나 잘 결합되는지는 하이버네이트-Coherence의 역사를 보면 아주 잘 알 수 있을 것이다. 시대가 이렇게 빠르게 흘러가는데 아직도 기업의 DB관리는 보수적이고 어쩌고 저쩌고 하면서 한번 배운 기술 마르고 닳도록 울궈먹기 모드로 꼭 들어가야 하는 것일까?</p>
<p>스프링의 초기에도 그랬던 것처럼 그런 이유는 무지해서 그렇다. 잘 모르거나, 어설픈 얕은 지식으로 그냥 자신의 무지를 성능탓으로 돌리는 것이다. 그것은 마치 스프링으로 개발하면 메인프레임과 연동은 불가능하다(EJB만 된다)는 헛소리와 마찬가지 주장이다.</p>
<p>다시 위의 DB설계의 책임이 누구에게 있냐에 따른 하이버네이트 적용의 판단기준을 살펴보자. 하이버네이트 팀은 저런 상황을 잘 파악하고 있었다. 그리고 이상적인 모델만 현실에 존재하지 않는다는 것을 잘 파악했다. 그래서 하이버네이트 3.0이 나온 것이다. 이미 3년 전에 말이다. 하이버네이트3.0은 정규화가 잘된 깔끔한 DB뿐 아니라 바보 DB모델러들이 어설프게 설계한 레거시 DB도 매핑하는데 아무런 문제가 없게 만들어졌다. 게다가 엔티티 단위가 아닌 각종 복잡한 프로젝션 쿼리(일명 리포트 쿼리)도 완벽하게 지원한다. 역시 객체 단위가 아닌 벌그 업데이트도 당연히 지원한다. 사실상 SQL레벨에서 하던 거의 모든 작업을 하이버네이트의 OR매핑 장점을 그대로 살린채로 다 적요할 수 있다. 심지어 DB에 아주아주 specific한 네이티브 쿼리를 사용해야 하는 경우도 얼마든지 적용된다. iBatis못지않은 SQL-객체 바인딩도 지원한다. 심지어 그 결과를 DTO가 아닌 엔티티로 가져와서 작업하는 것도 가능하다. 하이버네이트를 쓰면 못쓰는 DB특화된 SQL이 있어서라는 엉터리 주장을 하는 사람들을 보면 한심하기 짝이 없다.</p>
<p>오늘 아침에 읽은 글이다.<br>“스터디 끝나고, 간단히 식사를 하면서 왜 국내에서는 하이버네이트 보다 iBatis가 더 각광 받느냐에 대한 의견 교환이 있었습니다. 비즈니스 모델링 단계에서 개발자 혹은 설계자가 자료 구조에 대한 고민을 하고 되는데, 객체지향 분석/설계에 충실하다면 객체 모델링을 통해 도출된 데이터 구조 자체를 저장소(repository)로 손쉽게 매핑(mapping)할 수 있는 하이버네이트가 유리하다는 점에서는 동의했습니다. (사실 제 첫번째 직장이 객체형 데이터베이스 회사였기 때문에 충분히 수긍할 만한 의견이었습니다.)<br>하지만 국내 IT 현장에서 가장 큰 발언권을 가진 사람들은 개발자가 아니라 시스템 운영자들 혹은 데이터베이스 관리자들입니다. IT를 잘 모르는 경영진 입장에서는 아무래도 회사의 자산이라고 여겨지는 것이 바로 데이터베이스이고 프로그램은 덜 중요해 보이거든요. 그러다 보니, 시스템 개발 현장에서 가장 먼저 그리고 중요하게 분석/설계되는 것은 업무 요건이 아니라 바로 데이터베이스 설계입니다. 데이터 구조가 먼저 설계되고 쿼리를 만들고 그 위에 어플리케이션을 탑재하는 순서로 개발하니 당연히 하이버네이트는 적합한 프레임워크로 고려될 수 없게 되는 것입니다.”<br>제대로 DB설계가 된다면 왜 그것이 하이버네이트에는 적합하지 않다는 말인가? 참 답답하다. 이 글을 읽다가 답답한 마음이 들어 이 글을 쓰기 시작했다.</p>
<p>물론 나도 하이버네이트가 모든 곳에 항상 적용가능하고 낫다고 보지는 않는다. 예를 들어, DB는 간단하고 부하만 큰 포탈의 게시판, 블로그 등은 ORM이 적합한 곳이 당연히 아니다. 객체 매핑 해봐야 무슨 이득이 있겠는가. 사실상 저런데는 RDB조차 적합하지 않다. 4억명의 회원을 보유한 ebay는 잘 알려진대로 DB트랜잭션조차 사용하지 않는다고 한다. 올바른 선택이다. 또 데이터의 입출력은 거의 없는 분석위주의 OLAP시스템도 하이버네이트 쓰는 것이 불가능하지는 않으나 별 장점이 없다. 그럴땐 OLAP쿼리 관리나 깔끔히 하면서 iBatis 같은게 낫다고 하겠다. 고객이 정말 무식과 고집을 겸비하고 있는데다, 밉보이면 향후 프로젝트에 지장이 있을 것 같은데 무조건 JDBC기반 DAO를 쓰겠다고 주장하면 살금살금 꼬셔서 SpringJDBC정도만 어찌 도입해보는게 나을 것이다. 정치적인 이유지만 어쨌든 시스템을 원활히 개발하기 위한 어쩔 수 없는 선택이 있다는 것도 안다. 또 애플리케이션은 DB의 인터페이스 용으로만 쓰고 모든 로직이 다 Stored Procedure에 저장되어있는 구닥다리 시스템이고 그것을 고칠 마음이 전혀 없다면 역시 하이버네이트는 선택의 대상이 아니다. 하지만 그 외의 모든 경우라면 하이버네이트는 충분히 적합하고 적용할 수 있고 많은 장점이 있다. 하지만 개발자들이 먼저 나서서 하이버네이트는 성능이 어쩌고, 적합하지 않아서 어쩌고 하는 것은 정말 아니다. 제대로 검증해보고 타당한 증몀을 해봤는가? 장단점을 충분히 진지하게 따져봤는가?</p>
<p>대형사이트? 더욱 더 적극 도입해야 한다. 물론 개발자가 많으면 평균 수준이 떨어지고, 각자 가진 기술수준이 차이가 많이 나서 기술수준 자체를 낮춰야 할 수도 있겠다. SQL만 달랑 넣으면 DTO부터 전 레이어의 기본코드가 딱 만들어지는 초간단 툴들이 요즘 인기있는 이유가 그것이라고 한다. 그만큼 다른 많은 것을 손해를 보고 가야함은 당연한 것이지만. 그렇다고 언제고 SQL만 알고 자바 문법만 아는 사람들로만 시스템 개발을 할 것인가? 오픈소스는 안돼라고 외치던 많은 곳에서 이미 스트럿츠1을 시작으로 이미 스프링과 iBatis 같은 고급 프레임워크 까지 적용이 이뤄지고 있다. 적절한 전략과 충분한 준비와 시간이 있다면 얼마든지 도입 할 수 있다. 개발자가 많으면 구현방식의 통일이 어렵고, 버그의 발생가능성이 높아진다. 하이버네이트와 같은 자바에 충실한 개발방식이 얼마나 개발자의 스트레스를 덜어주고, 생산성을 높이며 버그발생을 줄여주고, DB와 자바, UI까지 왔다갔다 정신없는 것을 충실하게 자바 모델에만 집중해서 개발할 수 있게 해주는지 안다면, 대형사이트일 수록 과감한 도입이 필요할지도 모른다. 그 비싸고 많은 모델러와 컨털선트는 왜 쓰는데…</p>
<p>내가 실무 프로젝트를 초기에 경험 할때는 코볼에 ISAM에 익숙한 노땅 개발자들의 전성시대에서 RDB와 같은 신기술이 막 떠오르려고 하던 때이다. 또 틈새를 비집고 UniSQL과 같은 허접 ODB도 설쳐대던 때다. 그때 ISAM에 익숙한 선배 개발자들의 푸념이 기억난다. 메인프레임에서 ISAM으로 했으면 이 정도는 순식간에 완벽하게 착착 다 만들었을 텐데 이게 무슨 장난감 같은 유닉스에, 복잡한 언어인 C에, 배우기도 힘든 3-Tier기술에, 성능도 떨어지는 RAD툴에 RDB까지 정신이 없다고 투덜대던 시절이다. 왜 복잡하고 지저분한 SQL을 이용하는, ISAM에 비해 성능도 떨어지는 RDB를 써야 하냐는 그때 그 사람들의 모습이 바로 지금 SQL에 익숙한데 왜 하이버네이트와 같은 새로운 기술을 또 공부해야 하냐라고 저항하는 개발자들의 모습과 꼭 닮았다.</p>
<p>물론 하이버네이트가 좋으니 당장 바꿔라라고 말하고 싶지 않다. 심지어 하이버네이트 사이트에도 프로젝트 1개월 남았는데 갑자기 하이버네이트로 바꾸자 따위의 생각은 꿈도 꾸지 마라라고 FAQ에 나와있었다. 개발 패러다임의 변화이니 충분한 시간을 가지고 학습하고 최적화된 기술을 익히는 과도기를 거쳐야 할 것이다. 그런 이유에서라면 당장 도입을 지연하는 것은 이해한다. 하지만 별 것도 아닌 중소형 사이트에 시간도 있고, 새로운 프레임워크도 익힌다면서 하이버네이트는 “그거 한국에서는 안돼”라는 말로 아무런 근거도 검증도 없이 그냥 iBatis나 쓰자라는 식으로 가는 모습은 정말 안타깝다. 제발이지 좀 근거를 가지고 구체적으로 비판을 하려면 했으면 좋겠다. 제발이지 나도 화딱지 나서 외국의 개발자들에게 “한국 개발자들은 무식하고 겁쟁이라 하이버네이트는 쓸 줄도 모릅니다”라고 하지 않도록…</p>
<hr>
<p>이만입니다. 제 의견을 많이 집어넣지는 않도록 하겠습니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/jpa-modeling-orm-mybatis/">jpa, modeling, orm, mybatis</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/03/22/db-summary/"><span>11. DB Application Summary</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/03/22/db-summary/" rel="bookmark">
        <time class="entry-date published" datetime="2018-03-21T23:14:19.000Z">
          2018-03-22
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="DB-Application-Summary"><a href="#DB-Application-Summary" class="headerlink" title="DB Application Summary"></a>DB Application Summary</h1><p>지금까지 우리는 DB에 접속을 하고, DB에 있는 내용을 이용해서 Service를 구성하는 방법에 대해서 알아봤습니다.<br>기술들은 다들 자신만의 색깔을 가지고, 개발자들을 좀 더 편하게 하기 위해서 발전되어 왔습니다. 그렇기 때문에 개발자들마다 자신이 선호하는 기술들이 따로 있는 것이고요.<br>그렇지만, 우리가 지금까지 Model을 하는 부분에 대해서는 한가지만은 확실히 나올 수 있습니다.</p>
<p>“각자의 영역으로 분리”</p>
<p>이것은 DB를 다루는 Model 뿐 아니라, 모든 객체와 개발에서의 Layer가 지켜야지 되는 원칙이라고 할 수 있습니다.</p>
<p>일반적으로 우리가 사용한 Model은 다음과 같은 package로 나뉠 수 있습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">com.xyzlast.bookstore.entity</span><br><span class="line">com.xyzlast.bookstore.vo</span><br><span class="line">com.xyzlast.bookstore.dto</span><br><span class="line">com.xyzlast.bookstore.dao</span><br><span class="line">com.xyzlast.bookstore.repositories</span><br><span class="line">com.xyzlast.bookstore.services</span><br></pre></td></tr></table></figure>
<p>먼저, 지금까지 설명하고 있던 내용중에서 용어의 혼란을 가지고 오던 <code>DAO</code>와 <code>Repository</code>의 차이를 좀 더 깊게 알아보도록 하겠습니다.</p>
<h2 id="DAO-vs-Repository"><a href="#DAO-vs-Repository" class="headerlink" title="DAO vs Repository"></a>DAO vs Repository</h2><p><code>DAO(Data Access Object)</code>와 <code>Repository</code>는 기술적으로 동일한 기능을 갖습니다.</p>
<blockquote>
<p>Persistence 영역에 대한 접근 수단</p>
</blockquote>
<p>그런데, 이 두 객체는 사용되는 영역이 다릅니다. <code>DAO</code>의 경우, 용어 그대로 <code>어디서나 접근 가능한 데이터 영역</code>으로 된다면, <code>Repository</code>는 서비스영역에서 사용되며, <code>Repository</code>에서 반환되는 객체들은 우리가 개발하는 <code>DOMAIN</code>의 객체들을 사용하게 됩니다. 조금 말이 어렵습니다.</p>
<p><code>DAO</code>는 Service 이외에도 사용이 가능하며, 이는 <code>Service</code> 이외에도 사용이 가능하며, 모든 Transaction은 기본적으로 DAO를 기반으로 하게 됩니다. 그렇지만, Repostiory는 <code>Service</code>에서만 사용이 되며 Transaction은 제공되지 않고, <code>Service</code>에서 제공되는 <code>Transaction</code>을 기반으로 하게 됩니다.</p>
<h2 id="Packages"><a href="#Packages" class="headerlink" title="Packages"></a>Packages</h2><h3 id="entity-package"><a href="#entity-package" class="headerlink" title="entity package"></a>entity package</h3><p>Hibernate와 같은 ORM framework를 사용하는 경우, object와 persistence model간의 관계를 구성한 ORM 객체가 위치하는 영역입니다. 또는 Table에 1:1 mapping을 해서 구성하는 경우도 있습니다. 그렇지만, entities를 사용한다는 것은 기본적으로 DDD를 사용하는 것과 동일합니다. 객체과 그 객체의 관계에 대한 구성을 코드에 녹여내는 방식을 주로 사용하게 됩니다.</p>
<h3 id="vo-package-dto-package"><a href="#vo-package-dto-package" class="headerlink" title="vo package / dto package"></a>vo package / dto package</h3><p>vo(value object), dto(data transfer object)의 경우에는 일반적으로 persistence model에서 넘어오는 값들을 단순 parsing할 때 사용됩니다. 여기에 가장 대표적인 기술로 mybatis를 소개하였고, 이는 db에서 얻어오는 값을 view에서 단순 표시하기 위한 방법으로도 자주 사용하게 됩니다.<br>이 두 package는 myBatis를 Domain Layer의 Framework로 사용하는 경우에는 거의 필수로 사용됩니다. 또는 개발시에 Model 영역에서 Controller/View 로 데이터를 넘길때, DTO 객체를 만들어서 넘길때 사용되기도 합니다. 이때는 vo가 View/Value Object의 의미로 사용되기도 합니다.</p>
<h3 id="dao"><a href="#dao" class="headerlink" title="dao"></a>dao</h3><p>직접 DB에 query를 보내고, vo, dto를 얻어오는 영역입니다. DB를 사용하는 기술에 따라 다르게 구성이 되는 것이 일반적이며, CRUD에 대한 모음으로도 구성될 수 있습니다. 단순 CRUD가 이루어진다고 해도, DB에 대한 기술적 영역이 바뀌게 될 가능성은 항상 열어두고 작업을 하는 것이 좋을 것 같습니다. 그렇기 위해서는 interface로 정의된 dao를 사용하는 것이 보다더 효과적으로 구성이 가능하게 됩니다. dao로 지정하게 되는 것은 controller, domain 모두에서 dao를 사용하겠다는 의미입니다. Hibernate와 같은 ORM을 사용하는 경우에는 repository pattern으로 접근하는 것이 더 좋습니다.</p>
<h3 id="repositories"><a href="#repositories" class="headerlink" title="repositories"></a>repositories</h3><p>Repository는 Dao와 매우 유사한 개념입니다. 이 두 용어의 차이점은 기능이 아닌, 사용되는 코드의 위치입니다. Domain Layer에서만 사용되는 경우에는 repository, Domain뿐 아니라 모든 영역에서 사용된다면 dao로 개발하게 됩니다. 이 둘의 차이는 Model을 풀어가는 pattern의 차이입니다. 보다더 pattern 상위적인 개념이 Repository이고, Dao는 database 적 개념이 강한 Object라고 생각하면 좀 더 이해가 쉬울 것 같습니다.</p>
<h3 id="services"><a href="#services" class="headerlink" title="services"></a>services</h3><p>business logic 영역입니다. 여러개의 dao object들과 entity 또는 vo/dto object들을 얻어내고, 그 객체들간의 로직이 구성되는 영역입니다. 일반적으로 transaction의 단위 영역이 된다는 것을 명심해주세요.<br>위의 구성에서 결국은 model은 3개 이상의 package로 구성이 됨을 알 수 있습니다. 남의 코드를 보더라도 대부분 위와 비슷한 구성으로 package가 구성된 경우가 많으니 참고바랍니다.</p>
<h2 id="Persistence-Framework-Layer의-비교"><a href="#Persistence-Framework-Layer의-비교" class="headerlink" title="Persistence Framework Layer의 비교"></a>Persistence Framework Layer의 비교</h2><p>다음은 지금까지 알아본 Model을 접근하는 Framework의 조합에 대해서 한번 정리해보도록 하겠습니다.</p>
<table>
<thead>
<tr>
<th>방법</th>
<th>특징</th>
<th>장점</th>
<th>단점</th>
</tr>
</thead>
<tbody>
<tr>
<td>No Framework - <br>PreparedStatement<br>이용하는 방법</td>
<td>1. Native Query 구성</td>
<td>1. native query를 이용한 학습 시간의 단축</td>
<td>1.오타가 발생하는 경우, query를 실행하기 전까지 에러를 확인할 수 없다.<br>2.중복 코드가 많이 발생된다.<br>3.connection의 관리를 비롯한 Transaction의 처리를 모두 수동으로 해줘야지 된다.<br>4.java 코드에 sql 코드가 들어가기 때문에 관리 및 debug가 힘들다.</td>
</tr>
<tr>
<td>JdbcTemplate</td>
<td>1.Spring JdbcTemplate 이용<br>2.DataSource 이용<br>3.Native Query</td>
<td>1.native query를 이용한 학습 시간의 단축<br>2.connection 관리<br>3.Transaction 관리</td>
<td>1.오타가 발생한 경우, query를 실행하기 전까지 에러를 확인할 수 없다.<br>2.중복 코드가 많이 발생된다.<br>3.java 코드에 sql 코드가 들어가기 때문에 관리 및 debug가 힘들다.</td>
</tr>
<tr>
<td>myBatis (iBatis)</td>
<td>1.Native Query<br>2.DataSource<br>3.ibatis-spring 이용</td>
<td>1.국내의 많은 사용자<br>2.sql query의 관리를 하는 것이 가능하다.</td>
<td>1.객체가 아닌 VO type의 이용으로 인한, 프로그램 architecture의 발전 가능성이 낮아짐<br>2.java 언어 뿐 아니라, sql 로의 확장으로 인하여 관리 코드가 늘어남</td>
</tr>
<tr>
<td>Hibernate</td>
<td>1.HQL, Criteria<br>2.DataSource<br>3.Spring Transaction</td>
<td>1.다양한 reference<br>2.객체를 이용한 query의 처리로 인하여, 코드양을 줄일 수 있다.<br>3.프로그램 설계 및 구성 부분에 대해서 장점을 갖는다.<br>(DDD와 같은 객체 지향적 구성 가능)<br>4.Table의 변경 또는 DB의 변경에 유연한 장점을 갖고 있다.<br>5.동적 query가 자유스럽다.</td>
<td>1.학습 시간의 소요<br>2.criteria, HQL 모두 오타에 취약한 구조</td>
</tr>
<tr>
<td>Hibernate + queryDSL</td>
<td>1.JQL, Criteria<br>2.DataSource<br>3.type-safe<br>4.code generate</td>
<td>1.다양한 reference<br>2.객체를 이용한 query의 처리로 인하여, 코드양을 줄일 수 있다.<br>3.프로그램 설계 및 구성 부분에 대해서 장점을 갖는다.<br>(DDD와 같은 객체 지향적 구성 가능)<br>4.Table의 변경 또는 DB의 변경에 유연한 장점을 갖고 있다.<br>5.오타가 발생할 수 없는 type-safe 한 query를 작성할 수 있다.<br>6.sql query와 비슷한 문법으로, 학습에 도움을 줄 수 있다.</td>
<td>1.학습시간의 소요<br>2.단순 CRUD에 대한 코드양 증가<br>3.설정이 까다롭다.</td>
</tr>
<tr>
<td>Hibernate + JPA +<br>queryDSL + Spring Data JPA</td>
<td>1.JQL, Criteria<br>2.DataSource<br>3.type-safe<br>4.code generate</td>
<td>1.JPA - java 표준<br>2.객체를 이용한 query의 처리로 인하여, 코드양을 줄일 수 있다.<br>3.프로그램 설계 및 구성 부분에 대해서 장점을 갖는다. (DDD와 같은 객체 지향적 구성 가능)<br>4.Table의 변경 또는 DB의 변경에 유연한 장점을 갖고 있다.<br>5.오타가 발생할 수 없는 type-safe 한 query를 작성할 수 있다.<br>6.sql query와 비슷한 문법으로, 학습에 도움을 줄 수 있다.<br>7.CUD, select 문의 코딩양이 현격하게 줄어든다.<br>8.Hibernate 코드 역시 사용 가능하고 유연한 방법으로 대처가 가능하다.<br>9.Repository Interface code에 의한 가독성 향상</td>
<td>1.학습 시간의 소요<br>2.설정이 까다롭다.</td>
</tr>
</tbody>
</table>
<p>지금 전 이정도로 정리를 해봤는데, 다른 분들은 어떻게 정리를 할 수 있을까요? 각 방법에 대한 장/단점을 파악하는 것이 중요합니다. 적어도 이곳에 있는 분들만이라도요.<br>그리고, 만약에 외부 Project에 참여하게 되는 경우에는, 그 Project에 맞는 개발 방법을 이용해서 개발을 하는 것이 중요합니다.</p>
<h2 id="Web-Application에서의-데이터-흐름"><a href="#Web-Application에서의-데이터-흐름" class="headerlink" title="Web Application에서의 데이터 흐름"></a>Web Application에서의 데이터 흐름</h2><p>Domain Model을 이용해서 Web Application을 구성하는 방법은 두가지가 있습니다. 원칙을 지키고자 하는 <code>Pure Domain Model</code>과 Domain Model의 자유로운 사용이 특징인 <code>Domain Model Everywhere</code>입니다.<br>먼저 Domain Model Everywhere에 대해서 알아보도록 하겠습니다.</p>
<h3 id="Domain-Model-Everywhere"><a href="#Domain-Model-Everywhere" class="headerlink" title="Domain Model Everywhere"></a>Domain Model Everywhere</h3><p><img src="/images/11/01.png" alt=""></p>
<p>Repository, Service, Controller, View가 모두 Entity Model을 가지고 동작하는 방식입니다. 이 방식은 Domain의 Entity 객체가 Repository 뿐 아니라, Controller, View에 표현되는 방법까지 가지게 되게 됩니다. 이렇게 되면 Entity Model이 매우 커지게 됩니다. 그리고 객체의 “단일책임원칙”을 위반하게 되는 단점을 가지고 있습니다. 이 방법의 장단은 다음과 같습니다.</p>
<p>장점 :</p>
<ul>
<li>개발하기에 빠르고 편리함</li>
</ul>
<p>단점 :</p>
<ul>
<li>복잡한 View의 표현이 매우 힘듭니다.</li>
<li>Domain Model에서 View Logic이 포함되기 때문에 Domain Model의 순수성이 떨어지고 객체의 단일 책임원칙을 위반하게 됩니다.</li>
<li>REST 서버와 같이 외부와의 통신 API에 사용하게 되는 경우에는 Domain Model이 변경되면 API가 바뀌게 되기 때문에 큰 문제를 야기할 수 있습니다.</li>
</ul>
<h3 id="Pure-Domain-Model"><a href="#Pure-Domain-Model" class="headerlink" title="Pure Domain Model"></a>Pure Domain Model</h3><p><img src="/images/11/02.png" alt=""></p>
<p>Domain Model은 서비스와 Repository에서만 사용하고, Controller와 View에서는 DTO를 새로 만들어서 사용하는 방법입니다. 이는 Domain의 순수성을 지키게 되는 큰 장점을 가지고 있습니다. View에서만 DTO를 사용하는 것이 BL의 변화에 따른 View의 변경을 격리할 수 있는 좋은 방법이 됩니다.</p>
<p>장점 :</p>
<ul>
<li>순수한 Domain Model - 객체지향적인 OOP 모델</li>
</ul>
<p>단점</p>
<ul>
<li>DTO를 따로 만드는 것이 귀찮고, 성가시고, 괴롭다.</li>
<li>DTO는 또 다른 중복 코드를 만들어낸다.</li>
<li>DTO와 Domain Model간의 Convert를 따로 만들어줘야지 된다.</li>
</ul>
<p>Domain Model Everywhere pattern의 경우에는 anti-pattern이라고도 말하는 사람이 있을정도로 호불호가 매우 강하게 갈리는 pattern중 하나입니다. 개인적으로도 최대한 Pure Domain Model을 이용해서 개발하는 것이 좋다고 생각합니다.</p>
<p>…………………………………………………………………. 현실은 ? OTL</p>
<p>지금까지 개발을 해본 결과. 다음과 같은 상황에서는 반드시 DTO를 사용해야지 됩니다.</p>
<ul>
<li><p>REST 서버와 같은 API의 response.</p>
<blockquote>
<p>Domain Model은 자주 바뀔 수 있습니다. 그렇지만, client와 통신을 하게 되는 API의 response는 바뀌면 문제가 생기게 됩니다. 따라서 이 둘은 반드시 분리를 해야지 됩니다.</p>
</blockquote>
</li>
<li><p>여러 Domain Model이 결합되어서 만들어지는 새로운 View에 대한 DTO</p>
<blockquote>
<p>View가 너무너무나 복잡해서 서로간에 연관성이 없는 Domain Model을 response로 보내줘야지 되는 경우에는 DTO를 만드는 것이 좋습니다.</p>
</blockquote>
</li>
</ul>
<p>이 두가지 경우를 제외하고….. DTO를 모두 만드는 것은 다음과 같은 문제가 발생합니다.</p>
<ul>
<li>객체가 너무 많이 만들어집니다. 지금 DataWindow의 package와 같이 각 SP의 숫자만큼의 package같이 객체들이 구성되게 됩니다. 이는 객체의 naming rule 및 관리가 매우 힘들어지는 결과를 가지고 옵니다.</li>
<li>많이 만들어진 객체 숫자 만큼의 Converter가 필요합니다. Domain Model을 DTO로 바꿔주고 DTO를 Domain Model로 바꿔주는 Convert 숫자가 필요하게 됩니다.</li>
<li>위 이유로 관리 포인트가 3개로 늘어나게 됩니다. - Domain Model, DTO, Converter</li>
</ul>
<p><strong>배보다 배꼽이 더 큰 사태가 발생할 수 있습니다. Domain Model Everywhere가 절대로 좋은 것은 아닙니다. 그렇지만 개발 시간과 관리 포인트를 생각해서 Domain Model Everywhere로 만들고, 그 객체들을 차츰차츰 DTO로 변환시켜가는 과정이 Application을 더욱더 깔끔하게 만드는 과정이 되게 된다고 생각합니다.</strong></p>
<p>결론입니다.</p>
<ul>
<li>처음에는 Domain Model Everywhere로 Project를 시작합니다.</li>
<li>Domain Model로 처리하기 힘든 경우에는 DTO를 사용해서 객체의 변환을 합니다.</li>
<li>최대한 Pure Domain Model을 유지하기 위해서 계속 노력합니다.</li>
</ul>
<blockquote>
<p>Domain Model Everywhere를 지원하기 위해서 Spring은 JPA Model Object를 위한 OpenEntityManagerInViewFilter와 Hibernate를  위한 OpenSessionInViewFilter를 지원하고 있습니다.</p>
</blockquote>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/spring-jpa/">spring, jpa</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/03/15/jpa/"><span>10. JPA</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/03/15/jpa/" rel="bookmark">
        <time class="entry-date published" datetime="2018-03-14T15:51:30.000Z">
          2018-03-15
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>Java Persistence API의 약자입니다.<br>영속성객체에 대한 java의 접근방법을 정의한 API로, 객체를 통한 Persistence 영역으로 접근방법을 정의하고 있습니다.<br>객체를 통한 Persistence 영역에 대한 접근을 하기 위해, 사용되는 것이 ORM Framework 들이고, 그중에서 가장 선두를 달리고 있는 것이 Hibernate입니다.</p>
<h2 id="JPA-vs-Hibernate"><a href="#JPA-vs-Hibernate" class="headerlink" title="JPA vs Hibernate"></a>JPA vs Hibernate</h2><p>Hibernate와 JPA간의 차이를 한번 알아보도록 하겠습니다.</p>
<table>
<thead>
<tr>
<th>방법</th>
<th>Hibernate</th>
<th>JPA</th>
</tr>
</thead>
<tbody>
<tr>
<td>DB에 대한 접근(DataSource)</td>
<td>SessionFactory</td>
<td>EntityManagerFactory</td>
</tr>
<tr>
<td>DB의 query executor</td>
<td>Session</td>
<td>EntityManager</td>
</tr>
<tr>
<td>INSERT 대응 method</td>
<td>save, saveOrUpdate</td>
<td>merge</td>
</tr>
<tr>
<td>UPDATE 대응 method</td>
<td>update, saveOrUpdate</td>
<td>merge</td>
</tr>
<tr>
<td>DELETE 대응 method</td>
<td>delete, remove</td>
<td>remove</td>
</tr>
<tr>
<td>query 적용 방법</td>
<td><del>Criteria</del>, HQL (Hibernate query Language), Native SQL</td>
<td>Criteria, JPQL (java persistence query language), Native SQL</td>
</tr>
</tbody>
</table>
<p>접근 하는 방식은 거의 1:1로 동일합니다. 다만 query의 적용방법에서 차이를 보이게 되는데요. JPQL이 JPA의 표준이 되면서, 기존 Hibernate에서 주로 사용되고 있던 Criteria/HQL을 거의 사용하지 않습니다. 현 Hibernate 5.0 이상에서는 <code>Creteria</code>와 <code>HQL</code>은  <code>deprecated</code>되었습니다.</p>
<p>먼저 <code>JPA</code>를 구현하는 방법에 대해서 알아보도록 하겠습니다. 이는 <code>JAVA</code>의 표준기술입니다. 잘 알아둘 필요가 있습니다.<br>dependency는 다음과 같습니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">compileOnly <span class="string">group:</span> <span class="string">'org.projectlombok'</span>, <span class="string">name:</span> <span class="string">'lombok'</span>, <span class="string">version:</span> <span class="string">'1.16.18'</span></span><br><span class="line"></span><br><span class="line">compile <span class="string">'com.google.guava:guava:23.0'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'com.fasterxml.jackson.core'</span>, <span class="string">name:</span> <span class="string">'jackson-databind'</span>, <span class="string">version:</span> <span class="string">'2.9.3'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.mariadb.jdbc'</span>, <span class="string">name:</span> <span class="string">'mariadb-java-client'</span>, <span class="string">version:</span> <span class="string">'2.2.0'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.hibernate'</span>, <span class="string">name:</span> <span class="string">'hibernate-core'</span>, <span class="string">version:</span> <span class="string">'5.2.12.Final'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.hibernate'</span>, <span class="string">name:</span> <span class="string">'hibernate-entitymanager'</span>, <span class="string">version:</span> <span class="string">'5.2.12.Final'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.hibernate.javax.persistence'</span>, <span class="string">name:</span> <span class="string">'hibernate-jpa-2.1-api'</span>, <span class="string">version:</span> <span class="string">'1.0.0.Final'</span></span><br><span class="line"></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'com.zaxxer'</span>, <span class="string">name:</span> <span class="string">'HikariCP'</span>, <span class="string">version:</span> <span class="string">'2.7.4'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-context'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-orm'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br><span class="line"></span><br><span class="line">testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line">testCompile <span class="string">'org.assertj:assertj-core:3.8.0'</span></span><br><span class="line">testCompile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-test'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br></pre></td></tr></table></figure>
<p>JPA는 표준 API로서, 기존에 <code>de facto</code>로 사용되고 있던 <code>Hibernate</code>와 거의 완벽하게 동일합니다. <code>@Configuration</code>은 다음과 같이 구성됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(value = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.repository"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">        dataSource.setMaximumPoolSize(<span class="number">10</span>);</span><br><span class="line">        dataSource.setMinimumIdle(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title">entityManagerFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">"hibernate.dialect"</span>, <span class="string">"org.hibernate.dialect.MariaDB53Dialect"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"hibernate.show_sql"</span>, <span class="string">"true"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"hibernate.id.new_generator_mappings"</span>,<span class="string">"false"</span>);</span><br><span class="line"></span><br><span class="line">        LocalContainerEntityManagerFactoryBean em = <span class="keyword">new</span> LocalContainerEntityManagerFactoryBean();</span><br><span class="line">        em.setDataSource(dataSource());</span><br><span class="line">        em.setPackagesToScan(<span class="string">"com.xyzlast.bookstore.entity"</span>);</span><br><span class="line"></span><br><span class="line">        JpaVendorAdapter vendorAdapter = <span class="keyword">new</span> HibernateJpaVendorAdapter();</span><br><span class="line">        em.setJpaVendorAdapter(vendorAdapter);</span><br><span class="line">        em.setJpaProperties(properties);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> em;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JpaTransactionManager jpaTransactionManager = <span class="keyword">new</span> JpaTransactionManager();</span><br><span class="line">        jpaTransactionManager.setEntityManagerFactory(entityManagerFactoryBean().getObject());</span><br><span class="line">        jpaTransactionManager.setDataSource(dataSource());</span><br><span class="line">        <span class="keyword">return</span> jpaTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PersistenceExceptionTranslationPostProcessor <span class="title">exceptionTranslation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PersistenceExceptionTranslationPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>기존의 <code>SessionFactoryBean</code>과 <code>HibernateTransactionManager</code>, <code>HibernateExceptionTranslationPostProcessor</code>가 각각 <code>EntityManagerFactoryBean</code>, <code>JpaTransactionManager</code>, <code>PersistenceExceptionTranslationPostProcessor</code>로 변경되게 됩니다.<br>주의해서 보실 내용은 <code>HibernateJpaVendorAdapter</code>입니다. 이는 JPA 표준을 따르는 <code>Vendor</code>를 지정해줍니다. Hibernate에서 제공하는 Vendor Adapter입니다.</p>
<table>
<thead>
<tr>
<th>Hibernate</th>
<th>JPA</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td>SessionFactoryBean</td>
<td>EntityManagerFactoryBean</td>
<td>DB 접근방법</td>
</tr>
<tr>
<td>HibernateTransactionManager</td>
<td>JpaTransactionManager</td>
<td>Transaction 관리자</td>
</tr>
<tr>
<td>HibernateExceptionTranslationPostProcessor</td>
<td>PersistenceExceptionTranslationPostProcess</td>
<td>DB내에서 발생된 Exception의 Converter</td>
</tr>
</tbody>
</table>
<p>지금 <code>JPA</code>에 적합한 Framework는 2개입니다. <code>Hibernate</code>와 <code>EclipseLink</code>가 있습니다.</p>
<table>
<thead>
<tr>
<th>JpaVendorAdaptor</th>
<th>Hibernate</th>
<th>EclipseLink</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>HibernateJpaVendorAdapter</td>
<td>EclipseLinkJpaVendorAdapter</td>
</tr>
</tbody>
</table>
<p><code>BookDao</code>의 구성은 다음과 같이 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title">BookDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PersistenceContext</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager em;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> em.createQuery(<span class="string">"SELECT COUNT(*) FROM Book"</span>, Long.class).getSingleResult().intValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> em.createQuery(<span class="string">"FROM Book"</span>, Book.class).getResultList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> em.find(Book.class, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        em.merge(book);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        em.merge(book);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        em.remove(book);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        em.createQuery(<span class="string">"DELETE FROM Book"</span>).executeUpdate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hibernate의 <code>Session</code>을 이용하는 코드와 거의 유사합니다. 단 차이가 있다면 생성자로 <code>SessionFactory</code>를 전달했던 코드가 <code>@PersistenceContext</code>로 바뀌는 차이가 있습니다. 이는 JPA에 정의된 annotation으로 PersistenceContext의 주입을 지정합니다.</p>
<h2 id="Querydsl"><a href="#Querydsl" class="headerlink" title="Querydsl"></a>Querydsl</h2><p>ORM을 통해서, 우리는 RDBMS를 OOP적 사상으로 옮기는 것이 가능해졌습니다. 그렇지만, <code>FROM Book</code>과 같은 <code>JPQL</code>이라는 문자열식 query에 종속되고 있는 것이 사실입니다. 또한, <code>Entity</code>의 변경시에 문자열식 query는 변경되지 않기 때문에, 실행하기 전까지 오류를 찾아낼 수 없습니다. 그리고, 문법이 꽤나 복잡한 것이 사실입니다.</p>
<p>개발상 요구사항은 계속해서 바뀌게 되고, 개발도중에는 Schema가 계속해서 변경되게 되는 것이 사실입니다. 그때마다 <code>JPQL</code>에 문제가 있는지를 확인하는 것은 빼먹기쉬운 부분입니다. Querydsl은 <code>Entity</code>객체와 연동되는 ‘Q-class`라는 query 객체를 생성하고, 이를 통해서 query를 만들어내게 됩니다. 이를 통해 Entity의 변경에 따른 query문제를 없앨 수 있으며, Query의 동적인 생성을 원활하게 합니다.</p>
<p>Querydsl에서의 query pattern은 .NET의 linq 사상을 옮겨왔습니다.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> queryLondonCustomers = <span class="keyword">from</span> cust <span class="keyword">in</span> customers</span><br><span class="line">                           <span class="keyword">where</span> cust.LastName.startsWith(<span class="string">'A'</span>) &amp;&amp; cust.active</span><br><span class="line">                           <span class="keyword">orderby</span> cust.lastName <span class="keyword">ascending</span></span><br><span class="line">                           <span class="keyword">orderby</span> cust.firstName <span class="keyword">descending</span></span><br><span class="line">                           <span class="keyword">select</span> cust;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Customer&gt; result = query.from(customer)</span><br><span class="line">    .where(customer.lastName.like(<span class="string">"A%"</span>), customer.active.eq(<span class="keyword">true</span>))</span><br><span class="line">    .orderBy(customer.lastName.asc(), customer.firstName.desc())</span><br><span class="line">    .list(customer);</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> customer <span class="keyword">where</span> lastname <span class="keyword">like</span> <span class="string">'A%'</span> <span class="keyword">and</span> active = <span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> lastname <span class="keyword">asc</span>, firstname <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<p>보시면 query문과 매우 비슷한 구조를 가지고 있습니다.<br>Querydsl은 <code>EntityManager</code>를 한번 더 감싸서 얻을 수 있는 <code>JPAQuery</code>와 <code>Q-class</code>라는 Query 객체화 class를 이용합니다.</p>
<ul>
<li>Hibernate ORM 규칙에 따른 JPA annotation을 이용한 객체 정의</li>
<li>generate Q-class</li>
<li>Query Definition을 이용한 query 작성</li>
</ul>
<p>기존 JPA Project를 QueryDsl을 지원하는 프로젝트로 변경해보도록 하겠습니다.<br>먼저, <code>Querydsl</code>을 지원하기 위한 dependency 적용은 다음과 같습니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'com.querydsl'</span>, <span class="string">name:</span> <span class="string">'querydsl-apt'</span>, <span class="string">version:</span> <span class="string">'4.1.4'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'com.querydsl'</span>, <span class="string">name:</span> <span class="string">'querydsl-jpa'</span>, <span class="string">version:</span> <span class="string">'4.1.4'</span></span><br></pre></td></tr></table></figure>
<p>Querydsl을 지원하기 위한 <code>Q-Class</code>를 생성하기 위해 <code>build.gradle</code>에 새로운 <code>task</code>를 추가합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sourceSets &#123;</span><br><span class="line">    main &#123;</span><br><span class="line">        java &#123;</span><br><span class="line">            srcDirs <span class="string">'src/main/java'</span>, <span class="string">'src/main/generated'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task generateQueryDSL(<span class="string">type:</span> JavaCompile, <span class="string">group:</span> <span class="string">'build'</span>, <span class="string">description:</span> <span class="string">'Generates the QueryDSL query types'</span>) &#123;</span><br><span class="line">    file(<span class="keyword">new</span> File(projectDir, <span class="string">"/src/main/generated"</span>)).deleteDir()</span><br><span class="line">    file(<span class="keyword">new</span> File(projectDir, <span class="string">"/src/main/generated"</span>)).mkdirs()</span><br><span class="line">    source = sourceSets.main.java</span><br><span class="line">    classpath = configurations.compile + configurations.compileOnly</span><br><span class="line">    options.compilerArgs = [</span><br><span class="line">            <span class="string">"-proc:only"</span>,</span><br><span class="line">            <span class="string">"-processor"</span>, <span class="string">"com.querydsl.apt.jpa.JPAAnnotationProcessor"</span></span><br><span class="line">    ]</span><br><span class="line">    destinationDir = file(<span class="string">'src/main/generated'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>최종적으로 다음 gradle task를 실행합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle generateQuerydsl</span><br></pre></td></tr></table></figure>
<p>그 후, 다음과 같은 결과를 보실 수 있습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">BUILD SUCCESSFUL <span class="keyword">in</span> <span class="number">1</span>s</span><br><span class="line"><span class="number">1</span> actionable task: <span class="number">1</span> up-to-<span class="built_in">date</span></span><br><span class="line"> secucen  ~/dev/code/secucen-study/step05   feature/is10 ●✚  gradle generateQueryDSL</span><br><span class="line"></span><br><span class="line">&gt; Task :generateQueryDSL</span><br><span class="line"><span class="function">Note: <span class="title">Running</span> <span class="title">JPAAnnotationProcessor</span></span></span><br><span class="line"><span class="function"><span class="title">Note</span>: <span class="title">Serializing</span> <span class="title">Entity</span> <span class="title">types</span></span></span><br><span class="line"><span class="function"><span class="title">Note</span>: <span class="title">Generating</span> <span class="title">com.xyzlast.bookstore.entity.QUser</span> <span class="title">for</span> [<span class="title">com.xyzlast.bookstore.entity.User</span>]</span></span><br><span class="line"><span class="function"><span class="title">Note</span>: <span class="title">Generating</span> <span class="title">com.xyzlast.bookstore.entity.QBook</span> <span class="title">for</span> [<span class="title">com.xyzlast.bookstore.entity.Book</span>]</span></span><br><span class="line"><span class="function"><span class="title">Note</span>: <span class="title">Generating</span> <span class="title">com.xyzlast.bookstore.entity.QHistory</span> <span class="title">for</span> [<span class="title">com.xyzlast.bookstore.entity.History</span>]</span></span><br><span class="line"><span class="function"><span class="title">Note</span>: <span class="title">Running</span> <span class="title">JPAAnnotationProcessor</span></span></span><br><span class="line"><span class="function"><span class="title">Note</span>: <span class="title">Running</span> <span class="title">JPAAnnotationProcessor</span></span></span><br><span class="line"><span class="function"><span class="title">BUILD</span> <span class="title">SUCCESSFUL</span> <span class="title">in</span> 2<span class="title">s</span></span></span><br></pre></td></tr></table></figure>
<p>이제 <code>main/generated</code>안을 보시면 Q-class 들이 생성되어 있는 것을 보실 수 있습니다.</p>
<p><img src="/images/jpa/01.png" alt=""></p>
<p>이제 <code>Repository</code> class를 수정해보도록 하겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title">BookDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PersistenceContext</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager em;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JPAQuery&lt;Book&gt; jpaQuery = <span class="keyword">new</span> JPAQuery&lt;&gt;(em);</span><br><span class="line">        Long count = jpaQuery.from(QBook.book).fetchCount();</span><br><span class="line">        <span class="keyword">return</span> count.intValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JPAQuery&lt;Book&gt; jpaQuery = <span class="keyword">new</span> JPAQuery&lt;&gt;(em);</span><br><span class="line">        <span class="keyword">return</span> jpaQuery.from(QBook.book).fetch();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        JPQLQuery&lt;Book&gt; jpaQuery = <span class="keyword">new</span> JPAQuery&lt;&gt;(em);</span><br><span class="line">        QBook q = QBook.book;</span><br><span class="line">        <span class="keyword">return</span> jpaQuery.from(q).where(q.id.eq(id)).fetchFirst();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        em.merge(book);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        QBook q = QBook.book;</span><br><span class="line">        JPAUpdateClause updateClause = <span class="keyword">new</span> JPAUpdateClause(em, q);</span><br><span class="line">        updateClause.where(q.id.eq(book.getId()))</span><br><span class="line">            .set(q.name, book.getName())</span><br><span class="line">            .set(q.author, book.getAuthor())</span><br><span class="line">            .set(q.comment, book.getComment())</span><br><span class="line">            .set(q.publishDate, book.getPublishDate())</span><br><span class="line">            .execute();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        QBook q = QBook.book;</span><br><span class="line">        JPADeleteClause jpaDeleteClause = <span class="keyword">new</span> JPADeleteClause(em, q);</span><br><span class="line">        jpaDeleteClause.where(q.id.eq(book.getId())).execute();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JPADeleteClause jpaDeleteClause = <span class="keyword">new</span> JPADeleteClause(em, QBook.book);</span><br><span class="line">        jpaDeleteClause.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>BookDao</code>의 경우, 매우 단순한 select query만을 가지고 있기 때문에 큰 차이를 보이지 않을 수 있습니다. querydsl을 이용하면 조건등에 의한 동적인 query 작성에 매우 탁월합니다.</p>
<h2 id="Spring-Data-JPA"><a href="#Spring-Data-JPA" class="headerlink" title="Spring Data JPA"></a>Spring Data JPA</h2><p><code>http://spring.io</code>에서는 여러가지 project를 볼 수 있습니다. 그 중에서 <code>JPA</code>에 관련된 프로젝트가 있습니다. <code>Spring Data</code>가 바로 그것입니다. Spring Data JPA는 ORM Framework입니다. JPA 기반의 repository를 아주 빨리, 쉽게 개발할 수 있는 방법을 제시하고 있습니다. 지금까지 보던 모든 기술들(JdbcTemplate, Hibernate, myBatis)에서 repository는 객체만 바뀔뿐, 코드의 중복은 계속해서 나타나게 됩니다. 특히 우리가 CRUD라고 부르는 영역의 CUD 코드의 경우에는 거의 대부분이 중복이 되는 경우가 많습니다. 이러한 문제점을 착안하여 Spring Data - JPA project가 시작되게 되었습니다.</p>
<p>Spring Data JPA는 단독으로 동작하는 ORM Framework가 아닙니다. JPA ORM engine을 기반으로 동작하는 ORM Framework입니다. 여기에서 JPA ORM engine이 될 수 있는 표준적인 JSR 220 을 만족하는 ORM engine은 다음과 같습니다.</p>
<ul>
<li>Hibernate</li>
<li>Google App Engine for JAVA</li>
<li>TopLink</li>
</ul>
<p>Google App Engine이 RDBMS를 완벽하게 지원하지 못하고, TopLink의 경우에는 Oracle에서 판매하는 상용제품이며 Oracle DB에만 특화가 되어있는 ORM입니다. 그렇다면, 실질적으로 지금 사용할 수 있는 선택의 폭은 Hibernate 밖에는 존재하지 않습니다. 지금 상태로는 Spring Data JPA는 Hibernate를 기반으로 동작하는 ORM Framework이다. 라고 생각해주시면 좋을 것 같습니다.</p>
<p>신규 프로젝트에서부터 시작해서 <code>Spring Data JPA</code>를 적용한 프로젝트를 구성해보도록 하겠습니다.</p>
<p>기존 querydsl 프로젝트를 그대로 copy 후, repository들을 모두 지워줍니다. <code>spring-data-jpa</code>만을 추가합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.springframework.data'</span>, <span class="string">name:</span> <span class="string">'spring-data-jpa'</span>, <span class="string">version:</span> <span class="string">'2.0.2.RELEASE'</span></span><br></pre></td></tr></table></figure>
<p><code>@Configuration</code>은 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(value = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.repository"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories</span>(basePackages = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.repository"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">        dataSource.setMaximumPoolSize(<span class="number">10</span>);</span><br><span class="line">        dataSource.setMinimumIdle(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@EnableJpaRepositories</code>를 추가하고, <code>Repository</code>가 위치할 package들만 추가해주면 됩니다.</p>
<p>Spring JPA Data는 Dao/Repository의 반복적인 코드가 될 수 있는 CUD를 자동화된 코드로 지원합니다. Spring JPA Data에서 제공하는 interface는 다음과 같습니다.</p>
<ul>
<li>Repository</li>
<li>CrudRepository</li>
<li>JpaRepository</li>
</ul>
<p>이 중에서 우리가 사용할 녀석은 다른 interface를 모두 상속한 JpaRepository<t, c="">입니다. JapRepository의 선언은 전에 Hibernate의 GenericDao의 선언과 거의 동일합니다. 단 두번째 인자가 PK에 대한 객체 Type을 넣어주는것만 다릅니다. Book, User, History 모두 int를 사용하고 있기 때문에, Integer를 두번째 Type에 넣어주면 됩니다.</t,></p>
<p>이제 각 <code>BookDao</code>, <code>UserDao</code>, <code>HistoryDao</code>를 pattern에 맞도록 <code>BookRepository</code>, <code>UserRepository</code>, <code>HistoryRepository</code>로 만들어줍시다. 각 Repository 코드는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Book</span>, <span class="title">Integer</span>&gt;, <span class="title">QuerydslPredicateExecutor</span>&lt;<span class="title">Book</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Integer</span>&gt;, <span class="title">QuerydslPredicateExecutor</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HistoryRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">History</span>, <span class="title">Integer</span>&gt;, <span class="title">QuerydslPredicateExecutor</span>&lt;<span class="title">History</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>interface 구현이 아닌 interface 상속을 통해서 구현이 되어 있는 것을 주의해주세요. JpaRepository<t,c> 의 T에는 Target이 되는 Class가 들어가고, C에는 Target Class의 @Id property의 객체값이 들어갑니다. (int인 경우, Integer)</t,c></p>
<p>자. 이제 지금까지 만들었던 BookDaoImpl의 코딩은 모두 끝났습니다. interface에 대한 코딩 작업이 전혀 필요하지 않습니다. 그 이유는 기본적으로 전에 보셨던 GenericDao에 대한 확장과 비슷한 방법입니다. Spring Data JPA는 JpaRepository, Repository, CrudRepository를 상속받은 interface를 모두 찾아내서, 동적인 객체를 생성합니다. 우리가 따로 코드를 만들어줄 필요가 전혀 없는것이지요. GenericDao의 결정판입니다. ^^</p>
<p>이제 테스트 코드를 작성해보도록 하겠습니다. 기존의 테스트 코드에서 약간의 변경만 있으면 됩니다. countAll()을 count()로, add, update를 모두 save로 변경만 시켜주면 테스트 코드가 모두 완성됩니다.</p>
<h3 id="findByXXX-method의-확장"><a href="#findByXXX-method의-확장" class="headerlink" title="findByXXX method의 확장"></a>findByXXX method의 확장</h3><p>지금 만들어진 <code>Repository</code>는 매우 단순한 객체입니다. 만약에 <code>BookRepository</code>를 이용해서 <code>Book.name</code>을 이용해 검색을 한다면 다음과 같은 코드를 작성해야지 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByName01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    QBook qBook = QBook.book;</span><br><span class="line">    Optional&lt;Book&gt; bookOptional = bookRepository.findOne(qBook.name.eq(<span class="string">"ykyoon"</span>));</span><br><span class="line">    <span class="keyword">if</span> (bookOptional.isPresent()) &#123;</span><br><span class="line">        System.out.println(bookOptional.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>서비스코드에 이렇게 검색하는 루틴이 들어가 있는 것은 코드의 가독성을 떨어트립니다. Entity의 property만을 이용해서 검색하는 경우에 <code>spring-data-jpa</code>는 아주 멋진 방법을 제공합니다. <code>BookRepository</code>에 다음과 같은 method를 추가합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Book</span>, <span class="title">Integer</span>&gt;, <span class="title">QuerydslPredicateExecutor</span>&lt;<span class="title">Book</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">Book <span class="title">findByName</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이렇게만 넣어주는 것으로도 위 코드와 동일한 검색을 가능하게 할 수 있습니다. 이렇게 만들어줄 수 있는 패턴들은 다음과 같습니다.</p>
<table>
<thead>
<tr>
<th>KEYWORD</th>
<th>SAMPLE    JPQL</th>
<th>SNIPPET</th>
</tr>
</thead>
<tbody>
<tr>
<td>And</td>
<td>findByLastnameAndFirstname</td>
<td>… where x.lastname = ?1 and x.firstname = ?2</td>
</tr>
<tr>
<td>Or</td>
<td>findByLastnameOrFirstname</td>
<td>… where x.lastname = ?1 or x.firstname = ?2</td>
</tr>
<tr>
<td>Between</td>
<td>findByStartDateBetween</td>
<td>… where x.startDate between 1? and ?2</td>
</tr>
<tr>
<td>LessThan</td>
<td>findByAgeLessThan</td>
<td>… where x.age &lt; ?1</td>
</tr>
<tr>
<td>GreaterThan</td>
<td>findByAgeGreaterThan</td>
<td>… where x.age &gt; ?1</td>
</tr>
<tr>
<td>IsNull</td>
<td>findByAgeIsNull</td>
<td>… where x.age is null</td>
</tr>
<tr>
<td>IsNotNull,NotNull</td>
<td>findByAge(Is)NotNull</td>
<td>… where x.age not null</td>
</tr>
<tr>
<td>Like</td>
<td>findByFirstnameLike</td>
<td>… where x.firstname like ?1</td>
</tr>
<tr>
<td>NotLike</td>
<td>findByFirstnameNotLike</td>
<td>… where x.firstname not like ?1</td>
</tr>
<tr>
<td>OrderBy</td>
<td>findByAgeOrderByLastnameDesc</td>
<td>… where x.age = ?1 order by x.lastname desc</td>
</tr>
<tr>
<td>Not</td>
<td>findByLastnameNot</td>
<td>… where x.lastname &lt;&gt; ?1</td>
</tr>
<tr>
<td>In</td>
<td>findByAgeIn(Collection<age> ages)</age></td>
<td>… where x.age in ?1</td>
</tr>
<tr>
<td>NotIn</td>
<td>findByAgeNotIn(Collection<age> age)</age></td>
<td>… where x.age not in ?1</td>
</tr>
</tbody>
</table>
<h3 id="Predicate의-추가"><a href="#Predicate의-추가" class="headerlink" title="Predicate의 추가"></a>Predicate의 추가</h3><p><code>findByXXX</code>로 해결되지 않는 쿼리를 만들어내야지 될 때 사용하는 방법입니다. Domain Logic중에서 다음과 같은 경우를 가정해보도록 하겠습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UserId, BookId 입력받아, null인 경우 where 조건이 없이 진행한다.</span><br></pre></td></tr></table></figure>
<p>이 경우, Service code에 넣으면 다음과 같이 처리가 되어야지 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;History&gt; <span class="title">listHistories</span><span class="params">(Integer bookId, Integer userId, <span class="keyword">int</span> pageIndex, <span class="keyword">int</span> pageSize)</span> </span>&#123;</span><br><span class="line">    BooleanBuilder queryBuilder = <span class="keyword">new</span> BooleanBuilder();</span><br><span class="line">    <span class="keyword">if</span> (bookId != <span class="keyword">null</span>) &#123;</span><br><span class="line">        queryBuilder.and(QBook.book.id.eq(bookId));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (userId != <span class="keyword">null</span>) &#123;</span><br><span class="line">        queryBuilder.and(QUser.user.id.eq(userId));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> historyRepository.findAll(queryBuilder, PageRequest.of(pageIndex, pageSize));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>와 같은 코드로 만들어져야지 됩니다. parameter의 검사 및 query를 만드는 코드가 Service에 있다는 것은 원 서비스 코드의 목적인 BL에 대한 구현과 어울리지 않는 코드가 만들어집니다. 따라서 저런 코드들을 Predicate로 넣어서 만드는 것이 일반적입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HistoryPredicate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HistoryPredicate</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Predicate <span class="title">buildQueryByBookIdAndUserId</span><span class="params">(Integer bookId, Integer userId)</span> </span>&#123;</span><br><span class="line">        BooleanBuilder queryBuilder = <span class="keyword">new</span> BooleanBuilder();</span><br><span class="line">        <span class="keyword">if</span> (bookId != <span class="keyword">null</span>) &#123;</span><br><span class="line">            queryBuilder.and(QBook.book.id.eq(bookId));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (userId != <span class="keyword">null</span>) &#123;</span><br><span class="line">            queryBuilder.and(QUser.user.id.eq(userId));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> queryBuilder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>구성된 코드를 이용한 서비스 코드는 다음과 같이 만들어집니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;History&gt; <span class="title">listHistories</span><span class="params">(Integer bookId, Integer userId, <span class="keyword">int</span> pageIndex, <span class="keyword">int</span> pageSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> historyRepository.findAll(HistoryPredicate.buildQueryByBookIdAndUserId(bookId, userId),</span><br><span class="line">        PageRequest.of(pageIndex, pageSize));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>지금까지 <code>myBatis</code>, <code>Hibernate</code>, <code>JPA</code>, <code>JPA + Querydsl</code>, <code>Spring Data JPA + Querydsl</code>로 구성한 코드를 알아봤습니다.</p>
<p><code>Spring Data JPA + Querydsl</code>를 이용한 코드 패턴은 지금까지 보이는 코드들중 가장 복잡한 구조를 가지고 있지만, 현재 가장 선호되는 패턴입니다.<br>이렇게 복잡하게 계속해서 묶어주는 이유는 무엇일까요. 가장 큰 이유는 전에 이야기드린 것 처럼, 관계지향적 데이터를 우리가 가지고 있는 <code>OOP</code>적 방법으로 사용하기 위해서 입니다.</p>
<p>이 코드 패턴을 꼭 자신의 것으로 만드시길 바랍니다. <code>Repository Pattern</code>의 경우, 거의 대부분의 DB 어플리케이션개발의 중심이 됩니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/spring-java-jpa-hibernate/">spring, java, jpa, hibernate</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/03/07/09-hibernate/"><span>09. Hibernate</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/03/07/09-hibernate/" rel="bookmark">
        <time class="entry-date published" datetime="2018-03-07T07:54:35.000Z">
          2018-03-07
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="Hibernate"><a href="#Hibernate" class="headerlink" title="Hibernate"></a>Hibernate</h1><p>Hibernate는 지금까지 SQL을 이용한 DB query 방법이 아닌, 객체를 이용한 SQL auto generate를 통한 DB 접속 방법을 제공합니다. 이런 객체를 이용한 방법을 ORM(object relation model)이라고 합니다. 먼저, ORM에 대해서 간단한 소개를 해보도록 하겠습니다.</p>
<h2 id="ORM-Object-Relation-Model"><a href="#ORM-Object-Relation-Model" class="headerlink" title="ORM(Object Relation Model)"></a>ORM(Object Relation Model)</h2><p>java 언어의 발전은 sw 개발에 있어서 객체지향의 개발 방법으로 오는 혜택에 매료가 되었습니다. 그렇지만, 모든 웹 및 기업의 데이터가 저장되어 있는 RDBMS와 OOP간의 괴리의 차이에 의한 비용의 증가가 계속해서 발생하게 되었습니다. OOP적 개발 방법과 RDBMS의 관계형 개발 방법론이 끊임없이 충돌하게 되는 것이지요. 서로간에 전쟁(war) 라는 표현을 사용할 정도로 논란이 매우 큰 문제입니다. java 측에서는 relation 기술의 탓으로 돌리고, data 전문가들은 OOP 기술의 문제라고 약간은 소모적인 논쟁으로 계속해서 가게 되었지요.</p>
<p>이때, ORM(Object Relation Model)은 이러한 불일치 기술에 대한 solution을 지칭할 때 사용됩니다.</p>
<p>ORM은 4가지로 구성이 되어 있습니다.</p>
<ul>
<li>Persistence class에 대한 기본적인 CRUD를 수행하는 API</li>
<li>class 자체나 class의 property를 참조하는 query를 작성할 수 있는 API</li>
<li>mapping meta data 작성을 위한 기반 API</li>
<li>ORM 구성이 Transaction과 상호 동작하며 최적화를 수행하도록 돕는 API</li>
</ul>
<p>왜 ORM을 사용해야지 되는가?</p>
<ul>
<li>생산성 : SQL관련 코드를 제거하고 객체간의 관계를 명확하게 그릴수 있습니다. 그리고 Domain에 집중할 수 있는 설계 구조를 가지고 옵니다.</li>
<li>유지보수성 : Domain을 구현했기 때문에 Domain에 대한 명확한 정의가 나타납니다. Domain의 BL이 변경, 추가 되었을 때 그에 대한 수정이 쉽습니다.</li>
<li>성능 : 가장 큰 이슈입니다. VM을 설명할 때, VM보다 일반 assembly로 compile되는 언어가 더 빠르지만 이제 사용되지 않는 이유랑 동일합니다. ORM 자체에 이미 많은 최적화 방법들이 구현되어 있고, 그 현인들의 지식을 사용할 수 있다는 점에서 더욱더 큰 장점을 가지고 올 수 있습니다.</li>
<li>밴더 독립성 : ORM은 DB와 DB의 방언(각 DB만의 함수들)로부터 추상화 되어 있습니다. DB의 독립성은 매우 큰 장점을 가지고 오는데, 개발에 있어서 오히려 더 나은 장점을 가지고 옵니다. 개발자들은 자신의 개발 PC에 가벼운 DB(mysql)를 설치해서 개발을 하고, 실 서버에서는 Data에 최적화된 DB를 이용해서 서비스를 할 수 있는 장점을 가지고 있습니다. 이는 생산성과도 직결되는 문제입니다.</li>
<li>Java 표준 : ORM은 JSR 220에 의해서 java에 표준적인 기술로 인정을 받았습니다.</li>
</ul>
<h2 id="DDD-Domain-Driven-Design"><a href="#DDD-Domain-Driven-Design" class="headerlink" title="DDD(Domain Driven Design)"></a>DDD(Domain Driven Design)</h2><p>에릭 에반스 (Eric Evans) 는 과거의 지혜와 경험들을 종합하여 도메인-드리븐 디자인 (Domain Driven Design, DDD) 이라는 방법론을 제시 했습니다.<br>단순 객체지향 세계에서 살던 개발자들은  이 굉장하지만 새로운 개념에 어려움을 느껴 발표된지 몇년이 지난 후에야 관심을 가지게 되었죠.<br>DDD가 도대체 뭔데? 어떻게 해서든지 돌아가기만 하면 되는거 아냐! 하면서 무심히 지나쳤던 것들에 대해 체계적으로 설명하는 방법론이죠. 하지만 여전히 DDD는 어려운 것, 그저 한때 유행하는 버즈 워드로 인식되고 있는 경향이 있습니다. DDD가 무엇인지 처음 듣는 개발자도 많을 것입니다. DDD의 전체적인 철학을 쉽게 요약하고 있는 블로그 포스트 DDD: How to tackle complexity  번역으로 DDD 카테고리를 시작합니다.</p>
<hr>
<p>DDD (Domain Driven Design) 에서는 어플리케이션 도메인을 표현하기 위한 오브젝트 모델을 만듭니다.<br>이 모델은 도메인의 모든 관계와 로직을 담고 있습니다. 이렇게 하는 목적은 도메인의 복잡성을 관리하기 위함 입니다. DDD 에는 매우 많은 개념과 패턴이 투입되어 있으나, 정제된 두개의 큰 그림으로 그 복잡성에 태클을 걸 수 있습니다.</p>
<ol>
<li>도메인의 개념을 명확하게 표현합니다.</li>
<li>더욱 심도 있는 통찰을 위해 지속적인 리팩토링을 수행합니다.</li>
</ol>
<p>복잡성이란 자체의 복잡한 정도를 의미합니다. 복잡한 것은 이해하기 어렵습니다. 이해하기 어려우면 금방 알아 들을 수 없습니다.</p>
<p>이것이 실제 이슈 입니다 : 복잡한 소프트웨어는 이해하기 어렵습니다. 이것이 바로 모든 사람이 업데이트 하기를 두려워 하여 아예 처음부터 다시 만드는 이유입니다. 아마 첫번째나 두번째는 해킹 하듯이 코드를 추가해서 원하는 바를 이룰 수 있을지 모르지만, 각각의 해킹은 더 이상 시도하는 것이 의미가 없을 때까지 복잡성과 추잡함을 증가시킵니다. 이것을 다른 말로 실패 라고 합니다.</p>
<p>그래서 우리는 이 복잡성을 극복해야 합니다. DDD의 첫번째 방법은 객체지향, 모델 과 추상화의 장점을 얻는 것 입니다. 하지만 이건 매우 광범위 하죠. 우리는 이 오브젝트와 모델들을 어떻게 구조화 해야 하는지 알아내야 합니다. 이것이 DDD가 도메인의 개념을 명시적으로 표현하자는 아이디어의 입니다.</p>
<p>아이디어는 간단합니다. 여러분의 도메인에 새로이 적용되는 개념이 있다면 모델에서 확인할 수 있어야 합니다. 중요한 개념을 확인하기 위해서 코드를 뒤져서는 안됩니다. 그 개념은 모델에서 오브젝트로써 표현되어야 합니다. 특정 조건에서만 발생하는 액션이 있다고 합시다, 이 조건들이 중요하지 않다면 그 액션을 수행하도록 그저 IF Statement 메소드로 처리하면 됩니다. 하지만, 그 조건들이 도메인에서 중요하다면 코드로 부터 감추는 것만으로는 부족합니다. 그 조건들을 수행하도록 Policy Object가 조건들을 표현해야 합니다. 이제 조건들은 당신의 도메인에서 명시적으로 표현됩니다.</p>
<p>이 아이디어 들은 Factories, Repositories, Services, Knowledge Levels 등등으로 표현될 수 있습니다. 이 것은 여러분의 시스템을 이해 가능하도록 만드는 중요한 부분입니다.</p>
<p>DDD가 작동하도록 만드는 두번째 아이디어는 “Deeper Insight”를 위한 지속적인 리팩토링 입니다. Deeper Insight 란 이미 가지고 있는 도메인 모델에서 새로운 어떤 것을 발견하게 된다면 대충 끼워넣지 말고 도메인에서 중요한 요소인지 반드시 알아내라는 것을 의미합니다. 만약 중요하다면 새로 이해한 것이 명확하게 표현 되도록 모델을 리팩토링 해야 합니다. 이 리팩토링은 사소할 때도 있고, 매우 중요 할 때도 있습니다.</p>
<p>도메인 모델이 표현성을 잃게 되면 점점 더 부서지고, 점점더 복잡해 지며 점점 더 어려워 집니다. 여러분의 모델이 단순하며  표현력과 정확성을 유지할 수 있도록 항상 싸워야 합니다. 당신이 운이 좋다면 에릭 에반스가 말하는 Break Through [전에는 불가능 했던 것이 새로운 가능성과 통찰력이 갑자기 나타나는 일] 것을 경험할  수도 있습니다. 그렇게 된다면 진짜 운이 좋은 것입니다. 당신이 운이 좋지 않더라도 리팩토링은 적어도 모델이 유연성을 요구할때 유연함을 만족 시킬 수는 있습니다. 이것은 미래에 나타날 통찰력과 리팩토링 요소를 더 쉽게 핸들링 할 수 있음을 의미합니다.</p>
<hr>
<p>위 내용과 같이, DDD는 우리가 표현하고자 하는 실세계의 데이터 프로세스 자체를 컴퓨터 언어로 옮겨가는 과정입니다.<br>예를 들어, SQL로 작업을 하게 되면 다음과 같은 대화가 나오게 됩니다.</p>
<p><strong>TB_USER에서 SELECT를 할때, POINT Column으로 Order By DESC로 얻어오고, 그 POINT값이 100점 이상인 경우에는 LEVEL column값을 2로 업데이트를 시키면 됩니다.</strong></p>
<p>자, 방금 말한 내용을 실제 BL을 설계한 기획자에게 이야기를 해보도록 합시다. 과연 어떤 말인지 알아들을수 있을까요? SQL 개발자들이라면 가능하겠지요. DDD로 모델링을 거치면 다음과 같은 대화를 할 수 있습니다.</p>
<p><strong>User를 표로 보여줄 때, Book Point값이 높은 순서대로 보여주고, Book Point값이 100점이상인 경우에는 Reader로 사용자 Level을 높여줘서 보여주면 됩니다.</strong></p>
<p>어떤 대화가 좀 더 쉽습니까? 기존의 데이터 중심으로 보는 것과 모델링을 중심으로 보는것. 이 두가지의 차이는 그 데이터의 구조를 모르는 사람이 로직을 읽을수 있느냐, 없느냐에 따라 갈리게 됩니다. 그리고 우리가 문장으로 설명할 수 있는 BL을 code에 어떻게 녹여내느냐를 고민을 해야지 됩니다.</p>
<p>최종적으로 DDD는 다음 목표들을 갖습니다.</p>
<h3 id="Ubiquitous-Language"><a href="#Ubiquitous-Language" class="headerlink" title="Ubiquitous Language"></a>Ubiquitous Language</h3><p>Domain 중심의 SW팀에서는 모든 참가자들(사용자, 도메인전문가, 설계자, 프로그래머, 분석가)간에 동일한 의미를 갖는 공통된 언어를 갖는다. 심지어 공통된 언어는 Code의 Object로 구현이 가능해야지 된다.</p>
<h3 id="Layered-Architecture-pattern"><a href="#Layered-Architecture-pattern" class="headerlink" title="Layered Architecture pattern"></a>Layered Architecture pattern</h3><p>UI와 Model이 결합되어 있으면, UI가 바뀌는데에 따라 Model이 변경되어야지 됩니다. 따라서 UI, BL, Modeling간에 분리가 가능한 Layer들이 만들어져야지 됩니다. 기준에 따라 Layer를 나누고, 역할을 부여하는 작업이 필요합니다. 이에 대한 장점은 다음과 같습니다.</p>
<ul>
<li>Layer들이 재사용될 수 있어야지 됩니다.</li>
<li>표준을 지원한다.</li>
<li>종속성을 국지적으로 최소화한다.</li>
<li>교환 가능성이 확보된다.</li>
</ul>
<p>일반적으로 DDD는 다음 4개의 Layer로 구분시켜서 사용하게 됩니다.</p>
<p><img src="/images/hibernate/h01.png" alt=""></p>
<ul>
<li>Infrastructure Layer : 상위 계층을 지원하는 일반화된 기술적 기능을 제공. 공통 Library, Engine, Framework 영역</li>
<li>Domain Layer : 업무 개념과 업무 상황에 대한 정보. 업무 규칙을 표현하는 Layer.</li>
<li>Application Layer : 작업을 정의하고 조정하는 영역. Domain 객체로 작업을 위임하는 역활을 담당.</li>
<li>UI Layer : 정보를 노출하고 입력을 받아들이는 영역</li>
</ul>
<p>이러한 구조는 결국은 Domain의 격리, 즉 분리가 이루어지게 됩니다. 이러한 Layer architecture중 가장 대표적인 방식이 MVC 입니다.</p>
<h3 id="Smart-UI-anti-pattern"><a href="#Smart-UI-anti-pattern" class="headerlink" title="Smart UI anti pattern"></a>Smart UI anti pattern</h3><p>모든 업무로직을 사용자 인터페이스에 넣는 설계 방법을 Smart UI pattern이라고 합니다.</p>
<p>특징은</p>
<ul>
<li>application을 작은 기능으로 잘게 나누고,</li>
<li>나뉜 기능을 분리된 UI로 구현. 업무 규칙이 분리된 UI에 들어가게 합니다.</li>
<li>분리된 업무 규칙은 RDBMS를 이용해서 데이터를 공유하고 실행합니다. 주로 SP가 이 용도로 사용됩니다.</li>
<li>주로 자동화된 UI 구축 도구와 시각적인 프로그래밍 도구를 이용합니다.</li>
</ul>
<p>DDD pattern에서 가장 피해야지 되는 것이 바로 UI Pattern입니다.<br>UI pattern이라는 것은 지금도 매우 자주 쓰이고 있는 패턴입니다. 이 패턴의 가장 큰 문제는 우리가 사용하는 데이터 및 Domain에 대한 모든 로직을 보여지는 View에 맞추게 됩니다. 실질적인 데이터의 흐름을 방해하고, 언제나 바뀔 수 있는 View 영역에 Model이 영속되기 때문에 application의 변경에 취약한 약점을 갖게 됩니다.</p>
<p>대표적인 Smart UI pattern의 도구가 PowerBuilder입니다. Data Window의 Smart UI를 이용하기 위해, UI에 따른 Model과 로직이 꼬인 상태로 존재하게 됩니다. 이는 필연적으로 코드의 중복을 가지고 오게 되며, 아직까지 UI에 대한 명확한 테스트를 할 수 없는 현 시점에서 유지보수가 거의 불가능한 시스템을 만들게 됩니다. <em>anti pattern은 쓰지 말라고 있는겁니다.</em></p>
<h3 id="Entities-pattern"><a href="#Entities-pattern" class="headerlink" title="Entities pattern"></a>Entities pattern</h3><p>ID를 갖는 unique한 object를 갖는 pattern입니다. 이는 RDBMS의 PK와 연결시켜, 이 객체가 유일한 어떤 값임을 나타내는 방법을 제공합니다.</p>
<h3 id="Service-pattern"><a href="#Service-pattern" class="headerlink" title="Service pattern"></a>Service pattern</h3><p>서비스는 기능을 처리하거나, Entity로 구별할 수 없는 것을 지칭합니다. 가장 주로 사용되는 것은 BL의 Group을 표현하는 것이 가장 많습니다.</p>
<h3 id="Factory-pattern"><a href="#Factory-pattern" class="headerlink" title="Factory pattern"></a>Factory pattern</h3><p>각각의 Object, Service의 생성방법에 대한 통일성을 갖는것을 목표로 합니다. 어떤 객체를 생성할 때, 초기화 해줘야지 되는 값이라던지 실행시켜줘야지 되는 method가 독특하게 존재한다면 개발자 및 참여자들은 Domain에 집중할 수 없습니다. Spring의 ApplicationContext는 이런 경우 가장 좋은 해결 방법이 됩니다.</p>
<h3 id="Repository-pattern"><a href="#Repository-pattern" class="headerlink" title="Repository pattern"></a>Repository pattern</h3><p>생성된 객체나 Model이 외부(주로 DB)와 연동되어 생명주기를 가질때, 그 생명주기에 대한 관리 Focus가 되는 Layer가 존재해야지 됩니다. dao로 구현되는 것이 일반적이며, Spring에서는 @Repository로 지정하는 것이 일반적입니다.</p>
<p>DDD의 사상을 반영하기 위해 주로 사용되는 툴이 ORM이고, java에서 가장 오랜 시간동안 개발이 되고 사랑받고 있는 Hibernate가 그 선두 주자라고 할 수 있습니다.</p>
<h2 id="Hibernate를-이용한-Repository-개발"><a href="#Hibernate를-이용한-Repository-개발" class="headerlink" title="Hibernate를 이용한 Repository 개발"></a>Hibernate를 이용한 Repository 개발</h2><p>새로운 project를 만들고, Hibernate, DAO 관련 library를 추가합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.mariadb.jdbc'</span>, <span class="string">name:</span> <span class="string">'mariadb-java-client'</span>, <span class="string">version:</span> <span class="string">'2.2.0'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.hibernate'</span>, <span class="string">name:</span> <span class="string">'hibernate-core'</span>, <span class="string">version:</span> <span class="string">'5.2.12.Final'</span></span><br><span class="line">compileOnly <span class="string">group:</span> <span class="string">'org.projectlombok'</span>, <span class="string">name:</span> <span class="string">'lombok'</span>, <span class="string">version:</span> <span class="string">'1.16.18'</span></span><br></pre></td></tr></table></figure>
<p>기존에 만들어둔 <code>Book</code>, <code>BookStatus</code>, <code>User</code>, <code>History</code>를 copy해서 넣습니다.</p>
<p><code>hibernate.cfg.xml</code> 파일을 만들어주고, 다음과 같은 내용을 넣습니다. <code>hibernate.cfg.xml</code> 파일은 기본적으로 db 연결방법들을 제공합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<span class="meta">&lt;!DOCTYPE hibernate-configuration PUBLIC</span></span><br><span class="line"><span class="meta">        "-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span></span><br><span class="line"><span class="meta">        "http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd"&gt;</span><span class="tag">&lt;<span class="name">hibernate-configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">session-factory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.connection.driver_class"</span>&gt;</span>org.mariadb.jdbc.Driver<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.connection.password"</span>&gt;</span>qwer12#$<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://127.0.0.1:4306/bookstore<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.connection.username"</span>&gt;</span>root<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MariaDB53Dialect<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.show_sql"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">session-factory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">hibernate-configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Hibernate를 이용한 repository는 다음과 같은 pattern으로 동작합니다.</p>
<ul>
<li>SessionFactory를 통한 Session의 확보</li>
<li>Session을 통한 자동생성된 Query의 실행</li>
<li>Session close</li>
</ul>
<p><code>myBatis</code>와 동일한 패턴입니다. 이제 이 패턴대로 <code>BookDao</code>를 구성해보도록 하겠습니다.<br>먼저, DB의 Column과 구현되어 있는 Book간의 연결을 annotation을 이용해서 구성합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"books"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"id"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"name"</span>, nullable = <span class="keyword">false</span>, length = <span class="number">255</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"comment"</span>, nullable = <span class="keyword">true</span>, length = <span class="number">255</span>)</span><br><span class="line">    <span class="keyword">private</span> String comment;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"author"</span>, nullable = <span class="keyword">false</span>, length = <span class="number">50</span>)</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"publishDate"</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> Date publishDate;</span><br><span class="line">    <span class="meta">@Enumerated</span>(EnumType.ORDINAL)</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"status"</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> BookStatus bookStatus;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"rentUserId"</span>, nullable = <span class="keyword">true</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer rentUserId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>객체의 각 property와 DB의 물리적인 상관관계를 annotation을 통해서 relation을 갖게 하는 과정입니다. 이를 통해 객체지향적인 java 객체가 관계지향/물리적 DB와의 연결이 되게 됩니다.</p>
<p>다음은 <code>Repository</code> 코드입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title">BookDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SessionFactory sessionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookDaoImpl</span><span class="params">(SessionFactory sessionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sessionFactory = sessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Session session = sessionFactory.openSession()) &#123;</span><br><span class="line">            CriteriaBuilder builder = session.getCriteriaBuilder();</span><br><span class="line">            CriteriaQuery&lt;Long&gt; query = builder.createQuery(Long.class);</span><br><span class="line">            query.select(builder.count(query.from(Book.class)));</span><br><span class="line">            <span class="keyword">return</span> session.createQuery(query).getSingleResult().intValue();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Session session = sessionFactory.openSession()) &#123;</span><br><span class="line">            <span class="keyword">return</span> session.createQuery(<span class="string">"from Book"</span>, Book.class).list();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Session session = sessionFactory.openSession()) &#123;</span><br><span class="line">            Book book = session.byId(Book.class).load(id);</span><br><span class="line">            <span class="keyword">return</span> book;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Session session = sessionFactory.openSession()) &#123;</span><br><span class="line">            session.save(book);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Session session = sessionFactory.openSession()) &#123;</span><br><span class="line">            session.save(book);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Session session = sessionFactory.openSession()) &#123;</span><br><span class="line">            Book deleteBook = <span class="keyword">new</span> Book();</span><br><span class="line">            deleteBook.setId(bookId);</span><br><span class="line">            session.delete(deleteBook);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Session session = sessionFactory.openSession()) &#123;</span><br><span class="line">            CriteriaBuilder builder = session.getCriteriaBuilder();</span><br><span class="line">            CriteriaDelete&lt;Book&gt; query = builder.createCriteriaDelete(Book.class);</span><br><span class="line">            query.from(Book.class);</span><br><span class="line">            session.createQuery(query);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이 패턴은 전에 refactoring을 진행했던 Template-Callback pattern을 통해 Refactoring이 가능합니다. HibernateRefactoring을 진행해보도록 하겠습니다.<br>테스트 코드를 통해 실행되는 것을 확인하면 다음과 같이 구성 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDaoImplTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ServiceRegistry serviceRegistry;</span><br><span class="line">    <span class="keyword">private</span> SessionFactory sessionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line">        configuration.configure(<span class="string">"hibernate.cfg.xml"</span>);</span><br><span class="line">        configuration.addAnnotatedClass(Book.class);</span><br><span class="line">        configuration.addAnnotatedClass(User.class);</span><br><span class="line">        configuration.addAnnotatedClass(History.class);</span><br><span class="line">        serviceRegistry = <span class="keyword">new</span> StandardServiceRegistryBuilder()</span><br><span class="line">            .applySettings(configuration.getProperties()).build();</span><br><span class="line">        sessionFactory = configuration.buildSessionFactory(serviceRegistry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BookDao bookDao = <span class="keyword">new</span> BookDaoImpl(sessionFactory);</span><br><span class="line">        bookDao.getAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>기존과 좀 다른 형태의 <code>DaoImpl</code>이 만들어집니다. 이렇게만 작성하면 <code>ORM</code>과 전에 나온 <code>myBatis</code>간의 차이가 무엇인지 모르게됩니다. 이제 더 깊이 가보도록 하겠습니다.</p>
<h2 id="Hibernate를-이용한-Service의-개발-DDD"><a href="#Hibernate를-이용한-Service의-개발-DDD" class="headerlink" title="Hibernate를 이용한 Service의 개발 - DDD"></a>Hibernate를 이용한 Service의 개발 - DDD</h2><p>이제 서비스의 개발을 확인해보도록 하겠습니다. 다음과 같은 BL을 생각해보도록 하겠습니다.</p>
<p><strong> 사용자가 책을 대여한다. 대여하면서 사용자 point가 10점씩 증가된다. </strong></p>
<p>서비스 코드는 다음과 같이 구성될 수 있을 것입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentBook</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">    Book rentBook = bookDao.getById(bookId);</span><br><span class="line">    User user = userDao.getById(userId);</span><br><span class="line"></span><br><span class="line">    rentBook.setRentUser(user);</span><br><span class="line">    user.setPoint(user.getPoint() + <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    userDao.update(user);</span><br><span class="line">    bookDao.update(rentBook);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위와 같이 절차적으로 구성이 가능합니다.</p>
<blockquote>
<p>책을 얻어낸다.<br>사용자를 얻어낸다.<br>책에 대여사용자를 셋팅한다.<br>사용자의 point 값을 증가시킨다.<br>Dao를 이용해서 update 시킨다.</p>
</blockquote>
<p>그렇지만 이는 객체지향적이지 못합니다.</p>
<p><code>ORM</code>으로, 아니 <code>DDD</code>로 구성을 한다면 처음 이야기한 BL 그대로 해석이 가능한 코드가 서비스에서 녹아들어갈 수 있어야지 됩니다. 다음과 같이요.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentBook</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">    Book book = bookDao.getById(bookId);</span><br><span class="line">    User user = userDao.getById(userId);</span><br><span class="line">    user.rentBook(book, <span class="number">10</span>, bookDao, userDao);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위와 같이 <code>Entity</code> 객체들에 단순한 property만을 넣는 것이 아닌, action에 대한 처리 역시 <code>Entity</code>에 구현해서 보다더 확장된 <code>Entity</code>를 만들어주게되면 코드의 확장이 더욱더 잘 됩니다.<br>위와 같이 확장된 <code>User</code>의 코드는 다음과 같이 구성 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentBook</span><span class="params">(Book book, <span class="keyword">int</span> incrementPoint, BookDao bookDao, UserDao userDao)</span> </span>&#123;</span><br><span class="line">    book.setRentUser(<span class="keyword">this</span>);</span><br><span class="line">    bookDao.update(book);</span><br><span class="line">    <span class="keyword">this</span>.setPoint(<span class="keyword">this</span>.getPoint() + incrementPoint);</span><br><span class="line">    userDao.update(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이에 대한 테스트를 작성한다면 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserDao userDao = mock(UserDao.class);</span><br><span class="line">    BookDao bookDao = mock(BookDao.class);</span><br><span class="line"></span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setPoint(<span class="number">100</span>);</span><br><span class="line">    Book book = <span class="keyword">new</span> Book();</span><br><span class="line"></span><br><span class="line">    user.rentBook(book, <span class="number">10</span>, bookDao, userDao);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//book에 대여자가 정상적으로 설정되었는지 확인</span></span><br><span class="line">    assertThat(book.getRentUser()).isEqualTo(user);</span><br><span class="line">    <span class="comment">//user에 정상적으로 Point 값이 설정되었는지 확인</span></span><br><span class="line">    assertThat(user.getPoint()).isEqualTo(<span class="number">110</span>);</span><br><span class="line">    <span class="comment">//Repository를 통해서 객체 값이 업데이트가 되고 있는지 체크 필요</span></span><br><span class="line">    verify(userDao, times(<span class="number">1</span>)).update(user);</span><br><span class="line">    verify(bookDao, times(<span class="number">1</span>)).update(book);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BL 로직 자체를 DB가 없이 가능하게 되며, Entity간의 Domain Logic에 의해서 처리되고 있는 것을 볼 수 있습니다. 이는 서비스의 구현에 있어서 용어의 통일 및 로직의 확장에 용의하게 됩니다.</p>
<h2 id="Entity의-정의"><a href="#Entity의-정의" class="headerlink" title="Entity의 정의"></a>Entity의 정의</h2><p>Entity의 정의는 기존 <code>VO</code>나 <code>DTO</code>를 만들어낼때 사용되는 간단한 getter/setter만을 사용하지 않고 BL의 action의 확장 역시 가능합니다. 또한 Entity는 다른 Entity간의 Relation을 가지게 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"books"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"id"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"name"</span>, nullable = <span class="keyword">false</span>, length = <span class="number">255</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"comment"</span>, nullable = <span class="keyword">true</span>, length = <span class="number">255</span>)</span><br><span class="line">    <span class="keyword">private</span> String comment;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"author"</span>, nullable = <span class="keyword">false</span>, length = <span class="number">50</span>)</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"publishDate"</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> Date publishDate;</span><br><span class="line">    <span class="meta">@Enumerated</span>(EnumType.ORDINAL)</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"status"</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> BookStatus bookStatus;</span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn</span>(name = <span class="string">"rentUserId"</span>, nullable = <span class="keyword">true</span>)</span><br><span class="line">    <span class="keyword">private</span> User rentUser;</span><br><span class="line">    <span class="meta">@OneToMany</span>(mappedBy = <span class="string">"book"</span>)</span><br><span class="line">    <span class="keyword">private</span> List&lt;History&gt; histories;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"histories"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">History</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"id"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn</span>(name = <span class="string">"bookId"</span>)</span><br><span class="line">    <span class="keyword">private</span> Book book;</span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn</span>(name = <span class="string">"userId"</span>)</span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    <span class="meta">@Enumerated</span>(EnumType.ORDINAL)</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"actionType"</span>)</span><br><span class="line">    <span class="keyword">private</span> HistoryActionType actionType;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"insertDate"</span>)</span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"users"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"id"</span>)</span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"name"</span>, length = <span class="number">50</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"password"</span>, length = <span class="number">12</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"point"</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> point;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"level"</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> level;</span><br><span class="line">    <span class="meta">@OneToMany</span>(mappedBy = <span class="string">"user"</span>)</span><br><span class="line">    <span class="keyword">private</span> List&lt;History&gt; histories;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentBook</span><span class="params">(Book book, <span class="keyword">int</span> incrementPoint, BookDao bookDao, UserDao userDao)</span> </span>&#123;</span><br><span class="line">        book.setRentUser(<span class="keyword">this</span>);</span><br><span class="line">        bookDao.update(book);</span><br><span class="line">        <span class="keyword">this</span>.setPoint(<span class="keyword">this</span>.getPoint() + incrementPoint);</span><br><span class="line">        userDao.update(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>각 객체들간의 새로운 연관관계가 보이는 것을 볼 수 있습니다. <code>Book</code>이라는 객체를 통해서, RentUser를 얻어낼 수 있으며, Book의 연관 History를 모두 얻어낼 수 있습니다.<br>이러한 연관관계를 정의하는 annotation들은 다음과 같습니다.</p>
<table>
<thead>
<tr>
<th>이름</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Entity</td>
<td>entity 객체임을 지정하는 annotation입니다.</td>
</tr>
<tr>
<td>@Table</td>
<td>entitty 객체와 연결되는 table을 지정하는 annotation입니다.</td>
</tr>
<tr>
<td>@Id</td>
<td>PK를 지정하는 annotation입니다.</td>
</tr>
<tr>
<td>@Column</td>
<td>DB의 Column과 1:1로 mapping되는 Property를 지정하는 annotation입니다.</td>
</tr>
<tr>
<td>@GeneratedValue</td>
<td>PK의 값이 지정되는 방법을 결정할 수 있습니다. AUTO의 경우 mysql의 AUTO_INCREMENT에 해당됩니다. 각각의 DB에 따라 다른 값을 넣어주는 것도 가능합니다.(ex : oracle의 sequence)</td>
</tr>
<tr>
<td>@Enumerated</td>
<td>enum 값과 1:1로 mapping이 되는 것을 지정합니다.</td>
</tr>
<tr>
<td>@ManyToOne</td>
<td>자신과 같은 객체들이 다른 한개의 객체에 연관이 있음을 지정합니다. 이는 N:1의 속성을 지정하게 됩니다.</td>
</tr>
<tr>
<td>@JoinColumn</td>
<td>@ManyToOne과 같이 사용됩니다. Join 되는 Column을 지정합니다. (FK column)</td>
</tr>
<tr>
<td>@OneToMany</td>
<td>자신이 다른 객체들에 연관이 있음을 지정합니다. 이는 1:N 또는 N:N의 속성을 지정합니다.</td>
</tr>
</tbody>
</table>
<p>그리고, Entity에 대한 개념을 다시 한번 정리해보겠습니다.</p>
<h3 id="Entity의-요구사항"><a href="#Entity의-요구사항" class="headerlink" title="Entity의 요구사항"></a>Entity의 요구사항</h3><p>하나의 엔티티 클래스는 다음의 요구조건을 충족해야 합니다:</p>
<ul>
<li>클래스 선언부에 javax.persistence.Entity 어노테이션을 반드시 명시하여야 합니다.</li>
<li>기본 생성자를 반드시 포함해야 합니다. 기본생성자는 인수가 없는 생성자를 의미합니다. 만일, 인수를 포함한 생성자를 사용한다면 명시적으로 기본 생성자를 만들어야만 합니다.</li>
<li>클래스를 fianl로 선언해서는 안됩니다.</li>
<li>엔티티 인스턴스가 세션빈의 리모트 비지니스 인터페이스와 같이 detached object형태로 전달되는 경우, 클래스는 반드시 Serializble 인터페이스를 구현해야 합니다.</li>
<li>엔티티는 엔티티 또는 non-엔티티 클래스 모두 확장(extend)이 가능하며, non-엔티티 클래스는 엔티티 클래스를 확장할 수 있습니다.</li>
<li>영속화 인스턴스 변수는 반드시 private, protected, package-private중 하나로 선언되어야 하며, 엔티티 클래스의 메소드에 의해 직접 참조될 수 있습니다. 클라이언트는 엔티티의 상태를 접근자(accessor)또는 비지니스 메소드를 통해 접근이 가능합니다.</li>
</ul>
<p>또한, 영속상태의 엔티티는 엔티티의 인스턴스 변수 또는 자바빈 스타일의 속성에 의해 접근할 수 있습니다. 필드 또는 속성은 다음의 자바 언어 타입에 따라야지 됩니다.</p>
<ul>
<li>자바 원시 타입</li>
<li>java.lang.String</li>
<li>그외 직렬화 가능(Serializable) 타입들</li>
<li>자바 원시타입의 Wrappers</li>
<li>java.math.BigInteger</li>
<li>java.math.BigDecimal</li>
<li>java.util.Date</li>
<li>java.util.Calendar</li>
<li>java.sql.Date</li>
<li>java.sql.Time</li>
<li>java.sql.Timestamp</li>
<li>사용자 정의 직렬화 타입들</li>
<li>byte[]</li>
<li>Byte[]</li>
<li>char[]</li>
<li>Character[]</li>
<li>열거형(Enumerated) 타입들</li>
<li>다른 엔티티 또는 엔티티 컬렉션</li>
<li>내장형(Embeddable) 클래스</li>
</ul>
<h3 id="Entity간의-Relation"><a href="#Entity간의-Relation" class="headerlink" title="Entity간의 Relation"></a>Entity간의 Relation</h3><p>각 엔티티들은 다음과 같은 관계를 가질 수 있습니다.</p>
<ul>
<li>One-to-one : 각 엔티티 인스턴스는 하나의 인스턴스가 다른 엔티티와 연관됩니다. One-to-one 관계는 javax.persistence.OneToOne 어노테이션으로 해당 필드에 정의합니다.</li>
<li>One-to-many : 하나의 엔티티 인스턴스가 다수의 다른 엔티티 인스턴스와 연관됩니다. 영업주문의 경우 다수의 라인 아이템을 가집니다. 즉, Order 엔티티는 여러개의 LineItem 을 가지므로 이들 사이에는 One-to-many 관계가 선언되어야 하므로 javax.persistence.OneToMany 어노테이션을 사용합니다.</li>
<li>Many-to-one : 다수의 인스턴스가 하나의 다른 엔티티와 연관됩니다. 이것은 One-to-many 와 반대입니다. 영업주문의 경우 LineItem은 Order에 대해 Many-to-one 관계가 성립되므로 javax.persistence.ManyToOne 어노테이션을 지정합니다.</li>
<li>Many-to-many : 이 인스턴스는 다수의 인스턴스가 각기 다른 엔티티들과 연관됩니다. 예를들어, 학교에서 각 수업들은 다수의 학생들과 연관이 있으며, 학생 역시 다수의 수업을 듣고 있습니다. 이경우 수업과 학생은 Many-to-Many 관계가 성립되며 javax.persistence.ManyToMany 어노테이션을 사용합니다.</li>
</ul>
<p>Entity-Entity Relation은 매우 중요한 개념입니다. 이를 통해 RDBMS와 OOP간의 간극을 없애주는 핵심 개념입니다.</p>
<h2 id="Spring과-Hibernate-연결"><a href="#Spring과-Hibernate-연결" class="headerlink" title="Spring과 Hibernate 연결"></a>Spring과 Hibernate 연결</h2><p>지금까지 작성되었던 Hibernate를 이용한 dao, service layer를 spring을 이용하도록 수정해보도록 하겠습니다.</p>
<p>먼저 조금 소개를 한다면, Spring과 Hibernate는 원래 사이가 좋은 편은 아니였습니다.<br>예전 Spring 1.x와 Hibernate 2.x 간에는 개발자간에 매우 심각한 대립이 존재를 했었고, 그로 인한 키보드 배틀이 엄청나게 있었지요.<br>가장 큰 이유는 예전 Spring에서는 HibernateTemplate을 제공하고 있었습니다. Hibernate는 DB에 접근하는 방법을 Session을 바로 얻어서 사용하도록 되어 있는데, 이러한 Raw level 접근을 Spring을 사용함으로 Spring에서 Hibernate의 기본 사상을 망가트리고 있다는 불만이 가장 컷지요.</p>
<p>그렇지만, Hibernate 3.x대로 넘어가고, Spring이 2.x대로 넘어가면서 화해(?)를 하게 됩니다. Spring 측에서 HibernateTemplate을 사용하지 않고, Spring에서 Hibernate를 사용할 수 있도록 Spring Framework의 큰 부분을 변경했습니다. 그리고 그에 맞추어 Hibernate에서는 SessionFactory에서 getCurrentSession() method를 추가함으로서, Spring의 기본적인 Transaction 방법에 맞추어 Hibernate를 이용한 DB 접근을 가능하게 하였습니다.</p>
<p>둘간의 관계는 Spring 자체는 application framework입니다. Hibernate는 ORM framework고요. Hibernate 자체가 Spring보다 범위가 작은 Framework라고도 할 수 있습니다. Java의 모든 application은 Spring을 사용할 수 있지만, DB를 사용하지 않는 Application은 Hibernate를 사용하지 않을테니까요. 그럼에도 불구하고, Java의 최고 양대 open source framework는 spring과 hibernate입니다. 둘은 open source가 세상을 얼마나 바꾸어 놓을 수 있는지 보여주었고, 상업적으로도 엄청난 성공을 거뒀습니다. spring은 지금 vmware에서 제공되고 있고, hibernate는 weblogic을 제공하는 JBOSS에서 제공되고 있습니다.</p>
<p>잡설이 길었습니다. spring은 이러한 hibernate를 위한 library를 따로 분리해서 사용하고 있습니다.</p>
<p>구성될 dependencies 입니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">compileOnly <span class="string">group:</span> <span class="string">'org.projectlombok'</span>, <span class="string">name:</span> <span class="string">'lombok'</span>, <span class="string">version:</span> <span class="string">'1.16.18'</span></span><br><span class="line"></span><br><span class="line">compile <span class="string">'com.google.guava:guava:23.0'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'com.fasterxml.jackson.core'</span>, <span class="string">name:</span> <span class="string">'jackson-databind'</span>, <span class="string">version:</span> <span class="string">'2.9.3'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.mariadb.jdbc'</span>, <span class="string">name:</span> <span class="string">'mariadb-java-client'</span>, <span class="string">version:</span> <span class="string">'2.2.0'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.hibernate'</span>, <span class="string">name:</span> <span class="string">'hibernate-core'</span>, <span class="string">version:</span> <span class="string">'5.2.12.Final'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'com.zaxxer'</span>, <span class="string">name:</span> <span class="string">'HikariCP'</span>, <span class="string">version:</span> <span class="string">'2.7.4'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-context'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-orm'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br><span class="line"></span><br><span class="line">testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line">testCompile <span class="string">'org.assertj:assertj-core:3.8.0'</span></span><br><span class="line">testCompile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-test'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br></pre></td></tr></table></figure>
<p>이제 <code>@Configuration</code>을 구성하겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(value = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.repository"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">        dataSource.setMaximumPoolSize(<span class="number">10</span>);</span><br><span class="line">        dataSource.setMinimumIdle(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HibernateTransactionManager transactionManager = <span class="keyword">new</span> HibernateTransactionManager();</span><br><span class="line">        transactionManager.setDataSource(dataSource());</span><br><span class="line">        transactionManager.setSessionFactory(sessionFactoryBean().getObject());</span><br><span class="line">        <span class="keyword">return</span> transactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalSessionFactoryBean <span class="title">sessionFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">"hibernate.dialect"</span>, <span class="string">"org.hibernate.dialect.MariaDB53Dialect"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"hibernate.show_sql"</span>, <span class="string">"true"</span>);</span><br><span class="line"></span><br><span class="line">        LocalSessionFactoryBean localSessionFactoryBean = <span class="keyword">new</span> LocalSessionFactoryBean();</span><br><span class="line">        localSessionFactoryBean.setHibernateProperties(properties);</span><br><span class="line">        localSessionFactoryBean.setPackagesToScan(<span class="string">"com.xyzlast.bookstore.entity"</span>);</span><br><span class="line">        localSessionFactoryBean.setDataSource(dataSource());</span><br><span class="line">        <span class="keyword">return</span> localSessionFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HibernateExceptionTranslator <span class="title">hibernateExceptionTranslator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HibernateExceptionTranslator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 변경되는 <code>Repository</code> 코드는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDaoSpringImpl</span> <span class="keyword">implements</span> <span class="title">BookDao</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SessionFactory sessionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookDaoSpringImpl</span><span class="params">(SessionFactory sessionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sessionFactory = sessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        CriteriaBuilder builder = session.getCriteriaBuilder();</span><br><span class="line">        CriteriaQuery&lt;Long&gt; query = builder.createQuery(Long.class);</span><br><span class="line">        query.select(builder.count(query.from(Book.class)));</span><br><span class="line">        <span class="keyword">return</span> session.createQuery(query).getSingleResult().intValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        <span class="keyword">return</span> session.createQuery(<span class="string">"from Book"</span>, Book.class).list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        <span class="keyword">return</span> session.byId(Book.class).load(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        session.save(book);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        session.update(book);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        session.delete(book);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        session.createQuery(<span class="string">"DELETE FROM Book"</span>).executeUpdate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>차이는 <code>Session session = sessionFactory.openSession()</code>에서 <code>Session session = sessionFactory.getCurrentSession()</code>으로 바뀐것입니다. 그 이외에는 별 차이가 없습니다.<br>이제 만들어진 <code>Dao</code>를 가지고 Test code를 돌려보도록 합니다. 기존 test 코드를 그대로 사용 가능할 것입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(classes = BookStoreConfig.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDaoSpringImplTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BookDao bookDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Book&gt; allBooks = bookDao.getAll();</span><br><span class="line">        <span class="keyword">if</span> (allBooks.isEmpty()) &#123;</span><br><span class="line">            bookDao.add(TestValueGenerator.generateNewBook());</span><br><span class="line">            allBooks = bookDao.getAll();</span><br><span class="line">        &#125;</span><br><span class="line">        Book checkBook = allBooks.get(allBooks.size() - <span class="number">1</span>);</span><br><span class="line">        Book getBook = bookDao.getById(checkBook.getId());</span><br><span class="line">        Assert.assertEquals(checkBook.getId(), getBook.getId());</span><br><span class="line">    &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>돌리면 바로 다음과 같은 에러가 발생할 것입니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Jan <span class="number">11</span>, <span class="number">2018</span> <span class="number">9</span>:<span class="number">46</span>:<span class="number">18</span> AM org.hibernate.engine.jdbc.env.internal.LobCreatorBuilderImpl makeLobCreatorBuilder</span><br><span class="line"><span class="function">INFO: <span class="title">HHH000422</span>: <span class="title">Disabling</span> <span class="title">contextual</span> <span class="title">LOB</span> <span class="title">creation</span> <span class="title">as</span> <span class="title">connection</span> <span class="title">was</span> <span class="title">null</span></span></span><br><span class="line"><span class="function"><span class="title">org.hibernate.HibernateException</span>: <span class="title">Could</span> <span class="title">not</span> <span class="title">obtain</span> <span class="title">transaction</span>-<span class="title">synchronized</span> <span class="title">Session</span> <span class="title">for</span> <span class="title">current</span> <span class="title">thread</span></span></span><br><span class="line"><span class="function">	<span class="title">at</span> <span class="title">org.springframework.orm.hibernate5.SpringSessionContext.currentSession</span>(<span class="title">SpringSessionContext.java</span>:136)</span></span><br><span class="line"><span class="function">	<span class="title">at</span> <span class="title">org.hibernate.internal.SessionFactoryImpl.getCurrentSession</span>(<span class="title">SessionFactoryImpl.java</span>:465)</span></span><br></pre></td></tr></table></figure>
<p>에러가 발생되는 원인은 바로 변경된 코드인 <code>getCurrentSession()</code> 입니다. 현 상태는 Session이 <code>Open</code> 되어 있지 않은 상태입니다. <code>@Transactional</code> annotation을 통해 Session을 <code>Open</code>시켜줍니다. 이를 통해 <code>@Transactional</code>로 묶여 있는 한개의 method가 하나의 BL이 되는 명확한 지정이 됩니다.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>ORM을 이용한 개발에 대해서 알아봤습니다. ORM을 이용한다는 것을 DDD(Domain Driven Development)와 밀접한 연관을 가지고 있습니다. BL과 우리가 개발하는 코드간의 언어적 갭을 최대한 줄이는 것이 목적입니다. 새로운 언어가 나오면 그에 대한 Application Framework가 나오게 되고, 거의 동시에 ORM Framework가 나오는 것이 대부분의 추세입니다. 특히 Spring에서의 <code>Repository Pattern</code>은 기본적으로 ORM을 사용하는 것을 기본으로 구성하는 경우가 많습니다. 비록 국내 SI에서는 잘 사용되고 있지 않지만, 최근 스타트업 붐에 보이는 거의 대부분의 기업들이 ORM을 사용하고 있는 것이 현실입니다. 잘 익혀둬야지 됩니다.</p>
<p>ORM의 사용은 단순 코드의 개발로 끝나지 않습니다. 개발 패턴에 대한 내용이고, 사상에 대한 이슈입니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/java-spring-hibernate/">java, spring, hibernate</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/02/21/08-mybatis/"><span>08.myBatis</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/02/21/08-mybatis/" rel="bookmark">
        <time class="entry-date published" datetime="2018-02-21T14:18:14.000Z">
          2018-02-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="myBatis"><a href="#myBatis" class="headerlink" title="myBatis"></a>myBatis</h1><p>지금까지는 Spring에서 제공하는 <code>JdbcTemplate</code>를 이용하는 방법을 알아봤습니다. 단점으로 볼 수 있는 것이, 직접적인 query들을 계속해서 코드안에 넣어야지 되는 단점이 있습니다. 그리고, 실제적인 코드와 SQL간의 분리가 되지 않는다는 단점을 가지고 있습니다. 국내에서 DB 접근에 가장 많이 사용하고 있는 기술인 <code>myBatis</code>에 대해서 알아보도록 하겠습니다.</p>
<p>myBatis는 <code>Repository Pattern</code>을 충실히 지킬 수 있으며, DB의 <code>StoreProcedure</code>, <code>Function</code>과 같은 legacy sql을 직접적으로 쉽게 사용할 수 있는 장점을 가지고 있습니다. 이를 통해, JDBC를 이용한 반복적인 코드를 획기적으로 줄이는 것을 목표로 가지고 있으며, 개발자들에게 게을러질 수 있는 권리를 보장하는 것이 목표입니다.</p>
<h2 id="myBatis의-구조"><a href="#myBatis의-구조" class="headerlink" title="myBatis의 구조"></a>myBatis의 구조</h2><p>SqlSessionFactory, SqlSession이라는 두개의 객체를 가지고 있습니다. 기본적으로 mybatis.cfg.xml 파일을 이용해서 DB에 대한 연결 설정과 각각의 mapper를 구성하는 설정으로 구성되어 있습니다.</p>
<p>myBatis에서 DB에 대한 연결을 구성하는 방법은 다음과 같습니다.</p>
<ol>
<li>SqlSessionFactory 구성</li>
<li>SqlSessionFactory를 통한 SqlSession을 구성</li>
<li>SqlSession을 통해 mapper를 구성</li>
</ol>
<p>기본적인 <code>SqlSessionFactory</code>를 정의합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE configuration</span></span><br><span class="line"><span class="meta">        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"</span></span><br><span class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"org.mariadb.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"qwer12#$"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"mappers/bookDao.mapper.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>그리고, 각 Repository의 method에 따른 SQL문을 xml에 정의합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.xyzlast.bookstore.repository.BookDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"BookResult"</span> <span class="attr">type</span>=<span class="string">"com.xyzlast.bookstore.entity.Book"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"author"</span> <span class="attr">column</span>=<span class="string">"author"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"publishDate"</span> <span class="attr">column</span>=<span class="string">"publishDate"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"rentUserId"</span> <span class="attr">column</span>=<span class="string">"rentUserId"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"bookStatus"</span> <span class="attr">column</span>=<span class="string">"status"</span> <span class="attr">typeHandler</span>=<span class="string">"org.apache.ibatis.type.EnumOrdinalTypeHandler"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getById"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultMap</span>=<span class="string">"BookResult"</span>&gt;</span></span><br><span class="line">        SELECT * FROM books WHERE id = #&#123;bookId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getAll"</span> <span class="attr">resultMap</span>=<span class="string">"BookResult"</span>&gt;</span></span><br><span class="line">        SELECT * FROM books</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"countAll"</span> <span class="attr">resultType</span>=<span class="string">"int"</span>&gt;</span></span><br><span class="line">        SELECT count(*) FROM books</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"add"</span> <span class="attr">parameterType</span>=<span class="string">"com.xyzlast.bookstore.entity.Book"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyColumn</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">        INSERT INTO books(name, author, publishDate, comment, status, rentUserId)</span><br><span class="line">        VALUES(#&#123;name&#125;, #&#123;author&#125;, #&#123;publishDate&#125;, #&#123;comment&#125;, #&#123;bookStatus.value&#125;, #&#123;rentUserId&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"delete"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span>&gt;</span></span><br><span class="line">        DELETE FROM books WHERE id = #&#123;bookId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteAll"</span>&gt;</span></span><br><span class="line">        DELETE FROM books</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"update"</span> <span class="attr">parameterType</span>=<span class="string">"com.xyzlast.bookstore.entity.Book"</span>&gt;</span></span><br><span class="line">        UPDATE books SET</span><br><span class="line">        name = #&#123;name&#125;, author = #&#123;author&#125;, publishDate=#&#123;publishDate&#125;, status=#&#123;bookStatus.value&#125;, rentUserId=#&#123;rentUserId&#125;, comment = #&#123;comment&#125;</span><br><span class="line">        WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>xml이 모두 준비된 후, 다음과 같은 code pattern으로 처리됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line">SqlSession sqlSession;</span><br><span class="line"><span class="keyword">private</span> BookDao bookDao;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    InputStream is = Resources.getResourceAsStream(<span class="string">"mybatis-config.xml"</span>);</span><br><span class="line">    sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</span><br><span class="line">    sqlSession = sqlSessionFactory.openSession();</span><br><span class="line">    bookDao = sqlSession.getMapper(BookDao.class);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@After</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sqlSession != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sqlSession.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> bookCount = bookDao.countAll();</span><br><span class="line">    assertThat(bookCount).isGreaterThan(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SqlSessionFactory를 통해, SqlSession을 얻어내고 update/delete/insert에 대한 commit을 직접 행하도록 코드를 작성했습니다. 또한 모든 method가 완료되면 반드시 Session을 닫아줘야지만 됩니다.</p>
<h2 id="Spring-myBatis의-이용"><a href="#Spring-myBatis의-이용" class="headerlink" title="Spring-myBatis의 이용"></a>Spring-myBatis의 이용</h2><p>Spring과 myBatis를 연결하기 위해서는 추가 Library가 필요합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.mybatis'</span>, <span class="string">name:</span> <span class="string">'mybatis-spring'</span>, <span class="string">version:</span> <span class="string">'1.3.1'</span></span><br></pre></td></tr></table></figure>
<p>Spring에서 제공하는 <code>@Transaction</code>을 사용하기 위해서, <code>SqlSessionTemplate</code>를 이용합니다. 이는 <code>@Transaction</code>으로 지정된 method내 같은 <code>Session</code>으로 <code>@Transaction</code>이 지정될 수 있도록 만들어줍니다.<br>이를 지정하기 위한 <code>@Configruation</code>은 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(value = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.repository"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookStoreConfig</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">        dataSource.setMaximumPoolSize(<span class="number">10</span>);</span><br><span class="line">        dataSource.setMinimumIdle(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactoryBean <span class="title">sqlSessionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean sqlSessionFactoryBean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        sqlSessionFactoryBean.setDataSource(dataSource());</span><br><span class="line">        sqlSessionFactoryBean.setConfigLocation(context.getResource(<span class="string">"classpath:mybatis-config.xml"</span>));</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>그리고, <code>BookDaoImpl</code>을 구성해야지 됩니다. <code>BookDaoImpl</code>은 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDaoImpl</span> <span class="keyword">extends</span> <span class="title">SqlSessionDaoSupport</span> <span class="keyword">implements</span> <span class="title">BookDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookDaoImpl</span><span class="params">(SqlSessionFactory sqlSessionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setSqlSessionFactory(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSqlSession().getMapper(BookDao.class).countAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSqlSession().getMapper(BookDao.class).getAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSqlSession().getMapper(BookDao.class).getById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSqlSession().insert(<span class="string">"com.xyzlast.bookstore.repository.BookDao.add"</span>, book);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSqlSession().update(<span class="string">"com.xyzlast.bookstore.repository.BookDao.update"</span>, book);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSqlSession().delete(<span class="string">"com.xyzlast.bookstore.repository.BookDao.delete"</span>, bookId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>재미있는 코드를 하나 발견할 수 있습니다. <code>BookDaoImpl</code>의 생성자는 <code>SqlSessionFactory</code>를 인자로 받게 됩니다. 그런데, <code>SqlSessionFactory</code>를 <code>Bean</code>에 등록하는 코드는 <code>@Configuration</code>에 없습니다. 이건 어떻게 되는 것일까요. 이는 <code>SqlSessionFactoryBean</code>에서 확인할 수 있습니다. <code>SqlSessionFactoryBean</code>의 내부 코드는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlSessionFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">SqlSessionFactory</span>&gt;, <span class="title">InitializingBean</span>, <span class="title">ApplicationListener</span>&lt;<span class="title">ApplicationEvent</span>&gt; </span>&#123;</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>구현된 interface중에 <code>FactoryBean</code>이 있는 것을 보실 수 있습니다. Spring Configuration 내부에 <code>Factory Pattern</code>을 통해서 객체를 얻어내야지 될 필요가 있을 때, <code>FactoryBean</code> interface를 이용해서 구현하면 Spring은 이를 감지하여 <code>Factory Pattern</code>을 통해 객체를 얻어내게 됩니다.</p>
<p>마지막으로, query를 지정하는 방법은 다음 2가지로 볼 수 있습니다. <code>getMapper</code>를 통하거나, xml의 full-name을 기술하는 것. 두 방법 모두를 이용해서 구성이 가능합니다.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>국내에서 가장 많이 사용되는 <code>myBatis</code>를 이용한 DB 접근 방식에 대해서 알아봤습니다. 매우 간편한 설정 및 사용의 편의성, 무엇보다도 java 코드와 sql query간의 명확한 분리가 가장 큰 장점입니다.</p>
<h2 id="HOMEWORK"><a href="#HOMEWORK" class="headerlink" title="HOMEWORK"></a>HOMEWORK</h2><p>기존 코드의 Dao를 모두 <code>myBatis</code>를 이용해서 구성해주시길 바랍니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/java-spring-mybatis/">java, spring, mybatis</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/02/21/07-applicationcontext/"><span>07. ApplicationContext</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/02/21/07-applicationcontext/" rel="bookmark">
        <time class="entry-date published" datetime="2018-02-21T13:44:36.000Z">
          2018-02-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h1><p>Spring에서 ApplicationContext는 IoC, AOP를 설정하는 Container 또는 Configuration이라고 할 수 있습니다.<br>ApplicationContext는</p>
<ul>
<li>bean의 집합</li>
<li>bean에 대한 Map</li>
<li>bean의 life cycle 정의</li>
<li>bean에 대한 정의</li>
<li>AOP에 의한 bean의 확장에 대한 정의</li>
</ul>
<p>를 포함하고 있습니다. ApplicationContext에 대해서 좀 더 깊게 들어가보도록 하겠습니다.</p>
<h2 id="ApplicationContext-interface"><a href="#ApplicationContext-interface" class="headerlink" title="ApplicationContext interface"></a>ApplicationContext interface</h2><p>Application Context는 <code>org.springframework.context.ApplicationContext</code> interface를 상속받은 객체입니다. interface의 정의는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationContext</span> <span class="keyword">extends</span> <span class="title">EnvironmentCapable</span>, <span class="title">ListableBeanFactory</span>, <span class="title">HierarchicalBeanFactory</span>,</span></span><br><span class="line"><span class="class">        <span class="title">MessageSource</span>, <span class="title">ApplicationEventPublisher</span>, <span class="title">ResourcePatternResolver</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getId</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">getApplicationName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">getDisplayName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getStartupDate</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">ApplicationContext <span class="title">getParent</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">AutowireCapableBeanFactory <span class="title">getAutowireCapableBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ApplicationContext는 bean에 대한 집합이라고 했습니다. bean은 일반적으로 POJO class로 구성이 되게 됩니다. bean과 POJO의 정의는 다음과 같습니다.</p>
<h3 id="Java-Bean"><a href="#Java-Bean" class="headerlink" title="Java Bean"></a>Java Bean</h3><p>원 목적은 Servlet에서 Java 객체를 가지고 와서 사용하기 위해서 작성된 객체입니다. <strong>단순한 객체이며, 사용이 편리해야지 된다.</strong> 라는 것을 원칙으로 가지고 있습니다. 특징으로는</p>
<ul>
<li>property를 갖는다. (private 변수와 get/set method를 갖는다.)</li>
<li>serialization이 가능하다.</li>
</ul>
<h3 id="POJO-Plan-Old-Java-Object"><a href="#POJO-Plan-Old-Java-Object" class="headerlink" title="POJO (Plan Old Java Object)"></a>POJO (Plan Old Java Object)</h3><p>POJO 객체는 특정 기술과 Spec에 독립적인 객체로 만들어지는 것을 원칙으로 삼습니다. 자신이 속한 package에 속한 POJO 객체 이외에는 Java의 기본 객체만을 이용해서 작성하는 것이 원칙입니다. 또한, 확장성을 위해 자신이 속한 package의 POJO 객체가 아닌 POJO 객체의 interface를 속성으로 갖는 bean 객체로서 만들어지는 것이 일반적입니다. 지금까지 작성된 Book, User, UserHistory 객체의 경우에 POJO 객체라고 할 수 있습니다.</p>
<p>bean에 대한 집합인 ApplicationContext는 다음과 같은 특징을 갖습니다.</p>
<ul>
<li>bean id, name, alias로 구분이 가능한 bean들의 집합입니다.</li>
<li>life cycle을 갖습니다. (singleton, prototype)</li>
<li>property는 value 또는 다른 bean을 참조합니다.</li>
</ul>
<p>ApplicationContext는 bean들의 집합적인 특징 뿐 아니라, bean들의 loading 도 역시 담당하고 있습니다. ApplicationContext의 정보는 일반적으로 <code>@Configuration</code>과 <code>xml</code>을 이용합니다. 또한 수동으로 ApplicationContext를 구성하는 것 역시 가능합니다.</p>
<p>다음은 <code>StaticApplicationContext</code>을 이용해서 수동으로 ApplicationContext를 구성하는 것을 보여줍니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StaticApplicationContext ac = <span class="keyword">new</span> StaticApplicationContext();</span><br><span class="line">    ac.registerSingleton(<span class="string">"hello1"</span>, Hello.class);</span><br><span class="line">    Hello hello = ac.getBean(<span class="string">"hello1"</span>, Hello.class);</span><br><span class="line">    assertThat(hello).isNotNull();</span><br><span class="line">    Hello hello2 = ac.getBean(<span class="string">"hello1"</span>, Hello.class);</span><br><span class="line">    assertThat(hello).isSameAs(hello2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerApplicationContextWithPrototype</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StaticApplicationContext ac = <span class="keyword">new</span> StaticApplicationContext();</span><br><span class="line">    ac.registerPrototype(<span class="string">"hello1"</span>, Hello.class);</span><br><span class="line">    Hello hello = ac.getBean(<span class="string">"hello1"</span>, Hello.class);</span><br><span class="line">    assertThat(hello).isNotNull();</span><br><span class="line">    Hello hello2 = ac.getBean(<span class="string">"hello1"</span>, Hello.class);</span><br><span class="line">    assertThat(hello).isNotSameAs(hello2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>registerApplicationContext와 registerApplicationContextWithProtytype은 Hello 객체를 <code>Singleton</code> 또는 <code>Prototype</code>으로 등록하게 됩니다. Singleton은 ApplicationContext에 등록된 모든 객체들을 재사용하게 되는데, registerPrototype으로 등록된 객체들은 ApplicationContext에서 얻어낼 때마다 객체를 다시 생성해서 얻어내게 됩니다. 이는 <code>@Configuration</code>으로는 다음과 같이 구성됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(value = <span class="string">"hello1"</span>)</span><br><span class="line"><span class="meta">@Scope</span>(value = BeanDefinition.SCOPE_SINGLETON)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Hello <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Hello();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span>(value = <span class="string">"hello2"</span>)</span><br><span class="line"><span class="meta">@Scope</span>(value = BeanDefinition.SCOPE_PROTOTYPE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Hello <span class="title">hello1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Hello();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드는 다음 xml로 표현이 가능합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"hello1"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.ac.Hello"</span> <span class="attr">scope</span>=<span class="string">"singleton"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"hello2"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.ac.Hello"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="ApplicationContext에서-Bean의-등록-방법"><a href="#ApplicationContext에서-Bean의-등록-방법" class="headerlink" title="ApplicationContext에서 Bean의 등록 방법"></a>ApplicationContext에서 Bean의 등록 방법</h2><h3 id="annotation-을-이용하는-경우-singleton-prototype"><a href="#annotation-을-이용하는-경우-singleton-prototype" class="headerlink" title="annotation 을 이용하는 경우 - singleton/prototype"></a>annotation 을 이용하는 경우 - singleton/prototype</h3><p>주로 사용되는 방법입니다. <code>@Component</code>, <code>@Service</code>로 선언된 Bean들을 <code>@ComponentScan</code>을 통해서 검색해서 등록합니다.<br>이 때, 다음 두가지를 설정할 수 있습니다.</p>
<ul>
<li>객체의 LifeCycle: <code>@Scope</code>를 통해 <code>singleton/prototype</code>을 설정 가능합니다.</li>
<li>초기 실행 method: <code>@PostConstruct</code>를 통해 객체의 생성 이후에 실행할 method를 지정할 수 있습니다.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostConstruct</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//<span class="doctag">NOTE:</span> init method.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ApplicationContext에서의-FactoryPattern-이용"><a href="#ApplicationContext에서의-FactoryPattern-이용" class="headerlink" title="ApplicationContext에서의 FactoryPattern 이용"></a>ApplicationContext에서의 FactoryPattern 이용</h3><p>객체를 생성할 때, 무언가 초기화를 해줘야지 되는 경우가 왕왕 있습니다. <code>@PostConstruct</code>와 같이 단순하게 처리되는 경우도 있지만, 값을 설정하거나, TCP connection을 만들어주거나 하는 등의 초기 구성을 해줘야지 되는 경우가 꽤 있지요. 이때 주로 사용되는 것이 <code>Factory Pattern</code>입니다. <code>ApplicationContext</code>에서는 <code>FactoryBean&lt;T&gt;</code>을 통해 Factory Pattern을 지원합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FactoryBean</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="function">T <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  Class&lt;?&gt; getObjectType();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이와 같은 inteface를 구현한 객체는 <code>Hello</code>의 경우 다음과 같이 구성될 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">Hello</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Hello <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Hello hello = <span class="keyword">new</span> Hello();</span><br><span class="line">    <span class="keyword">return</span> hello;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">    <span class="keyword">return</span> Hello.class;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 이 코드를 <code>@Configuration</code>에 등록시켜줍니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DomainConfiguration</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> HelloFactoryBean <span class="title">helloFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HelloFactoryBean();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이렇게 등록된 <code>ApplicationContext</code>의 경우에는 다음 2개의 객체를 얻어낼 수 있습니다.</p>
<ul>
<li>HelloFactoryBean</li>
<li>Hello</li>
</ul>
<p>객체의 이름 그대로 <code>Factory pattern</code>을 사용해서 <code>Bean</code>을 얻어낼 수 있도록 지원합니다.</p>
<h2 id="ApplicationContext의-등록방법"><a href="#ApplicationContext의-등록방법" class="headerlink" title="ApplicationContext의 등록방법"></a>ApplicationContext의 등록방법</h2><p>applicationContext 의 등록방법은 spring에서 계속해서 발전되어가는 분야중 하나입니다. 총 3가지의 방법으로 나눌 수 있으며, 이 방법들은 같이 사용되는 것도 가능합니다.</p>
<h3 id="applicationContext-xml만을-이용-전체-Bean을-모두-각각-등록하는-방법"><a href="#applicationContext-xml만을-이용-전체-Bean을-모두-각각-등록하는-방법" class="headerlink" title="applicationContext.xml만을 이용, 전체 Bean을 모두 각각 등록하는 방법"></a>applicationContext.xml만을 이용, 전체 Bean을 모두 각각 등록하는 방법</h3><p>bookDao를 이용할 때, 처음 사용한 방법입니다. bean을 선언하고, id값을 이용해서 사용하는 방법으로 이 방법은 가장 오랫동안 사용해왔기 때문에 많은 reference들이 존재합니다. 그렇지만, 객체가 많아질수록 파일의 길이가 너무나 길어지고 관리가 힘들어지는 단점 때문에 요즘은 잘 사용되지 않습니다.</p>
<h3 id="annotation과-aplicationContext-xml을-이용하는-방법"><a href="#annotation과-aplicationContext-xml을-이용하는-방법" class="headerlink" title="@annotation과 aplicationContext.xml을 이용하는 방법"></a>@annotation과 aplicationContext.xml을 이용하는 방법</h3><p>@Component, @Repository, @Service, @Controller, @Value 등을 사용하고, component-scan 을 이용해서 applicationContext.xml에서 등록하는 방법입니다. 이 방법은 예전에 가장 많이 사용되었던 방법입니다. applicationContext.xml의 길이가 적당히 길고, 구성하기 편하다는 장점을 가지고 있습니다.</p>
<h3 id="Configuration을-이용한-applicationContext-객체를-이용하는-방법"><a href="#Configuration을-이용한-applicationContext-객체를-이용하는-방법" class="headerlink" title="@Configuration을 이용한 applicationContext 객체를 이용하는 방법"></a>@Configuration을 이용한 applicationContext 객체를 이용하는 방법</h3><p>Spring에서 근간에 밀고 있는 방법입니다. 이 방법은 다음과 같은 장점을 가지고 있습니다.</p>
<ul>
<li>이해하기 쉽습니다. - xml에 비해서 사용하기 쉽습니다.</li>
<li>복잡한 Bean 설정이나 초기화 작업을 손쉽게 적용할 수 있습니다. - 프로그래밍 적으로 만들기 때문에, 개발자가 다룰수 있는 영역이 늘어납니다.</li>
<li>작성 속도가 빠릅니다. - eclipse에서 java coding 하는것과 동일하게 작성하기 때문에 작성이 용의합니다.</li>
</ul>
<p>개인적으로는 2, 3번 방법을 모두 알아둬야지 된다고 생각합니다. 이유는 2번 방법의 경우, 기존에 가장 많이 사용되었던 방법입니다. legacy 코드에 대한 지원을 하기 위해서는 이 방법을 다룰줄 알아야지 됩니다. 최근은 당연히 3번 방법입니다. 최근에는 <code>xml</code>을 사용하는 예시조차 찾기 힘들정도로 3번 방법으로 집중되어가는 중입니다.</p>
<p>그럼, 이 3가지 방법을 모두 이용해서 기존의 BookStore를 등록하는 applicationContext를 한번 살펴보도록 하겠습니다.</p>
<h3 id="applicationContext-xml만을-이용하는-방법"><a href="#applicationContext-xml만을-이용하는-방법" class="headerlink" title="applicationContext.xml만을 이용하는 방법"></a>applicationContext.xml만을 이용하는 방법</h3><p>초기 Spring 2.5 이하 버젼에서 지원하던 방법입니다. 일명 xml 지옥이라고 불리우는 어마어마한 xml을 자랑했습니다. 최종적으로 만들어져 있는 applicationContext.xml의 구성은 다음과 같습니다. Transaction annotation이 적용되지 않기 때문에, Transaction에 대한 AOP code 까지 추가되는 엄청나게 긴 xml을 보여주고 있습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.2.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jdbcTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.core.JdbcTemplate"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.jolbox.bonecp.BoneCPDataSource"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.driver&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.url&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.username&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.password&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idleConnectionTestPeriodInMinutes"</span> <span class="attr">value</span>=<span class="string">"60"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idleMaxAgeInMinutes"</span> <span class="attr">value</span>=<span class="string">"240"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxConnectionsPerPartition"</span> <span class="attr">value</span>=<span class="string">"30"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minConnectionsPerPartition"</span> <span class="attr">value</span>=<span class="string">"10"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"partitionCount"</span> <span class="attr">value</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"acquireIncrement"</span> <span class="attr">value</span>=<span class="string">"5"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"statementsCacheSize"</span> <span class="attr">value</span>=<span class="string">"100"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"releaseHelperThreads"</span> <span class="attr">value</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:spring.properties"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"bookDao"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.bookstore02.dao.BookDaoImpl"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcTemplate"</span> <span class="attr">ref</span>=<span class="string">"jdbcTemplate"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userDao"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.bookstore02.dao.UserDaoImpl"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcTemplate"</span> <span class="attr">ref</span>=<span class="string">"jdbcTemplate"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"historyDao"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.bookstore02.dao.HistoryDaoImpl"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcTemplate"</span> <span class="attr">ref</span>=<span class="string">"jdbcTemplate"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userService"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.bookstore02.services.UserServiceImpl"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"bookDao"</span> <span class="attr">ref</span>=<span class="string">"bookDao"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"userDao"</span> <span class="attr">ref</span>=<span class="string">"userDao"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"historyDao"</span> <span class="attr">ref</span>=<span class="string">"historyDao"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"bookService"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.bookstore02.services.HistoryServiceImpl"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"bookDao"</span> <span class="attr">ref</span>=<span class="string">"bookDao"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"userDao"</span> <span class="attr">ref</span>=<span class="string">"userDao"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"historyDao"</span> <span class="attr">ref</span>=<span class="string">"historyDao"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManagerAdvisor"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.bookstore02.utils.TransactionAdvisor"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"transactionManager"</span> <span class="attr">ref</span>=<span class="string">"transactionManager"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">"org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"beanNames"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>userService<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>bookService<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"interceptorNames"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>transactionManagerAdvisor<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="annotation-applicationContext-xml을-이용한-방법"><a href="#annotation-applicationContext-xml을-이용한-방법" class="headerlink" title="@annotation + applicationContext.xml을 이용한 방법"></a>@annotation + applicationContext.xml을 이용한 방법</h3><p>@Repository, @Component, @Service를 이용해서 편한 방법을 제공합니다. 특히 component-scan과 @Autowired를 이용하면 위 applicationContext.xml을 효과적으로 줄일 수 있습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.2.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jdbcTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.core.JdbcTemplate"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.jolbox.bonecp.BoneCPDataSource"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.driver&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.url&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.username&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.password&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idleConnectionTestPeriodInMinutes"</span> <span class="attr">value</span>=<span class="string">"60"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idleMaxAgeInMinutes"</span> <span class="attr">value</span>=<span class="string">"240"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxConnectionsPerPartition"</span> <span class="attr">value</span>=<span class="string">"30"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minConnectionsPerPartition"</span> <span class="attr">value</span>=<span class="string">"10"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"partitionCount"</span> <span class="attr">value</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"acquireIncrement"</span> <span class="attr">value</span>=<span class="string">"5"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"statementsCacheSize"</span> <span class="attr">value</span>=<span class="string">"100"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"releaseHelperThreads"</span> <span class="attr">value</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:spring.properties"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.xyzlast.bookstore02.dao"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.xyzlast.bookstore02.services"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="annotation-Configuration을-이용한-방법"><a href="#annotation-Configuration을-이용한-방법" class="headerlink" title="@annotation + @Configuration을 이용한 방법"></a>@annotation + @Configuration을 이용한 방법</h3><p>이 방법은 xml을 아애 없애버릴 수 있습니다. xml이 제거된 ApplicationContext의 내용은 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:spring.properties"</span>)</span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;<span class="string">"com.xyzlast.bookstore02.dao"</span>, <span class="string">"com.xyzlast.bookstore02.services"</span>&#125;)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Environment env;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PropertySourcesPlaceholderConfigurer <span class="title">propertySourcesPlaceholderConfigurer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        PropertySourcesPlaceholderConfigurer configHolder = <span class="keyword">new</span> PropertySourcesPlaceholderConfigurer();</span><br><span class="line">        <span class="keyword">return</span> configHolder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BoneCPDataSource dataSource = <span class="keyword">new</span> BoneCPDataSource();</span><br><span class="line">        dataSource.setUsername(env.getProperty(<span class="string">"connect.username"</span>));</span><br><span class="line">        dataSource.setPassword(env.getProperty(<span class="string">"connect.password"</span>));</span><br><span class="line">        dataSource.setDriverClass(env.getProperty(<span class="string">"connect.driver"</span>));</span><br><span class="line">        dataSource.setJdbcUrl(env.getProperty(<span class="string">"connect.url"</span>));</span><br><span class="line">        dataSource.setMaxConnectionsPerPartition(<span class="number">20</span>);</span><br><span class="line">        dataSource.setMinConnectionsPerPartition(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JdbcTemplate template = <span class="keyword">new</span> JdbcTemplate();</span><br><span class="line">        template.setDataSource(dataSource());</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DataSourceTransactionManager transactionManager = <span class="keyword">new</span> DataSourceTransactionManager(dataSource());</span><br><span class="line">        <span class="keyword">return</span> transactionManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>지금까지 작성하던 xml과는 완전히 다른 모습의 ApplicationContext입니다. ApplicationContext Config 객체는 다음과 같은 특성을 갖습니다.</p>
<ul>
<li>@Configuration annotation을 갖는다.</li>
<li>bean으로 등록되는 객체는 method로 관리되고, @Bean annotation을 갖습니다.</li>
<li>method의 이름이 <code>&lt;bean id=&quot;&quot;&gt;</code>값과 매칭됩니다.</li>
<li>component-scan, property-place-holder의 경우, class의 annotation으로 갖습니다.</li>
<li>@EnableTransactionManagement와 같이 @Enable** 로 시작되는 annotation을 이용해서 전역 annotation을 구성합니다.</li>
<li>Properties 파일을 사용하기 위해서는 반드시 static method로 PropertySourcesPlaceholderConfigurer를 return 시켜줘야지 됩니다.</li>
</ul>
<h3 id="xml-annotation-Configuration을-이용한-방법"><a href="#xml-annotation-Configuration을-이용한-방법" class="headerlink" title="xml + @annotation + @Configuration을 이용한 방법"></a>xml + @annotation + @Configuration을 이용한 방법</h3><p>위에서는 3가지 방법이라고 했지만, 한가지 방법이 더 있습니다. 모두를 다 섞어서 사용하는 방법입니다. 기본은 <code>@Configuration</code>에서 시작합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ImportResource</span>(<span class="string">"classpath:/config/spring.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>용도에 따라, 다른 <code>@Configuration</code>을 결합해서 사용할 필요도 있습니다. 다음과 같이 확장이 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import</span>(&#123; AppConfigWeb.class &#125;)</span><br><span class="line"><span class="meta">@ImportResource</span>(<span class="string">"classpath:/config/spring.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Summay"><a href="#Summay" class="headerlink" title="Summay"></a>Summay</h2><p>ApplicationContext에 대한 기본 개념을 정리해봤습니다. ApplicationContext는 Spring의 핵심 기능입니다. DI를 통한 IoC를 가능하게 하고, AOP에 대한 설정 등 모든 Spring에서 하는 일이 설정되어 있는 것이 ApplicaionContext라고 할 수 있습니다. 이에 대한 설정 및 구성을 명확하게 알아놓을 필요가 있습니다. 그리고, 내부에서 어떤 일을 해서 Spring에서 하는 이런 일들이 가능하게 되는지에 대한 이해가 필요합니다. 마지막으로 ApplicationContext를 구성하는 방법에 대해서 알아봤습니다. 제공되는 3가지 방법에 대해 자유자재로 사용할 수 있는 능력이 필요합니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/java-spring/">java, spring</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/02/08/aop/"><span>06.AOP</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/02/08/aop/" rel="bookmark">
        <time class="entry-date published" datetime="2018-02-07T23:21:07.000Z">
          2018-02-08
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h1><p>지금까지 구성된 테스트 코드의 마지막에 코드를 하나 추가해보도록 하겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserService userService = applicationContext.getBean(UserService.class);</span><br><span class="line">    UserDao userDao = applicationContext.getBean(UserDao.class);</span><br><span class="line">    BookDao bookDao = applicationContext.getBean(BookDao.class);</span><br><span class="line">    User user = userDao.getAll().get(<span class="number">0</span>);</span><br><span class="line">    Book book = bookDao.getAll().get(<span class="number">0</span>);</span><br><span class="line">    book.setBookStatus(BookStatus.CanRent);</span><br><span class="line">    book.setRentUserId(<span class="keyword">null</span>);</span><br><span class="line">    bookDao.update(book);</span><br><span class="line"></span><br><span class="line">    assertThat(userService.rent(user.getId(), book.getId())).isTrue();</span><br><span class="line">    assertThat(userService).isInstanceOf(UserServiceImpl.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>실행해보면 테스트 오류가 발생되는 것을 볼 수 있습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">java.lang.AssertionError:</span></span><br><span class="line"><span class="function"><span class="title">Expecting</span>:</span></span><br><span class="line"><span class="function">  &lt;<span class="title">com.xyzlast.bookstore.service.UserServiceImpl</span>@7<span class="title">bbc8656</span>&gt;</span></span><br><span class="line"><span class="function"><span class="title">to</span> <span class="title">be</span> <span class="title">an</span> <span class="title">instance</span> <span class="title">of</span>:</span></span><br><span class="line"><span class="function">  &lt;<span class="title">com.xyzlast.bookstore.service.UserServiceImpl</span>&gt;</span></span><br><span class="line"><span class="function"><span class="title">but</span> <span class="title">was</span> <span class="title">instance</span> <span class="title">of</span>:</span></span><br><span class="line"><span class="function">  &lt;<span class="title">com.sun.proxy</span>.$<span class="title">Proxy31</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>그럼 기존의 <code>@Transactional</code>을 제거한 후, 테스트를 돌리면 테스트오류가 발생되지 않습니다. 처음보는 객체이름이 보입니다. 거기에 이제는 최대한 사용하지 말라고 되어 있는 <code>com.sun</code> package의 객체입니다. 어떻게 이런 일이 발생하게 되는지 알아보도록 하겠습니다.</p>
<p>이 부분을 이해하기 위해서는 Spring의 이제 2번째 개념인 AOP에 대한 이해가 필요합니다. AOP에 대한 설명을 하기 위해 기존 <code>PlatformTransactionManager</code>를 사용한 코드를 먼저 참고합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">    TransactionStatus status = transactionManager.getTransaction(<span class="keyword">new</span> DefaultTransactionDefinition());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        User user = userDao.get(userId);</span><br><span class="line">        Book book = bookDao.get(bookId);</span><br><span class="line"></span><br><span class="line">        book.setRentUserId(user.getId());</span><br><span class="line">        book.setStatus(BookStatus.RentNow);</span><br><span class="line">        bookDao.update(book);</span><br><span class="line"></span><br><span class="line">        user.setPoint(user.getPoint() + <span class="number">10</span>);</span><br><span class="line">        user.setLevel(userLevelLocator.getUserLevel(user.getPoint()));</span><br><span class="line"></span><br><span class="line">        UserHistory history = <span class="keyword">new</span> UserHistory();</span><br><span class="line">        history.setUserId(userId);</span><br><span class="line">        history.setBookId(book.getId());</span><br><span class="line">        history.setAction(HistoryActionType.RENT);</span><br><span class="line"></span><br><span class="line">        userDao.update(user);</span><br><span class="line">        userHistoryDao.add(history);</span><br><span class="line">        <span class="keyword">this</span>.transactionManager.commit(status);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">        <span class="keyword">this</span>.transactionManager.rollback(status);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드를 보면 Transaction의 경계설정 코드와 BL 코드가 복잡하고 연결이 되어있는것 같이 보이지만, 명확하게 코드는 분리가 될 수 있습니다. transactionManager를 사용하는 코드와 BL 코드로 분리가 깔끔하게 가능합니다. 여기서 전에 사용한 Template-callback 으로 변경시키는 것 역시 쉽게 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> userId, <span class="keyword">final</span> <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">    doBLWithTransaction(<span class="keyword">new</span> BusinessLogic() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            User user = userDao.get(userId);</span><br><span class="line">            Book book = bookDao.get(bookId);</span><br><span class="line"></span><br><span class="line">            book.setRentUserId(user.getId());</span><br><span class="line">            book.setStatus(BookStatus.RentNow);</span><br><span class="line">            bookDao.update(book);</span><br><span class="line"></span><br><span class="line">            user.setPoint(user.getPoint() + <span class="number">10</span>);</span><br><span class="line">            user.setLevel(userLevelLocator.getUserLevel(user.getPoint()));</span><br><span class="line"></span><br><span class="line">            UserHistory history = <span class="keyword">new</span> UserHistory();</span><br><span class="line">            history.setUserId(userId);</span><br><span class="line">            history.setBookId(book.getId());</span><br><span class="line">            history.setAction(HistoryActionType.RENT);</span><br><span class="line"></span><br><span class="line">            userDao.update(user);</span><br><span class="line">            userHistoryDao.add(history);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">BusinessLogic</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doProcess</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doBLWithTransaction</span><span class="params">(BusinessLogic loc)</span> </span>&#123;</span><br><span class="line">    TransactionStatus status = transactionManager.getTransaction(<span class="keyword">new</span> DefaultTransactionDefinition());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        loc.doProcess();</span><br><span class="line">        <span class="keyword">this</span>.transactionManager.commit(status);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">        <span class="keyword">this</span>.transactionManager.rollback(status);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>그런데, 이와 같은 코드는 지금까지 만들어진 <code>Repository Pattern</code>과 조금 다른 경계를 갖습니다.  DB에 대한 내용은 Repository측으로, BL측은 Service로 분리가 되어 있던 것이, Transaction에 대한 코드가 BL과 같이 있으면서 OOP의 기본 원칙인 <code>단일책임원칙</code>이 어긋나기 시작합니다. 그리고, 이런 코드는 계속되는 반복에 의해서 만들어지기 때문에 코드를 관리하는데 조금 복잡해보이는것이 사실입니다. 이와 같이 분리된 코드를 도식화 하면 다음과 같습니다.</p>
<p><img src="/images/aop/01.jpg" alt=""></p>
<p>그렇다면, Transaction에 대한 코드를 아애 분리하는 방법을 생각해볼 수 있습니다. BL과 Transaction을 아애 분리시키고, BL을 사용하는 측에서는 Transaction을 사용하는 객체를 사용하는 것입니다. 다음은 분리된 Transaction 코드 패턴을 볼 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceTx</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    PlatformTransactionManager transactionManager;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userServiceImpl;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">BusinessLogic</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">doProcess</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doBLWithTransaction</span><span class="params">(BusinessLogic loc)</span> </span>&#123;</span><br><span class="line">        TransactionStatus status = transactionManager.getTransaction(<span class="keyword">new</span> DefaultTransactionDefinition());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            loc.doProcess();</span><br><span class="line">            <span class="keyword">this</span>.transactionManager.commit(status);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">            <span class="keyword">this</span>.transactionManager.rollback(status);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> userId, <span class="keyword">final</span> <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">        doBLWithTransaction(<span class="keyword">new</span> BusinessLogic() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                userService.rent(userId, bookId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드는 실제 구현된 <code>UserServiceImpl</code>을 한번 더 감싼 <code>UserServiceTx</code>를 또 만들어서 사용하는 것입니다. <code>UserServiceTx</code>를 사용하는 측에서 보면 다음과 같이 실행되게 됩니다.</p>
<p><img src="/images/aop/02.jpg" alt=""></p>
<p>이와 같은 개발 패턴을 proxy pattern이라고 합니다. proxy pattern의 정의는 다음과 같습니다.</p>
<p><strong>Proxy패턴은 object를 호출할 때, 부가적인 처리를 실행할 수 있도록 하기 위한 패턴입니다. 이와 동시에 그 오브젝트의 이용자(클라이언트)에 대한 변경을 최소화할 수도 있다. Proxy 패턴을 잘 사용한다면, 어플리케이션의 사용편리성을 향상시키는데 이용됩니다.</strong></p>
<p>말이 어렵습니다. 간단히 말을 풀면, UserService를 실행하는 Test 객체 입장에선 UserServiceImpl을 실행을 하나, UserServiceTx를 실행하나 동일한 interface를 실행하게 됩니다.  동일한 Interface로 접근을 하되, 다른 객체를 통해서 원 객체를 접근하게 만드는 방식을 Proxy pattern 이라고 합니다.</p>
<p>또한, Proxy pattern은 거의 또 다른 pattern을 동시에 실행하게 됩니다. 그건 decorate pattern 입니다. decorate patten의 정의는 다음과 같습니다.</p>
<p><strong>기능의 ‘장식’(Decorator)이라는 개념을 클래스로 만들어 분화시킨 후, 이를 기존 객체가 참조하는 형태로 덧붙여나갈 수 있게 한다. Decorator와 꾸미는 대상이 되는 클래스는 같은 기반 클래스를 상속받는다. 그리고 두 클래스 모두 새로운Decorator 객체를 참조할 수 있는 구조로 만든다.</strong></p>
<p>말이 더 어렵습니다. decorate pattern은 동일한 interface에 접근되는 객체에 새로운 기능이 추가되는 것을 decorate pattern이라고 합니다. proxy pattern과 decorate pattern은 매우 헛갈리면서 같이 사용이 되는 것이 일반적입니다. 접근되는 객체에 대한 관점은 proxy pattern이라고 생각하시면 되고, decorate pattern은 접근된 기능에 추가 기능을 같이 실행시키는 것을 의미합니다.</p>
<p>위 객체를 다시 설명을 하면, UserServiceTx라는 Proxy를 만들어서 UserServiceImpl에 접근을 하게 되고, UserServiceTx는 decorate pattern을 이용해서 transaction 기능을 추가하고 있습니다.</p>
<p>최종적으로, Spring의 @Transaction 역시 Proxy Pattern과 Decorate Pattern이 결합된 형태로 구성되어 있습니다. Transaction 기능을 추가하기 위해서 Decorate Pattern으로 기능이 추가 되어 있으며, 실 객체가 아닌 (예제에서는 UserServiceImpl) Decorate가 추가된 객체에 접근하도록 객체의 접근을 제어한 Proxy Pattern이 결합되어 있습니다. 이 부분을 구현하는 Java의 기본 코드 구조를 Dynamic Proxy라고 합니다.</p>
<h2 id="Dynamic-Proxy"><a href="#Dynamic-Proxy" class="headerlink" title="Dynamic Proxy"></a>Dynamic Proxy</h2><p>이러한 Proxy 객체를 어떻게 만들어주게 되는 걸까요? 지금 저희 코드는 UserServiceTx라는 Proxy를 작성해줬습니다. Spring과 같은 Framework는 범용적이며, 가변적인 Proxy를 만드는 방법들을 가지고 있습니다. 가장 대표적인 것은 reflection입니다. Spring은 기본적으로 reflection을 통해서 이 부분을 처리합니다. 이 부분에 대해서 좀 더 깊게 들어가보도록 하겠습니다. 먼저 간단한 Relection 코드를 확인해보도록 하겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doDynamicReflection</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String name = <span class="string">"ykyoon"</span>;</span><br><span class="line">    Method lengthMethhod = String.class.getMethod(<span class="string">"length"</span>);</span><br><span class="line">    Object invokeResult = lengthMethhod.invoke(name);</span><br><span class="line">    assertThat(invokeResult).isInstanceOf(Integer.class).isEqualTo(<span class="number">6</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드를 보시면 좀 재미있는 내용들이 보이게 됩니다. String 객체의 length method를 문자열로 mehtod의 이름을 이용해서 호출할 수 있는 것을 확인할 수 있는데요.<br>java의 Method object는 각 객체의 method에 대한 정의를 갖는 객체입니다. 이를 이용해서 dynamic한 method 호출을 할 수 있지요. 이제 본격적인 Relection 코드를 확인해보도록 하겠습니다.</p>
<p>Dynamic Proxy에 대해서 깊게 알아보기 위해서 가장 먼저 알아봐야지 될 내용은  InvocationHandler interface입니다. InvocationHandler는 Proxy.newInstance에서 새로운 객체를 만들고, 그 객체에 Proxy를 통해서 접근하는 방식을 제공하는 interface입니다.</p>
<p>한번 예시를 사용해보도록 하겠습니다. InvocationHandler를 이용해서 객체의 모든 String output을 대문자로 자동으로 변경시키는 Proxy를 만들어보도록 하겠습니다.</p>
<p>먼저, Proxy의 target이 되는 interface와 객체입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">sayHello</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">sayHi</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">sayThankYou</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloImpl</span> <span class="keyword">implements</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello "</span> + name + <span class="string">"!!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHi</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hi "</span> + name + <span class="string">"!!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayThankYou</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Thank you. "</span> + name + <span class="string">"!!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>그리고, 모든 output을 UpperCast로 변경시키는 InvocationHandler를 구성하도록 하겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UppercaseHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UppercaseHandler</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        String ret = (String) method.invoke(<span class="keyword">this</span>.target, args);</span><br><span class="line">        <span class="keyword">return</span> ret.toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>코드는 매우 단순합니다.</p>
<p>그리고, Hello interface를 통해서 HelloImpl로 접근하는 Proxy 객체를 만들어보도록 하겠습니다.  HelloImpl에 대한 test 를 작성해서 다음 코드를 실행해보면 다음 결과를 얻어낼 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">helloWorldReflection</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Hello proxiedHello = (Hello) Proxy.newProxyInstance(getClass().getClassLoader(),</span><br><span class="line">        <span class="keyword">new</span> Class[] &#123; Hello.class&#125;,</span><br><span class="line">        <span class="keyword">new</span> UppercaseHandler(<span class="keyword">new</span> HelloImpl()));</span><br><span class="line"></span><br><span class="line">    String output = proxiedHello.sayHello(<span class="string">"ykyoon"</span>);</span><br><span class="line">    System.out.println(<span class="string">"Output은 다음과 같습니다. : "</span> + output);</span><br><span class="line">    System.out.println(<span class="string">"Proxy의 이름은 다음과 같습니다. : "</span> + proxiedHello.getClass().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">com.intellij.rt.execution.junit.JUnitStarter -ideVersion5 -junit4 com.xyzlast.bookstore.aop.ReflectionTest,helloWorldReflection</span><br><span class="line">Output은 다음과 같습니다. : HELLO YKYOON!!</span><br><span class="line">Proxy의 이름은 다음과 같습니다. : com.sun.proxy.$Proxy4</span><br></pre></td></tr></table></figure>
<p>Spring에서 @Transaction에서 보시던 결과가 나왔습니다. Spring에서 @Transaction은 다음과 같은 코드로 구성되어 있습니다.  (Sudo code입니다.)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTransactionProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object targetService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PlatformTransactionManager transactionManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpringTransactionProxy</span><span class="params">(Object targetService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.targetService = targetService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        TransactionStatus status = transactionManager.beginTransaction(<span class="keyword">new</span> DefaultTransaction());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            method.invoke(<span class="keyword">this</span>.targetService, args);</span><br><span class="line">            transactionManager.commit(status);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">            transactionManager.rollback(status);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>잘 보시면, 기존의 template-callback pattern과 유사한 코드가 만들어집니다. 단, 구현 방법이 InvocationHandler를 이용한 Proxy객체를 만들어서, 그 객체를 통해 method의 전/후에 특정한 action을 집어 넣고 있는 방식을 사용하고 있는 것입니다. 이렇게 method의 전/후에 특정 action을 삽입하는 개발 방법을 AOP(aspect oriented programming)라고 합니다.</p>
<h2 id="Spring에서의-AOP-이용"><a href="#Spring에서의-AOP-이용" class="headerlink" title="Spring에서의 AOP 이용"></a>Spring에서의 AOP 이용</h2><p>AOP는 Transaction 뿐 아니라, 다른 method들에서도 이와 같은 Decorate와 Proxy patten들을 사용할 수 있는 멋진 방법들을 제공합니다. 지금까지 보던 Transaction에 대한 코드를 보시면 Transaction의 대상이 되는 method의 전/후에 transaction.begin() / commit()이 실행되고 있습니다. 좀더 이것을 발전시킨다면 특정 method가 시작되기 전에, 또는 method가 실행 된 후에,아니면 method에서 exception이 발생한 후에 수행되는 특정 InvocationHandler를 지정해주는 것도 가능하지 않을까? 라는 의문이 생깁니다. 이러한 개발 방법을 이용하면, 지금까지 공부해왔던 OOP에 대한 다른 개념으로 발전하게 됩니다.</p>
<p>OOP를 공부하면 가장 많이 나오는 말은 상속 그리고 구현입니다. extends, implements에 대한 이야기들이 대부분이지요. 이는 object의 종적인 연결관계를 나타냅니다. 그렇지만, 이와 같이 method의 횡적인 연결관계에 대한 논의입니다. OOP와는 조금 다른 부분의 이야기라고 생각합니다.</p>
<p><img src="/images/aop/03.jpg" alt=""></p>
<p>이러한 개념은 여러 곳에서 사용될 수 있습니다. 예를 들어…</p>
<ul>
<li>사용자의 권한 체크</li>
<li>In/Out에 대한 로그 기능</li>
<li>Return값에 특정한 값이 있는 경우에 공통되는 Action을 해야지 되는 경우</li>
<li>Transaction과 같은 method의 실행에 있어서 전/후 처리를 해줘야지 될때</li>
<li>Return값에 특정한 데이터 양식을 추가해야지 될 때</li>
<li>Exception의 처리</li>
</ul>
<p>제가 생각하는 기능들은 이정도인데, 다른 분들은 어떤 기능을 추가할 수 있을까요?</p>
<p>AOP의 확장은 거의 무한대에 가깝습니다. 기존의 OOP 적 사고방식을 크게 확장시킬 수 있는 개념이기도 하면서, 기존의 OOP의 설계를 무너트릴수도 있는 개념입니다. OOP는 종적, AOP는 횡적 객체의 확장이다. 라고 이해를 하시고 다음 용어들을 이해하시면 좀 더 이해가 편할 것 같습니다.</p>
<h3 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h3><p>AOP의 Target이 되는 객체입니다. 지금까지 만들었던 Service객체 또는 HelloImpl과 같이 직접 AOP 당하는 객체를 Target이라고 합니다.</p>
<h3 id="Advice"><a href="#Advice" class="headerlink" title="Advice"></a>Advice</h3><p>위에 구성된 InvocationHandler에 의해서 사용될 interface가 구현된 객체입니다. 다른 객체에 추가적인 action을 확장시키기 위한 객체입니다. Spring은 총 3개의 Advice interface를 제공하고 있습니다. 아래의 interface를 상속받아 Advice를 구성합니다.</p>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>MethodBeforeAdvice</td>
<td>method가 실행되기 전에 실행되는 Advicer를 구성합니다.</td>
</tr>
<tr>
<td>AfterReturningAdvice</td>
<td>method가 실행 후, return 값을 보내기 직전에 실행되는 Advicer를 구성합니다.</td>
</tr>
<tr>
<td>MethodInterceptor</td>
<td>method의 전/후 모두에 실행 가능한 Advicer를 구성합니다.</td>
</tr>
</tbody>
</table>
<h3 id="Pointcut"><a href="#Pointcut" class="headerlink" title="Pointcut"></a>Pointcut</h3><p>Advice를 적용할 Point를 선별하는 작업을 하는 객체를 말합니다. Spring에서는 @Transactional이 적용된 모든 method에 대한 Transaction Advice의 Pointcut은</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>으로 선언되고 있습니다.</p>
<h3 id="Advisor"><a href="#Advisor" class="headerlink" title="Advisor"></a>Advisor</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Advisor = Advice + PointCut</span><br></pre></td></tr></table></figure>
<p>이라고 생각하시면 됩니다. 부가기능 + 적용대상이 반영된 interface라고 하면 설명이 좀더 쉽습니다.<br>이제 Spring에서 AOP를 다른 method에 적용해보도록 하겠습니다.</p>
<p>간단히 <code>AfterReturningAdvice</code>를 <code>UserService</code>에 적용하는 설정은 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceMethodAdvice</span> <span class="keyword">implements</span> <span class="title">AfterReturningAdvice</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">(Object returnValue, Method method, Object[] args, Object target)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(method.getName() + <span class="string">" is called"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Advice</code>를 선언한 후, 이제 <code>PointCut</code>과 <code>Target</code>을 섞어서 선언해줍니다. 이는 <code>@Configuration</code>에서 설정합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanNameAutoProxyCreator <span class="title">beanNameAutoProxyCreator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BeanNameAutoProxyCreator beanNameAutoProxyCreator = <span class="keyword">new</span> BeanNameAutoProxyCreator();</span><br><span class="line">    beanNameAutoProxyCreator.setBeanNames(<span class="string">"userServiceImpl"</span>);</span><br><span class="line">    beanNameAutoProxyCreator.setInterceptorNames(<span class="string">"methodInterceptor"</span>);</span><br><span class="line">    <span class="keyword">return</span> beanNameAutoProxyCreator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span>(value = <span class="string">"methodInterceptor"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ServiceMethodAdvice <span class="title">methodInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ServiceMethodAdvice();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>구성되어 있는 <code>AOP</code>는 객체중심으로 선언이 됩니다. 그런데, 요즘은 이와 같은 방법을 통해서 <code>AOP</code>를 선언하는 것을 권장하지 않습니다.</p>
<h2 id="AspectJ-Spring을-이용한-AOP"><a href="#AspectJ-Spring을-이용한-AOP" class="headerlink" title="AspectJ + Spring을 이용한 AOP"></a>AspectJ + Spring을 이용한 AOP</h2><p><code>AspectJ</code>는 AspectJ는 PARC에서 개발한 자바 프로그래밍 언어용 관점 지향 프로그래밍 (AOP) 확장 기능입니다. 이클립스 재단 오픈 소스 프로젝트에서 독립형 또는 이클립스로 통합하여 이용 가능합니다. AspectJ는 최종 사용자를 위한 단순함과 이용성을 강조함으로써 폭넓게 사용되는 AOP에 대한 데 팍토 표준입니다.</p>
<p>기본 Spring Proxy를 이용하는 것보다 performance + 확장성이 더 좋습니다. 먼저 <code>spring-aop</code>를 추가합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-aop'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br><span class="line">compile <span class="string">'org.aspectj:aspectjrt:1.8.1'</span></span><br><span class="line">compile <span class="string">'org.aspectj:aspectjtools:1.8.1'</span></span><br><span class="line">compile <span class="string">'org.aspectj:aspectjweaver:1.8.1'</span></span><br></pre></td></tr></table></figure>
<p>먼저 Target이 될 method를 결정합니다. 이 method를 결정하는 방법은 여러가지가 있습니다. 다음 6가지가 주로 사용됩니다.</p>
<ul>
<li>execution: 메소드 실행 결합점(join points)과 일치시키는데 사용된다.</li>
<li>within: 특정 타입에 속하는 결합점을 정의한다.</li>
<li>this: 빈 참조가 주어진 타입의 인스턴스를 갖는 결합점을 정의한다.</li>
<li>target: 대상 객체가 주어진 타입을 갖는 결합점을 정의한다.</li>
<li>args: 인자가 주어진 타입의 인스턴스인 결합점을 정의한다.</li>
<li>annotation: method에 선언된 @Annotation을 기준으로 결합점을 정의한다.</li>
</ul>
<p>다음은 Pointcut의 예시입니다.</p>
<table>
<thead>
<tr>
<th>Pointcut</th>
<th>선택된 Joinpoints</th>
</tr>
</thead>
<tbody>
<tr>
<td>execution(public <em> </em>(..))</td>
<td>public 메소드 실행</td>
</tr>
<tr>
<td>execution(<em> set</em>(..))</td>
<td>이름이 set으로 시작하는 모든 메소드명 실행</td>
</tr>
<tr>
<td>execution(<em> set</em>(..))</td>
<td>이름이 set으로 시작하는 모든 메소드명 실행</td>
</tr>
<tr>
<td>execution(<em> com.xyz.service.AccountService.</em>(..))</td>
<td>AccountService 인터페이스의 모든 메소드 실행</td>
</tr>
<tr>
<td>execution(<em> com.xyz.service.</em>.*(..))</td>
<td>service 패키지의 모든 메소드 실행</td>
</tr>
<tr>
<td>execution(<em> com.xyz.service..</em>.*(..))</td>
<td>service 패키지와 하위 패키지의 모든 메소드 실행</td>
</tr>
<tr>
<td>within(com.xyz.service.*)</td>
<td>service 패키지 내의 모든 결합점</td>
</tr>
<tr>
<td>within(com.xyz.service..*)</td>
<td>service 패키지 및 하위 패키지의 모든 결합점</td>
</tr>
<tr>
<td>this(com.xyz.service.AccountService)</td>
<td>AccountService 인터페이스를 구현하는 프록시 개체의 모든 결합점</td>
</tr>
<tr>
<td>target(com.xyz.service.AccountService)</td>
<td>AccountService 인터페이스를 구현하는 대상 객체의 모든 결합점</td>
</tr>
<tr>
<td>args(java.io.Serializable)</td>
<td>하나의 파라미터를 갖고 전달된 인자가 Serializable인 모든 결합점</td>
</tr>
<tr>
<td>@target(org.springframework.transaction.annotation.Transactional)</td>
<td>대상 객체가 @Transactional 어노테이션을 갖는 모든 결합점</td>
</tr>
<tr>
<td>@within(org.springframework.transaction.annotation.Transactional)</td>
<td>대상 객체의 선언 타입이 @Transactional 어노테이션을 갖는 모든 결합점</td>
</tr>
<tr>
<td>@annotation(org.springframework.transaction.annotation.Transactional)</td>
<td>실행 메소드가 @Transactional 어노테이션을 갖는 모든 결합점</td>
</tr>
<tr>
<td>@args(com.xyz.security.Classified)</td>
<td>단일 파라미터를 받고, 전달된 인자 타입이 @Classified 어노테이션을 갖는 모든 결합점</td>
</tr>
<tr>
<td>bean(accountRepository)</td>
<td>“accountRepository” 빈</td>
</tr>
<tr>
<td>!bean(accountRepository)</td>
<td>“accountRepository” 빈을 제외한 모든 빈</td>
</tr>
<tr>
<td>bean(*)</td>
<td>모든 빈</td>
</tr>
<tr>
<td>bean(account*)</td>
<td>이름이 ‘account’로 시작되는 모든 빈</td>
</tr>
<tr>
<td>bean(*Repository)</td>
<td>이름이 “Repository”로 끝나는 모든 빈</td>
</tr>
<tr>
<td>bean(accounting/*)</td>
<td>이름이 “accounting/“로 시작하는 모든 빈</td>
</tr>
</tbody>
</table>
<p>개인적으로는 Spring에서의 <code>@Transaction</code>의 처리와 동일하게 AOP선언에 맞게 신규 <code>@Annotation</code>을 만들어주고, 이를 Target으로 명확하게 지정하는 것입니다. 다음과 같이 구성하는 것입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(value = ElementType.METHOD)</span><br><span class="line"><span class="meta">@Retention</span>(value = RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ServiceAopMethod &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>그리고, 이를 <code>Advisor</code>에 다음과 같이 등록합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceAdvisor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"@annotation(com.xyzlast.bookstore.aop.ServiceAopMethod)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceMethodPointCut</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AspectJ</code>는 다음 5개의 annotation을 제공합니다. 이는 다음과 같습니다.</p>
<table>
<thead>
<tr>
<th>Annotation</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Before</td>
<td>method가 call되기 전 입니다.</td>
</tr>
<tr>
<td>@Around</td>
<td>method를 wrap 시켜서 사용되는 형태입니다.</td>
</tr>
<tr>
<td>@After</td>
<td>method가 call이 모두 완료된 이후에 실행됩니다. finally와 동일한 형태라고 생각하시면 됩니다.</td>
</tr>
<tr>
<td>@AfterReturning</td>
<td>method가 정상적으로 실행된 이후, 실행됩니다.</td>
</tr>
<tr>
<td>@AfterThrowing</td>
<td>method에서 exception이 발생될 때 사용됩니다.</td>
</tr>
</tbody>
</table>
<p>이제 <code>Pointcut</code>과 <code>Advice</code>가 모두 추가된 <code>Advisor</code>는 다음과 같은 형태로 구성됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceAdvisor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"@annotation(com.xyzlast.bookstore.aop.ServiceAopMethod)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceMethodPointCut</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"serviceMethodPointCut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTargetMethod</span><span class="params">(JoinPoint thisJoinPoint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"beforeTargetMethod"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(pointcut = <span class="string">"serviceMethodPointCut()"</span>, returning = <span class="string">"retVal"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturningTargetMethod</span><span class="params">(JoinPoint thisJoinPoint, Object retVal)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"AspectUsingAnnotation.afterReturningTargetMethod executed."</span> +</span><br><span class="line">            <span class="string">" return value is ["</span> + retVal + <span class="string">"]"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(pointcut = <span class="string">"serviceMethodPointCut()"</span>, throwing = <span class="string">"exception"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowingTargetMethod</span><span class="params">(JoinPoint thisJoinPoint,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          Exception exception)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"AspectUsingAnnotation.afterThrowingTargetMethod executed."</span>);</span><br><span class="line">        System.out.println(<span class="string">"에러가 발생했습니다."</span> + exception.getMessage());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"에러가 발생했습니다."</span>, exception);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(value = <span class="string">"serviceMethodPointCut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(JoinPoint thisJoinPoint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"AspectUsing After"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"serviceMethodPointCut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">wrapResponseObject</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before: "</span>);</span><br><span class="line">        Object ret = pjp.proceed();</span><br><span class="line">        System.out.println(<span class="string">"after: "</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@Aspect</code>로 <code>Advisor</code>임을 지정하는 일이 필요합니다. 이제 이 <code>Advisor</code>를 <code>@Configuration</code>에 등록하는 코드는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.dao"</span>,</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.service"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServiceAdvisor <span class="title">serviceAdvisor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServiceAdvisor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@Bean</code>의 등록이 필요하고, <code>@EnableAspectJAutoProxy</code>를 <em>꼭</em> 선언하는 것을 기억해주세요.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>AOP는 spring에서 매우 중요한 개념입니다. 무엇보다 OOP의 한계인 횡적인 객체의 확장이 가능하게 하는 놀라운 기술중 하나입니다. 그렇지만, 알아야지 될 내용들도 무척 많습니다. 테스트 코드에서는 NameMatchMethodPointcut 만을 사용했지만, Pointcut의 종류가 매우 많습니다. Pointcut에 따라, 특정 객체, method, 그리고 advice에 따라 method의 실행 전/후를 결정을 해서 많은 일들을 할 수 있습니다.</p>
<p>개발을 하다보면 좀더 많은 활용법을 같이 생각해볼 수 있는 구조입니다. 꼭 깊게 공부를 해보시길 바랍니다. 그리고 추가로 이야기드릴것이 Spring은 AspectJ라는 AOP 개발 기법을 지원합니다. 지금까지 proxy를 이용한 AOP 방법이였다면, AspectJ는 compile 시에 기존 class를 변경시켜서 새로운 class를 만들어줍니다. 아애 변형된 객체를 구성시켜주는 것이지요. 이는 성능상에서 이익을 가지고 오고, AOP의 pointcut과 acdvice에 대한 테스팅이 매우 쉬운 장점을 가지고 있습니다. AspectJ에 대해서는 개인적인 공부를 좀 더 해주시길 바랍니다.</p>
<p>이제 JDBC를 직접 이용하는 Simple application의 제작이 모두 마쳐졌습니다. 모두들 수고하셨습니다. 기존의 버릇과는 다른 개발 방법에 대해 고민을 많이 하셨을 것 같은데, 이쪽까지 잘 해주셔서 정말 감사드립니다. 지금까지 하신 내용을 잊어먹지는 말아주세요.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/java-spring-aop/">java, spring, aop</a>
    </span>
    

    </div>

    
  </div>
</article>




<nav class="pagination">
  
  
  <a href="/page/2/" class="pagination-next">Next</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2018 ykyoon
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>