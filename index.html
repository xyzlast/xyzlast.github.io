<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Programming is Fun | Still waters run deep. When the well&#39;s dry, we know the worth of water.</title>

  
  <meta name="author" content="ykyoon">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="Programming is Fun"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Programming is Fun" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Programming is Fun</a>
    </h1>
    <p class="site-description">Still waters run deep. When the well&#39;s dry, we know the worth of water.</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2018/03/22/db-korean/"><span>12. Model 기술에 대한 논쟁 - 국내 IT 환경</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/03/22/db-korean/" rel="bookmark">
        <time class="entry-date published" datetime="2018-03-21T23:16:34.000Z">
          2018-03-22
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="Model-기술에-대한-논쟁-국내-IT-환경"><a href="#Model-기술에-대한-논쟁-국내-IT-환경" class="headerlink" title="Model 기술에 대한 논쟁 - 국내 IT 환경"></a>Model 기술에 대한 논쟁 - 국내 IT 환경</h1><p>그리고, 지금까지 Jdbc, Hibernate, MyBatis와 같이 DB에 접근하는 다양한 방법에 대해서 알아봤습니다.</p>
<p>각각의 DB를 다루는 기술들은 다양한 장점과 단점을 가지고 있습니다. 특히 myBatis는 기존의 sql의 재사용 또는 sql query만으로 Business Logic을 만들던 개발자들이 쉽게 접근할 수 있다는 장점이 있는것 같습니다. 그리고 Mapper를 이용하는 경우, Dao에 대한 구현 객체 생성을 거의 하지 않아도 된다는 장점을 가지고 있고요. 또 다른 장점은 무엇이 있을까요? 이 부분에 대해서는 코드를 보면서 서로간에 토론을 해보는것도 좋을 것 같습니다.</p>
<p>지금까지 우리는 MVC 모델의 M에 대한 기술적인 접근을 알아봤습니다. DB에 sql적 접근을 하는 Jdbc는 좀 다른 영역이라고 할 수 있고, myBatis와 Hibernate는 결국은 Jdbc를 한번 wrapping 한 형태라고도 할 수 있습니다. 제가 한번 질문을 던져보도록 하겠습니다. myBatis는 ORM일까요?</p>
<p>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.</p>
<p>myBatis는 ORM이 아닙니다. ORM은 DB가 갖는 relation 관계에 대한 객체화에 주목합니다. 그렇지만, myBatis는 DB에 대한 query값에 대한 표현에 주목하고 있는 형태의 query에 대한 관리 포인트에 중점을 두고 있습니다. 이 둘의 차이는 조금 있습니다. 이 부분에 대해서 다시한번 알아보도록 하겠습니다.<br>Hibernate에서 사용된 ORM 객체들은 Entity object라고 불리웁니다. 그렇지만, myBatis의 객체는 VO, DTO라고 불리웁니다.<br>이에 대한 정의는 다음과 같습니다.</p>
<ul>
<li><strong>Entity Object</strong></li>
</ul>
<p>프로세스 상에 존재하는 데이터 개체로 물리적이거나 추상적인 것을 모두 포함합니다. 실제 DB의 코드에서 동작이 가능한 객체입니다. 지금 저희가 만든 예제에서는 Book, User, UserHistory 등이 각 객체로서 동작할 수 있습니다. 객체는 method를 가질 수 있으며, 생명 주기 및 객체간의 관계를 갖습니다.</p>
<ul>
<li><strong>VO(Value Object), DTO(Data Transfer Object)</strong></li>
</ul>
<p>단순히 값을 저장하는 객체입니다. Layer에서 Layer로 값을 전달할 때 주로 사용이 되며, 값에 대한 재 사용이 이루어지지 못합니다. 실제 Object에 대한 Model을 표현하기보다는 데이터를 저장하고, 전달하는데에 초점이 맞춰져 있습니다. VO, DTO를 사용하기 보다는 Map을 이용한 Dictionary 구조의 객체를 사용해도 동일한 결과를 가지고 올 수 있습니다. Entity Object를 화면에 보이기 위해서 또는 DB의 특정 query 결과를 다른 Layer에서 사용하기 위해 주로 사용됩니다.</p>
<p>차이를 아시겠나요? 단순히 Hibernate에서는 DB에 대한 값의 전달 뿐 아니라, 객체의 주기와 객체와 객체간의 관계까지 가지고 있는 Instance되어 있는 객체로서 움직입니다. 그렇지만, VO에서는 단순한 query값에 대한 return값을 의미하게 됩니다. 이 부분의 차이는 매우 큽니다. VO로 주로 작업을 하게 되면 결국은 절차 지향적 프로그래밍으로 동작하게 됩니다. Flow가 흐르듯이 method1 call, method2 call 식으로요. 그렇지만, 객체를 이용하게 되는 경우, 객체간의 상호 동작에 의하여 프로그램이 개발이 되게 됩니다. 이 두 객체의 사용 문제는 국내에서만 뜨거운 감자입니다. 외국은 이미 Entity가 평정을 한 상태이지만, 국내는 무척 말이 많군요. 전에 Daum에서 조사한 결과로는 해외는 8:2, 국내는 2:8 수준이라고 했습니다. 이 부분에 대한 논쟁을 따로 정리해봤습니다. 코드를 한줄 더 짜는 것보다, 이 부분에 대한 내용을 한번 정리해보는 것은 개발자들에게 있어서 굉장히 중요한 시간입니다. 다들 읽어보시고, 같이 이야기해보는 시간을 갖도록 하겠습니다.</p>
<h2 id="Entity-vs-DTO-VO-국내의-myBatis와-Hibernate-사용-논쟁에-대해서"><a href="#Entity-vs-DTO-VO-국내의-myBatis와-Hibernate-사용-논쟁에-대해서" class="headerlink" title="Entity vs DTO, VO - 국내의 myBatis와 Hibernate 사용 논쟁에 대해서."></a>Entity vs DTO, VO - 국내의 myBatis와 Hibernate 사용 논쟁에 대해서.</h2><p>myBatis, Hibernate에 대한 사용빈도를 명확하게 측정할 수는 없지만, 검색 빈도로 간접적으로 사용빈도의 %를 알아볼 수 있습니다.</p>
<p><img src="/images/12/01.png" alt=""></p>
<p>전 세계적으로 <code>myBatis:Hibernate:JPA = 6:55:25</code>의 비율을 보실 수 있습니다.</p>
<p>그럼 국내는 어떨까요?</p>
<p><img src="/images/12/02.png" alt=""></p>
<p><code>myBatis:Hibernate:JPA = 70:7:26</code>의 비율을 보이고 있는 것을 보실 수 있습니다.</p>
<p>이 정도면 해외에서는 myBatis는 거의 죽은 기술입니다. 그런데 왜 국내는? 이라는 것은 상당한 논쟁을 가지고 옵니다.</p>
<p>아래는 토비의 스프링 3.1로 유명한 토비의 글입니다.</p>
<hr>
<p>내가 가장 좋아하고 많이 사용하는 자바 프레임워크는 스프링과 하이버네이트다. 거의 5년전 이 두개의 프레임워크를 처음 접했을 때의 충격과 감동은 지금도 잊혀지지 않는다. 두가지 다 내가 가졌던 오랜 고정관념을 확실히 깨뜨려주었고, 자바 프로그래머로서의 정체성을 다시금 확인할 수 있게 해주었다. 자바가 객체지향언어이며 비록 웹 개발을 한다고 할지라도 구지 ASP인지 JSP인지 구분이 안가는 JSP+스크립트성 자바코드 방식이 아닌 진정한 자바의 객체지향언어로서의 장점을 지키며 개발할 수 있다는 것을 분명 확인할 수 있었다. DB지상주의자들의 오만한 주장처럼 자바(또는 일반 프로그래밍 언어)는 그저 DB를 호출하고 UI랑 연동시켜주는데 사용하는 껍데기 인터페이스 뿐이다라는 수십년된 구닥다리 생각이 얼마나 시대에 뒤떨어지고 무지에서 나온 것인지도 분명히 깨닫게 되었다.</p>
<p>특히 하이버네이트는 당시 10년이 넘도록 매진해온 RDB의 경험과 매력을 사실 한층 더 가치있게 활용하는 법을 알려준 가장 고마운 프레임워크이다. 80년데 DBase시리즈로 출발해서 클리퍼,폭스베이스,폭스프로 등을 경험하다 93년에 처음 오라클7.3을 대형 프로젝트에서 처음 경험 했을 때 알게된 RDB의 매력과 능력이 당시에는 존재하지도 않았던 자바라는 멋진 언어와 이렇게 잘 조화되어서 양쪽의 장점을 다 살려서 빠르고 정확하고 멋지게 개발할 수 있구나라는 생각을 하게 만들어주었다. 당시 하이버네이트는 버전 2.6이었고, Gavin King이 호주 멜번에서 주로 EJB기반의 프로젝트에 참여하던 시절에 그의 매일 밤과 주말 시간을 모두 희생해서 열정적으로 개발하고 지원하던 사실상 1인 개발 프레임워크였던 시절이었다. 그럼에도 I모사의 책상 앞에서만 똑똑한 연구진들이 만들어내, 기업의 덩치로 밀어붙여 억지로 표준기술로 만들어버린 EntityBean이라는 자바역사상 가장 웃음거리가 된 기술보다 백만배쯤 낫다고 느껴졌다. 사용자들의 반응도 뜨거웠다. 결국 Gaving King은 JBoss에 영입되어 하이버네이트 개발을 책임지는 풀타임 오픈소스 개발자가 되었다.</p>
<p>그 당시 Hibernate vs JDBC와 관련된 논쟁이 많이 있었다. 그때 나름 공감을 받던 주장은 이렇다.<br>만약 애플리케이션 개발자가 DB설계를 직접 할 수 있거나, 영향력을 줄 수 있는 위치에 있다면 하이버네이트가 좋고, 아니고 DBA팀을 비롯한 애플리케이션 쪽은 전혀 모르고 DB만 고려하고 설계하거나 이미 오래전에 만들어져서 운영준인 레거시DB라는 JDBC를 선택하는 것이 낫다<br>이유가 뭘까? 왜 같은 DB이고 같은 애플리케이션이 결국 사용할 것인데 개발자들이 직접 DB를 관장하면 하이버네이트에 적합하고, 아니라면 부적합한 것일까? 어떤 이들은 이것을 하이버네이트는 객체DB스타일의 설계가 필요하기 때문에 ODB적인 구조로 DB를 특별하게 만들어야 하기 때문에 객체설계 후 그에 따른 DB스키마 작성이 필요하기 때문이라고 말한다. 하이버네이트의 기본도 모르는 바보들의 주장이다.</p>
<p>하이버네이트는 순수 객체기반 영속성 솔루션인 엔티티빈에 대한 반감과 저항으로 등장한 기술이다. 하이버네이트가 지향하는 것은 진정한 O<em>R</em>M이다. 저 R이 관계형DB의 R이라는 것을 모르지는 않을텐데 말이다. 왜 DB를 써서 ODM이라고 하지 않고 ORM이라고 구지 관계형DB라는 것을 명시했을까? 그 이유는 하이버네이트는 관계형DB와 자바의 매핑이 목적인 프레임워크이기 때문이다. 그 말은 하이버네이트에 적합하게 따로 설계된 DB가 아닌, 가장 관계형DB다운 DB라면 하이버네이트와 완벽하게 연동이 될 수 있다는 말이다.</p>
<p>레거시DB와 하이버네이트 2.x가 함께 사용하기에 부적합했던 이유는 딱 한가지이다. 무식한 DBA나 DB설계자들 탓에 정규화도 제대로 되지 않은 엉망인 구조의 DB들인 경우가 있었기 때문이다. 물론 필요에 따라 비정규화를 한 경우도 있겠지만, 국내 한 유명 DB컨설턴트의 푸념처럼 정규화를 거치지도 안고 처음부터 그냥 생각없이 퍼포먼스를 위해서라는 근거도 없는 명분으로 비정규화부터 하는 식의 엉터리 DB설계들이 판을 치기 때문이라는 것이다. 하이버네티는 2.x조차도 RDB의 바른 설계원칙을 따라 만들어진 DB라면 완벽하게 매핑시킬 수 있다.</p>
<p>또 한가지 주장은 퍼포먼스이다. ORM은 JDBC를 그대로 가져다가 사용하는 것에 비해서 분명 퍼포먼스의 손해가 있다. 하지만 이 가정은 아주 단순한 기본적인 아이디어일 뿐이다. 혹 하이버네이트 1.x라면 들어맞을지도 모르겠다. 하지만 하이버네이트는 수많은 ORM의 퍼포먼스 향상 기법을 도입했고, 단지 매핑된 객체와 하이버네이트의 기반 HQL을 이용해서 거의 완벽에 가깝게 그것이 만들어 내는 SQL을 제어할 수 있다. 초기 ORM기술의 바보같은 n+1 퀴리 문제 같은 것은 더 이상 하이버네이트에서는 아무 문제가 아니다. 모델은 그대로 1tom 이더라도 그 정보를 조인해서 한번에 가져오는 것은 아주 간단한 일이다. 혹 하이버네이트에 무지한 자들이 하이버네이트는 JDBC/SQL을 사용하지 않는 것처럼 착각하는데 하이버네이트도 결국 JDBC를 이용해서 SQL로 DB와 커뮤니케이션 한다. 숙련된 하이버네이트 개발자들은 엔티티 객체를 다루면서 그것이 백그라운드에서 만들어 내는 SQL을 완벽하게 함께 머리로 그릴 수 있는 능력이 있다. 게다가 하이버네이트는 매우 간단한 설정만으로 객체베렐, 퀴리 레벨의 다양한 캐슁을 지원한다. 그것도 분산서버에서 트랜잭션까지 지원하는 캐슁도 아무런 문제없이 지원한다. DB스타일에 따라 캐슁이 적절히 사용되면 별다른 캐슁기술을 적용하지 않은 JDBC코드와 비교해서 훨씬 나은 성능을 보여줄 수도 있다.</p>
<p>JDBC를 이용한 애플리케이션도 이전처럼 ResultSet을 jsp까지 끌어가서 화면에 바로 출력하는 미련한 짓은 하지 않을 것이다. 다 DAO레이어를 만들고, 어떤 스타일이든 DTO를 사용해서 객체에 정보를 담는다. 그런 오버헤드가 사실상 전체 퍼포먼스에 미치는 영향은 극히 미미한데다 그것으로 얻을 수 있는 개발생산성과 버그의 위험도를 줄일 수 있는 가능성등의 장점이 워낙 크기 때문에 당연히 다들 DTO를 사용한다. 그런데 왜 하이버네이트의 매핑은 무슨 엄청난 오버헤드가 있어서 별 대단한 것도 아닌 시스템에서조차 성능때문에 못쓴다라고 하는 것일까?</p>
<p>DB의 성능에 대한 요구는 DB자체의 발전만으로는 커버가 불가능하다. 경험해본 사람들은 DB의 스케일업과 아웃이 얼마나 큰 비용이 드는지는 잘 알것이다. 클러스터링이 가장 어렵고, 된다고 해도 엄청난 비용이 드는 것이 DB이다. 작년엔가 모 금융사에서 메인메모리만 수백G짜리 수십억(백억이 넘던가..) 대의 초대형 DB서버를 구입해서 콘솔리데이션 프로젝트를 했었는데 얼마나 끔찍하게 고생했는지 거기에 참여했던 컨설턴트를 통해서 들은 적이 있다. 그래서 이제는 각종 Data Grid 와 같은 분산 기술들이 자바와 같은 객체지향언어와 결합해서 엄청난 속도로 발전하고 있다. DB의 절대왕좌를 차지하고 있는 오라클 조차 Coherence의 Tangosol을 인수했다는 것을 모르는가? Coherence는 수백대의 클러스터 그리드를 이용해서 미국의 한 금융 벤치마크에서 백만 TPS를 기록했다고도 한다. 국내의 경우에도 리니어하게 스케일링되는 구조에서 노드당 1500TPS이상을 가뿐하게 기록했다고 나와있다. 리니어스케일이 되는 이런 기술들이 하이버네이트와 얼마나 잘 결합되는지는 하이버네이트-Coherence의 역사를 보면 아주 잘 알 수 있을 것이다. 시대가 이렇게 빠르게 흘러가는데 아직도 기업의 DB관리는 보수적이고 어쩌고 저쩌고 하면서 한번 배운 기술 마르고 닳도록 울궈먹기 모드로 꼭 들어가야 하는 것일까?</p>
<p>스프링의 초기에도 그랬던 것처럼 그런 이유는 무지해서 그렇다. 잘 모르거나, 어설픈 얕은 지식으로 그냥 자신의 무지를 성능탓으로 돌리는 것이다. 그것은 마치 스프링으로 개발하면 메인프레임과 연동은 불가능하다(EJB만 된다)는 헛소리와 마찬가지 주장이다.</p>
<p>다시 위의 DB설계의 책임이 누구에게 있냐에 따른 하이버네이트 적용의 판단기준을 살펴보자. 하이버네이트 팀은 저런 상황을 잘 파악하고 있었다. 그리고 이상적인 모델만 현실에 존재하지 않는다는 것을 잘 파악했다. 그래서 하이버네이트 3.0이 나온 것이다. 이미 3년 전에 말이다. 하이버네이트3.0은 정규화가 잘된 깔끔한 DB뿐 아니라 바보 DB모델러들이 어설프게 설계한 레거시 DB도 매핑하는데 아무런 문제가 없게 만들어졌다. 게다가 엔티티 단위가 아닌 각종 복잡한 프로젝션 쿼리(일명 리포트 쿼리)도 완벽하게 지원한다. 역시 객체 단위가 아닌 벌그 업데이트도 당연히 지원한다. 사실상 SQL레벨에서 하던 거의 모든 작업을 하이버네이트의 OR매핑 장점을 그대로 살린채로 다 적요할 수 있다. 심지어 DB에 아주아주 specific한 네이티브 쿼리를 사용해야 하는 경우도 얼마든지 적용된다. iBatis못지않은 SQL-객체 바인딩도 지원한다. 심지어 그 결과를 DTO가 아닌 엔티티로 가져와서 작업하는 것도 가능하다. 하이버네이트를 쓰면 못쓰는 DB특화된 SQL이 있어서라는 엉터리 주장을 하는 사람들을 보면 한심하기 짝이 없다.</p>
<p>오늘 아침에 읽은 글이다.<br>“스터디 끝나고, 간단히 식사를 하면서 왜 국내에서는 하이버네이트 보다 iBatis가 더 각광 받느냐에 대한 의견 교환이 있었습니다. 비즈니스 모델링 단계에서 개발자 혹은 설계자가 자료 구조에 대한 고민을 하고 되는데, 객체지향 분석/설계에 충실하다면 객체 모델링을 통해 도출된 데이터 구조 자체를 저장소(repository)로 손쉽게 매핑(mapping)할 수 있는 하이버네이트가 유리하다는 점에서는 동의했습니다. (사실 제 첫번째 직장이 객체형 데이터베이스 회사였기 때문에 충분히 수긍할 만한 의견이었습니다.)<br>하지만 국내 IT 현장에서 가장 큰 발언권을 가진 사람들은 개발자가 아니라 시스템 운영자들 혹은 데이터베이스 관리자들입니다. IT를 잘 모르는 경영진 입장에서는 아무래도 회사의 자산이라고 여겨지는 것이 바로 데이터베이스이고 프로그램은 덜 중요해 보이거든요. 그러다 보니, 시스템 개발 현장에서 가장 먼저 그리고 중요하게 분석/설계되는 것은 업무 요건이 아니라 바로 데이터베이스 설계입니다. 데이터 구조가 먼저 설계되고 쿼리를 만들고 그 위에 어플리케이션을 탑재하는 순서로 개발하니 당연히 하이버네이트는 적합한 프레임워크로 고려될 수 없게 되는 것입니다.”<br>제대로 DB설계가 된다면 왜 그것이 하이버네이트에는 적합하지 않다는 말인가? 참 답답하다. 이 글을 읽다가 답답한 마음이 들어 이 글을 쓰기 시작했다.</p>
<p>물론 나도 하이버네이트가 모든 곳에 항상 적용가능하고 낫다고 보지는 않는다. 예를 들어, DB는 간단하고 부하만 큰 포탈의 게시판, 블로그 등은 ORM이 적합한 곳이 당연히 아니다. 객체 매핑 해봐야 무슨 이득이 있겠는가. 사실상 저런데는 RDB조차 적합하지 않다. 4억명의 회원을 보유한 ebay는 잘 알려진대로 DB트랜잭션조차 사용하지 않는다고 한다. 올바른 선택이다. 또 데이터의 입출력은 거의 없는 분석위주의 OLAP시스템도 하이버네이트 쓰는 것이 불가능하지는 않으나 별 장점이 없다. 그럴땐 OLAP쿼리 관리나 깔끔히 하면서 iBatis 같은게 낫다고 하겠다. 고객이 정말 무식과 고집을 겸비하고 있는데다, 밉보이면 향후 프로젝트에 지장이 있을 것 같은데 무조건 JDBC기반 DAO를 쓰겠다고 주장하면 살금살금 꼬셔서 SpringJDBC정도만 어찌 도입해보는게 나을 것이다. 정치적인 이유지만 어쨌든 시스템을 원활히 개발하기 위한 어쩔 수 없는 선택이 있다는 것도 안다. 또 애플리케이션은 DB의 인터페이스 용으로만 쓰고 모든 로직이 다 Stored Procedure에 저장되어있는 구닥다리 시스템이고 그것을 고칠 마음이 전혀 없다면 역시 하이버네이트는 선택의 대상이 아니다. 하지만 그 외의 모든 경우라면 하이버네이트는 충분히 적합하고 적용할 수 있고 많은 장점이 있다. 하지만 개발자들이 먼저 나서서 하이버네이트는 성능이 어쩌고, 적합하지 않아서 어쩌고 하는 것은 정말 아니다. 제대로 검증해보고 타당한 증몀을 해봤는가? 장단점을 충분히 진지하게 따져봤는가?</p>
<p>대형사이트? 더욱 더 적극 도입해야 한다. 물론 개발자가 많으면 평균 수준이 떨어지고, 각자 가진 기술수준이 차이가 많이 나서 기술수준 자체를 낮춰야 할 수도 있겠다. SQL만 달랑 넣으면 DTO부터 전 레이어의 기본코드가 딱 만들어지는 초간단 툴들이 요즘 인기있는 이유가 그것이라고 한다. 그만큼 다른 많은 것을 손해를 보고 가야함은 당연한 것이지만. 그렇다고 언제고 SQL만 알고 자바 문법만 아는 사람들로만 시스템 개발을 할 것인가? 오픈소스는 안돼라고 외치던 많은 곳에서 이미 스트럿츠1을 시작으로 이미 스프링과 iBatis 같은 고급 프레임워크 까지 적용이 이뤄지고 있다. 적절한 전략과 충분한 준비와 시간이 있다면 얼마든지 도입 할 수 있다. 개발자가 많으면 구현방식의 통일이 어렵고, 버그의 발생가능성이 높아진다. 하이버네이트와 같은 자바에 충실한 개발방식이 얼마나 개발자의 스트레스를 덜어주고, 생산성을 높이며 버그발생을 줄여주고, DB와 자바, UI까지 왔다갔다 정신없는 것을 충실하게 자바 모델에만 집중해서 개발할 수 있게 해주는지 안다면, 대형사이트일 수록 과감한 도입이 필요할지도 모른다. 그 비싸고 많은 모델러와 컨털선트는 왜 쓰는데…</p>
<p>내가 실무 프로젝트를 초기에 경험 할때는 코볼에 ISAM에 익숙한 노땅 개발자들의 전성시대에서 RDB와 같은 신기술이 막 떠오르려고 하던 때이다. 또 틈새를 비집고 UniSQL과 같은 허접 ODB도 설쳐대던 때다. 그때 ISAM에 익숙한 선배 개발자들의 푸념이 기억난다. 메인프레임에서 ISAM으로 했으면 이 정도는 순식간에 완벽하게 착착 다 만들었을 텐데 이게 무슨 장난감 같은 유닉스에, 복잡한 언어인 C에, 배우기도 힘든 3-Tier기술에, 성능도 떨어지는 RAD툴에 RDB까지 정신이 없다고 투덜대던 시절이다. 왜 복잡하고 지저분한 SQL을 이용하는, ISAM에 비해 성능도 떨어지는 RDB를 써야 하냐는 그때 그 사람들의 모습이 바로 지금 SQL에 익숙한데 왜 하이버네이트와 같은 새로운 기술을 또 공부해야 하냐라고 저항하는 개발자들의 모습과 꼭 닮았다.</p>
<p>물론 하이버네이트가 좋으니 당장 바꿔라라고 말하고 싶지 않다. 심지어 하이버네이트 사이트에도 프로젝트 1개월 남았는데 갑자기 하이버네이트로 바꾸자 따위의 생각은 꿈도 꾸지 마라라고 FAQ에 나와있었다. 개발 패러다임의 변화이니 충분한 시간을 가지고 학습하고 최적화된 기술을 익히는 과도기를 거쳐야 할 것이다. 그런 이유에서라면 당장 도입을 지연하는 것은 이해한다. 하지만 별 것도 아닌 중소형 사이트에 시간도 있고, 새로운 프레임워크도 익힌다면서 하이버네이트는 “그거 한국에서는 안돼”라는 말로 아무런 근거도 검증도 없이 그냥 iBatis나 쓰자라는 식으로 가는 모습은 정말 안타깝다. 제발이지 좀 근거를 가지고 구체적으로 비판을 하려면 했으면 좋겠다. 제발이지 나도 화딱지 나서 외국의 개발자들에게 “한국 개발자들은 무식하고 겁쟁이라 하이버네이트는 쓸 줄도 모릅니다”라고 하지 않도록…</p>
<hr>
<p>이만입니다. 제 의견을 많이 집어넣지는 않도록 하겠습니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/jpa-modeling-orm-mybatis/">jpa, modeling, orm, mybatis</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/03/22/db-summary/"><span>11. DB Application Summary</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/03/22/db-summary/" rel="bookmark">
        <time class="entry-date published" datetime="2018-03-21T23:14:19.000Z">
          2018-03-22
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="DB-Application-Summary"><a href="#DB-Application-Summary" class="headerlink" title="DB Application Summary"></a>DB Application Summary</h1><p>지금까지 우리는 DB에 접속을 하고, DB에 있는 내용을 이용해서 Service를 구성하는 방법에 대해서 알아봤습니다.<br>기술들은 다들 자신만의 색깔을 가지고, 개발자들을 좀 더 편하게 하기 위해서 발전되어 왔습니다. 그렇기 때문에 개발자들마다 자신이 선호하는 기술들이 따로 있는 것이고요.<br>그렇지만, 우리가 지금까지 Model을 하는 부분에 대해서는 한가지만은 확실히 나올 수 있습니다.</p>
<p>“각자의 영역으로 분리”</p>
<p>이것은 DB를 다루는 Model 뿐 아니라, 모든 객체와 개발에서의 Layer가 지켜야지 되는 원칙이라고 할 수 있습니다.</p>
<p>일반적으로 우리가 사용한 Model은 다음과 같은 package로 나뉠 수 있습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">com.xyzlast.bookstore.entity</span><br><span class="line">com.xyzlast.bookstore.vo</span><br><span class="line">com.xyzlast.bookstore.dto</span><br><span class="line">com.xyzlast.bookstore.dao</span><br><span class="line">com.xyzlast.bookstore.repositories</span><br><span class="line">com.xyzlast.bookstore.services</span><br></pre></td></tr></table></figure>
<p>먼저, 지금까지 설명하고 있던 내용중에서 용어의 혼란을 가지고 오던 <code>DAO</code>와 <code>Repository</code>의 차이를 좀 더 깊게 알아보도록 하겠습니다.</p>
<h2 id="DAO-vs-Repository"><a href="#DAO-vs-Repository" class="headerlink" title="DAO vs Repository"></a>DAO vs Repository</h2><p><code>DAO(Data Access Object)</code>와 <code>Repository</code>는 기술적으로 동일한 기능을 갖습니다.</p>
<blockquote>
<p>Persistence 영역에 대한 접근 수단</p>
</blockquote>
<p>그런데, 이 두 객체는 사용되는 영역이 다릅니다. <code>DAO</code>의 경우, 용어 그대로 <code>어디서나 접근 가능한 데이터 영역</code>으로 된다면, <code>Repository</code>는 서비스영역에서 사용되며, <code>Repository</code>에서 반환되는 객체들은 우리가 개발하는 <code>DOMAIN</code>의 객체들을 사용하게 됩니다. 조금 말이 어렵습니다.</p>
<p><code>DAO</code>는 Service 이외에도 사용이 가능하며, 이는 <code>Service</code> 이외에도 사용이 가능하며, 모든 Transaction은 기본적으로 DAO를 기반으로 하게 됩니다. 그렇지만, Repostiory는 <code>Service</code>에서만 사용이 되며 Transaction은 제공되지 않고, <code>Service</code>에서 제공되는 <code>Transaction</code>을 기반으로 하게 됩니다.</p>
<h2 id="Packages"><a href="#Packages" class="headerlink" title="Packages"></a>Packages</h2><h3 id="entity-package"><a href="#entity-package" class="headerlink" title="entity package"></a>entity package</h3><p>Hibernate와 같은 ORM framework를 사용하는 경우, object와 persistence model간의 관계를 구성한 ORM 객체가 위치하는 영역입니다. 또는 Table에 1:1 mapping을 해서 구성하는 경우도 있습니다. 그렇지만, entities를 사용한다는 것은 기본적으로 DDD를 사용하는 것과 동일합니다. 객체과 그 객체의 관계에 대한 구성을 코드에 녹여내는 방식을 주로 사용하게 됩니다.</p>
<h3 id="vo-package-dto-package"><a href="#vo-package-dto-package" class="headerlink" title="vo package / dto package"></a>vo package / dto package</h3><p>vo(value object), dto(data transfer object)의 경우에는 일반적으로 persistence model에서 넘어오는 값들을 단순 parsing할 때 사용됩니다. 여기에 가장 대표적인 기술로 mybatis를 소개하였고, 이는 db에서 얻어오는 값을 view에서 단순 표시하기 위한 방법으로도 자주 사용하게 됩니다.<br>이 두 package는 myBatis를 Domain Layer의 Framework로 사용하는 경우에는 거의 필수로 사용됩니다. 또는 개발시에 Model 영역에서 Controller/View 로 데이터를 넘길때, DTO 객체를 만들어서 넘길때 사용되기도 합니다. 이때는 vo가 View/Value Object의 의미로 사용되기도 합니다.</p>
<h3 id="dao"><a href="#dao" class="headerlink" title="dao"></a>dao</h3><p>직접 DB에 query를 보내고, vo, dto를 얻어오는 영역입니다. DB를 사용하는 기술에 따라 다르게 구성이 되는 것이 일반적이며, CRUD에 대한 모음으로도 구성될 수 있습니다. 단순 CRUD가 이루어진다고 해도, DB에 대한 기술적 영역이 바뀌게 될 가능성은 항상 열어두고 작업을 하는 것이 좋을 것 같습니다. 그렇기 위해서는 interface로 정의된 dao를 사용하는 것이 보다더 효과적으로 구성이 가능하게 됩니다. dao로 지정하게 되는 것은 controller, domain 모두에서 dao를 사용하겠다는 의미입니다. Hibernate와 같은 ORM을 사용하는 경우에는 repository pattern으로 접근하는 것이 더 좋습니다.</p>
<h3 id="repositories"><a href="#repositories" class="headerlink" title="repositories"></a>repositories</h3><p>Repository는 Dao와 매우 유사한 개념입니다. 이 두 용어의 차이점은 기능이 아닌, 사용되는 코드의 위치입니다. Domain Layer에서만 사용되는 경우에는 repository, Domain뿐 아니라 모든 영역에서 사용된다면 dao로 개발하게 됩니다. 이 둘의 차이는 Model을 풀어가는 pattern의 차이입니다. 보다더 pattern 상위적인 개념이 Repository이고, Dao는 database 적 개념이 강한 Object라고 생각하면 좀 더 이해가 쉬울 것 같습니다.</p>
<h3 id="services"><a href="#services" class="headerlink" title="services"></a>services</h3><p>business logic 영역입니다. 여러개의 dao object들과 entity 또는 vo/dto object들을 얻어내고, 그 객체들간의 로직이 구성되는 영역입니다. 일반적으로 transaction의 단위 영역이 된다는 것을 명심해주세요.<br>위의 구성에서 결국은 model은 3개 이상의 package로 구성이 됨을 알 수 있습니다. 남의 코드를 보더라도 대부분 위와 비슷한 구성으로 package가 구성된 경우가 많으니 참고바랍니다.</p>
<h2 id="Persistence-Framework-Layer의-비교"><a href="#Persistence-Framework-Layer의-비교" class="headerlink" title="Persistence Framework Layer의 비교"></a>Persistence Framework Layer의 비교</h2><p>다음은 지금까지 알아본 Model을 접근하는 Framework의 조합에 대해서 한번 정리해보도록 하겠습니다.</p>
<table>
<thead>
<tr>
<th>방법</th>
<th>특징</th>
<th>장점</th>
<th>단점</th>
</tr>
</thead>
<tbody>
<tr>
<td>No Framework - <br>PreparedStatement<br>이용하는 방법</td>
<td>1. Native Query 구성</td>
<td>1. native query를 이용한 학습 시간의 단축</td>
<td>1.오타가 발생하는 경우, query를 실행하기 전까지 에러를 확인할 수 없다.<br>2.중복 코드가 많이 발생된다.<br>3.connection의 관리를 비롯한 Transaction의 처리를 모두 수동으로 해줘야지 된다.<br>4.java 코드에 sql 코드가 들어가기 때문에 관리 및 debug가 힘들다.</td>
</tr>
<tr>
<td>JdbcTemplate</td>
<td>1.Spring JdbcTemplate 이용<br>2.DataSource 이용<br>3.Native Query</td>
<td>1.native query를 이용한 학습 시간의 단축<br>2.connection 관리<br>3.Transaction 관리</td>
<td>1.오타가 발생한 경우, query를 실행하기 전까지 에러를 확인할 수 없다.<br>2.중복 코드가 많이 발생된다.<br>3.java 코드에 sql 코드가 들어가기 때문에 관리 및 debug가 힘들다.</td>
</tr>
<tr>
<td>myBatis (iBatis)</td>
<td>1.Native Query<br>2.DataSource<br>3.ibatis-spring 이용</td>
<td>1.국내의 많은 사용자<br>2.sql query의 관리를 하는 것이 가능하다.</td>
<td>1.객체가 아닌 VO type의 이용으로 인한, 프로그램 architecture의 발전 가능성이 낮아짐<br>2.java 언어 뿐 아니라, sql 로의 확장으로 인하여 관리 코드가 늘어남</td>
</tr>
<tr>
<td>Hibernate</td>
<td>1.HQL, Criteria<br>2.DataSource<br>3.Spring Transaction</td>
<td>1.다양한 reference<br>2.객체를 이용한 query의 처리로 인하여, 코드양을 줄일 수 있다.<br>3.프로그램 설계 및 구성 부분에 대해서 장점을 갖는다.<br>(DDD와 같은 객체 지향적 구성 가능)<br>4.Table의 변경 또는 DB의 변경에 유연한 장점을 갖고 있다.<br>5.동적 query가 자유스럽다.</td>
<td>1.학습 시간의 소요<br>2.criteria, HQL 모두 오타에 취약한 구조</td>
</tr>
<tr>
<td>Hibernate + queryDSL</td>
<td>1.JQL, Criteria<br>2.DataSource<br>3.type-safe<br>4.code generate</td>
<td>1.다양한 reference<br>2.객체를 이용한 query의 처리로 인하여, 코드양을 줄일 수 있다.<br>3.프로그램 설계 및 구성 부분에 대해서 장점을 갖는다.<br>(DDD와 같은 객체 지향적 구성 가능)<br>4.Table의 변경 또는 DB의 변경에 유연한 장점을 갖고 있다.<br>5.오타가 발생할 수 없는 type-safe 한 query를 작성할 수 있다.<br>6.sql query와 비슷한 문법으로, 학습에 도움을 줄 수 있다.</td>
<td>1.학습시간의 소요<br>2.단순 CRUD에 대한 코드양 증가<br>3.설정이 까다롭다.</td>
</tr>
<tr>
<td>Hibernate + JPA +<br>queryDSL + Spring Data JPA</td>
<td>1.JQL, Criteria<br>2.DataSource<br>3.type-safe<br>4.code generate</td>
<td>1.JPA - java 표준<br>2.객체를 이용한 query의 처리로 인하여, 코드양을 줄일 수 있다.<br>3.프로그램 설계 및 구성 부분에 대해서 장점을 갖는다. (DDD와 같은 객체 지향적 구성 가능)<br>4.Table의 변경 또는 DB의 변경에 유연한 장점을 갖고 있다.<br>5.오타가 발생할 수 없는 type-safe 한 query를 작성할 수 있다.<br>6.sql query와 비슷한 문법으로, 학습에 도움을 줄 수 있다.<br>7.CUD, select 문의 코딩양이 현격하게 줄어든다.<br>8.Hibernate 코드 역시 사용 가능하고 유연한 방법으로 대처가 가능하다.<br>9.Repository Interface code에 의한 가독성 향상</td>
<td>1.학습 시간의 소요<br>2.설정이 까다롭다.</td>
</tr>
</tbody>
</table>
<p>지금 전 이정도로 정리를 해봤는데, 다른 분들은 어떻게 정리를 할 수 있을까요? 각 방법에 대한 장/단점을 파악하는 것이 중요합니다. 적어도 이곳에 있는 분들만이라도요.<br>그리고, 만약에 외부 Project에 참여하게 되는 경우에는, 그 Project에 맞는 개발 방법을 이용해서 개발을 하는 것이 중요합니다.</p>
<h2 id="Web-Application에서의-데이터-흐름"><a href="#Web-Application에서의-데이터-흐름" class="headerlink" title="Web Application에서의 데이터 흐름"></a>Web Application에서의 데이터 흐름</h2><p>Domain Model을 이용해서 Web Application을 구성하는 방법은 두가지가 있습니다. 원칙을 지키고자 하는 <code>Pure Domain Model</code>과 Domain Model의 자유로운 사용이 특징인 <code>Domain Model Everywhere</code>입니다.<br>먼저 Domain Model Everywhere에 대해서 알아보도록 하겠습니다.</p>
<h3 id="Domain-Model-Everywhere"><a href="#Domain-Model-Everywhere" class="headerlink" title="Domain Model Everywhere"></a>Domain Model Everywhere</h3><p><img src="/images/11/01.png" alt=""></p>
<p>Repository, Service, Controller, View가 모두 Entity Model을 가지고 동작하는 방식입니다. 이 방식은 Domain의 Entity 객체가 Repository 뿐 아니라, Controller, View에 표현되는 방법까지 가지게 되게 됩니다. 이렇게 되면 Entity Model이 매우 커지게 됩니다. 그리고 객체의 “단일책임원칙”을 위반하게 되는 단점을 가지고 있습니다. 이 방법의 장단은 다음과 같습니다.</p>
<p>장점 :</p>
<ul>
<li>개발하기에 빠르고 편리함</li>
</ul>
<p>단점 :</p>
<ul>
<li>복잡한 View의 표현이 매우 힘듭니다.</li>
<li>Domain Model에서 View Logic이 포함되기 때문에 Domain Model의 순수성이 떨어지고 객체의 단일 책임원칙을 위반하게 됩니다.</li>
<li>REST 서버와 같이 외부와의 통신 API에 사용하게 되는 경우에는 Domain Model이 변경되면 API가 바뀌게 되기 때문에 큰 문제를 야기할 수 있습니다.</li>
</ul>
<h3 id="Pure-Domain-Model"><a href="#Pure-Domain-Model" class="headerlink" title="Pure Domain Model"></a>Pure Domain Model</h3><p><img src="/images/11/02.png" alt=""></p>
<p>Domain Model은 서비스와 Repository에서만 사용하고, Controller와 View에서는 DTO를 새로 만들어서 사용하는 방법입니다. 이는 Domain의 순수성을 지키게 되는 큰 장점을 가지고 있습니다. View에서만 DTO를 사용하는 것이 BL의 변화에 따른 View의 변경을 격리할 수 있는 좋은 방법이 됩니다.</p>
<p>장점 :</p>
<ul>
<li>순수한 Domain Model - 객체지향적인 OOP 모델</li>
</ul>
<p>단점</p>
<ul>
<li>DTO를 따로 만드는 것이 귀찮고, 성가시고, 괴롭다.</li>
<li>DTO는 또 다른 중복 코드를 만들어낸다.</li>
<li>DTO와 Domain Model간의 Convert를 따로 만들어줘야지 된다.</li>
</ul>
<p>Domain Model Everywhere pattern의 경우에는 anti-pattern이라고도 말하는 사람이 있을정도로 호불호가 매우 강하게 갈리는 pattern중 하나입니다. 개인적으로도 최대한 Pure Domain Model을 이용해서 개발하는 것이 좋다고 생각합니다.</p>
<p>…………………………………………………………………. 현실은 ? OTL</p>
<p>지금까지 개발을 해본 결과. 다음과 같은 상황에서는 반드시 DTO를 사용해야지 됩니다.</p>
<ul>
<li><p>REST 서버와 같은 API의 response.</p>
<blockquote>
<p>Domain Model은 자주 바뀔 수 있습니다. 그렇지만, client와 통신을 하게 되는 API의 response는 바뀌면 문제가 생기게 됩니다. 따라서 이 둘은 반드시 분리를 해야지 됩니다.</p>
</blockquote>
</li>
<li><p>여러 Domain Model이 결합되어서 만들어지는 새로운 View에 대한 DTO</p>
<blockquote>
<p>View가 너무너무나 복잡해서 서로간에 연관성이 없는 Domain Model을 response로 보내줘야지 되는 경우에는 DTO를 만드는 것이 좋습니다.</p>
</blockquote>
</li>
</ul>
<p>이 두가지 경우를 제외하고….. DTO를 모두 만드는 것은 다음과 같은 문제가 발생합니다.</p>
<ul>
<li>객체가 너무 많이 만들어집니다. 지금 DataWindow의 package와 같이 각 SP의 숫자만큼의 package같이 객체들이 구성되게 됩니다. 이는 객체의 naming rule 및 관리가 매우 힘들어지는 결과를 가지고 옵니다.</li>
<li>많이 만들어진 객체 숫자 만큼의 Converter가 필요합니다. Domain Model을 DTO로 바꿔주고 DTO를 Domain Model로 바꿔주는 Convert 숫자가 필요하게 됩니다.</li>
<li>위 이유로 관리 포인트가 3개로 늘어나게 됩니다. - Domain Model, DTO, Converter</li>
</ul>
<p><strong>배보다 배꼽이 더 큰 사태가 발생할 수 있습니다. Domain Model Everywhere가 절대로 좋은 것은 아닙니다. 그렇지만 개발 시간과 관리 포인트를 생각해서 Domain Model Everywhere로 만들고, 그 객체들을 차츰차츰 DTO로 변환시켜가는 과정이 Application을 더욱더 깔끔하게 만드는 과정이 되게 된다고 생각합니다.</strong></p>
<p>결론입니다.</p>
<ul>
<li>처음에는 Domain Model Everywhere로 Project를 시작합니다.</li>
<li>Domain Model로 처리하기 힘든 경우에는 DTO를 사용해서 객체의 변환을 합니다.</li>
<li>최대한 Pure Domain Model을 유지하기 위해서 계속 노력합니다.</li>
</ul>
<blockquote>
<p>Domain Model Everywhere를 지원하기 위해서 Spring은 JPA Model Object를 위한 OpenEntityManagerInViewFilter와 Hibernate를  위한 OpenSessionInViewFilter를 지원하고 있습니다.</p>
</blockquote>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/spring-jpa/">spring, jpa</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/03/15/jpa/"><span>10. JPA</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/03/15/jpa/" rel="bookmark">
        <time class="entry-date published" datetime="2018-03-14T15:51:30.000Z">
          2018-03-15
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>Java Persistence API의 약자입니다.<br>영속성객체에 대한 java의 접근방법을 정의한 API로, 객체를 통한 Persistence 영역으로 접근방법을 정의하고 있습니다.<br>객체를 통한 Persistence 영역에 대한 접근을 하기 위해, 사용되는 것이 ORM Framework 들이고, 그중에서 가장 선두를 달리고 있는 것이 Hibernate입니다.</p>
<h2 id="JPA-vs-Hibernate"><a href="#JPA-vs-Hibernate" class="headerlink" title="JPA vs Hibernate"></a>JPA vs Hibernate</h2><p>Hibernate와 JPA간의 차이를 한번 알아보도록 하겠습니다.</p>
<table>
<thead>
<tr>
<th>방법</th>
<th>Hibernate</th>
<th>JPA</th>
</tr>
</thead>
<tbody>
<tr>
<td>DB에 대한 접근(DataSource)</td>
<td>SessionFactory</td>
<td>EntityManagerFactory</td>
</tr>
<tr>
<td>DB의 query executor</td>
<td>Session</td>
<td>EntityManager</td>
</tr>
<tr>
<td>INSERT 대응 method</td>
<td>save, saveOrUpdate</td>
<td>merge</td>
</tr>
<tr>
<td>UPDATE 대응 method</td>
<td>update, saveOrUpdate</td>
<td>merge</td>
</tr>
<tr>
<td>DELETE 대응 method</td>
<td>delete, remove</td>
<td>remove</td>
</tr>
<tr>
<td>query 적용 방법</td>
<td><del>Criteria</del>, HQL (Hibernate query Language), Native SQL</td>
<td>Criteria, JPQL (java persistence query language), Native SQL</td>
</tr>
</tbody>
</table>
<p>접근 하는 방식은 거의 1:1로 동일합니다. 다만 query의 적용방법에서 차이를 보이게 되는데요. JPQL이 JPA의 표준이 되면서, 기존 Hibernate에서 주로 사용되고 있던 Criteria/HQL을 거의 사용하지 않습니다. 현 Hibernate 5.0 이상에서는 <code>Creteria</code>와 <code>HQL</code>은  <code>deprecated</code>되었습니다.</p>
<p>먼저 <code>JPA</code>를 구현하는 방법에 대해서 알아보도록 하겠습니다. 이는 <code>JAVA</code>의 표준기술입니다. 잘 알아둘 필요가 있습니다.<br>dependency는 다음과 같습니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">compileOnly <span class="string">group:</span> <span class="string">'org.projectlombok'</span>, <span class="string">name:</span> <span class="string">'lombok'</span>, <span class="string">version:</span> <span class="string">'1.16.18'</span></span><br><span class="line"></span><br><span class="line">compile <span class="string">'com.google.guava:guava:23.0'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'com.fasterxml.jackson.core'</span>, <span class="string">name:</span> <span class="string">'jackson-databind'</span>, <span class="string">version:</span> <span class="string">'2.9.3'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.mariadb.jdbc'</span>, <span class="string">name:</span> <span class="string">'mariadb-java-client'</span>, <span class="string">version:</span> <span class="string">'2.2.0'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.hibernate'</span>, <span class="string">name:</span> <span class="string">'hibernate-core'</span>, <span class="string">version:</span> <span class="string">'5.2.12.Final'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.hibernate'</span>, <span class="string">name:</span> <span class="string">'hibernate-entitymanager'</span>, <span class="string">version:</span> <span class="string">'5.2.12.Final'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.hibernate.javax.persistence'</span>, <span class="string">name:</span> <span class="string">'hibernate-jpa-2.1-api'</span>, <span class="string">version:</span> <span class="string">'1.0.0.Final'</span></span><br><span class="line"></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'com.zaxxer'</span>, <span class="string">name:</span> <span class="string">'HikariCP'</span>, <span class="string">version:</span> <span class="string">'2.7.4'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-context'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-orm'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br><span class="line"></span><br><span class="line">testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line">testCompile <span class="string">'org.assertj:assertj-core:3.8.0'</span></span><br><span class="line">testCompile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-test'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br></pre></td></tr></table></figure>
<p>JPA는 표준 API로서, 기존에 <code>de facto</code>로 사용되고 있던 <code>Hibernate</code>와 거의 완벽하게 동일합니다. <code>@Configuration</code>은 다음과 같이 구성됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(value = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.repository"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">        dataSource.setMaximumPoolSize(<span class="number">10</span>);</span><br><span class="line">        dataSource.setMinimumIdle(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title">entityManagerFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">"hibernate.dialect"</span>, <span class="string">"org.hibernate.dialect.MariaDB53Dialect"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"hibernate.show_sql"</span>, <span class="string">"true"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"hibernate.id.new_generator_mappings"</span>,<span class="string">"false"</span>);</span><br><span class="line"></span><br><span class="line">        LocalContainerEntityManagerFactoryBean em = <span class="keyword">new</span> LocalContainerEntityManagerFactoryBean();</span><br><span class="line">        em.setDataSource(dataSource());</span><br><span class="line">        em.setPackagesToScan(<span class="string">"com.xyzlast.bookstore.entity"</span>);</span><br><span class="line"></span><br><span class="line">        JpaVendorAdapter vendorAdapter = <span class="keyword">new</span> HibernateJpaVendorAdapter();</span><br><span class="line">        em.setJpaVendorAdapter(vendorAdapter);</span><br><span class="line">        em.setJpaProperties(properties);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> em;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JpaTransactionManager jpaTransactionManager = <span class="keyword">new</span> JpaTransactionManager();</span><br><span class="line">        jpaTransactionManager.setEntityManagerFactory(entityManagerFactoryBean().getObject());</span><br><span class="line">        jpaTransactionManager.setDataSource(dataSource());</span><br><span class="line">        <span class="keyword">return</span> jpaTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PersistenceExceptionTranslationPostProcessor <span class="title">exceptionTranslation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PersistenceExceptionTranslationPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>기존의 <code>SessionFactoryBean</code>과 <code>HibernateTransactionManager</code>, <code>HibernateExceptionTranslationPostProcessor</code>가 각각 <code>EntityManagerFactoryBean</code>, <code>JpaTransactionManager</code>, <code>PersistenceExceptionTranslationPostProcessor</code>로 변경되게 됩니다.<br>주의해서 보실 내용은 <code>HibernateJpaVendorAdapter</code>입니다. 이는 JPA 표준을 따르는 <code>Vendor</code>를 지정해줍니다. Hibernate에서 제공하는 Vendor Adapter입니다.</p>
<table>
<thead>
<tr>
<th>Hibernate</th>
<th>JPA</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td>SessionFactoryBean</td>
<td>EntityManagerFactoryBean</td>
<td>DB 접근방법</td>
</tr>
<tr>
<td>HibernateTransactionManager</td>
<td>JpaTransactionManager</td>
<td>Transaction 관리자</td>
</tr>
<tr>
<td>HibernateExceptionTranslationPostProcessor</td>
<td>PersistenceExceptionTranslationPostProcess</td>
<td>DB내에서 발생된 Exception의 Converter</td>
</tr>
</tbody>
</table>
<p>지금 <code>JPA</code>에 적합한 Framework는 2개입니다. <code>Hibernate</code>와 <code>EclipseLink</code>가 있습니다.</p>
<table>
<thead>
<tr>
<th>JpaVendorAdaptor</th>
<th>Hibernate</th>
<th>EclipseLink</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>HibernateJpaVendorAdapter</td>
<td>EclipseLinkJpaVendorAdapter</td>
</tr>
</tbody>
</table>
<p><code>BookDao</code>의 구성은 다음과 같이 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title">BookDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PersistenceContext</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager em;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> em.createQuery(<span class="string">"SELECT COUNT(*) FROM Book"</span>, Long.class).getSingleResult().intValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> em.createQuery(<span class="string">"FROM Book"</span>, Book.class).getResultList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> em.find(Book.class, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        em.merge(book);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        em.merge(book);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        em.remove(book);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        em.createQuery(<span class="string">"DELETE FROM Book"</span>).executeUpdate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hibernate의 <code>Session</code>을 이용하는 코드와 거의 유사합니다. 단 차이가 있다면 생성자로 <code>SessionFactory</code>를 전달했던 코드가 <code>@PersistenceContext</code>로 바뀌는 차이가 있습니다. 이는 JPA에 정의된 annotation으로 PersistenceContext의 주입을 지정합니다.</p>
<h2 id="Querydsl"><a href="#Querydsl" class="headerlink" title="Querydsl"></a>Querydsl</h2><p>ORM을 통해서, 우리는 RDBMS를 OOP적 사상으로 옮기는 것이 가능해졌습니다. 그렇지만, <code>FROM Book</code>과 같은 <code>JPQL</code>이라는 문자열식 query에 종속되고 있는 것이 사실입니다. 또한, <code>Entity</code>의 변경시에 문자열식 query는 변경되지 않기 때문에, 실행하기 전까지 오류를 찾아낼 수 없습니다. 그리고, 문법이 꽤나 복잡한 것이 사실입니다.</p>
<p>개발상 요구사항은 계속해서 바뀌게 되고, 개발도중에는 Schema가 계속해서 변경되게 되는 것이 사실입니다. 그때마다 <code>JPQL</code>에 문제가 있는지를 확인하는 것은 빼먹기쉬운 부분입니다. Querydsl은 <code>Entity</code>객체와 연동되는 ‘Q-class`라는 query 객체를 생성하고, 이를 통해서 query를 만들어내게 됩니다. 이를 통해 Entity의 변경에 따른 query문제를 없앨 수 있으며, Query의 동적인 생성을 원활하게 합니다.</p>
<p>Querydsl에서의 query pattern은 .NET의 linq 사상을 옮겨왔습니다.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> queryLondonCustomers = <span class="keyword">from</span> cust <span class="keyword">in</span> customers</span><br><span class="line">                           <span class="keyword">where</span> cust.LastName.startsWith(<span class="string">'A'</span>) &amp;&amp; cust.active</span><br><span class="line">                           <span class="keyword">orderby</span> cust.lastName <span class="keyword">ascending</span></span><br><span class="line">                           <span class="keyword">orderby</span> cust.firstName <span class="keyword">descending</span></span><br><span class="line">                           <span class="keyword">select</span> cust;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Customer&gt; result = query.from(customer)</span><br><span class="line">    .where(customer.lastName.like(<span class="string">"A%"</span>), customer.active.eq(<span class="keyword">true</span>))</span><br><span class="line">    .orderBy(customer.lastName.asc(), customer.firstName.desc())</span><br><span class="line">    .list(customer);</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> customer <span class="keyword">where</span> lastname <span class="keyword">like</span> <span class="string">'A%'</span> <span class="keyword">and</span> active = <span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> lastname <span class="keyword">asc</span>, firstname <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<p>보시면 query문과 매우 비슷한 구조를 가지고 있습니다.<br>Querydsl은 <code>EntityManager</code>를 한번 더 감싸서 얻을 수 있는 <code>JPAQuery</code>와 <code>Q-class</code>라는 Query 객체화 class를 이용합니다.</p>
<ul>
<li>Hibernate ORM 규칙에 따른 JPA annotation을 이용한 객체 정의</li>
<li>generate Q-class</li>
<li>Query Definition을 이용한 query 작성</li>
</ul>
<p>기존 JPA Project를 QueryDsl을 지원하는 프로젝트로 변경해보도록 하겠습니다.<br>먼저, <code>Querydsl</code>을 지원하기 위한 dependency 적용은 다음과 같습니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'com.querydsl'</span>, <span class="string">name:</span> <span class="string">'querydsl-apt'</span>, <span class="string">version:</span> <span class="string">'4.1.4'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'com.querydsl'</span>, <span class="string">name:</span> <span class="string">'querydsl-jpa'</span>, <span class="string">version:</span> <span class="string">'4.1.4'</span></span><br></pre></td></tr></table></figure>
<p>Querydsl을 지원하기 위한 <code>Q-Class</code>를 생성하기 위해 <code>build.gradle</code>에 새로운 <code>task</code>를 추가합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sourceSets &#123;</span><br><span class="line">    main &#123;</span><br><span class="line">        java &#123;</span><br><span class="line">            srcDirs <span class="string">'src/main/java'</span>, <span class="string">'src/main/generated'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task generateQueryDSL(<span class="string">type:</span> JavaCompile, <span class="string">group:</span> <span class="string">'build'</span>, <span class="string">description:</span> <span class="string">'Generates the QueryDSL query types'</span>) &#123;</span><br><span class="line">    file(<span class="keyword">new</span> File(projectDir, <span class="string">"/src/main/generated"</span>)).deleteDir()</span><br><span class="line">    file(<span class="keyword">new</span> File(projectDir, <span class="string">"/src/main/generated"</span>)).mkdirs()</span><br><span class="line">    source = sourceSets.main.java</span><br><span class="line">    classpath = configurations.compile + configurations.compileOnly</span><br><span class="line">    options.compilerArgs = [</span><br><span class="line">            <span class="string">"-proc:only"</span>,</span><br><span class="line">            <span class="string">"-processor"</span>, <span class="string">"com.querydsl.apt.jpa.JPAAnnotationProcessor"</span></span><br><span class="line">    ]</span><br><span class="line">    destinationDir = file(<span class="string">'src/main/generated'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>최종적으로 다음 gradle task를 실행합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle generateQuerydsl</span><br></pre></td></tr></table></figure>
<p>그 후, 다음과 같은 결과를 보실 수 있습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">BUILD SUCCESSFUL <span class="keyword">in</span> <span class="number">1</span>s</span><br><span class="line"><span class="number">1</span> actionable task: <span class="number">1</span> up-to-<span class="built_in">date</span></span><br><span class="line"> secucen  ~/dev/code/secucen-study/step05   feature/is10 ●✚  gradle generateQueryDSL</span><br><span class="line"></span><br><span class="line">&gt; Task :generateQueryDSL</span><br><span class="line"><span class="function">Note: <span class="title">Running</span> <span class="title">JPAAnnotationProcessor</span></span></span><br><span class="line"><span class="function"><span class="title">Note</span>: <span class="title">Serializing</span> <span class="title">Entity</span> <span class="title">types</span></span></span><br><span class="line"><span class="function"><span class="title">Note</span>: <span class="title">Generating</span> <span class="title">com.xyzlast.bookstore.entity.QUser</span> <span class="title">for</span> [<span class="title">com.xyzlast.bookstore.entity.User</span>]</span></span><br><span class="line"><span class="function"><span class="title">Note</span>: <span class="title">Generating</span> <span class="title">com.xyzlast.bookstore.entity.QBook</span> <span class="title">for</span> [<span class="title">com.xyzlast.bookstore.entity.Book</span>]</span></span><br><span class="line"><span class="function"><span class="title">Note</span>: <span class="title">Generating</span> <span class="title">com.xyzlast.bookstore.entity.QHistory</span> <span class="title">for</span> [<span class="title">com.xyzlast.bookstore.entity.History</span>]</span></span><br><span class="line"><span class="function"><span class="title">Note</span>: <span class="title">Running</span> <span class="title">JPAAnnotationProcessor</span></span></span><br><span class="line"><span class="function"><span class="title">Note</span>: <span class="title">Running</span> <span class="title">JPAAnnotationProcessor</span></span></span><br><span class="line"><span class="function"><span class="title">BUILD</span> <span class="title">SUCCESSFUL</span> <span class="title">in</span> 2<span class="title">s</span></span></span><br></pre></td></tr></table></figure>
<p>이제 <code>main/generated</code>안을 보시면 Q-class 들이 생성되어 있는 것을 보실 수 있습니다.</p>
<p><img src="/images/jpa/01.png" alt=""></p>
<p>이제 <code>Repository</code> class를 수정해보도록 하겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title">BookDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PersistenceContext</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager em;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JPAQuery&lt;Book&gt; jpaQuery = <span class="keyword">new</span> JPAQuery&lt;&gt;(em);</span><br><span class="line">        Long count = jpaQuery.from(QBook.book).fetchCount();</span><br><span class="line">        <span class="keyword">return</span> count.intValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JPAQuery&lt;Book&gt; jpaQuery = <span class="keyword">new</span> JPAQuery&lt;&gt;(em);</span><br><span class="line">        <span class="keyword">return</span> jpaQuery.from(QBook.book).fetch();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        JPQLQuery&lt;Book&gt; jpaQuery = <span class="keyword">new</span> JPAQuery&lt;&gt;(em);</span><br><span class="line">        QBook q = QBook.book;</span><br><span class="line">        <span class="keyword">return</span> jpaQuery.from(q).where(q.id.eq(id)).fetchFirst();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        em.merge(book);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        QBook q = QBook.book;</span><br><span class="line">        JPAUpdateClause updateClause = <span class="keyword">new</span> JPAUpdateClause(em, q);</span><br><span class="line">        updateClause.where(q.id.eq(book.getId()))</span><br><span class="line">            .set(q.name, book.getName())</span><br><span class="line">            .set(q.author, book.getAuthor())</span><br><span class="line">            .set(q.comment, book.getComment())</span><br><span class="line">            .set(q.publishDate, book.getPublishDate())</span><br><span class="line">            .execute();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        QBook q = QBook.book;</span><br><span class="line">        JPADeleteClause jpaDeleteClause = <span class="keyword">new</span> JPADeleteClause(em, q);</span><br><span class="line">        jpaDeleteClause.where(q.id.eq(book.getId())).execute();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JPADeleteClause jpaDeleteClause = <span class="keyword">new</span> JPADeleteClause(em, QBook.book);</span><br><span class="line">        jpaDeleteClause.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>BookDao</code>의 경우, 매우 단순한 select query만을 가지고 있기 때문에 큰 차이를 보이지 않을 수 있습니다. querydsl을 이용하면 조건등에 의한 동적인 query 작성에 매우 탁월합니다.</p>
<h2 id="Spring-Data-JPA"><a href="#Spring-Data-JPA" class="headerlink" title="Spring Data JPA"></a>Spring Data JPA</h2><p><code>http://spring.io</code>에서는 여러가지 project를 볼 수 있습니다. 그 중에서 <code>JPA</code>에 관련된 프로젝트가 있습니다. <code>Spring Data</code>가 바로 그것입니다. Spring Data JPA는 ORM Framework입니다. JPA 기반의 repository를 아주 빨리, 쉽게 개발할 수 있는 방법을 제시하고 있습니다. 지금까지 보던 모든 기술들(JdbcTemplate, Hibernate, myBatis)에서 repository는 객체만 바뀔뿐, 코드의 중복은 계속해서 나타나게 됩니다. 특히 우리가 CRUD라고 부르는 영역의 CUD 코드의 경우에는 거의 대부분이 중복이 되는 경우가 많습니다. 이러한 문제점을 착안하여 Spring Data - JPA project가 시작되게 되었습니다.</p>
<p>Spring Data JPA는 단독으로 동작하는 ORM Framework가 아닙니다. JPA ORM engine을 기반으로 동작하는 ORM Framework입니다. 여기에서 JPA ORM engine이 될 수 있는 표준적인 JSR 220 을 만족하는 ORM engine은 다음과 같습니다.</p>
<ul>
<li>Hibernate</li>
<li>Google App Engine for JAVA</li>
<li>TopLink</li>
</ul>
<p>Google App Engine이 RDBMS를 완벽하게 지원하지 못하고, TopLink의 경우에는 Oracle에서 판매하는 상용제품이며 Oracle DB에만 특화가 되어있는 ORM입니다. 그렇다면, 실질적으로 지금 사용할 수 있는 선택의 폭은 Hibernate 밖에는 존재하지 않습니다. 지금 상태로는 Spring Data JPA는 Hibernate를 기반으로 동작하는 ORM Framework이다. 라고 생각해주시면 좋을 것 같습니다.</p>
<p>신규 프로젝트에서부터 시작해서 <code>Spring Data JPA</code>를 적용한 프로젝트를 구성해보도록 하겠습니다.</p>
<p>기존 querydsl 프로젝트를 그대로 copy 후, repository들을 모두 지워줍니다. <code>spring-data-jpa</code>만을 추가합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.springframework.data'</span>, <span class="string">name:</span> <span class="string">'spring-data-jpa'</span>, <span class="string">version:</span> <span class="string">'2.0.2.RELEASE'</span></span><br></pre></td></tr></table></figure>
<p><code>@Configuration</code>은 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(value = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.repository"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories</span>(basePackages = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.repository"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">        dataSource.setMaximumPoolSize(<span class="number">10</span>);</span><br><span class="line">        dataSource.setMinimumIdle(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@EnableJpaRepositories</code>를 추가하고, <code>Repository</code>가 위치할 package들만 추가해주면 됩니다.</p>
<p>Spring JPA Data는 Dao/Repository의 반복적인 코드가 될 수 있는 CUD를 자동화된 코드로 지원합니다. Spring JPA Data에서 제공하는 interface는 다음과 같습니다.</p>
<ul>
<li>Repository</li>
<li>CrudRepository</li>
<li>JpaRepository</li>
</ul>
<p>이 중에서 우리가 사용할 녀석은 다른 interface를 모두 상속한 JpaRepository<t, c="">입니다. JapRepository의 선언은 전에 Hibernate의 GenericDao의 선언과 거의 동일합니다. 단 두번째 인자가 PK에 대한 객체 Type을 넣어주는것만 다릅니다. Book, User, History 모두 int를 사용하고 있기 때문에, Integer를 두번째 Type에 넣어주면 됩니다.</t,></p>
<p>이제 각 <code>BookDao</code>, <code>UserDao</code>, <code>HistoryDao</code>를 pattern에 맞도록 <code>BookRepository</code>, <code>UserRepository</code>, <code>HistoryRepository</code>로 만들어줍시다. 각 Repository 코드는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Book</span>, <span class="title">Integer</span>&gt;, <span class="title">QuerydslPredicateExecutor</span>&lt;<span class="title">Book</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>, <span class="title">Integer</span>&gt;, <span class="title">QuerydslPredicateExecutor</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HistoryRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">History</span>, <span class="title">Integer</span>&gt;, <span class="title">QuerydslPredicateExecutor</span>&lt;<span class="title">History</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>interface 구현이 아닌 interface 상속을 통해서 구현이 되어 있는 것을 주의해주세요. JpaRepository<t,c> 의 T에는 Target이 되는 Class가 들어가고, C에는 Target Class의 @Id property의 객체값이 들어갑니다. (int인 경우, Integer)</t,c></p>
<p>자. 이제 지금까지 만들었던 BookDaoImpl의 코딩은 모두 끝났습니다. interface에 대한 코딩 작업이 전혀 필요하지 않습니다. 그 이유는 기본적으로 전에 보셨던 GenericDao에 대한 확장과 비슷한 방법입니다. Spring Data JPA는 JpaRepository, Repository, CrudRepository를 상속받은 interface를 모두 찾아내서, 동적인 객체를 생성합니다. 우리가 따로 코드를 만들어줄 필요가 전혀 없는것이지요. GenericDao의 결정판입니다. ^^</p>
<p>이제 테스트 코드를 작성해보도록 하겠습니다. 기존의 테스트 코드에서 약간의 변경만 있으면 됩니다. countAll()을 count()로, add, update를 모두 save로 변경만 시켜주면 테스트 코드가 모두 완성됩니다.</p>
<h3 id="findByXXX-method의-확장"><a href="#findByXXX-method의-확장" class="headerlink" title="findByXXX method의 확장"></a>findByXXX method의 확장</h3><p>지금 만들어진 <code>Repository</code>는 매우 단순한 객체입니다. 만약에 <code>BookRepository</code>를 이용해서 <code>Book.name</code>을 이용해 검색을 한다면 다음과 같은 코드를 작성해야지 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findByName01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    QBook qBook = QBook.book;</span><br><span class="line">    Optional&lt;Book&gt; bookOptional = bookRepository.findOne(qBook.name.eq(<span class="string">"ykyoon"</span>));</span><br><span class="line">    <span class="keyword">if</span> (bookOptional.isPresent()) &#123;</span><br><span class="line">        System.out.println(bookOptional.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>서비스코드에 이렇게 검색하는 루틴이 들어가 있는 것은 코드의 가독성을 떨어트립니다. Entity의 property만을 이용해서 검색하는 경우에 <code>spring-data-jpa</code>는 아주 멋진 방법을 제공합니다. <code>BookRepository</code>에 다음과 같은 method를 추가합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Book</span>, <span class="title">Integer</span>&gt;, <span class="title">QuerydslPredicateExecutor</span>&lt;<span class="title">Book</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">Book <span class="title">findByName</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이렇게만 넣어주는 것으로도 위 코드와 동일한 검색을 가능하게 할 수 있습니다. 이렇게 만들어줄 수 있는 패턴들은 다음과 같습니다.</p>
<table>
<thead>
<tr>
<th>KEYWORD</th>
<th>SAMPLE    JPQL</th>
<th>SNIPPET</th>
</tr>
</thead>
<tbody>
<tr>
<td>And</td>
<td>findByLastnameAndFirstname</td>
<td>… where x.lastname = ?1 and x.firstname = ?2</td>
</tr>
<tr>
<td>Or</td>
<td>findByLastnameOrFirstname</td>
<td>… where x.lastname = ?1 or x.firstname = ?2</td>
</tr>
<tr>
<td>Between</td>
<td>findByStartDateBetween</td>
<td>… where x.startDate between 1? and ?2</td>
</tr>
<tr>
<td>LessThan</td>
<td>findByAgeLessThan</td>
<td>… where x.age &lt; ?1</td>
</tr>
<tr>
<td>GreaterThan</td>
<td>findByAgeGreaterThan</td>
<td>… where x.age &gt; ?1</td>
</tr>
<tr>
<td>IsNull</td>
<td>findByAgeIsNull</td>
<td>… where x.age is null</td>
</tr>
<tr>
<td>IsNotNull,NotNull</td>
<td>findByAge(Is)NotNull</td>
<td>… where x.age not null</td>
</tr>
<tr>
<td>Like</td>
<td>findByFirstnameLike</td>
<td>… where x.firstname like ?1</td>
</tr>
<tr>
<td>NotLike</td>
<td>findByFirstnameNotLike</td>
<td>… where x.firstname not like ?1</td>
</tr>
<tr>
<td>OrderBy</td>
<td>findByAgeOrderByLastnameDesc</td>
<td>… where x.age = ?1 order by x.lastname desc</td>
</tr>
<tr>
<td>Not</td>
<td>findByLastnameNot</td>
<td>… where x.lastname &lt;&gt; ?1</td>
</tr>
<tr>
<td>In</td>
<td>findByAgeIn(Collection<age> ages)</age></td>
<td>… where x.age in ?1</td>
</tr>
<tr>
<td>NotIn</td>
<td>findByAgeNotIn(Collection<age> age)</age></td>
<td>… where x.age not in ?1</td>
</tr>
</tbody>
</table>
<h3 id="Predicate의-추가"><a href="#Predicate의-추가" class="headerlink" title="Predicate의 추가"></a>Predicate의 추가</h3><p><code>findByXXX</code>로 해결되지 않는 쿼리를 만들어내야지 될 때 사용하는 방법입니다. Domain Logic중에서 다음과 같은 경우를 가정해보도록 하겠습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UserId, BookId 입력받아, null인 경우 where 조건이 없이 진행한다.</span><br></pre></td></tr></table></figure>
<p>이 경우, Service code에 넣으면 다음과 같이 처리가 되어야지 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;History&gt; <span class="title">listHistories</span><span class="params">(Integer bookId, Integer userId, <span class="keyword">int</span> pageIndex, <span class="keyword">int</span> pageSize)</span> </span>&#123;</span><br><span class="line">    BooleanBuilder queryBuilder = <span class="keyword">new</span> BooleanBuilder();</span><br><span class="line">    <span class="keyword">if</span> (bookId != <span class="keyword">null</span>) &#123;</span><br><span class="line">        queryBuilder.and(QBook.book.id.eq(bookId));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (userId != <span class="keyword">null</span>) &#123;</span><br><span class="line">        queryBuilder.and(QUser.user.id.eq(userId));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> historyRepository.findAll(queryBuilder, PageRequest.of(pageIndex, pageSize));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>와 같은 코드로 만들어져야지 됩니다. parameter의 검사 및 query를 만드는 코드가 Service에 있다는 것은 원 서비스 코드의 목적인 BL에 대한 구현과 어울리지 않는 코드가 만들어집니다. 따라서 저런 코드들을 Predicate로 넣어서 만드는 것이 일반적입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HistoryPredicate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">HistoryPredicate</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Predicate <span class="title">buildQueryByBookIdAndUserId</span><span class="params">(Integer bookId, Integer userId)</span> </span>&#123;</span><br><span class="line">        BooleanBuilder queryBuilder = <span class="keyword">new</span> BooleanBuilder();</span><br><span class="line">        <span class="keyword">if</span> (bookId != <span class="keyword">null</span>) &#123;</span><br><span class="line">            queryBuilder.and(QBook.book.id.eq(bookId));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (userId != <span class="keyword">null</span>) &#123;</span><br><span class="line">            queryBuilder.and(QUser.user.id.eq(userId));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> queryBuilder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>구성된 코드를 이용한 서비스 코드는 다음과 같이 만들어집니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;History&gt; <span class="title">listHistories</span><span class="params">(Integer bookId, Integer userId, <span class="keyword">int</span> pageIndex, <span class="keyword">int</span> pageSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> historyRepository.findAll(HistoryPredicate.buildQueryByBookIdAndUserId(bookId, userId),</span><br><span class="line">        PageRequest.of(pageIndex, pageSize));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>지금까지 <code>myBatis</code>, <code>Hibernate</code>, <code>JPA</code>, <code>JPA + Querydsl</code>, <code>Spring Data JPA + Querydsl</code>로 구성한 코드를 알아봤습니다.</p>
<p><code>Spring Data JPA + Querydsl</code>를 이용한 코드 패턴은 지금까지 보이는 코드들중 가장 복잡한 구조를 가지고 있지만, 현재 가장 선호되는 패턴입니다.<br>이렇게 복잡하게 계속해서 묶어주는 이유는 무엇일까요. 가장 큰 이유는 전에 이야기드린 것 처럼, 관계지향적 데이터를 우리가 가지고 있는 <code>OOP</code>적 방법으로 사용하기 위해서 입니다.</p>
<p>이 코드 패턴을 꼭 자신의 것으로 만드시길 바랍니다. <code>Repository Pattern</code>의 경우, 거의 대부분의 DB 어플리케이션개발의 중심이 됩니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/spring-java-jpa-hibernate/">spring, java, jpa, hibernate</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/03/07/09-hibernate/"><span>09. Hibernate</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/03/07/09-hibernate/" rel="bookmark">
        <time class="entry-date published" datetime="2018-03-07T07:54:35.000Z">
          2018-03-07
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="Hibernate"><a href="#Hibernate" class="headerlink" title="Hibernate"></a>Hibernate</h1><p>Hibernate는 지금까지 SQL을 이용한 DB query 방법이 아닌, 객체를 이용한 SQL auto generate를 통한 DB 접속 방법을 제공합니다. 이런 객체를 이용한 방법을 ORM(object relation model)이라고 합니다. 먼저, ORM에 대해서 간단한 소개를 해보도록 하겠습니다.</p>
<h2 id="ORM-Object-Relation-Model"><a href="#ORM-Object-Relation-Model" class="headerlink" title="ORM(Object Relation Model)"></a>ORM(Object Relation Model)</h2><p>java 언어의 발전은 sw 개발에 있어서 객체지향의 개발 방법으로 오는 혜택에 매료가 되었습니다. 그렇지만, 모든 웹 및 기업의 데이터가 저장되어 있는 RDBMS와 OOP간의 괴리의 차이에 의한 비용의 증가가 계속해서 발생하게 되었습니다. OOP적 개발 방법과 RDBMS의 관계형 개발 방법론이 끊임없이 충돌하게 되는 것이지요. 서로간에 전쟁(war) 라는 표현을 사용할 정도로 논란이 매우 큰 문제입니다. java 측에서는 relation 기술의 탓으로 돌리고, data 전문가들은 OOP 기술의 문제라고 약간은 소모적인 논쟁으로 계속해서 가게 되었지요.</p>
<p>이때, ORM(Object Relation Model)은 이러한 불일치 기술에 대한 solution을 지칭할 때 사용됩니다.</p>
<p>ORM은 4가지로 구성이 되어 있습니다.</p>
<ul>
<li>Persistence class에 대한 기본적인 CRUD를 수행하는 API</li>
<li>class 자체나 class의 property를 참조하는 query를 작성할 수 있는 API</li>
<li>mapping meta data 작성을 위한 기반 API</li>
<li>ORM 구성이 Transaction과 상호 동작하며 최적화를 수행하도록 돕는 API</li>
</ul>
<p>왜 ORM을 사용해야지 되는가?</p>
<ul>
<li>생산성 : SQL관련 코드를 제거하고 객체간의 관계를 명확하게 그릴수 있습니다. 그리고 Domain에 집중할 수 있는 설계 구조를 가지고 옵니다.</li>
<li>유지보수성 : Domain을 구현했기 때문에 Domain에 대한 명확한 정의가 나타납니다. Domain의 BL이 변경, 추가 되었을 때 그에 대한 수정이 쉽습니다.</li>
<li>성능 : 가장 큰 이슈입니다. VM을 설명할 때, VM보다 일반 assembly로 compile되는 언어가 더 빠르지만 이제 사용되지 않는 이유랑 동일합니다. ORM 자체에 이미 많은 최적화 방법들이 구현되어 있고, 그 현인들의 지식을 사용할 수 있다는 점에서 더욱더 큰 장점을 가지고 올 수 있습니다.</li>
<li>밴더 독립성 : ORM은 DB와 DB의 방언(각 DB만의 함수들)로부터 추상화 되어 있습니다. DB의 독립성은 매우 큰 장점을 가지고 오는데, 개발에 있어서 오히려 더 나은 장점을 가지고 옵니다. 개발자들은 자신의 개발 PC에 가벼운 DB(mysql)를 설치해서 개발을 하고, 실 서버에서는 Data에 최적화된 DB를 이용해서 서비스를 할 수 있는 장점을 가지고 있습니다. 이는 생산성과도 직결되는 문제입니다.</li>
<li>Java 표준 : ORM은 JSR 220에 의해서 java에 표준적인 기술로 인정을 받았습니다.</li>
</ul>
<h2 id="DDD-Domain-Driven-Design"><a href="#DDD-Domain-Driven-Design" class="headerlink" title="DDD(Domain Driven Design)"></a>DDD(Domain Driven Design)</h2><p>에릭 에반스 (Eric Evans) 는 과거의 지혜와 경험들을 종합하여 도메인-드리븐 디자인 (Domain Driven Design, DDD) 이라는 방법론을 제시 했습니다.<br>단순 객체지향 세계에서 살던 개발자들은  이 굉장하지만 새로운 개념에 어려움을 느껴 발표된지 몇년이 지난 후에야 관심을 가지게 되었죠.<br>DDD가 도대체 뭔데? 어떻게 해서든지 돌아가기만 하면 되는거 아냐! 하면서 무심히 지나쳤던 것들에 대해 체계적으로 설명하는 방법론이죠. 하지만 여전히 DDD는 어려운 것, 그저 한때 유행하는 버즈 워드로 인식되고 있는 경향이 있습니다. DDD가 무엇인지 처음 듣는 개발자도 많을 것입니다. DDD의 전체적인 철학을 쉽게 요약하고 있는 블로그 포스트 DDD: How to tackle complexity  번역으로 DDD 카테고리를 시작합니다.</p>
<hr>
<p>DDD (Domain Driven Design) 에서는 어플리케이션 도메인을 표현하기 위한 오브젝트 모델을 만듭니다.<br>이 모델은 도메인의 모든 관계와 로직을 담고 있습니다. 이렇게 하는 목적은 도메인의 복잡성을 관리하기 위함 입니다. DDD 에는 매우 많은 개념과 패턴이 투입되어 있으나, 정제된 두개의 큰 그림으로 그 복잡성에 태클을 걸 수 있습니다.</p>
<ol>
<li>도메인의 개념을 명확하게 표현합니다.</li>
<li>더욱 심도 있는 통찰을 위해 지속적인 리팩토링을 수행합니다.</li>
</ol>
<p>복잡성이란 자체의 복잡한 정도를 의미합니다. 복잡한 것은 이해하기 어렵습니다. 이해하기 어려우면 금방 알아 들을 수 없습니다.</p>
<p>이것이 실제 이슈 입니다 : 복잡한 소프트웨어는 이해하기 어렵습니다. 이것이 바로 모든 사람이 업데이트 하기를 두려워 하여 아예 처음부터 다시 만드는 이유입니다. 아마 첫번째나 두번째는 해킹 하듯이 코드를 추가해서 원하는 바를 이룰 수 있을지 모르지만, 각각의 해킹은 더 이상 시도하는 것이 의미가 없을 때까지 복잡성과 추잡함을 증가시킵니다. 이것을 다른 말로 실패 라고 합니다.</p>
<p>그래서 우리는 이 복잡성을 극복해야 합니다. DDD의 첫번째 방법은 객체지향, 모델 과 추상화의 장점을 얻는 것 입니다. 하지만 이건 매우 광범위 하죠. 우리는 이 오브젝트와 모델들을 어떻게 구조화 해야 하는지 알아내야 합니다. 이것이 DDD가 도메인의 개념을 명시적으로 표현하자는 아이디어의 입니다.</p>
<p>아이디어는 간단합니다. 여러분의 도메인에 새로이 적용되는 개념이 있다면 모델에서 확인할 수 있어야 합니다. 중요한 개념을 확인하기 위해서 코드를 뒤져서는 안됩니다. 그 개념은 모델에서 오브젝트로써 표현되어야 합니다. 특정 조건에서만 발생하는 액션이 있다고 합시다, 이 조건들이 중요하지 않다면 그 액션을 수행하도록 그저 IF Statement 메소드로 처리하면 됩니다. 하지만, 그 조건들이 도메인에서 중요하다면 코드로 부터 감추는 것만으로는 부족합니다. 그 조건들을 수행하도록 Policy Object가 조건들을 표현해야 합니다. 이제 조건들은 당신의 도메인에서 명시적으로 표현됩니다.</p>
<p>이 아이디어 들은 Factories, Repositories, Services, Knowledge Levels 등등으로 표현될 수 있습니다. 이 것은 여러분의 시스템을 이해 가능하도록 만드는 중요한 부분입니다.</p>
<p>DDD가 작동하도록 만드는 두번째 아이디어는 “Deeper Insight”를 위한 지속적인 리팩토링 입니다. Deeper Insight 란 이미 가지고 있는 도메인 모델에서 새로운 어떤 것을 발견하게 된다면 대충 끼워넣지 말고 도메인에서 중요한 요소인지 반드시 알아내라는 것을 의미합니다. 만약 중요하다면 새로 이해한 것이 명확하게 표현 되도록 모델을 리팩토링 해야 합니다. 이 리팩토링은 사소할 때도 있고, 매우 중요 할 때도 있습니다.</p>
<p>도메인 모델이 표현성을 잃게 되면 점점 더 부서지고, 점점더 복잡해 지며 점점 더 어려워 집니다. 여러분의 모델이 단순하며  표현력과 정확성을 유지할 수 있도록 항상 싸워야 합니다. 당신이 운이 좋다면 에릭 에반스가 말하는 Break Through [전에는 불가능 했던 것이 새로운 가능성과 통찰력이 갑자기 나타나는 일] 것을 경험할  수도 있습니다. 그렇게 된다면 진짜 운이 좋은 것입니다. 당신이 운이 좋지 않더라도 리팩토링은 적어도 모델이 유연성을 요구할때 유연함을 만족 시킬 수는 있습니다. 이것은 미래에 나타날 통찰력과 리팩토링 요소를 더 쉽게 핸들링 할 수 있음을 의미합니다.</p>
<hr>
<p>위 내용과 같이, DDD는 우리가 표현하고자 하는 실세계의 데이터 프로세스 자체를 컴퓨터 언어로 옮겨가는 과정입니다.<br>예를 들어, SQL로 작업을 하게 되면 다음과 같은 대화가 나오게 됩니다.</p>
<p><strong>TB_USER에서 SELECT를 할때, POINT Column으로 Order By DESC로 얻어오고, 그 POINT값이 100점 이상인 경우에는 LEVEL column값을 2로 업데이트를 시키면 됩니다.</strong></p>
<p>자, 방금 말한 내용을 실제 BL을 설계한 기획자에게 이야기를 해보도록 합시다. 과연 어떤 말인지 알아들을수 있을까요? SQL 개발자들이라면 가능하겠지요. DDD로 모델링을 거치면 다음과 같은 대화를 할 수 있습니다.</p>
<p><strong>User를 표로 보여줄 때, Book Point값이 높은 순서대로 보여주고, Book Point값이 100점이상인 경우에는 Reader로 사용자 Level을 높여줘서 보여주면 됩니다.</strong></p>
<p>어떤 대화가 좀 더 쉽습니까? 기존의 데이터 중심으로 보는 것과 모델링을 중심으로 보는것. 이 두가지의 차이는 그 데이터의 구조를 모르는 사람이 로직을 읽을수 있느냐, 없느냐에 따라 갈리게 됩니다. 그리고 우리가 문장으로 설명할 수 있는 BL을 code에 어떻게 녹여내느냐를 고민을 해야지 됩니다.</p>
<p>최종적으로 DDD는 다음 목표들을 갖습니다.</p>
<h3 id="Ubiquitous-Language"><a href="#Ubiquitous-Language" class="headerlink" title="Ubiquitous Language"></a>Ubiquitous Language</h3><p>Domain 중심의 SW팀에서는 모든 참가자들(사용자, 도메인전문가, 설계자, 프로그래머, 분석가)간에 동일한 의미를 갖는 공통된 언어를 갖는다. 심지어 공통된 언어는 Code의 Object로 구현이 가능해야지 된다.</p>
<h3 id="Layered-Architecture-pattern"><a href="#Layered-Architecture-pattern" class="headerlink" title="Layered Architecture pattern"></a>Layered Architecture pattern</h3><p>UI와 Model이 결합되어 있으면, UI가 바뀌는데에 따라 Model이 변경되어야지 됩니다. 따라서 UI, BL, Modeling간에 분리가 가능한 Layer들이 만들어져야지 됩니다. 기준에 따라 Layer를 나누고, 역할을 부여하는 작업이 필요합니다. 이에 대한 장점은 다음과 같습니다.</p>
<ul>
<li>Layer들이 재사용될 수 있어야지 됩니다.</li>
<li>표준을 지원한다.</li>
<li>종속성을 국지적으로 최소화한다.</li>
<li>교환 가능성이 확보된다.</li>
</ul>
<p>일반적으로 DDD는 다음 4개의 Layer로 구분시켜서 사용하게 됩니다.</p>
<p><img src="/images/hibernate/h01.png" alt=""></p>
<ul>
<li>Infrastructure Layer : 상위 계층을 지원하는 일반화된 기술적 기능을 제공. 공통 Library, Engine, Framework 영역</li>
<li>Domain Layer : 업무 개념과 업무 상황에 대한 정보. 업무 규칙을 표현하는 Layer.</li>
<li>Application Layer : 작업을 정의하고 조정하는 영역. Domain 객체로 작업을 위임하는 역활을 담당.</li>
<li>UI Layer : 정보를 노출하고 입력을 받아들이는 영역</li>
</ul>
<p>이러한 구조는 결국은 Domain의 격리, 즉 분리가 이루어지게 됩니다. 이러한 Layer architecture중 가장 대표적인 방식이 MVC 입니다.</p>
<h3 id="Smart-UI-anti-pattern"><a href="#Smart-UI-anti-pattern" class="headerlink" title="Smart UI anti pattern"></a>Smart UI anti pattern</h3><p>모든 업무로직을 사용자 인터페이스에 넣는 설계 방법을 Smart UI pattern이라고 합니다.</p>
<p>특징은</p>
<ul>
<li>application을 작은 기능으로 잘게 나누고,</li>
<li>나뉜 기능을 분리된 UI로 구현. 업무 규칙이 분리된 UI에 들어가게 합니다.</li>
<li>분리된 업무 규칙은 RDBMS를 이용해서 데이터를 공유하고 실행합니다. 주로 SP가 이 용도로 사용됩니다.</li>
<li>주로 자동화된 UI 구축 도구와 시각적인 프로그래밍 도구를 이용합니다.</li>
</ul>
<p>DDD pattern에서 가장 피해야지 되는 것이 바로 UI Pattern입니다.<br>UI pattern이라는 것은 지금도 매우 자주 쓰이고 있는 패턴입니다. 이 패턴의 가장 큰 문제는 우리가 사용하는 데이터 및 Domain에 대한 모든 로직을 보여지는 View에 맞추게 됩니다. 실질적인 데이터의 흐름을 방해하고, 언제나 바뀔 수 있는 View 영역에 Model이 영속되기 때문에 application의 변경에 취약한 약점을 갖게 됩니다.</p>
<p>대표적인 Smart UI pattern의 도구가 PowerBuilder입니다. Data Window의 Smart UI를 이용하기 위해, UI에 따른 Model과 로직이 꼬인 상태로 존재하게 됩니다. 이는 필연적으로 코드의 중복을 가지고 오게 되며, 아직까지 UI에 대한 명확한 테스트를 할 수 없는 현 시점에서 유지보수가 거의 불가능한 시스템을 만들게 됩니다. <em>anti pattern은 쓰지 말라고 있는겁니다.</em></p>
<h3 id="Entities-pattern"><a href="#Entities-pattern" class="headerlink" title="Entities pattern"></a>Entities pattern</h3><p>ID를 갖는 unique한 object를 갖는 pattern입니다. 이는 RDBMS의 PK와 연결시켜, 이 객체가 유일한 어떤 값임을 나타내는 방법을 제공합니다.</p>
<h3 id="Service-pattern"><a href="#Service-pattern" class="headerlink" title="Service pattern"></a>Service pattern</h3><p>서비스는 기능을 처리하거나, Entity로 구별할 수 없는 것을 지칭합니다. 가장 주로 사용되는 것은 BL의 Group을 표현하는 것이 가장 많습니다.</p>
<h3 id="Factory-pattern"><a href="#Factory-pattern" class="headerlink" title="Factory pattern"></a>Factory pattern</h3><p>각각의 Object, Service의 생성방법에 대한 통일성을 갖는것을 목표로 합니다. 어떤 객체를 생성할 때, 초기화 해줘야지 되는 값이라던지 실행시켜줘야지 되는 method가 독특하게 존재한다면 개발자 및 참여자들은 Domain에 집중할 수 없습니다. Spring의 ApplicationContext는 이런 경우 가장 좋은 해결 방법이 됩니다.</p>
<h3 id="Repository-pattern"><a href="#Repository-pattern" class="headerlink" title="Repository pattern"></a>Repository pattern</h3><p>생성된 객체나 Model이 외부(주로 DB)와 연동되어 생명주기를 가질때, 그 생명주기에 대한 관리 Focus가 되는 Layer가 존재해야지 됩니다. dao로 구현되는 것이 일반적이며, Spring에서는 @Repository로 지정하는 것이 일반적입니다.</p>
<p>DDD의 사상을 반영하기 위해 주로 사용되는 툴이 ORM이고, java에서 가장 오랜 시간동안 개발이 되고 사랑받고 있는 Hibernate가 그 선두 주자라고 할 수 있습니다.</p>
<h2 id="Hibernate를-이용한-Repository-개발"><a href="#Hibernate를-이용한-Repository-개발" class="headerlink" title="Hibernate를 이용한 Repository 개발"></a>Hibernate를 이용한 Repository 개발</h2><p>새로운 project를 만들고, Hibernate, DAO 관련 library를 추가합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.mariadb.jdbc'</span>, <span class="string">name:</span> <span class="string">'mariadb-java-client'</span>, <span class="string">version:</span> <span class="string">'2.2.0'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.hibernate'</span>, <span class="string">name:</span> <span class="string">'hibernate-core'</span>, <span class="string">version:</span> <span class="string">'5.2.12.Final'</span></span><br><span class="line">compileOnly <span class="string">group:</span> <span class="string">'org.projectlombok'</span>, <span class="string">name:</span> <span class="string">'lombok'</span>, <span class="string">version:</span> <span class="string">'1.16.18'</span></span><br></pre></td></tr></table></figure>
<p>기존에 만들어둔 <code>Book</code>, <code>BookStatus</code>, <code>User</code>, <code>History</code>를 copy해서 넣습니다.</p>
<p><code>hibernate.cfg.xml</code> 파일을 만들어주고, 다음과 같은 내용을 넣습니다. <code>hibernate.cfg.xml</code> 파일은 기본적으로 db 연결방법들을 제공합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<span class="meta">&lt;!DOCTYPE hibernate-configuration PUBLIC</span></span><br><span class="line"><span class="meta">        "-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span></span><br><span class="line"><span class="meta">        "http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd"&gt;</span><span class="tag">&lt;<span class="name">hibernate-configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">session-factory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.connection.driver_class"</span>&gt;</span>org.mariadb.jdbc.Driver<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.connection.password"</span>&gt;</span>qwer12#$<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://127.0.0.1:4306/bookstore<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.connection.username"</span>&gt;</span>root<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MariaDB53Dialect<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.show_sql"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">session-factory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">hibernate-configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Hibernate를 이용한 repository는 다음과 같은 pattern으로 동작합니다.</p>
<ul>
<li>SessionFactory를 통한 Session의 확보</li>
<li>Session을 통한 자동생성된 Query의 실행</li>
<li>Session close</li>
</ul>
<p><code>myBatis</code>와 동일한 패턴입니다. 이제 이 패턴대로 <code>BookDao</code>를 구성해보도록 하겠습니다.<br>먼저, DB의 Column과 구현되어 있는 Book간의 연결을 annotation을 이용해서 구성합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"books"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"id"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"name"</span>, nullable = <span class="keyword">false</span>, length = <span class="number">255</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"comment"</span>, nullable = <span class="keyword">true</span>, length = <span class="number">255</span>)</span><br><span class="line">    <span class="keyword">private</span> String comment;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"author"</span>, nullable = <span class="keyword">false</span>, length = <span class="number">50</span>)</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"publishDate"</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> Date publishDate;</span><br><span class="line">    <span class="meta">@Enumerated</span>(EnumType.ORDINAL)</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"status"</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> BookStatus bookStatus;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"rentUserId"</span>, nullable = <span class="keyword">true</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer rentUserId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>객체의 각 property와 DB의 물리적인 상관관계를 annotation을 통해서 relation을 갖게 하는 과정입니다. 이를 통해 객체지향적인 java 객체가 관계지향/물리적 DB와의 연결이 되게 됩니다.</p>
<p>다음은 <code>Repository</code> 코드입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDaoImpl</span> <span class="keyword">implements</span> <span class="title">BookDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SessionFactory sessionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookDaoImpl</span><span class="params">(SessionFactory sessionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sessionFactory = sessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Session session = sessionFactory.openSession()) &#123;</span><br><span class="line">            CriteriaBuilder builder = session.getCriteriaBuilder();</span><br><span class="line">            CriteriaQuery&lt;Long&gt; query = builder.createQuery(Long.class);</span><br><span class="line">            query.select(builder.count(query.from(Book.class)));</span><br><span class="line">            <span class="keyword">return</span> session.createQuery(query).getSingleResult().intValue();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Session session = sessionFactory.openSession()) &#123;</span><br><span class="line">            <span class="keyword">return</span> session.createQuery(<span class="string">"from Book"</span>, Book.class).list();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Session session = sessionFactory.openSession()) &#123;</span><br><span class="line">            Book book = session.byId(Book.class).load(id);</span><br><span class="line">            <span class="keyword">return</span> book;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Session session = sessionFactory.openSession()) &#123;</span><br><span class="line">            session.save(book);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Session session = sessionFactory.openSession()) &#123;</span><br><span class="line">            session.save(book);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Session session = sessionFactory.openSession()) &#123;</span><br><span class="line">            Book deleteBook = <span class="keyword">new</span> Book();</span><br><span class="line">            deleteBook.setId(bookId);</span><br><span class="line">            session.delete(deleteBook);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (Session session = sessionFactory.openSession()) &#123;</span><br><span class="line">            CriteriaBuilder builder = session.getCriteriaBuilder();</span><br><span class="line">            CriteriaDelete&lt;Book&gt; query = builder.createCriteriaDelete(Book.class);</span><br><span class="line">            query.from(Book.class);</span><br><span class="line">            session.createQuery(query);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이 패턴은 전에 refactoring을 진행했던 Template-Callback pattern을 통해 Refactoring이 가능합니다. HibernateRefactoring을 진행해보도록 하겠습니다.<br>테스트 코드를 통해 실행되는 것을 확인하면 다음과 같이 구성 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDaoImplTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ServiceRegistry serviceRegistry;</span><br><span class="line">    <span class="keyword">private</span> SessionFactory sessionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Configuration configuration = <span class="keyword">new</span> Configuration();</span><br><span class="line">        configuration.configure(<span class="string">"hibernate.cfg.xml"</span>);</span><br><span class="line">        configuration.addAnnotatedClass(Book.class);</span><br><span class="line">        configuration.addAnnotatedClass(User.class);</span><br><span class="line">        configuration.addAnnotatedClass(History.class);</span><br><span class="line">        serviceRegistry = <span class="keyword">new</span> StandardServiceRegistryBuilder()</span><br><span class="line">            .applySettings(configuration.getProperties()).build();</span><br><span class="line">        sessionFactory = configuration.buildSessionFactory(serviceRegistry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BookDao bookDao = <span class="keyword">new</span> BookDaoImpl(sessionFactory);</span><br><span class="line">        bookDao.getAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>기존과 좀 다른 형태의 <code>DaoImpl</code>이 만들어집니다. 이렇게만 작성하면 <code>ORM</code>과 전에 나온 <code>myBatis</code>간의 차이가 무엇인지 모르게됩니다. 이제 더 깊이 가보도록 하겠습니다.</p>
<h2 id="Hibernate를-이용한-Service의-개발-DDD"><a href="#Hibernate를-이용한-Service의-개발-DDD" class="headerlink" title="Hibernate를 이용한 Service의 개발 - DDD"></a>Hibernate를 이용한 Service의 개발 - DDD</h2><p>이제 서비스의 개발을 확인해보도록 하겠습니다. 다음과 같은 BL을 생각해보도록 하겠습니다.</p>
<p><strong> 사용자가 책을 대여한다. 대여하면서 사용자 point가 10점씩 증가된다. </strong></p>
<p>서비스 코드는 다음과 같이 구성될 수 있을 것입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentBook</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">    Book rentBook = bookDao.getById(bookId);</span><br><span class="line">    User user = userDao.getById(userId);</span><br><span class="line"></span><br><span class="line">    rentBook.setRentUser(user);</span><br><span class="line">    user.setPoint(user.getPoint() + <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    userDao.update(user);</span><br><span class="line">    bookDao.update(rentBook);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위와 같이 절차적으로 구성이 가능합니다.</p>
<blockquote>
<p>책을 얻어낸다.<br>사용자를 얻어낸다.<br>책에 대여사용자를 셋팅한다.<br>사용자의 point 값을 증가시킨다.<br>Dao를 이용해서 update 시킨다.</p>
</blockquote>
<p>그렇지만 이는 객체지향적이지 못합니다.</p>
<p><code>ORM</code>으로, 아니 <code>DDD</code>로 구성을 한다면 처음 이야기한 BL 그대로 해석이 가능한 코드가 서비스에서 녹아들어갈 수 있어야지 됩니다. 다음과 같이요.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentBook</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">    Book book = bookDao.getById(bookId);</span><br><span class="line">    User user = userDao.getById(userId);</span><br><span class="line">    user.rentBook(book, <span class="number">10</span>, bookDao, userDao);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위와 같이 <code>Entity</code> 객체들에 단순한 property만을 넣는 것이 아닌, action에 대한 처리 역시 <code>Entity</code>에 구현해서 보다더 확장된 <code>Entity</code>를 만들어주게되면 코드의 확장이 더욱더 잘 됩니다.<br>위와 같이 확장된 <code>User</code>의 코드는 다음과 같이 구성 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentBook</span><span class="params">(Book book, <span class="keyword">int</span> incrementPoint, BookDao bookDao, UserDao userDao)</span> </span>&#123;</span><br><span class="line">    book.setRentUser(<span class="keyword">this</span>);</span><br><span class="line">    bookDao.update(book);</span><br><span class="line">    <span class="keyword">this</span>.setPoint(<span class="keyword">this</span>.getPoint() + incrementPoint);</span><br><span class="line">    userDao.update(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이에 대한 테스트를 작성한다면 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserDao userDao = mock(UserDao.class);</span><br><span class="line">    BookDao bookDao = mock(BookDao.class);</span><br><span class="line"></span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setPoint(<span class="number">100</span>);</span><br><span class="line">    Book book = <span class="keyword">new</span> Book();</span><br><span class="line"></span><br><span class="line">    user.rentBook(book, <span class="number">10</span>, bookDao, userDao);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//book에 대여자가 정상적으로 설정되었는지 확인</span></span><br><span class="line">    assertThat(book.getRentUser()).isEqualTo(user);</span><br><span class="line">    <span class="comment">//user에 정상적으로 Point 값이 설정되었는지 확인</span></span><br><span class="line">    assertThat(user.getPoint()).isEqualTo(<span class="number">110</span>);</span><br><span class="line">    <span class="comment">//Repository를 통해서 객체 값이 업데이트가 되고 있는지 체크 필요</span></span><br><span class="line">    verify(userDao, times(<span class="number">1</span>)).update(user);</span><br><span class="line">    verify(bookDao, times(<span class="number">1</span>)).update(book);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BL 로직 자체를 DB가 없이 가능하게 되며, Entity간의 Domain Logic에 의해서 처리되고 있는 것을 볼 수 있습니다. 이는 서비스의 구현에 있어서 용어의 통일 및 로직의 확장에 용의하게 됩니다.</p>
<h2 id="Entity의-정의"><a href="#Entity의-정의" class="headerlink" title="Entity의 정의"></a>Entity의 정의</h2><p>Entity의 정의는 기존 <code>VO</code>나 <code>DTO</code>를 만들어낼때 사용되는 간단한 getter/setter만을 사용하지 않고 BL의 action의 확장 역시 가능합니다. 또한 Entity는 다른 Entity간의 Relation을 가지게 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"books"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"id"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"name"</span>, nullable = <span class="keyword">false</span>, length = <span class="number">255</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"comment"</span>, nullable = <span class="keyword">true</span>, length = <span class="number">255</span>)</span><br><span class="line">    <span class="keyword">private</span> String comment;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"author"</span>, nullable = <span class="keyword">false</span>, length = <span class="number">50</span>)</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"publishDate"</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> Date publishDate;</span><br><span class="line">    <span class="meta">@Enumerated</span>(EnumType.ORDINAL)</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"status"</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> BookStatus bookStatus;</span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn</span>(name = <span class="string">"rentUserId"</span>, nullable = <span class="keyword">true</span>)</span><br><span class="line">    <span class="keyword">private</span> User rentUser;</span><br><span class="line">    <span class="meta">@OneToMany</span>(mappedBy = <span class="string">"book"</span>)</span><br><span class="line">    <span class="keyword">private</span> List&lt;History&gt; histories;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"histories"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">History</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"id"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn</span>(name = <span class="string">"bookId"</span>)</span><br><span class="line">    <span class="keyword">private</span> Book book;</span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn</span>(name = <span class="string">"userId"</span>)</span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    <span class="meta">@Enumerated</span>(EnumType.ORDINAL)</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"actionType"</span>)</span><br><span class="line">    <span class="keyword">private</span> HistoryActionType actionType;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"insertDate"</span>)</span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"users"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"id"</span>)</span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"name"</span>, length = <span class="number">50</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"password"</span>, length = <span class="number">12</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"point"</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> point;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"level"</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> level;</span><br><span class="line">    <span class="meta">@OneToMany</span>(mappedBy = <span class="string">"user"</span>)</span><br><span class="line">    <span class="keyword">private</span> List&lt;History&gt; histories;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentBook</span><span class="params">(Book book, <span class="keyword">int</span> incrementPoint, BookDao bookDao, UserDao userDao)</span> </span>&#123;</span><br><span class="line">        book.setRentUser(<span class="keyword">this</span>);</span><br><span class="line">        bookDao.update(book);</span><br><span class="line">        <span class="keyword">this</span>.setPoint(<span class="keyword">this</span>.getPoint() + incrementPoint);</span><br><span class="line">        userDao.update(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>각 객체들간의 새로운 연관관계가 보이는 것을 볼 수 있습니다. <code>Book</code>이라는 객체를 통해서, RentUser를 얻어낼 수 있으며, Book의 연관 History를 모두 얻어낼 수 있습니다.<br>이러한 연관관계를 정의하는 annotation들은 다음과 같습니다.</p>
<table>
<thead>
<tr>
<th>이름</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Entity</td>
<td>entity 객체임을 지정하는 annotation입니다.</td>
</tr>
<tr>
<td>@Table</td>
<td>entitty 객체와 연결되는 table을 지정하는 annotation입니다.</td>
</tr>
<tr>
<td>@Id</td>
<td>PK를 지정하는 annotation입니다.</td>
</tr>
<tr>
<td>@Column</td>
<td>DB의 Column과 1:1로 mapping되는 Property를 지정하는 annotation입니다.</td>
</tr>
<tr>
<td>@GeneratedValue</td>
<td>PK의 값이 지정되는 방법을 결정할 수 있습니다. AUTO의 경우 mysql의 AUTO_INCREMENT에 해당됩니다. 각각의 DB에 따라 다른 값을 넣어주는 것도 가능합니다.(ex : oracle의 sequence)</td>
</tr>
<tr>
<td>@Enumerated</td>
<td>enum 값과 1:1로 mapping이 되는 것을 지정합니다.</td>
</tr>
<tr>
<td>@ManyToOne</td>
<td>자신과 같은 객체들이 다른 한개의 객체에 연관이 있음을 지정합니다. 이는 N:1의 속성을 지정하게 됩니다.</td>
</tr>
<tr>
<td>@JoinColumn</td>
<td>@ManyToOne과 같이 사용됩니다. Join 되는 Column을 지정합니다. (FK column)</td>
</tr>
<tr>
<td>@OneToMany</td>
<td>자신이 다른 객체들에 연관이 있음을 지정합니다. 이는 1:N 또는 N:N의 속성을 지정합니다.</td>
</tr>
</tbody>
</table>
<p>그리고, Entity에 대한 개념을 다시 한번 정리해보겠습니다.</p>
<h3 id="Entity의-요구사항"><a href="#Entity의-요구사항" class="headerlink" title="Entity의 요구사항"></a>Entity의 요구사항</h3><p>하나의 엔티티 클래스는 다음의 요구조건을 충족해야 합니다:</p>
<ul>
<li>클래스 선언부에 javax.persistence.Entity 어노테이션을 반드시 명시하여야 합니다.</li>
<li>기본 생성자를 반드시 포함해야 합니다. 기본생성자는 인수가 없는 생성자를 의미합니다. 만일, 인수를 포함한 생성자를 사용한다면 명시적으로 기본 생성자를 만들어야만 합니다.</li>
<li>클래스를 fianl로 선언해서는 안됩니다.</li>
<li>엔티티 인스턴스가 세션빈의 리모트 비지니스 인터페이스와 같이 detached object형태로 전달되는 경우, 클래스는 반드시 Serializble 인터페이스를 구현해야 합니다.</li>
<li>엔티티는 엔티티 또는 non-엔티티 클래스 모두 확장(extend)이 가능하며, non-엔티티 클래스는 엔티티 클래스를 확장할 수 있습니다.</li>
<li>영속화 인스턴스 변수는 반드시 private, protected, package-private중 하나로 선언되어야 하며, 엔티티 클래스의 메소드에 의해 직접 참조될 수 있습니다. 클라이언트는 엔티티의 상태를 접근자(accessor)또는 비지니스 메소드를 통해 접근이 가능합니다.</li>
</ul>
<p>또한, 영속상태의 엔티티는 엔티티의 인스턴스 변수 또는 자바빈 스타일의 속성에 의해 접근할 수 있습니다. 필드 또는 속성은 다음의 자바 언어 타입에 따라야지 됩니다.</p>
<ul>
<li>자바 원시 타입</li>
<li>java.lang.String</li>
<li>그외 직렬화 가능(Serializable) 타입들</li>
<li>자바 원시타입의 Wrappers</li>
<li>java.math.BigInteger</li>
<li>java.math.BigDecimal</li>
<li>java.util.Date</li>
<li>java.util.Calendar</li>
<li>java.sql.Date</li>
<li>java.sql.Time</li>
<li>java.sql.Timestamp</li>
<li>사용자 정의 직렬화 타입들</li>
<li>byte[]</li>
<li>Byte[]</li>
<li>char[]</li>
<li>Character[]</li>
<li>열거형(Enumerated) 타입들</li>
<li>다른 엔티티 또는 엔티티 컬렉션</li>
<li>내장형(Embeddable) 클래스</li>
</ul>
<h3 id="Entity간의-Relation"><a href="#Entity간의-Relation" class="headerlink" title="Entity간의 Relation"></a>Entity간의 Relation</h3><p>각 엔티티들은 다음과 같은 관계를 가질 수 있습니다.</p>
<ul>
<li>One-to-one : 각 엔티티 인스턴스는 하나의 인스턴스가 다른 엔티티와 연관됩니다. One-to-one 관계는 javax.persistence.OneToOne 어노테이션으로 해당 필드에 정의합니다.</li>
<li>One-to-many : 하나의 엔티티 인스턴스가 다수의 다른 엔티티 인스턴스와 연관됩니다. 영업주문의 경우 다수의 라인 아이템을 가집니다. 즉, Order 엔티티는 여러개의 LineItem 을 가지므로 이들 사이에는 One-to-many 관계가 선언되어야 하므로 javax.persistence.OneToMany 어노테이션을 사용합니다.</li>
<li>Many-to-one : 다수의 인스턴스가 하나의 다른 엔티티와 연관됩니다. 이것은 One-to-many 와 반대입니다. 영업주문의 경우 LineItem은 Order에 대해 Many-to-one 관계가 성립되므로 javax.persistence.ManyToOne 어노테이션을 지정합니다.</li>
<li>Many-to-many : 이 인스턴스는 다수의 인스턴스가 각기 다른 엔티티들과 연관됩니다. 예를들어, 학교에서 각 수업들은 다수의 학생들과 연관이 있으며, 학생 역시 다수의 수업을 듣고 있습니다. 이경우 수업과 학생은 Many-to-Many 관계가 성립되며 javax.persistence.ManyToMany 어노테이션을 사용합니다.</li>
</ul>
<p>Entity-Entity Relation은 매우 중요한 개념입니다. 이를 통해 RDBMS와 OOP간의 간극을 없애주는 핵심 개념입니다.</p>
<h2 id="Spring과-Hibernate-연결"><a href="#Spring과-Hibernate-연결" class="headerlink" title="Spring과 Hibernate 연결"></a>Spring과 Hibernate 연결</h2><p>지금까지 작성되었던 Hibernate를 이용한 dao, service layer를 spring을 이용하도록 수정해보도록 하겠습니다.</p>
<p>먼저 조금 소개를 한다면, Spring과 Hibernate는 원래 사이가 좋은 편은 아니였습니다.<br>예전 Spring 1.x와 Hibernate 2.x 간에는 개발자간에 매우 심각한 대립이 존재를 했었고, 그로 인한 키보드 배틀이 엄청나게 있었지요.<br>가장 큰 이유는 예전 Spring에서는 HibernateTemplate을 제공하고 있었습니다. Hibernate는 DB에 접근하는 방법을 Session을 바로 얻어서 사용하도록 되어 있는데, 이러한 Raw level 접근을 Spring을 사용함으로 Spring에서 Hibernate의 기본 사상을 망가트리고 있다는 불만이 가장 컷지요.</p>
<p>그렇지만, Hibernate 3.x대로 넘어가고, Spring이 2.x대로 넘어가면서 화해(?)를 하게 됩니다. Spring 측에서 HibernateTemplate을 사용하지 않고, Spring에서 Hibernate를 사용할 수 있도록 Spring Framework의 큰 부분을 변경했습니다. 그리고 그에 맞추어 Hibernate에서는 SessionFactory에서 getCurrentSession() method를 추가함으로서, Spring의 기본적인 Transaction 방법에 맞추어 Hibernate를 이용한 DB 접근을 가능하게 하였습니다.</p>
<p>둘간의 관계는 Spring 자체는 application framework입니다. Hibernate는 ORM framework고요. Hibernate 자체가 Spring보다 범위가 작은 Framework라고도 할 수 있습니다. Java의 모든 application은 Spring을 사용할 수 있지만, DB를 사용하지 않는 Application은 Hibernate를 사용하지 않을테니까요. 그럼에도 불구하고, Java의 최고 양대 open source framework는 spring과 hibernate입니다. 둘은 open source가 세상을 얼마나 바꾸어 놓을 수 있는지 보여주었고, 상업적으로도 엄청난 성공을 거뒀습니다. spring은 지금 vmware에서 제공되고 있고, hibernate는 weblogic을 제공하는 JBOSS에서 제공되고 있습니다.</p>
<p>잡설이 길었습니다. spring은 이러한 hibernate를 위한 library를 따로 분리해서 사용하고 있습니다.</p>
<p>구성될 dependencies 입니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">compileOnly <span class="string">group:</span> <span class="string">'org.projectlombok'</span>, <span class="string">name:</span> <span class="string">'lombok'</span>, <span class="string">version:</span> <span class="string">'1.16.18'</span></span><br><span class="line"></span><br><span class="line">compile <span class="string">'com.google.guava:guava:23.0'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'com.fasterxml.jackson.core'</span>, <span class="string">name:</span> <span class="string">'jackson-databind'</span>, <span class="string">version:</span> <span class="string">'2.9.3'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.mariadb.jdbc'</span>, <span class="string">name:</span> <span class="string">'mariadb-java-client'</span>, <span class="string">version:</span> <span class="string">'2.2.0'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.hibernate'</span>, <span class="string">name:</span> <span class="string">'hibernate-core'</span>, <span class="string">version:</span> <span class="string">'5.2.12.Final'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'com.zaxxer'</span>, <span class="string">name:</span> <span class="string">'HikariCP'</span>, <span class="string">version:</span> <span class="string">'2.7.4'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-context'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br><span class="line">compile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-orm'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br><span class="line"></span><br><span class="line">testCompile <span class="string">'junit:junit:4.12'</span></span><br><span class="line">testCompile <span class="string">'org.assertj:assertj-core:3.8.0'</span></span><br><span class="line">testCompile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-test'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br></pre></td></tr></table></figure>
<p>이제 <code>@Configuration</code>을 구성하겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(value = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.repository"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">        dataSource.setMaximumPoolSize(<span class="number">10</span>);</span><br><span class="line">        dataSource.setMinimumIdle(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HibernateTransactionManager transactionManager = <span class="keyword">new</span> HibernateTransactionManager();</span><br><span class="line">        transactionManager.setDataSource(dataSource());</span><br><span class="line">        transactionManager.setSessionFactory(sessionFactoryBean().getObject());</span><br><span class="line">        <span class="keyword">return</span> transactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalSessionFactoryBean <span class="title">sessionFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">"hibernate.dialect"</span>, <span class="string">"org.hibernate.dialect.MariaDB53Dialect"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"hibernate.show_sql"</span>, <span class="string">"true"</span>);</span><br><span class="line"></span><br><span class="line">        LocalSessionFactoryBean localSessionFactoryBean = <span class="keyword">new</span> LocalSessionFactoryBean();</span><br><span class="line">        localSessionFactoryBean.setHibernateProperties(properties);</span><br><span class="line">        localSessionFactoryBean.setPackagesToScan(<span class="string">"com.xyzlast.bookstore.entity"</span>);</span><br><span class="line">        localSessionFactoryBean.setDataSource(dataSource());</span><br><span class="line">        <span class="keyword">return</span> localSessionFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HibernateExceptionTranslator <span class="title">hibernateExceptionTranslator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HibernateExceptionTranslator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 변경되는 <code>Repository</code> 코드는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDaoSpringImpl</span> <span class="keyword">implements</span> <span class="title">BookDao</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SessionFactory sessionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookDaoSpringImpl</span><span class="params">(SessionFactory sessionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sessionFactory = sessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        CriteriaBuilder builder = session.getCriteriaBuilder();</span><br><span class="line">        CriteriaQuery&lt;Long&gt; query = builder.createQuery(Long.class);</span><br><span class="line">        query.select(builder.count(query.from(Book.class)));</span><br><span class="line">        <span class="keyword">return</span> session.createQuery(query).getSingleResult().intValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        <span class="keyword">return</span> session.createQuery(<span class="string">"from Book"</span>, Book.class).list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        <span class="keyword">return</span> session.byId(Book.class).load(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        session.save(book);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        session.update(book);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        session.delete(book);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Session session = sessionFactory.getCurrentSession();</span><br><span class="line">        session.createQuery(<span class="string">"DELETE FROM Book"</span>).executeUpdate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>차이는 <code>Session session = sessionFactory.openSession()</code>에서 <code>Session session = sessionFactory.getCurrentSession()</code>으로 바뀐것입니다. 그 이외에는 별 차이가 없습니다.<br>이제 만들어진 <code>Dao</code>를 가지고 Test code를 돌려보도록 합니다. 기존 test 코드를 그대로 사용 가능할 것입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(classes = BookStoreConfig.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDaoSpringImplTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BookDao bookDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Book&gt; allBooks = bookDao.getAll();</span><br><span class="line">        <span class="keyword">if</span> (allBooks.isEmpty()) &#123;</span><br><span class="line">            bookDao.add(TestValueGenerator.generateNewBook());</span><br><span class="line">            allBooks = bookDao.getAll();</span><br><span class="line">        &#125;</span><br><span class="line">        Book checkBook = allBooks.get(allBooks.size() - <span class="number">1</span>);</span><br><span class="line">        Book getBook = bookDao.getById(checkBook.getId());</span><br><span class="line">        Assert.assertEquals(checkBook.getId(), getBook.getId());</span><br><span class="line">    &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>돌리면 바로 다음과 같은 에러가 발생할 것입니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Jan <span class="number">11</span>, <span class="number">2018</span> <span class="number">9</span>:<span class="number">46</span>:<span class="number">18</span> AM org.hibernate.engine.jdbc.env.internal.LobCreatorBuilderImpl makeLobCreatorBuilder</span><br><span class="line"><span class="function">INFO: <span class="title">HHH000422</span>: <span class="title">Disabling</span> <span class="title">contextual</span> <span class="title">LOB</span> <span class="title">creation</span> <span class="title">as</span> <span class="title">connection</span> <span class="title">was</span> <span class="title">null</span></span></span><br><span class="line"><span class="function"><span class="title">org.hibernate.HibernateException</span>: <span class="title">Could</span> <span class="title">not</span> <span class="title">obtain</span> <span class="title">transaction</span>-<span class="title">synchronized</span> <span class="title">Session</span> <span class="title">for</span> <span class="title">current</span> <span class="title">thread</span></span></span><br><span class="line"><span class="function">	<span class="title">at</span> <span class="title">org.springframework.orm.hibernate5.SpringSessionContext.currentSession</span>(<span class="title">SpringSessionContext.java</span>:136)</span></span><br><span class="line"><span class="function">	<span class="title">at</span> <span class="title">org.hibernate.internal.SessionFactoryImpl.getCurrentSession</span>(<span class="title">SessionFactoryImpl.java</span>:465)</span></span><br></pre></td></tr></table></figure>
<p>에러가 발생되는 원인은 바로 변경된 코드인 <code>getCurrentSession()</code> 입니다. 현 상태는 Session이 <code>Open</code> 되어 있지 않은 상태입니다. <code>@Transactional</code> annotation을 통해 Session을 <code>Open</code>시켜줍니다. 이를 통해 <code>@Transactional</code>로 묶여 있는 한개의 method가 하나의 BL이 되는 명확한 지정이 됩니다.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>ORM을 이용한 개발에 대해서 알아봤습니다. ORM을 이용한다는 것을 DDD(Domain Driven Development)와 밀접한 연관을 가지고 있습니다. BL과 우리가 개발하는 코드간의 언어적 갭을 최대한 줄이는 것이 목적입니다. 새로운 언어가 나오면 그에 대한 Application Framework가 나오게 되고, 거의 동시에 ORM Framework가 나오는 것이 대부분의 추세입니다. 특히 Spring에서의 <code>Repository Pattern</code>은 기본적으로 ORM을 사용하는 것을 기본으로 구성하는 경우가 많습니다. 비록 국내 SI에서는 잘 사용되고 있지 않지만, 최근 스타트업 붐에 보이는 거의 대부분의 기업들이 ORM을 사용하고 있는 것이 현실입니다. 잘 익혀둬야지 됩니다.</p>
<p>ORM의 사용은 단순 코드의 개발로 끝나지 않습니다. 개발 패턴에 대한 내용이고, 사상에 대한 이슈입니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/java-spring-hibernate/">java, spring, hibernate</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/02/21/08-mybatis/"><span>08.myBatis</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/02/21/08-mybatis/" rel="bookmark">
        <time class="entry-date published" datetime="2018-02-21T14:18:14.000Z">
          2018-02-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="myBatis"><a href="#myBatis" class="headerlink" title="myBatis"></a>myBatis</h1><p>지금까지는 Spring에서 제공하는 <code>JdbcTemplate</code>를 이용하는 방법을 알아봤습니다. 단점으로 볼 수 있는 것이, 직접적인 query들을 계속해서 코드안에 넣어야지 되는 단점이 있습니다. 그리고, 실제적인 코드와 SQL간의 분리가 되지 않는다는 단점을 가지고 있습니다. 국내에서 DB 접근에 가장 많이 사용하고 있는 기술인 <code>myBatis</code>에 대해서 알아보도록 하겠습니다.</p>
<p>myBatis는 <code>Repository Pattern</code>을 충실히 지킬 수 있으며, DB의 <code>StoreProcedure</code>, <code>Function</code>과 같은 legacy sql을 직접적으로 쉽게 사용할 수 있는 장점을 가지고 있습니다. 이를 통해, JDBC를 이용한 반복적인 코드를 획기적으로 줄이는 것을 목표로 가지고 있으며, 개발자들에게 게을러질 수 있는 권리를 보장하는 것이 목표입니다.</p>
<h2 id="myBatis의-구조"><a href="#myBatis의-구조" class="headerlink" title="myBatis의 구조"></a>myBatis의 구조</h2><p>SqlSessionFactory, SqlSession이라는 두개의 객체를 가지고 있습니다. 기본적으로 mybatis.cfg.xml 파일을 이용해서 DB에 대한 연결 설정과 각각의 mapper를 구성하는 설정으로 구성되어 있습니다.</p>
<p>myBatis에서 DB에 대한 연결을 구성하는 방법은 다음과 같습니다.</p>
<ol>
<li>SqlSessionFactory 구성</li>
<li>SqlSessionFactory를 통한 SqlSession을 구성</li>
<li>SqlSession을 통해 mapper를 구성</li>
</ol>
<p>기본적인 <code>SqlSessionFactory</code>를 정의합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE configuration</span></span><br><span class="line"><span class="meta">        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"</span></span><br><span class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"org.mariadb.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"qwer12#$"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"mappers/bookDao.mapper.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>그리고, 각 Repository의 method에 따른 SQL문을 xml에 정의합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.xyzlast.bookstore.repository.BookDao"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"BookResult"</span> <span class="attr">type</span>=<span class="string">"com.xyzlast.bookstore.entity.Book"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"author"</span> <span class="attr">column</span>=<span class="string">"author"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"publishDate"</span> <span class="attr">column</span>=<span class="string">"publishDate"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"rentUserId"</span> <span class="attr">column</span>=<span class="string">"rentUserId"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"bookStatus"</span> <span class="attr">column</span>=<span class="string">"status"</span> <span class="attr">typeHandler</span>=<span class="string">"org.apache.ibatis.type.EnumOrdinalTypeHandler"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getById"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultMap</span>=<span class="string">"BookResult"</span>&gt;</span></span><br><span class="line">        SELECT * FROM books WHERE id = #&#123;bookId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getAll"</span> <span class="attr">resultMap</span>=<span class="string">"BookResult"</span>&gt;</span></span><br><span class="line">        SELECT * FROM books</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"countAll"</span> <span class="attr">resultType</span>=<span class="string">"int"</span>&gt;</span></span><br><span class="line">        SELECT count(*) FROM books</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"add"</span> <span class="attr">parameterType</span>=<span class="string">"com.xyzlast.bookstore.entity.Book"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyColumn</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">        INSERT INTO books(name, author, publishDate, comment, status, rentUserId)</span><br><span class="line">        VALUES(#&#123;name&#125;, #&#123;author&#125;, #&#123;publishDate&#125;, #&#123;comment&#125;, #&#123;bookStatus.value&#125;, #&#123;rentUserId&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"delete"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span>&gt;</span></span><br><span class="line">        DELETE FROM books WHERE id = #&#123;bookId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteAll"</span>&gt;</span></span><br><span class="line">        DELETE FROM books</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"update"</span> <span class="attr">parameterType</span>=<span class="string">"com.xyzlast.bookstore.entity.Book"</span>&gt;</span></span><br><span class="line">        UPDATE books SET</span><br><span class="line">        name = #&#123;name&#125;, author = #&#123;author&#125;, publishDate=#&#123;publishDate&#125;, status=#&#123;bookStatus.value&#125;, rentUserId=#&#123;rentUserId&#125;, comment = #&#123;comment&#125;</span><br><span class="line">        WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>xml이 모두 준비된 후, 다음과 같은 code pattern으로 처리됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line">SqlSession sqlSession;</span><br><span class="line"><span class="keyword">private</span> BookDao bookDao;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    InputStream is = Resources.getResourceAsStream(<span class="string">"mybatis-config.xml"</span>);</span><br><span class="line">    sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(is);</span><br><span class="line">    sqlSession = sqlSessionFactory.openSession();</span><br><span class="line">    bookDao = sqlSession.getMapper(BookDao.class);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@After</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sqlSession != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sqlSession.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> bookCount = bookDao.countAll();</span><br><span class="line">    assertThat(bookCount).isGreaterThan(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SqlSessionFactory를 통해, SqlSession을 얻어내고 update/delete/insert에 대한 commit을 직접 행하도록 코드를 작성했습니다. 또한 모든 method가 완료되면 반드시 Session을 닫아줘야지만 됩니다.</p>
<h2 id="Spring-myBatis의-이용"><a href="#Spring-myBatis의-이용" class="headerlink" title="Spring-myBatis의 이용"></a>Spring-myBatis의 이용</h2><p>Spring과 myBatis를 연결하기 위해서는 추가 Library가 필요합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.mybatis'</span>, <span class="string">name:</span> <span class="string">'mybatis-spring'</span>, <span class="string">version:</span> <span class="string">'1.3.1'</span></span><br></pre></td></tr></table></figure>
<p>Spring에서 제공하는 <code>@Transaction</code>을 사용하기 위해서, <code>SqlSessionTemplate</code>를 이용합니다. 이는 <code>@Transaction</code>으로 지정된 method내 같은 <code>Session</code>으로 <code>@Transaction</code>이 지정될 수 있도록 만들어줍니다.<br>이를 지정하기 위한 <code>@Configruation</code>은 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(value = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.repository"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookStoreConfig</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">        dataSource.setMaximumPoolSize(<span class="number">10</span>);</span><br><span class="line">        dataSource.setMinimumIdle(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactoryBean <span class="title">sqlSessionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean sqlSessionFactoryBean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        sqlSessionFactoryBean.setDataSource(dataSource());</span><br><span class="line">        sqlSessionFactoryBean.setConfigLocation(context.getResource(<span class="string">"classpath:mybatis-config.xml"</span>));</span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>그리고, <code>BookDaoImpl</code>을 구성해야지 됩니다. <code>BookDaoImpl</code>은 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDaoImpl</span> <span class="keyword">extends</span> <span class="title">SqlSessionDaoSupport</span> <span class="keyword">implements</span> <span class="title">BookDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookDaoImpl</span><span class="params">(SqlSessionFactory sqlSessionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setSqlSessionFactory(sqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSqlSession().getMapper(BookDao.class).countAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSqlSession().getMapper(BookDao.class).getAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSqlSession().getMapper(BookDao.class).getById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSqlSession().insert(<span class="string">"com.xyzlast.bookstore.repository.BookDao.add"</span>, book);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSqlSession().update(<span class="string">"com.xyzlast.bookstore.repository.BookDao.update"</span>, book);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getSqlSession().delete(<span class="string">"com.xyzlast.bookstore.repository.BookDao.delete"</span>, bookId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>재미있는 코드를 하나 발견할 수 있습니다. <code>BookDaoImpl</code>의 생성자는 <code>SqlSessionFactory</code>를 인자로 받게 됩니다. 그런데, <code>SqlSessionFactory</code>를 <code>Bean</code>에 등록하는 코드는 <code>@Configuration</code>에 없습니다. 이건 어떻게 되는 것일까요. 이는 <code>SqlSessionFactoryBean</code>에서 확인할 수 있습니다. <code>SqlSessionFactoryBean</code>의 내부 코드는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlSessionFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">SqlSessionFactory</span>&gt;, <span class="title">InitializingBean</span>, <span class="title">ApplicationListener</span>&lt;<span class="title">ApplicationEvent</span>&gt; </span>&#123;</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>구현된 interface중에 <code>FactoryBean</code>이 있는 것을 보실 수 있습니다. Spring Configuration 내부에 <code>Factory Pattern</code>을 통해서 객체를 얻어내야지 될 필요가 있을 때, <code>FactoryBean</code> interface를 이용해서 구현하면 Spring은 이를 감지하여 <code>Factory Pattern</code>을 통해 객체를 얻어내게 됩니다.</p>
<p>마지막으로, query를 지정하는 방법은 다음 2가지로 볼 수 있습니다. <code>getMapper</code>를 통하거나, xml의 full-name을 기술하는 것. 두 방법 모두를 이용해서 구성이 가능합니다.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>국내에서 가장 많이 사용되는 <code>myBatis</code>를 이용한 DB 접근 방식에 대해서 알아봤습니다. 매우 간편한 설정 및 사용의 편의성, 무엇보다도 java 코드와 sql query간의 명확한 분리가 가장 큰 장점입니다.</p>
<h2 id="HOMEWORK"><a href="#HOMEWORK" class="headerlink" title="HOMEWORK"></a>HOMEWORK</h2><p>기존 코드의 Dao를 모두 <code>myBatis</code>를 이용해서 구성해주시길 바랍니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/java-spring-mybatis/">java, spring, mybatis</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/02/21/07-applicationcontext/"><span>07. ApplicationContext</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/02/21/07-applicationcontext/" rel="bookmark">
        <time class="entry-date published" datetime="2018-02-21T13:44:36.000Z">
          2018-02-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h1><p>Spring에서 ApplicationContext는 IoC, AOP를 설정하는 Container 또는 Configuration이라고 할 수 있습니다.<br>ApplicationContext는</p>
<ul>
<li>bean의 집합</li>
<li>bean에 대한 Map</li>
<li>bean의 life cycle 정의</li>
<li>bean에 대한 정의</li>
<li>AOP에 의한 bean의 확장에 대한 정의</li>
</ul>
<p>를 포함하고 있습니다. ApplicationContext에 대해서 좀 더 깊게 들어가보도록 하겠습니다.</p>
<h2 id="ApplicationContext-interface"><a href="#ApplicationContext-interface" class="headerlink" title="ApplicationContext interface"></a>ApplicationContext interface</h2><p>Application Context는 <code>org.springframework.context.ApplicationContext</code> interface를 상속받은 객체입니다. interface의 정의는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplicationContext</span> <span class="keyword">extends</span> <span class="title">EnvironmentCapable</span>, <span class="title">ListableBeanFactory</span>, <span class="title">HierarchicalBeanFactory</span>,</span></span><br><span class="line"><span class="class">        <span class="title">MessageSource</span>, <span class="title">ApplicationEventPublisher</span>, <span class="title">ResourcePatternResolver</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getId</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">getApplicationName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">getDisplayName</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getStartupDate</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">ApplicationContext <span class="title">getParent</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">AutowireCapableBeanFactory <span class="title">getAutowireCapableBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ApplicationContext는 bean에 대한 집합이라고 했습니다. bean은 일반적으로 POJO class로 구성이 되게 됩니다. bean과 POJO의 정의는 다음과 같습니다.</p>
<h3 id="Java-Bean"><a href="#Java-Bean" class="headerlink" title="Java Bean"></a>Java Bean</h3><p>원 목적은 Servlet에서 Java 객체를 가지고 와서 사용하기 위해서 작성된 객체입니다. <strong>단순한 객체이며, 사용이 편리해야지 된다.</strong> 라는 것을 원칙으로 가지고 있습니다. 특징으로는</p>
<ul>
<li>property를 갖는다. (private 변수와 get/set method를 갖는다.)</li>
<li>serialization이 가능하다.</li>
</ul>
<h3 id="POJO-Plan-Old-Java-Object"><a href="#POJO-Plan-Old-Java-Object" class="headerlink" title="POJO (Plan Old Java Object)"></a>POJO (Plan Old Java Object)</h3><p>POJO 객체는 특정 기술과 Spec에 독립적인 객체로 만들어지는 것을 원칙으로 삼습니다. 자신이 속한 package에 속한 POJO 객체 이외에는 Java의 기본 객체만을 이용해서 작성하는 것이 원칙입니다. 또한, 확장성을 위해 자신이 속한 package의 POJO 객체가 아닌 POJO 객체의 interface를 속성으로 갖는 bean 객체로서 만들어지는 것이 일반적입니다. 지금까지 작성된 Book, User, UserHistory 객체의 경우에 POJO 객체라고 할 수 있습니다.</p>
<p>bean에 대한 집합인 ApplicationContext는 다음과 같은 특징을 갖습니다.</p>
<ul>
<li>bean id, name, alias로 구분이 가능한 bean들의 집합입니다.</li>
<li>life cycle을 갖습니다. (singleton, prototype)</li>
<li>property는 value 또는 다른 bean을 참조합니다.</li>
</ul>
<p>ApplicationContext는 bean들의 집합적인 특징 뿐 아니라, bean들의 loading 도 역시 담당하고 있습니다. ApplicationContext의 정보는 일반적으로 <code>@Configuration</code>과 <code>xml</code>을 이용합니다. 또한 수동으로 ApplicationContext를 구성하는 것 역시 가능합니다.</p>
<p>다음은 <code>StaticApplicationContext</code>을 이용해서 수동으로 ApplicationContext를 구성하는 것을 보여줍니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StaticApplicationContext ac = <span class="keyword">new</span> StaticApplicationContext();</span><br><span class="line">    ac.registerSingleton(<span class="string">"hello1"</span>, Hello.class);</span><br><span class="line">    Hello hello = ac.getBean(<span class="string">"hello1"</span>, Hello.class);</span><br><span class="line">    assertThat(hello).isNotNull();</span><br><span class="line">    Hello hello2 = ac.getBean(<span class="string">"hello1"</span>, Hello.class);</span><br><span class="line">    assertThat(hello).isSameAs(hello2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerApplicationContextWithPrototype</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StaticApplicationContext ac = <span class="keyword">new</span> StaticApplicationContext();</span><br><span class="line">    ac.registerPrototype(<span class="string">"hello1"</span>, Hello.class);</span><br><span class="line">    Hello hello = ac.getBean(<span class="string">"hello1"</span>, Hello.class);</span><br><span class="line">    assertThat(hello).isNotNull();</span><br><span class="line">    Hello hello2 = ac.getBean(<span class="string">"hello1"</span>, Hello.class);</span><br><span class="line">    assertThat(hello).isNotSameAs(hello2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>registerApplicationContext와 registerApplicationContextWithProtytype은 Hello 객체를 <code>Singleton</code> 또는 <code>Prototype</code>으로 등록하게 됩니다. Singleton은 ApplicationContext에 등록된 모든 객체들을 재사용하게 되는데, registerPrototype으로 등록된 객체들은 ApplicationContext에서 얻어낼 때마다 객체를 다시 생성해서 얻어내게 됩니다. 이는 <code>@Configuration</code>으로는 다음과 같이 구성됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(value = <span class="string">"hello1"</span>)</span><br><span class="line"><span class="meta">@Scope</span>(value = BeanDefinition.SCOPE_SINGLETON)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Hello <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Hello();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span>(value = <span class="string">"hello2"</span>)</span><br><span class="line"><span class="meta">@Scope</span>(value = BeanDefinition.SCOPE_PROTOTYPE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Hello <span class="title">hello1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Hello();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드는 다음 xml로 표현이 가능합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"hello1"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.ac.Hello"</span> <span class="attr">scope</span>=<span class="string">"singleton"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"hello2"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.ac.Hello"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="ApplicationContext에서-Bean의-등록-방법"><a href="#ApplicationContext에서-Bean의-등록-방법" class="headerlink" title="ApplicationContext에서 Bean의 등록 방법"></a>ApplicationContext에서 Bean의 등록 방법</h2><h3 id="annotation-을-이용하는-경우-singleton-prototype"><a href="#annotation-을-이용하는-경우-singleton-prototype" class="headerlink" title="annotation 을 이용하는 경우 - singleton/prototype"></a>annotation 을 이용하는 경우 - singleton/prototype</h3><p>주로 사용되는 방법입니다. <code>@Component</code>, <code>@Service</code>로 선언된 Bean들을 <code>@ComponentScan</code>을 통해서 검색해서 등록합니다.<br>이 때, 다음 두가지를 설정할 수 있습니다.</p>
<ul>
<li>객체의 LifeCycle: <code>@Scope</code>를 통해 <code>singleton/prototype</code>을 설정 가능합니다.</li>
<li>초기 실행 method: <code>@PostConstruct</code>를 통해 객체의 생성 이후에 실행할 method를 지정할 수 있습니다.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostConstruct</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//<span class="doctag">NOTE:</span> init method.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ApplicationContext에서의-FactoryPattern-이용"><a href="#ApplicationContext에서의-FactoryPattern-이용" class="headerlink" title="ApplicationContext에서의 FactoryPattern 이용"></a>ApplicationContext에서의 FactoryPattern 이용</h3><p>객체를 생성할 때, 무언가 초기화를 해줘야지 되는 경우가 왕왕 있습니다. <code>@PostConstruct</code>와 같이 단순하게 처리되는 경우도 있지만, 값을 설정하거나, TCP connection을 만들어주거나 하는 등의 초기 구성을 해줘야지 되는 경우가 꽤 있지요. 이때 주로 사용되는 것이 <code>Factory Pattern</code>입니다. <code>ApplicationContext</code>에서는 <code>FactoryBean&lt;T&gt;</code>을 통해 Factory Pattern을 지원합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FactoryBean</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  <span class="function">T <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Nullable</span></span><br><span class="line">  Class&lt;?&gt; getObjectType();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이와 같은 inteface를 구현한 객체는 <code>Hello</code>의 경우 다음과 같이 구성될 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloFactoryBean</span> <span class="keyword">implements</span> <span class="title">FactoryBean</span>&lt;<span class="title">Hello</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Hello <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Hello hello = <span class="keyword">new</span> Hello();</span><br><span class="line">    <span class="keyword">return</span> hello;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">    <span class="keyword">return</span> Hello.class;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 이 코드를 <code>@Configuration</code>에 등록시켜줍니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DomainConfiguration</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> HelloFactoryBean <span class="title">helloFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HelloFactoryBean();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이렇게 등록된 <code>ApplicationContext</code>의 경우에는 다음 2개의 객체를 얻어낼 수 있습니다.</p>
<ul>
<li>HelloFactoryBean</li>
<li>Hello</li>
</ul>
<p>객체의 이름 그대로 <code>Factory pattern</code>을 사용해서 <code>Bean</code>을 얻어낼 수 있도록 지원합니다.</p>
<h2 id="ApplicationContext의-등록방법"><a href="#ApplicationContext의-등록방법" class="headerlink" title="ApplicationContext의 등록방법"></a>ApplicationContext의 등록방법</h2><p>applicationContext 의 등록방법은 spring에서 계속해서 발전되어가는 분야중 하나입니다. 총 3가지의 방법으로 나눌 수 있으며, 이 방법들은 같이 사용되는 것도 가능합니다.</p>
<h3 id="applicationContext-xml만을-이용-전체-Bean을-모두-각각-등록하는-방법"><a href="#applicationContext-xml만을-이용-전체-Bean을-모두-각각-등록하는-방법" class="headerlink" title="applicationContext.xml만을 이용, 전체 Bean을 모두 각각 등록하는 방법"></a>applicationContext.xml만을 이용, 전체 Bean을 모두 각각 등록하는 방법</h3><p>bookDao를 이용할 때, 처음 사용한 방법입니다. bean을 선언하고, id값을 이용해서 사용하는 방법으로 이 방법은 가장 오랫동안 사용해왔기 때문에 많은 reference들이 존재합니다. 그렇지만, 객체가 많아질수록 파일의 길이가 너무나 길어지고 관리가 힘들어지는 단점 때문에 요즘은 잘 사용되지 않습니다.</p>
<h3 id="annotation과-aplicationContext-xml을-이용하는-방법"><a href="#annotation과-aplicationContext-xml을-이용하는-방법" class="headerlink" title="@annotation과 aplicationContext.xml을 이용하는 방법"></a>@annotation과 aplicationContext.xml을 이용하는 방법</h3><p>@Component, @Repository, @Service, @Controller, @Value 등을 사용하고, component-scan 을 이용해서 applicationContext.xml에서 등록하는 방법입니다. 이 방법은 예전에 가장 많이 사용되었던 방법입니다. applicationContext.xml의 길이가 적당히 길고, 구성하기 편하다는 장점을 가지고 있습니다.</p>
<h3 id="Configuration을-이용한-applicationContext-객체를-이용하는-방법"><a href="#Configuration을-이용한-applicationContext-객체를-이용하는-방법" class="headerlink" title="@Configuration을 이용한 applicationContext 객체를 이용하는 방법"></a>@Configuration을 이용한 applicationContext 객체를 이용하는 방법</h3><p>Spring에서 근간에 밀고 있는 방법입니다. 이 방법은 다음과 같은 장점을 가지고 있습니다.</p>
<ul>
<li>이해하기 쉽습니다. - xml에 비해서 사용하기 쉽습니다.</li>
<li>복잡한 Bean 설정이나 초기화 작업을 손쉽게 적용할 수 있습니다. - 프로그래밍 적으로 만들기 때문에, 개발자가 다룰수 있는 영역이 늘어납니다.</li>
<li>작성 속도가 빠릅니다. - eclipse에서 java coding 하는것과 동일하게 작성하기 때문에 작성이 용의합니다.</li>
</ul>
<p>개인적으로는 2, 3번 방법을 모두 알아둬야지 된다고 생각합니다. 이유는 2번 방법의 경우, 기존에 가장 많이 사용되었던 방법입니다. legacy 코드에 대한 지원을 하기 위해서는 이 방법을 다룰줄 알아야지 됩니다. 최근은 당연히 3번 방법입니다. 최근에는 <code>xml</code>을 사용하는 예시조차 찾기 힘들정도로 3번 방법으로 집중되어가는 중입니다.</p>
<p>그럼, 이 3가지 방법을 모두 이용해서 기존의 BookStore를 등록하는 applicationContext를 한번 살펴보도록 하겠습니다.</p>
<h3 id="applicationContext-xml만을-이용하는-방법"><a href="#applicationContext-xml만을-이용하는-방법" class="headerlink" title="applicationContext.xml만을 이용하는 방법"></a>applicationContext.xml만을 이용하는 방법</h3><p>초기 Spring 2.5 이하 버젼에서 지원하던 방법입니다. 일명 xml 지옥이라고 불리우는 어마어마한 xml을 자랑했습니다. 최종적으로 만들어져 있는 applicationContext.xml의 구성은 다음과 같습니다. Transaction annotation이 적용되지 않기 때문에, Transaction에 대한 AOP code 까지 추가되는 엄청나게 긴 xml을 보여주고 있습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.2.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jdbcTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.core.JdbcTemplate"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.jolbox.bonecp.BoneCPDataSource"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.driver&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.url&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.username&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.password&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idleConnectionTestPeriodInMinutes"</span> <span class="attr">value</span>=<span class="string">"60"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idleMaxAgeInMinutes"</span> <span class="attr">value</span>=<span class="string">"240"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxConnectionsPerPartition"</span> <span class="attr">value</span>=<span class="string">"30"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minConnectionsPerPartition"</span> <span class="attr">value</span>=<span class="string">"10"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"partitionCount"</span> <span class="attr">value</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"acquireIncrement"</span> <span class="attr">value</span>=<span class="string">"5"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"statementsCacheSize"</span> <span class="attr">value</span>=<span class="string">"100"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"releaseHelperThreads"</span> <span class="attr">value</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:spring.properties"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"bookDao"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.bookstore02.dao.BookDaoImpl"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcTemplate"</span> <span class="attr">ref</span>=<span class="string">"jdbcTemplate"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userDao"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.bookstore02.dao.UserDaoImpl"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcTemplate"</span> <span class="attr">ref</span>=<span class="string">"jdbcTemplate"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"historyDao"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.bookstore02.dao.HistoryDaoImpl"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcTemplate"</span> <span class="attr">ref</span>=<span class="string">"jdbcTemplate"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userService"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.bookstore02.services.UserServiceImpl"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"bookDao"</span> <span class="attr">ref</span>=<span class="string">"bookDao"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"userDao"</span> <span class="attr">ref</span>=<span class="string">"userDao"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"historyDao"</span> <span class="attr">ref</span>=<span class="string">"historyDao"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"bookService"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.bookstore02.services.HistoryServiceImpl"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"bookDao"</span> <span class="attr">ref</span>=<span class="string">"bookDao"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"userDao"</span> <span class="attr">ref</span>=<span class="string">"userDao"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"historyDao"</span> <span class="attr">ref</span>=<span class="string">"historyDao"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManagerAdvisor"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.bookstore02.utils.TransactionAdvisor"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"transactionManager"</span> <span class="attr">ref</span>=<span class="string">"transactionManager"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">"org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"beanNames"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>userService<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>bookService<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"interceptorNames"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>transactionManagerAdvisor<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="annotation-applicationContext-xml을-이용한-방법"><a href="#annotation-applicationContext-xml을-이용한-방법" class="headerlink" title="@annotation + applicationContext.xml을 이용한 방법"></a>@annotation + applicationContext.xml을 이용한 방법</h3><p>@Repository, @Component, @Service를 이용해서 편한 방법을 제공합니다. 특히 component-scan과 @Autowired를 이용하면 위 applicationContext.xml을 효과적으로 줄일 수 있습니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.2.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jdbcTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.core.JdbcTemplate"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.jolbox.bonecp.BoneCPDataSource"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.driver&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.url&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.username&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;connect.password&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idleConnectionTestPeriodInMinutes"</span> <span class="attr">value</span>=<span class="string">"60"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idleMaxAgeInMinutes"</span> <span class="attr">value</span>=<span class="string">"240"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxConnectionsPerPartition"</span> <span class="attr">value</span>=<span class="string">"30"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minConnectionsPerPartition"</span> <span class="attr">value</span>=<span class="string">"10"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"partitionCount"</span> <span class="attr">value</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"acquireIncrement"</span> <span class="attr">value</span>=<span class="string">"5"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"statementsCacheSize"</span> <span class="attr">value</span>=<span class="string">"100"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"releaseHelperThreads"</span> <span class="attr">value</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:spring.properties"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.xyzlast.bookstore02.dao"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.xyzlast.bookstore02.services"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="annotation-Configuration을-이용한-방법"><a href="#annotation-Configuration을-이용한-방법" class="headerlink" title="@annotation + @Configuration을 이용한 방법"></a>@annotation + @Configuration을 이용한 방법</h3><p>이 방법은 xml을 아애 없애버릴 수 있습니다. xml이 제거된 ApplicationContext의 내용은 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@PropertySource</span>(<span class="string">"classpath:spring.properties"</span>)</span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;<span class="string">"com.xyzlast.bookstore02.dao"</span>, <span class="string">"com.xyzlast.bookstore02.services"</span>&#125;)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Environment env;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PropertySourcesPlaceholderConfigurer <span class="title">propertySourcesPlaceholderConfigurer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        PropertySourcesPlaceholderConfigurer configHolder = <span class="keyword">new</span> PropertySourcesPlaceholderConfigurer();</span><br><span class="line">        <span class="keyword">return</span> configHolder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BoneCPDataSource dataSource = <span class="keyword">new</span> BoneCPDataSource();</span><br><span class="line">        dataSource.setUsername(env.getProperty(<span class="string">"connect.username"</span>));</span><br><span class="line">        dataSource.setPassword(env.getProperty(<span class="string">"connect.password"</span>));</span><br><span class="line">        dataSource.setDriverClass(env.getProperty(<span class="string">"connect.driver"</span>));</span><br><span class="line">        dataSource.setJdbcUrl(env.getProperty(<span class="string">"connect.url"</span>));</span><br><span class="line">        dataSource.setMaxConnectionsPerPartition(<span class="number">20</span>);</span><br><span class="line">        dataSource.setMinConnectionsPerPartition(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JdbcTemplate template = <span class="keyword">new</span> JdbcTemplate();</span><br><span class="line">        template.setDataSource(dataSource());</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DataSourceTransactionManager transactionManager = <span class="keyword">new</span> DataSourceTransactionManager(dataSource());</span><br><span class="line">        <span class="keyword">return</span> transactionManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>지금까지 작성하던 xml과는 완전히 다른 모습의 ApplicationContext입니다. ApplicationContext Config 객체는 다음과 같은 특성을 갖습니다.</p>
<ul>
<li>@Configuration annotation을 갖는다.</li>
<li>bean으로 등록되는 객체는 method로 관리되고, @Bean annotation을 갖습니다.</li>
<li>method의 이름이 <code>&lt;bean id=&quot;&quot;&gt;</code>값과 매칭됩니다.</li>
<li>component-scan, property-place-holder의 경우, class의 annotation으로 갖습니다.</li>
<li>@EnableTransactionManagement와 같이 @Enable** 로 시작되는 annotation을 이용해서 전역 annotation을 구성합니다.</li>
<li>Properties 파일을 사용하기 위해서는 반드시 static method로 PropertySourcesPlaceholderConfigurer를 return 시켜줘야지 됩니다.</li>
</ul>
<h3 id="xml-annotation-Configuration을-이용한-방법"><a href="#xml-annotation-Configuration을-이용한-방법" class="headerlink" title="xml + @annotation + @Configuration을 이용한 방법"></a>xml + @annotation + @Configuration을 이용한 방법</h3><p>위에서는 3가지 방법이라고 했지만, 한가지 방법이 더 있습니다. 모두를 다 섞어서 사용하는 방법입니다. 기본은 <code>@Configuration</code>에서 시작합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ImportResource</span>(<span class="string">"classpath:/config/spring.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>용도에 따라, 다른 <code>@Configuration</code>을 결합해서 사용할 필요도 있습니다. 다음과 같이 확장이 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Import</span>(&#123; AppConfigWeb.class &#125;)</span><br><span class="line"><span class="meta">@ImportResource</span>(<span class="string">"classpath:/config/spring.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Summay"><a href="#Summay" class="headerlink" title="Summay"></a>Summay</h2><p>ApplicationContext에 대한 기본 개념을 정리해봤습니다. ApplicationContext는 Spring의 핵심 기능입니다. DI를 통한 IoC를 가능하게 하고, AOP에 대한 설정 등 모든 Spring에서 하는 일이 설정되어 있는 것이 ApplicaionContext라고 할 수 있습니다. 이에 대한 설정 및 구성을 명확하게 알아놓을 필요가 있습니다. 그리고, 내부에서 어떤 일을 해서 Spring에서 하는 이런 일들이 가능하게 되는지에 대한 이해가 필요합니다. 마지막으로 ApplicationContext를 구성하는 방법에 대해서 알아봤습니다. 제공되는 3가지 방법에 대해 자유자재로 사용할 수 있는 능력이 필요합니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/java-spring/">java, spring</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/02/08/aop/"><span>06.AOP</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/02/08/aop/" rel="bookmark">
        <time class="entry-date published" datetime="2018-02-07T23:21:07.000Z">
          2018-02-08
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h1><p>지금까지 구성된 테스트 코드의 마지막에 코드를 하나 추가해보도록 하겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rentTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    UserService userService = applicationContext.getBean(UserService.class);</span><br><span class="line">    UserDao userDao = applicationContext.getBean(UserDao.class);</span><br><span class="line">    BookDao bookDao = applicationContext.getBean(BookDao.class);</span><br><span class="line">    User user = userDao.getAll().get(<span class="number">0</span>);</span><br><span class="line">    Book book = bookDao.getAll().get(<span class="number">0</span>);</span><br><span class="line">    book.setBookStatus(BookStatus.CanRent);</span><br><span class="line">    book.setRentUserId(<span class="keyword">null</span>);</span><br><span class="line">    bookDao.update(book);</span><br><span class="line"></span><br><span class="line">    assertThat(userService.rent(user.getId(), book.getId())).isTrue();</span><br><span class="line">    assertThat(userService).isInstanceOf(UserServiceImpl.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>실행해보면 테스트 오류가 발생되는 것을 볼 수 있습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">java.lang.AssertionError:</span></span><br><span class="line"><span class="function"><span class="title">Expecting</span>:</span></span><br><span class="line"><span class="function">  &lt;<span class="title">com.xyzlast.bookstore.service.UserServiceImpl</span>@7<span class="title">bbc8656</span>&gt;</span></span><br><span class="line"><span class="function"><span class="title">to</span> <span class="title">be</span> <span class="title">an</span> <span class="title">instance</span> <span class="title">of</span>:</span></span><br><span class="line"><span class="function">  &lt;<span class="title">com.xyzlast.bookstore.service.UserServiceImpl</span>&gt;</span></span><br><span class="line"><span class="function"><span class="title">but</span> <span class="title">was</span> <span class="title">instance</span> <span class="title">of</span>:</span></span><br><span class="line"><span class="function">  &lt;<span class="title">com.sun.proxy</span>.$<span class="title">Proxy31</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>그럼 기존의 <code>@Transactional</code>을 제거한 후, 테스트를 돌리면 테스트오류가 발생되지 않습니다. 처음보는 객체이름이 보입니다. 거기에 이제는 최대한 사용하지 말라고 되어 있는 <code>com.sun</code> package의 객체입니다. 어떻게 이런 일이 발생하게 되는지 알아보도록 하겠습니다.</p>
<p>이 부분을 이해하기 위해서는 Spring의 이제 2번째 개념인 AOP에 대한 이해가 필요합니다. AOP에 대한 설명을 하기 위해 기존 <code>PlatformTransactionManager</code>를 사용한 코드를 먼저 참고합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">    TransactionStatus status = transactionManager.getTransaction(<span class="keyword">new</span> DefaultTransactionDefinition());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        User user = userDao.get(userId);</span><br><span class="line">        Book book = bookDao.get(bookId);</span><br><span class="line"></span><br><span class="line">        book.setRentUserId(user.getId());</span><br><span class="line">        book.setStatus(BookStatus.RentNow);</span><br><span class="line">        bookDao.update(book);</span><br><span class="line"></span><br><span class="line">        user.setPoint(user.getPoint() + <span class="number">10</span>);</span><br><span class="line">        user.setLevel(userLevelLocator.getUserLevel(user.getPoint()));</span><br><span class="line"></span><br><span class="line">        UserHistory history = <span class="keyword">new</span> UserHistory();</span><br><span class="line">        history.setUserId(userId);</span><br><span class="line">        history.setBookId(book.getId());</span><br><span class="line">        history.setAction(HistoryActionType.RENT);</span><br><span class="line"></span><br><span class="line">        userDao.update(user);</span><br><span class="line">        userHistoryDao.add(history);</span><br><span class="line">        <span class="keyword">this</span>.transactionManager.commit(status);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">        <span class="keyword">this</span>.transactionManager.rollback(status);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드를 보면 Transaction의 경계설정 코드와 BL 코드가 복잡하고 연결이 되어있는것 같이 보이지만, 명확하게 코드는 분리가 될 수 있습니다. transactionManager를 사용하는 코드와 BL 코드로 분리가 깔끔하게 가능합니다. 여기서 전에 사용한 Template-callback 으로 변경시키는 것 역시 쉽게 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> userId, <span class="keyword">final</span> <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">    doBLWithTransaction(<span class="keyword">new</span> BusinessLogic() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            User user = userDao.get(userId);</span><br><span class="line">            Book book = bookDao.get(bookId);</span><br><span class="line"></span><br><span class="line">            book.setRentUserId(user.getId());</span><br><span class="line">            book.setStatus(BookStatus.RentNow);</span><br><span class="line">            bookDao.update(book);</span><br><span class="line"></span><br><span class="line">            user.setPoint(user.getPoint() + <span class="number">10</span>);</span><br><span class="line">            user.setLevel(userLevelLocator.getUserLevel(user.getPoint()));</span><br><span class="line"></span><br><span class="line">            UserHistory history = <span class="keyword">new</span> UserHistory();</span><br><span class="line">            history.setUserId(userId);</span><br><span class="line">            history.setBookId(book.getId());</span><br><span class="line">            history.setAction(HistoryActionType.RENT);</span><br><span class="line"></span><br><span class="line">            userDao.update(user);</span><br><span class="line">            userHistoryDao.add(history);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">BusinessLogic</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doProcess</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doBLWithTransaction</span><span class="params">(BusinessLogic loc)</span> </span>&#123;</span><br><span class="line">    TransactionStatus status = transactionManager.getTransaction(<span class="keyword">new</span> DefaultTransactionDefinition());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        loc.doProcess();</span><br><span class="line">        <span class="keyword">this</span>.transactionManager.commit(status);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">        <span class="keyword">this</span>.transactionManager.rollback(status);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>그런데, 이와 같은 코드는 지금까지 만들어진 <code>Repository Pattern</code>과 조금 다른 경계를 갖습니다.  DB에 대한 내용은 Repository측으로, BL측은 Service로 분리가 되어 있던 것이, Transaction에 대한 코드가 BL과 같이 있으면서 OOP의 기본 원칙인 <code>단일책임원칙</code>이 어긋나기 시작합니다. 그리고, 이런 코드는 계속되는 반복에 의해서 만들어지기 때문에 코드를 관리하는데 조금 복잡해보이는것이 사실입니다. 이와 같이 분리된 코드를 도식화 하면 다음과 같습니다.</p>
<p><img src="/images/aop/01.jpg" alt=""></p>
<p>그렇다면, Transaction에 대한 코드를 아애 분리하는 방법을 생각해볼 수 있습니다. BL과 Transaction을 아애 분리시키고, BL을 사용하는 측에서는 Transaction을 사용하는 객체를 사용하는 것입니다. 다음은 분리된 Transaction 코드 패턴을 볼 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceTx</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    PlatformTransactionManager transactionManager;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userServiceImpl;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">BusinessLogic</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">doProcess</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doBLWithTransaction</span><span class="params">(BusinessLogic loc)</span> </span>&#123;</span><br><span class="line">        TransactionStatus status = transactionManager.getTransaction(<span class="keyword">new</span> DefaultTransactionDefinition());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            loc.doProcess();</span><br><span class="line">            <span class="keyword">this</span>.transactionManager.commit(status);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">            <span class="keyword">this</span>.transactionManager.rollback(status);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> userId, <span class="keyword">final</span> <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">        doBLWithTransaction(<span class="keyword">new</span> BusinessLogic() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                userService.rent(userId, bookId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드는 실제 구현된 <code>UserServiceImpl</code>을 한번 더 감싼 <code>UserServiceTx</code>를 또 만들어서 사용하는 것입니다. <code>UserServiceTx</code>를 사용하는 측에서 보면 다음과 같이 실행되게 됩니다.</p>
<p><img src="/images/aop/02.jpg" alt=""></p>
<p>이와 같은 개발 패턴을 proxy pattern이라고 합니다. proxy pattern의 정의는 다음과 같습니다.</p>
<p><strong>Proxy패턴은 object를 호출할 때, 부가적인 처리를 실행할 수 있도록 하기 위한 패턴입니다. 이와 동시에 그 오브젝트의 이용자(클라이언트)에 대한 변경을 최소화할 수도 있다. Proxy 패턴을 잘 사용한다면, 어플리케이션의 사용편리성을 향상시키는데 이용됩니다.</strong></p>
<p>말이 어렵습니다. 간단히 말을 풀면, UserService를 실행하는 Test 객체 입장에선 UserServiceImpl을 실행을 하나, UserServiceTx를 실행하나 동일한 interface를 실행하게 됩니다.  동일한 Interface로 접근을 하되, 다른 객체를 통해서 원 객체를 접근하게 만드는 방식을 Proxy pattern 이라고 합니다.</p>
<p>또한, Proxy pattern은 거의 또 다른 pattern을 동시에 실행하게 됩니다. 그건 decorate pattern 입니다. decorate patten의 정의는 다음과 같습니다.</p>
<p><strong>기능의 ‘장식’(Decorator)이라는 개념을 클래스로 만들어 분화시킨 후, 이를 기존 객체가 참조하는 형태로 덧붙여나갈 수 있게 한다. Decorator와 꾸미는 대상이 되는 클래스는 같은 기반 클래스를 상속받는다. 그리고 두 클래스 모두 새로운Decorator 객체를 참조할 수 있는 구조로 만든다.</strong></p>
<p>말이 더 어렵습니다. decorate pattern은 동일한 interface에 접근되는 객체에 새로운 기능이 추가되는 것을 decorate pattern이라고 합니다. proxy pattern과 decorate pattern은 매우 헛갈리면서 같이 사용이 되는 것이 일반적입니다. 접근되는 객체에 대한 관점은 proxy pattern이라고 생각하시면 되고, decorate pattern은 접근된 기능에 추가 기능을 같이 실행시키는 것을 의미합니다.</p>
<p>위 객체를 다시 설명을 하면, UserServiceTx라는 Proxy를 만들어서 UserServiceImpl에 접근을 하게 되고, UserServiceTx는 decorate pattern을 이용해서 transaction 기능을 추가하고 있습니다.</p>
<p>최종적으로, Spring의 @Transaction 역시 Proxy Pattern과 Decorate Pattern이 결합된 형태로 구성되어 있습니다. Transaction 기능을 추가하기 위해서 Decorate Pattern으로 기능이 추가 되어 있으며, 실 객체가 아닌 (예제에서는 UserServiceImpl) Decorate가 추가된 객체에 접근하도록 객체의 접근을 제어한 Proxy Pattern이 결합되어 있습니다. 이 부분을 구현하는 Java의 기본 코드 구조를 Dynamic Proxy라고 합니다.</p>
<h2 id="Dynamic-Proxy"><a href="#Dynamic-Proxy" class="headerlink" title="Dynamic Proxy"></a>Dynamic Proxy</h2><p>이러한 Proxy 객체를 어떻게 만들어주게 되는 걸까요? 지금 저희 코드는 UserServiceTx라는 Proxy를 작성해줬습니다. Spring과 같은 Framework는 범용적이며, 가변적인 Proxy를 만드는 방법들을 가지고 있습니다. 가장 대표적인 것은 reflection입니다. Spring은 기본적으로 reflection을 통해서 이 부분을 처리합니다. 이 부분에 대해서 좀 더 깊게 들어가보도록 하겠습니다. 먼저 간단한 Relection 코드를 확인해보도록 하겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doDynamicReflection</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String name = <span class="string">"ykyoon"</span>;</span><br><span class="line">    Method lengthMethhod = String.class.getMethod(<span class="string">"length"</span>);</span><br><span class="line">    Object invokeResult = lengthMethhod.invoke(name);</span><br><span class="line">    assertThat(invokeResult).isInstanceOf(Integer.class).isEqualTo(<span class="number">6</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드를 보시면 좀 재미있는 내용들이 보이게 됩니다. String 객체의 length method를 문자열로 mehtod의 이름을 이용해서 호출할 수 있는 것을 확인할 수 있는데요.<br>java의 Method object는 각 객체의 method에 대한 정의를 갖는 객체입니다. 이를 이용해서 dynamic한 method 호출을 할 수 있지요. 이제 본격적인 Relection 코드를 확인해보도록 하겠습니다.</p>
<p>Dynamic Proxy에 대해서 깊게 알아보기 위해서 가장 먼저 알아봐야지 될 내용은  InvocationHandler interface입니다. InvocationHandler는 Proxy.newInstance에서 새로운 객체를 만들고, 그 객체에 Proxy를 통해서 접근하는 방식을 제공하는 interface입니다.</p>
<p>한번 예시를 사용해보도록 하겠습니다. InvocationHandler를 이용해서 객체의 모든 String output을 대문자로 자동으로 변경시키는 Proxy를 만들어보도록 하겠습니다.</p>
<p>먼저, Proxy의 target이 되는 interface와 객체입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">sayHello</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">sayHi</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">sayThankYou</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloImpl</span> <span class="keyword">implements</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello "</span> + name + <span class="string">"!!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHi</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hi "</span> + name + <span class="string">"!!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayThankYou</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Thank you. "</span> + name + <span class="string">"!!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>그리고, 모든 output을 UpperCast로 변경시키는 InvocationHandler를 구성하도록 하겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UppercaseHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UppercaseHandler</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        String ret = (String) method.invoke(<span class="keyword">this</span>.target, args);</span><br><span class="line">        <span class="keyword">return</span> ret.toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>코드는 매우 단순합니다.</p>
<p>그리고, Hello interface를 통해서 HelloImpl로 접근하는 Proxy 객체를 만들어보도록 하겠습니다.  HelloImpl에 대한 test 를 작성해서 다음 코드를 실행해보면 다음 결과를 얻어낼 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">helloWorldReflection</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Hello proxiedHello = (Hello) Proxy.newProxyInstance(getClass().getClassLoader(),</span><br><span class="line">        <span class="keyword">new</span> Class[] &#123; Hello.class&#125;,</span><br><span class="line">        <span class="keyword">new</span> UppercaseHandler(<span class="keyword">new</span> HelloImpl()));</span><br><span class="line"></span><br><span class="line">    String output = proxiedHello.sayHello(<span class="string">"ykyoon"</span>);</span><br><span class="line">    System.out.println(<span class="string">"Output은 다음과 같습니다. : "</span> + output);</span><br><span class="line">    System.out.println(<span class="string">"Proxy의 이름은 다음과 같습니다. : "</span> + proxiedHello.getClass().getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">com.intellij.rt.execution.junit.JUnitStarter -ideVersion5 -junit4 com.xyzlast.bookstore.aop.ReflectionTest,helloWorldReflection</span><br><span class="line">Output은 다음과 같습니다. : HELLO YKYOON!!</span><br><span class="line">Proxy의 이름은 다음과 같습니다. : com.sun.proxy.$Proxy4</span><br></pre></td></tr></table></figure>
<p>Spring에서 @Transaction에서 보시던 결과가 나왔습니다. Spring에서 @Transaction은 다음과 같은 코드로 구성되어 있습니다.  (Sudo code입니다.)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringTransactionProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object targetService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PlatformTransactionManager transactionManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpringTransactionProxy</span><span class="params">(Object targetService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.targetService = targetService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        TransactionStatus status = transactionManager.beginTransaction(<span class="keyword">new</span> DefaultTransaction());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            method.invoke(<span class="keyword">this</span>.targetService, args);</span><br><span class="line">            transactionManager.commit(status);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">            transactionManager.rollback(status);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>잘 보시면, 기존의 template-callback pattern과 유사한 코드가 만들어집니다. 단, 구현 방법이 InvocationHandler를 이용한 Proxy객체를 만들어서, 그 객체를 통해 method의 전/후에 특정한 action을 집어 넣고 있는 방식을 사용하고 있는 것입니다. 이렇게 method의 전/후에 특정 action을 삽입하는 개발 방법을 AOP(aspect oriented programming)라고 합니다.</p>
<h2 id="Spring에서의-AOP-이용"><a href="#Spring에서의-AOP-이용" class="headerlink" title="Spring에서의 AOP 이용"></a>Spring에서의 AOP 이용</h2><p>AOP는 Transaction 뿐 아니라, 다른 method들에서도 이와 같은 Decorate와 Proxy patten들을 사용할 수 있는 멋진 방법들을 제공합니다. 지금까지 보던 Transaction에 대한 코드를 보시면 Transaction의 대상이 되는 method의 전/후에 transaction.begin() / commit()이 실행되고 있습니다. 좀더 이것을 발전시킨다면 특정 method가 시작되기 전에, 또는 method가 실행 된 후에,아니면 method에서 exception이 발생한 후에 수행되는 특정 InvocationHandler를 지정해주는 것도 가능하지 않을까? 라는 의문이 생깁니다. 이러한 개발 방법을 이용하면, 지금까지 공부해왔던 OOP에 대한 다른 개념으로 발전하게 됩니다.</p>
<p>OOP를 공부하면 가장 많이 나오는 말은 상속 그리고 구현입니다. extends, implements에 대한 이야기들이 대부분이지요. 이는 object의 종적인 연결관계를 나타냅니다. 그렇지만, 이와 같이 method의 횡적인 연결관계에 대한 논의입니다. OOP와는 조금 다른 부분의 이야기라고 생각합니다.</p>
<p><img src="/images/aop/03.jpg" alt=""></p>
<p>이러한 개념은 여러 곳에서 사용될 수 있습니다. 예를 들어…</p>
<ul>
<li>사용자의 권한 체크</li>
<li>In/Out에 대한 로그 기능</li>
<li>Return값에 특정한 값이 있는 경우에 공통되는 Action을 해야지 되는 경우</li>
<li>Transaction과 같은 method의 실행에 있어서 전/후 처리를 해줘야지 될때</li>
<li>Return값에 특정한 데이터 양식을 추가해야지 될 때</li>
<li>Exception의 처리</li>
</ul>
<p>제가 생각하는 기능들은 이정도인데, 다른 분들은 어떤 기능을 추가할 수 있을까요?</p>
<p>AOP의 확장은 거의 무한대에 가깝습니다. 기존의 OOP 적 사고방식을 크게 확장시킬 수 있는 개념이기도 하면서, 기존의 OOP의 설계를 무너트릴수도 있는 개념입니다. OOP는 종적, AOP는 횡적 객체의 확장이다. 라고 이해를 하시고 다음 용어들을 이해하시면 좀 더 이해가 편할 것 같습니다.</p>
<h3 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h3><p>AOP의 Target이 되는 객체입니다. 지금까지 만들었던 Service객체 또는 HelloImpl과 같이 직접 AOP 당하는 객체를 Target이라고 합니다.</p>
<h3 id="Advice"><a href="#Advice" class="headerlink" title="Advice"></a>Advice</h3><p>위에 구성된 InvocationHandler에 의해서 사용될 interface가 구현된 객체입니다. 다른 객체에 추가적인 action을 확장시키기 위한 객체입니다. Spring은 총 3개의 Advice interface를 제공하고 있습니다. 아래의 interface를 상속받아 Advice를 구성합니다.</p>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>MethodBeforeAdvice</td>
<td>method가 실행되기 전에 실행되는 Advicer를 구성합니다.</td>
</tr>
<tr>
<td>AfterReturningAdvice</td>
<td>method가 실행 후, return 값을 보내기 직전에 실행되는 Advicer를 구성합니다.</td>
</tr>
<tr>
<td>MethodInterceptor</td>
<td>method의 전/후 모두에 실행 가능한 Advicer를 구성합니다.</td>
</tr>
</tbody>
</table>
<h3 id="Pointcut"><a href="#Pointcut" class="headerlink" title="Pointcut"></a>Pointcut</h3><p>Advice를 적용할 Point를 선별하는 작업을 하는 객체를 말합니다. Spring에서는 @Transactional이 적용된 모든 method에 대한 Transaction Advice의 Pointcut은</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>으로 선언되고 있습니다.</p>
<h3 id="Advisor"><a href="#Advisor" class="headerlink" title="Advisor"></a>Advisor</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Advisor = Advice + PointCut</span><br></pre></td></tr></table></figure>
<p>이라고 생각하시면 됩니다. 부가기능 + 적용대상이 반영된 interface라고 하면 설명이 좀더 쉽습니다.<br>이제 Spring에서 AOP를 다른 method에 적용해보도록 하겠습니다.</p>
<p>간단히 <code>AfterReturningAdvice</code>를 <code>UserService</code>에 적용하는 설정은 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceMethodAdvice</span> <span class="keyword">implements</span> <span class="title">AfterReturningAdvice</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">(Object returnValue, Method method, Object[] args, Object target)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(method.getName() + <span class="string">" is called"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Advice</code>를 선언한 후, 이제 <code>PointCut</code>과 <code>Target</code>을 섞어서 선언해줍니다. 이는 <code>@Configuration</code>에서 설정합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BeanNameAutoProxyCreator <span class="title">beanNameAutoProxyCreator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BeanNameAutoProxyCreator beanNameAutoProxyCreator = <span class="keyword">new</span> BeanNameAutoProxyCreator();</span><br><span class="line">    beanNameAutoProxyCreator.setBeanNames(<span class="string">"userServiceImpl"</span>);</span><br><span class="line">    beanNameAutoProxyCreator.setInterceptorNames(<span class="string">"methodInterceptor"</span>);</span><br><span class="line">    <span class="keyword">return</span> beanNameAutoProxyCreator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span>(value = <span class="string">"methodInterceptor"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ServiceMethodAdvice <span class="title">methodInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ServiceMethodAdvice();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>구성되어 있는 <code>AOP</code>는 객체중심으로 선언이 됩니다. 그런데, 요즘은 이와 같은 방법을 통해서 <code>AOP</code>를 선언하는 것을 권장하지 않습니다.</p>
<h2 id="AspectJ-Spring을-이용한-AOP"><a href="#AspectJ-Spring을-이용한-AOP" class="headerlink" title="AspectJ + Spring을 이용한 AOP"></a>AspectJ + Spring을 이용한 AOP</h2><p><code>AspectJ</code>는 AspectJ는 PARC에서 개발한 자바 프로그래밍 언어용 관점 지향 프로그래밍 (AOP) 확장 기능입니다. 이클립스 재단 오픈 소스 프로젝트에서 독립형 또는 이클립스로 통합하여 이용 가능합니다. AspectJ는 최종 사용자를 위한 단순함과 이용성을 강조함으로써 폭넓게 사용되는 AOP에 대한 데 팍토 표준입니다.</p>
<p>기본 Spring Proxy를 이용하는 것보다 performance + 확장성이 더 좋습니다. 먼저 <code>spring-aop</code>를 추가합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-aop'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br><span class="line">compile <span class="string">'org.aspectj:aspectjrt:1.8.1'</span></span><br><span class="line">compile <span class="string">'org.aspectj:aspectjtools:1.8.1'</span></span><br><span class="line">compile <span class="string">'org.aspectj:aspectjweaver:1.8.1'</span></span><br></pre></td></tr></table></figure>
<p>먼저 Target이 될 method를 결정합니다. 이 method를 결정하는 방법은 여러가지가 있습니다. 다음 6가지가 주로 사용됩니다.</p>
<ul>
<li>execution: 메소드 실행 결합점(join points)과 일치시키는데 사용된다.</li>
<li>within: 특정 타입에 속하는 결합점을 정의한다.</li>
<li>this: 빈 참조가 주어진 타입의 인스턴스를 갖는 결합점을 정의한다.</li>
<li>target: 대상 객체가 주어진 타입을 갖는 결합점을 정의한다.</li>
<li>args: 인자가 주어진 타입의 인스턴스인 결합점을 정의한다.</li>
<li>annotation: method에 선언된 @Annotation을 기준으로 결합점을 정의한다.</li>
</ul>
<p>다음은 Pointcut의 예시입니다.</p>
<table>
<thead>
<tr>
<th>Pointcut</th>
<th>선택된 Joinpoints</th>
</tr>
</thead>
<tbody>
<tr>
<td>execution(public <em> </em>(..))</td>
<td>public 메소드 실행</td>
</tr>
<tr>
<td>execution(<em> set</em>(..))</td>
<td>이름이 set으로 시작하는 모든 메소드명 실행</td>
</tr>
<tr>
<td>execution(<em> set</em>(..))</td>
<td>이름이 set으로 시작하는 모든 메소드명 실행</td>
</tr>
<tr>
<td>execution(<em> com.xyz.service.AccountService.</em>(..))</td>
<td>AccountService 인터페이스의 모든 메소드 실행</td>
</tr>
<tr>
<td>execution(<em> com.xyz.service.</em>.*(..))</td>
<td>service 패키지의 모든 메소드 실행</td>
</tr>
<tr>
<td>execution(<em> com.xyz.service..</em>.*(..))</td>
<td>service 패키지와 하위 패키지의 모든 메소드 실행</td>
</tr>
<tr>
<td>within(com.xyz.service.*)</td>
<td>service 패키지 내의 모든 결합점</td>
</tr>
<tr>
<td>within(com.xyz.service..*)</td>
<td>service 패키지 및 하위 패키지의 모든 결합점</td>
</tr>
<tr>
<td>this(com.xyz.service.AccountService)</td>
<td>AccountService 인터페이스를 구현하는 프록시 개체의 모든 결합점</td>
</tr>
<tr>
<td>target(com.xyz.service.AccountService)</td>
<td>AccountService 인터페이스를 구현하는 대상 객체의 모든 결합점</td>
</tr>
<tr>
<td>args(java.io.Serializable)</td>
<td>하나의 파라미터를 갖고 전달된 인자가 Serializable인 모든 결합점</td>
</tr>
<tr>
<td>@target(org.springframework.transaction.annotation.Transactional)</td>
<td>대상 객체가 @Transactional 어노테이션을 갖는 모든 결합점</td>
</tr>
<tr>
<td>@within(org.springframework.transaction.annotation.Transactional)</td>
<td>대상 객체의 선언 타입이 @Transactional 어노테이션을 갖는 모든 결합점</td>
</tr>
<tr>
<td>@annotation(org.springframework.transaction.annotation.Transactional)</td>
<td>실행 메소드가 @Transactional 어노테이션을 갖는 모든 결합점</td>
</tr>
<tr>
<td>@args(com.xyz.security.Classified)</td>
<td>단일 파라미터를 받고, 전달된 인자 타입이 @Classified 어노테이션을 갖는 모든 결합점</td>
</tr>
<tr>
<td>bean(accountRepository)</td>
<td>“accountRepository” 빈</td>
</tr>
<tr>
<td>!bean(accountRepository)</td>
<td>“accountRepository” 빈을 제외한 모든 빈</td>
</tr>
<tr>
<td>bean(*)</td>
<td>모든 빈</td>
</tr>
<tr>
<td>bean(account*)</td>
<td>이름이 ‘account’로 시작되는 모든 빈</td>
</tr>
<tr>
<td>bean(*Repository)</td>
<td>이름이 “Repository”로 끝나는 모든 빈</td>
</tr>
<tr>
<td>bean(accounting/*)</td>
<td>이름이 “accounting/“로 시작하는 모든 빈</td>
</tr>
</tbody>
</table>
<p>개인적으로는 Spring에서의 <code>@Transaction</code>의 처리와 동일하게 AOP선언에 맞게 신규 <code>@Annotation</code>을 만들어주고, 이를 Target으로 명확하게 지정하는 것입니다. 다음과 같이 구성하는 것입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(value = ElementType.METHOD)</span><br><span class="line"><span class="meta">@Retention</span>(value = RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ServiceAopMethod &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>그리고, 이를 <code>Advisor</code>에 다음과 같이 등록합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceAdvisor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"@annotation(com.xyzlast.bookstore.aop.ServiceAopMethod)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceMethodPointCut</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AspectJ</code>는 다음 5개의 annotation을 제공합니다. 이는 다음과 같습니다.</p>
<table>
<thead>
<tr>
<th>Annotation</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Before</td>
<td>method가 call되기 전 입니다.</td>
</tr>
<tr>
<td>@Around</td>
<td>method를 wrap 시켜서 사용되는 형태입니다.</td>
</tr>
<tr>
<td>@After</td>
<td>method가 call이 모두 완료된 이후에 실행됩니다. finally와 동일한 형태라고 생각하시면 됩니다.</td>
</tr>
<tr>
<td>@AfterReturning</td>
<td>method가 정상적으로 실행된 이후, 실행됩니다.</td>
</tr>
<tr>
<td>@AfterThrowing</td>
<td>method에서 exception이 발생될 때 사용됩니다.</td>
</tr>
</tbody>
</table>
<p>이제 <code>Pointcut</code>과 <code>Advice</code>가 모두 추가된 <code>Advisor</code>는 다음과 같은 형태로 구성됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceAdvisor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"@annotation(com.xyzlast.bookstore.aop.ServiceAopMethod)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceMethodPointCut</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"serviceMethodPointCut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeTargetMethod</span><span class="params">(JoinPoint thisJoinPoint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"beforeTargetMethod"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(pointcut = <span class="string">"serviceMethodPointCut()"</span>, returning = <span class="string">"retVal"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturningTargetMethod</span><span class="params">(JoinPoint thisJoinPoint, Object retVal)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"AspectUsingAnnotation.afterReturningTargetMethod executed."</span> +</span><br><span class="line">            <span class="string">" return value is ["</span> + retVal + <span class="string">"]"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(pointcut = <span class="string">"serviceMethodPointCut()"</span>, throwing = <span class="string">"exception"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterThrowingTargetMethod</span><span class="params">(JoinPoint thisJoinPoint,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          Exception exception)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"AspectUsingAnnotation.afterThrowingTargetMethod executed."</span>);</span><br><span class="line">        System.out.println(<span class="string">"에러가 발생했습니다."</span> + exception.getMessage());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"에러가 발생했습니다."</span>, exception);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span>(value = <span class="string">"serviceMethodPointCut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(JoinPoint thisJoinPoint)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"AspectUsing After"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"serviceMethodPointCut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">wrapResponseObject</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"before: "</span>);</span><br><span class="line">        Object ret = pjp.proceed();</span><br><span class="line">        System.out.println(<span class="string">"after: "</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@Aspect</code>로 <code>Advisor</code>임을 지정하는 일이 필요합니다. 이제 이 <code>Advisor</code>를 <code>@Configuration</code>에 등록하는 코드는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.dao"</span>,</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.service"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServiceAdvisor <span class="title">serviceAdvisor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServiceAdvisor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@Bean</code>의 등록이 필요하고, <code>@EnableAspectJAutoProxy</code>를 <em>꼭</em> 선언하는 것을 기억해주세요.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>AOP는 spring에서 매우 중요한 개념입니다. 무엇보다 OOP의 한계인 횡적인 객체의 확장이 가능하게 하는 놀라운 기술중 하나입니다. 그렇지만, 알아야지 될 내용들도 무척 많습니다. 테스트 코드에서는 NameMatchMethodPointcut 만을 사용했지만, Pointcut의 종류가 매우 많습니다. Pointcut에 따라, 특정 객체, method, 그리고 advice에 따라 method의 실행 전/후를 결정을 해서 많은 일들을 할 수 있습니다.</p>
<p>개발을 하다보면 좀더 많은 활용법을 같이 생각해볼 수 있는 구조입니다. 꼭 깊게 공부를 해보시길 바랍니다. 그리고 추가로 이야기드릴것이 Spring은 AspectJ라는 AOP 개발 기법을 지원합니다. 지금까지 proxy를 이용한 AOP 방법이였다면, AspectJ는 compile 시에 기존 class를 변경시켜서 새로운 class를 만들어줍니다. 아애 변형된 객체를 구성시켜주는 것이지요. 이는 성능상에서 이익을 가지고 오고, AOP의 pointcut과 acdvice에 대한 테스팅이 매우 쉬운 장점을 가지고 있습니다. AspectJ에 대해서는 개인적인 공부를 좀 더 해주시길 바랍니다.</p>
<p>이제 JDBC를 직접 이용하는 Simple application의 제작이 모두 마쳐졌습니다. 모두들 수고하셨습니다. 기존의 버릇과는 다른 개발 방법에 대해 고민을 많이 하셨을 것 같은데, 이쪽까지 잘 해주셔서 정말 감사드립니다. 지금까지 하신 내용을 잊어먹지는 말아주세요.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/java-spring-aop/">java, spring, aop</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/02/05/05-05-sample-app/"><span>05-05.SampleApplication(5)</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/02/05/05-05-sample-app/" rel="bookmark">
        <time class="entry-date published" datetime="2018-02-05T00:06:39.000Z">
          2018-02-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="SampleApplication-5-using-SpringDao"><a href="#SampleApplication-5-using-SpringDao" class="headerlink" title="SampleApplication(5) - using SpringDao"></a>SampleApplication(5) - using SpringDao</h1><p>지금까지 우리는 Template-callback 구조의 SqlExecutor와 Connection을 처리하는 ConnectionFactory를 이용한 Dao 객체들을 구성하였습니다. 지금까지 만든 Dao 객체들을 Spring에서 제공하는 Jdbc객체들을 이용해서 변환시키는 과정을 한번 알아보도록 하겠습니다.</p>
<h2 id="Spring-JDBC를-이용한-DAO의-개발"><a href="#Spring-JDBC를-이용한-DAO의-개발" class="headerlink" title="Spring JDBC를 이용한 DAO의 개발"></a>Spring JDBC를 이용한 DAO의 개발</h2><p>Spring JDBC는 지금까지 이야기한 모든 기능들이 다 포함되어있습니다.</p>
<ul>
<li>Template, callback 구조</li>
<li>DataSource를 이용한 ConnectionFactory 구현</li>
<li>Checked Exception을 Runtime Exception으로 변경</li>
</ul>
<p>먼저, <code>build.gradle</code>에 다음 dependency를 추가합니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.springframework'</span>, <span class="string">name:</span> <span class="string">'spring-jdbc'</span>, <span class="string">version:</span> <span class="string">'5.0.2.RELEASE'</span></span><br></pre></td></tr></table></figure>
<h3 id="ConnectionFactory-gt-DataSource"><a href="#ConnectionFactory-gt-DataSource" class="headerlink" title="ConnectionFactory -&gt; DataSource"></a>ConnectionFactory -&gt; DataSource</h3><p>ConnectionFactory를 대신할 객체로 Spring에서는 <code>DataSource</code> 인터페이스를 구현한 <code>DriverManagerDataSource</code>를 제공합니다. <code>@Configuration</code>에서 다음과 같이 정의할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">    dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">    dataSource.setUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">    dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">    dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>참고삼아, <code>JNDI</code>를 이용한 <code>DataSource</code>의 경우에는 다음과 같이 구성 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">jndiDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JndiDataSourceLookup lookup = <span class="keyword">new</span> JndiDataSourceLookup();</span><br><span class="line">    lookup.setResourceRef(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> lookup.getDataSource(jndiName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SqlExecutor-gt-JdbcTemplate"><a href="#SqlExecutor-gt-JdbcTemplate" class="headerlink" title="SqlExecutor -&gt; JdbcTemplate"></a>SqlExecutor -&gt; JdbcTemplate</h3><p>구현된 <code>SqlExecutor</code>에서 제공되는 Template, Callback을 이용한 객체를 <code>Spring</code>에서는 <code>JdbcTemplate</code>로 제공하고 있습니다. 객체 Bean은 다음과 같이 등록이 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>JdbcTemplate</code>은 다음 method들을 가지고 있습니다.</p>
<ul>
<li>queryForList: select에 의해서 List return이 발생할 때 사용됩니다.</li>
<li>queryForObject: 한개의 객체를 return하는 method입니다.</li>
<li>update: insert/update/delete query에서 사용됩니다. return값은 영향 받는 row의 갯수를 반환합니다.</li>
</ul>
<p>기존 코드를 이제 <code>JdbcTemplate</code>를 이용해서 모두 변경해보도록 하겠습니다. 기존 <code>BookDao</code>는 다음과 같이 변경이 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDao</span> <span class="keyword">implements</span> <span class="title">BookStoreDao</span>&lt;<span class="title">Book</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookDao</span><span class="params">(JdbcTemplate jdbcTemplate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">countAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">"select count(*) from books"</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.queryForObject(sql, Integer.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">"delete from books"</span>;</span><br><span class="line">        jdbcTemplate.update(sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">"select id, name, author, status, rentUserId, comment, publishDate from books"</span>;</span><br><span class="line">        List&lt;Book&gt; books = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; maps = jdbcTemplate.queryForList(sql);</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; map : maps) &#123;</span><br><span class="line">            books.add(convertBookFromResultSet(map));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> books;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">"select id, name, author, publishDate, comment, status, rentUserId from books where id=?"</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.queryForObject(sql, <span class="keyword">new</span> Object[] &#123;id&#125;, (rs, rowNum) -&gt; convertBookFromResultSet(rs));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">update</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">"update books set name = ?, author = ?, publishDate = ?, comment = ?, status = ?, rentUserId =? "</span> +</span><br><span class="line">            <span class="string">"where id = ?"</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.update(sql,</span><br><span class="line">            book.getName(), book.getAuthor(),</span><br><span class="line">            <span class="keyword">new</span> java.sql.Date(book.getPublishDate().getTime()),</span><br><span class="line">            book.getComment(),</span><br><span class="line">            book.getBookStatus().value(),</span><br><span class="line">            book.getRentUserId(),</span><br><span class="line">            book.getId()) == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">"insert books(name, author, publishDate, comment, status, rentUserId) values(?, ?, ?, ?, ?, ?)"</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.update(sql,</span><br><span class="line">            book.getName(), book.getAuthor(),</span><br><span class="line">            <span class="keyword">new</span> java.sql.Date(book.getPublishDate().getTime()),</span><br><span class="line">            book.getComment(),</span><br><span class="line">            book.getBookStatus().value(),</span><br><span class="line">            book.getRentUserId()) == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(Book entity)</span> </span>&#123;</span><br><span class="line">        String sql = <span class="string">"delete from books where id = ?"</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.update(sql, entity.getId()) == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Book <span class="title">convertBookFromResultSet</span><span class="params">(Map rs)</span> </span>&#123;</span><br><span class="line">        Book book = <span class="keyword">new</span> Book();</span><br><span class="line">        book.setId((<span class="keyword">int</span>) rs.get(<span class="string">"id"</span>));</span><br><span class="line">        book.setName((String) rs.get(<span class="string">"name"</span>));</span><br><span class="line">        book.setAuthor((String) rs.get(<span class="string">"author"</span>));</span><br><span class="line">        book.setPublishDate((Timestamp) rs.get(<span class="string">"publishDate"</span>));</span><br><span class="line">        book.setBookStatus(BookStatus.parse((<span class="keyword">int</span>) rs.get(<span class="string">"status"</span>)));</span><br><span class="line">        Integer rentUserId = (Integer) rs.get(<span class="string">"rentUserId"</span>);</span><br><span class="line">        book.setRentUserId(rentUserId);</span><br><span class="line">        book.setComment((String) rs.get(<span class="string">"comment"</span>));</span><br><span class="line">        <span class="keyword">return</span> book;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Book <span class="title">convertBookFromResultSet</span><span class="params">(ResultSet rs)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        Book book = <span class="keyword">new</span> Book();</span><br><span class="line">        book.setId(rs.getInt(<span class="string">"id"</span>));</span><br><span class="line">        book.setName(rs.getString(<span class="string">"name"</span>));</span><br><span class="line">        book.setAuthor(rs.getString(<span class="string">"author"</span>));</span><br><span class="line">        java.util.Date date = <span class="keyword">new</span> java.util.Date(rs.getDate(<span class="string">"publishDate"</span>).getTime());</span><br><span class="line">        book.setPublishDate(date);</span><br><span class="line">        book.setBookStatus(BookStatus.parse(rs.getInt(<span class="string">"status"</span>)));</span><br><span class="line">        Integer rentUserId = (Integer) rs.getObject(<span class="string">"rentUserId"</span>);</span><br><span class="line">        book.setRentUserId(rentUserId);</span><br><span class="line">        book.setComment(rs.getString(<span class="string">"comment"</span>));</span><br><span class="line">        <span class="keyword">return</span> book;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Bean의-등록"><a href="#Bean의-등록" class="headerlink" title="Bean의 등록"></a>Bean의 등록</h2><p><code>BookDao</code>, <code>UserDao</code>, <code>HistoryDao</code>를 각각 <code>ApplicationContext</code>에 등록하게 되면 다음과 같이 구성됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DriverManagerDataSource dataSource = <span class="keyword">new</span> DriverManagerDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BookDao <span class="title">bookDao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BookDao(jdbcTemplate());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDao <span class="title">userDao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserDao(jdbcTemplate());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HistoryDao <span class="title">historyDao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HistoryDao(jdbcTemplate());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>만약 <code>Dao</code> 객체들이 여러개가 된다면 이러한 코드 패턴을 여러개를 계속해서 만들어줘야지 됩니다. 이를 간단하게 처리할 수 있는 방법으로 <code>ComponentScan</code>을 제공합니다. <code>ComponentScan</code>은 다음과 같이 사용 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.dao"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>해당되는 <code>package</code>안의 객체들을 자동으로 <code>ApplicationContext</code>에 등록하게 되는데, 이는 annotation을 기준으로 갖습니다. Spring에서 <code>ComponentScan</code>에 의하여 자동 등록되는 기준 annotation은 다음과 같습니다.</p>
<table>
<thead>
<tr>
<th>종류</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Component</td>
<td>일반적인 객체에 사용됩니다.</td>
</tr>
<tr>
<td>@Repository</td>
<td>DB에 접근되는 객체에 사용됩니다. 일반적으로 <code>DAO</code>, <code>Repository</code> 객체에 적용이 됩니다.</td>
</tr>
<tr>
<td>@Service</td>
<td>Business Logic이 구성되는 Service 객체에 사용됩니다. BL은 여러개의 Repository의 구성으로 만들어집니다.</td>
</tr>
<tr>
<td>@Controller</td>
<td>WebMVC에서 사용되는 객체입니다. Url Request와 연결되는 객체를 지정할 때 사용됩니다.</td>
</tr>
</tbody>
</table>
<p>그리고, 자동등록이 지정된 객체들에 자동으로 추가되어야지 될 내용들을 어떻게 지정해주어야지 될까요? 지금 <code>Dao</code> 객체들은 생성자에 <code>JdbcTemplate</code>이 <code>ApplicationContext</code>에 등록된 객체를 사용할 수 있도록 지정해야 합니다. 이럴때 <code>@Autowired</code>를 이용합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDao</span> <span class="keyword">implements</span> <span class="title">BookStoreDao</span>&lt;<span class="title">Book</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookDao</span><span class="params">(JdbcTemplate jdbcTemplate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@Autowired</code>가 지정된 객체들은 <code>ApplicationContext</code>에서 생성될 순서가 뒤로 밀리게 됩니다. 우선 다른 객체들의 dependency가 없는 객체들부터 우선 생성하고, <code>@Autowired</code>가 지정된 객체들을 찾아서 처리하게 됩니다. 이때, 지정된 객체를 찾는 것은 다음과 같은 순서를 갖습니다.</p>
<ol>
<li><code>@Autowired</code>될 객체의 Bean 이름을 지정한 경우</li>
<li><code>@Autowired</code>될 객체의 type이 동일한 경우</li>
</ol>
<p>위 케이스의 경우, 객체의 type이 동일한 경우입니다. <code>Bean</code>의 이름이 지정되어 있지 않기 때문입니다. 만약에 <code>UserDao</code>, <code>BookDao</code>가 각각 다른 <code>JdbcTemplate</code>를 사용해야지 된다면, <code>@Qualifier</code>를 이용해서 각기 사용할 Bean을 지정해줄 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(<span class="string">"jdbcTemplate"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span>(<span class="string">"jdbcTemplate2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDao</span> <span class="keyword">implements</span> <span class="title">BookStoreDao</span>&lt;<span class="title">Book</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookDao</span><span class="params">(@Qualifier(value = <span class="string">"jdbcTemplate"</span>)</span> JdbcTemplate jdbcTemplate) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span> <span class="keyword">implements</span> <span class="title">BookStoreDao</span>&lt;<span class="title">User</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDao</span><span class="params">(@Qualifier(value = <span class="string">"jdbcTemplate2"</span>)</span> JdbcTemplate jdbcTemplate) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="DataSource의-변경"><a href="#DataSource의-변경" class="headerlink" title="DataSource의 변경"></a>DataSource의 변경</h2><p><code>DriverManagerDataSource</code>는 매우 단순한 <code>DataSource</code>입니다. 1개의 <code>connection</code>에 대한 <code>open</code>/<code>close</code>만을 담당하고 있는 매우 단순한 형태이지요. 실무에서는 절대로 사용되지 않는 형태의 <code>DataSource</code>입니다. 실무에서는 <code>JNDI</code> 또는 <code>Connection Pool</code>을 사용합니다.</p>
<p><code>Connection Pool</code>은 미리 <code>Connection</code>을 준비해두고, <code>DAO</code>에서 사용된 <code>Connection</code>을 <code>Pool</code>에 넣어서 관리하는 형태입니다. 이 방식은 다음과 같은 장점을 갖습니다.</p>
<ul>
<li>DB에 대한 가장 큰 부하인 Connection open / close 횟수를 줄여, System의 부하를 줄일수 있습니다.</li>
<li>Web과 같은 동시접근성이 보장되어야지 되는 시스템에서 Connection의 여유분을 만들어서, 시스템의 성능을 높일 수 있습니다.</li>
<li>DB System에 대한 max connection 숫자를 파악할 수 있기 때문에, DB System에 대한 부하 및 성능에 대한 예측이 가능합니다.</li>
</ul>
<p>주로 사용되는 ConnectionPool Library는 다음 5가지를 볼 수 있습니다.</p>
<ul>
<li>apache common-dhcp</li>
<li>tomcat jdbc</li>
<li>boneCP</li>
<li>HikiriCP</li>
<li>c3p0</li>
</ul>
<p>주로 사용되고 있는 <code>apache common-dhcp</code>는 사용버젼에 주의할 필요가 있습니다. <code>1.4.1</code>이전 버젼의 경우 memoryLeak이 발생합니다. 그런데, <code>1.4.1</code> 정식버젼이 아직 release되고 있지 않습니다. 따라서, 다음 선언을 모두 변경하는 것이 좋습니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'commons-dbcp'</span>, <span class="string">name:</span> <span class="string">'commons-dbcp'</span>, <span class="string">version:</span> <span class="string">'1.4'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">group:</span> <span class="string">'org.apache.commons'</span>, <span class="string">name:</span> <span class="string">'commons-dbcp2'</span>, <span class="string">version:</span> <span class="string">'2.1.1'</span></span><br></pre></td></tr></table></figure>
<p>개인적으로는 <code>HikariCP</code>를 추천합니다. 성능이 좋습니다.</p>
<p><img src="https://github.com/brettwooldridge/HikariCP/wiki/HikariCP-bench-2.6.0.png" alt=""></p>
<p><code>ConnectionPool</code>은 다음과 같은 일반적인 속성들을 갖습니다.</p>
<ul>
<li>idleConnectionTestPeriodInMinutes : connection이 쉬고 있는 상태인지 확인하는 주기입니다.</li>
<li>idleMaxAgeInMinutes : connection이 유휴상태로 놓어지는 최대시간입니다. 이 시간 이후, connection은 소멸됩니다.</li>
<li>maxConnections : 최대 connection의 갯수입니다.</li>
<li>minConnections : 최소 connection의 갯수입니다.</li>
<li>acquireIncrement : 한번에 connection을 얻어낼 때, 얻어내는 숫자입니다.</li>
</ul>
<p>application의 최대 성능을 높이기 위해서는 <code>maxConnections</code>와 <code>minConnections</code>의 숫자를 일치시키는 것이 강력 권장합니다. <code>HikariCP</code>를 이용하는 경우 DataSource를 변경하면 다음과 같이 <code>@Configuration</code>의 변경이 필요합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">    dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">    dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">    dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">    dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">    dataSource.setMaximumPoolSize(<span class="number">10</span>);</span><br><span class="line">    dataSource.setMinimumIdle(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>DataSourc</code>를 변경한 이후에도 기존 코드에 아무런 변경이 없이 적용이 가능합니다. 이는 <code>DI</code>에 의한 <code>IoC</code>의 대표적인 한 예가 될 수 있습니다.</p>
<h2 id="Repository-Pattern"><a href="#Repository-Pattern" class="headerlink" title="Repository Pattern"></a>Repository Pattern</h2><p><code>Spring</code>에서 Logic의 구성은 일반적으로 <code>Repository Pattern</code>을 따를 것을 권고하고 있습니다. <code>Repository Pattern</code>은 BL(Business Logic)과 데이터의 저장(Repository)에 대한 Layer를 명확히 구분시키는 pattern 입니다. 일반적인 구성은 다음과 같이 만들어집니다.</p>
<p><img src="https://i-msdn.sec.s-msft.com/dynimg/IC340233.png" alt=""></p>
<p>데이터의 검색/저장 영역과 그 데이터를 이용하는 BL을 철저하게 구분합니다. 이는 <code>DAO Pattern</code>과는 구분 됩니다. <code>DAO Pattern</code>의 경우, 데이터에 Access를 어떤 Layer에서나 접근이 가능한 차이를 가지고 있습니다.</p>
<p>그래서, Spring으로 구성된 프로젝트를 보면 다음과 같은 package들로 구성되는 경우가 많습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── config</span><br><span class="line">├── controller</span><br><span class="line">├── entity</span><br><span class="line">├── repository</span><br><span class="line">└── service</span><br></pre></td></tr></table></figure>
<p>이제 몇가지 BL을 가지고 Spring에서의 Service를 구현해보도록 하겠습니다.</p>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>이제 BookStore의 BL을 정의해보도록 하겠습니다.</p>
<ul>
<li>user는 book을 빌리거나 반납할 수 있다.</li>
<li>user가 book을 빌리면, point가 10점씩 쌓인다.</li>
<li>point가 100점이 넘어가면 LEVEL이 READER(1)가 된다.</li>
<li>point가 300점이 넘어가면 MVP(2)가 된다.</li>
<li>point가 100점 이하인 경우, 일반유저(NORMAL)이다.</li>
<li>전체 book을 list up 할 수 있으며, 대출이 가능한 책 우선으로 Sort된다.</li>
<li>book은 대출 가능, 대출중, 분실의 3가지의 상태를 갖는다.</li>
<li>user는 자신이 지금까지 빌린 book들의 기록(대출,반납)을 최신 순으로 볼 수 있다.</li>
<li>user의 RENT/RETURN은 모두 History가 남는다.</li>
</ul>
<p>매우 간단한 BL입니다. 그리고, 이 BL에 대한 Action 주체를 기준으로 다음과 같이 명명한 서비스들을 구상할 수 있습니다.</p>
<ul>
<li>UserService: User가 Action의 주체가 되는 서비스입니다.</li>
<li>BookService: Book이 Action의 주체가 되는 서비스입니다.</li>
</ul>
<p>서비스의 명명법은 일반적으로 영문법을 따르게 되며 다음과 같은 영어 문장과 같은 구성을 갖는것이 좋습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">userService.listupRentHistories();</span><br><span class="line">userService.rentBook(Book book);</span><br><span class="line">userService.returnBook(Book book);</span><br><span class="line">bookService.listup();</span><br></pre></td></tr></table></figure>
<p>이에 대한 서비스는 다음과 같이 설계할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">returnBook</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span></span>;</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">listup</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">List&lt;History&gt; <span class="title">getHistories</span><span class="params">(<span class="keyword">int</span> userId)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">listup</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이와 같이 interface는 단순히 객체에 대한 프로그래밍적 요소로만 사용되는 것이 아닌, 프로그램의 in/out에 대한 설계로서 사용이 가능합니다. 우리가 어떠한 application을 작성을 할때, input/output에 대한 정의를 명확히 할 수 있는 경우, interface를 이용해서 코드를 명확히 구성하는 것이 가능합니다. 이제 interface를 기반으로 서비스를 구현해보면 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    <span class="keyword">private</span> BookDao bookDao;</span><br><span class="line">    <span class="keyword">private</span> HistoryDao historyDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserServiceImpl</span><span class="params">(UserDao userDao, BookDao bookDao, HistoryDao historyDao)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userDao = userDao;</span><br><span class="line">        <span class="keyword">this</span>.bookDao = bookDao;</span><br><span class="line">        <span class="keyword">this</span>.historyDao = historyDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">        User user = userDao.getById(userId);</span><br><span class="line">        Book book = bookDao.getById(bookId);</span><br><span class="line">        <span class="keyword">if</span> (book.getBookStatus() != BookStatus.CanRent || book.getRentUserId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        user.setPoint(user.getPoint() + <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (user.getPoint() &gt;= <span class="number">100</span> &amp;&amp; user.getPoint() &lt; <span class="number">300</span>) &#123;</span><br><span class="line">            user.setLevel(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (user.getPoint() &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">            user.setLevel(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            user.setLevel(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        book.setRentUserId(userId);</span><br><span class="line">        book.setBookStatus(BookStatus.RentNow);</span><br><span class="line"></span><br><span class="line">        userDao.update(user);</span><br><span class="line">        bookDao.update(book);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//<span class="doctag">NOTE:</span> History 기록</span></span><br><span class="line">        History history = <span class="keyword">new</span> History();</span><br><span class="line">        history.setDate(<span class="keyword">new</span> Date());</span><br><span class="line">        history.setActionType(HistoryActionType.RENT_BOOK);</span><br><span class="line">        history.setUserId(userId);</span><br><span class="line">        history.setBookId(bookId);</span><br><span class="line">        historyDao.add(history);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 구현된 서비스를 <code>@Service</code>로 등록됩니다. 이제 <code>@Configuration</code>에 등록하는 코드를 확인해보겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.dao"</span>,</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.service"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">        dataSource.setMaximumPoolSize(<span class="number">10</span>);</span><br><span class="line">        dataSource.setMinimumIdle(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 정상적으로 등록되었는지 확인해보도록 하겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(classes = BookStoreConfig.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImplTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        UserService userService = applicationContext.getBean(UserService.class);</span><br><span class="line">        assertThat(userService).isNotNull();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doTest01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Service-Code의-테스트-방법"><a href="#Service-Code의-테스트-방법" class="headerlink" title="Service Code의 테스트 방법"></a>Service Code의 테스트 방법</h2><p><code>@Service</code> 객체들을 모두 가져다 사용이 가능한 것을 볼 수 있습니다. 이제 우리는 <code>Repository Pattern</code>으로 개발할 준비가 모두 마쳐진 상태입니다. 그렇다면 이와 같은 코드를 어떻게 테스트를 할 수 있을까요?</p>
<p><code>rent</code> 코드가 정상적으로 동작하는 것을 확인하기 위해서는 다음 상황을 확인할 수 있어야지 됩니다.</p>
<ul>
<li><code>Book</code>의 상태에 따라 대여가 가능하거나 불가능해야지 됩니다.</li>
<li><code>User</code>의 Point 점수에 따라 Level이 변경이 될 수 있어야지 됩니다.</li>
<li><code>History</code>의 추가가 되어야지 됩니다.</li>
</ul>
<p>위 3가지를 확인하기 위해서는 <code>Repository</code>에 올바른 데이터가 입력되어 있어야지 됩니다. 그리고, 테스트가 정상적으로 동작할 수 있도록 데이터를 준비하더라도 테스트가 반복적으로 실행될 수는 없는 구조입니다. <code>User</code>의 상태가 변경되기 때문이지요. 그렇다면 이런 문제를 회피하면서 테스트를 진행하기 위해서는 어떻게 해야지 될까요?</p>
<p>여기서 한번 우리가 기본적으로 알고 있는 <code>OOP</code>에 대해서 다시 생각해볼 필요가 있습니다. 우리의 테스트 코드는 테스트하고자 하는 객체에 대한 테스트를 진행해야지 됩니다. <code>Service</code> 테스트 코드가 굳이 <code>Repository</code>에 대한 테스트를 진행할 필요가 없다는 것입니다. 그렇다면 <code>Repository</code>를 우리가 원하는 객체만을 반환하게 해줘서 테스트를 진행하면 이 문제를 해결할 수 있습니다.</p>
<p>다시한번 위 3가지의 테스트 조건이 어떻게 통과될 수 있는지 확인해보도록 하겠습니다.</p>
<table>
<thead>
<tr>
<th>상황</th>
<th>해결방안</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Book</code>의 상태에 따라 대여가 가능하거나 불가능해야지 됩니다.</td>
<td>bookDao.getById에서 원하는 상태를 갖는 <code>Book</code>을 얻어낼 수 있으면 가능합니다.</td>
</tr>
<tr>
<td><code>User</code>의 Point 점수에 따라 Level이 변경이 될 수 있어야지 됩니다.</td>
<td><code>User.point</code>, <code>User.level</code>이 테스트 하고자 하는 상태를 갖는 <code>User</code>를 얻어낼 수 있으면 가능합니다.</td>
</tr>
<tr>
<td><code>History</code>의 추가가 되어야지 됩니다.</td>
<td><code>historyDao.add</code>가 호출되어야지 됩니다.</td>
</tr>
</tbody>
</table>
<p>이렇게 설정된 값을 반환하는 테스트 객체를 이용하는 테스트를 <code>mockTest</code>라고 합니다. <code>mockTest</code>는 매우 중요합니다. 모든 <code>application</code>은 <code>Dependency</code>를 갖게 되는데 이 <code>Dependency</code>의 영향을 받지 않는 테스트를 구성하지 않으면, 좋은 테스트 코드를 구현할 수 없습니다. <code>mockTest</code>를 구현하기 위해 자주 사용되는 library는 <code>mokito</code>입니다.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testCompile <span class="string">group:</span> <span class="string">'org.mockito'</span>, <span class="string">name:</span> <span class="string">'mockito-all'</span>, <span class="string">version:</span> <span class="string">'1.10.19'</span></span><br></pre></td></tr></table></figure>
<p>다음은 구성된 테스트 코드입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.assertj.core.api.Assertions.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mockito.Mockito.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockUserServiceImplTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> BOOK상태가_정상적이지_않은_경우_테스트() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Book book = <span class="keyword">new</span> Book();</span><br><span class="line">        <span class="comment">//대여되어 있는 상태</span></span><br><span class="line">        book.setBookStatus(BookStatus.RentNow);</span><br><span class="line"></span><br><span class="line">        BookDao bookDao = mock(BookDao.class);</span><br><span class="line">        when(bookDao.getById(any())).thenReturn(book);</span><br><span class="line">        UserDao userDao = mock(UserDao.class);</span><br><span class="line">        HistoryDao historyDao = mock(HistoryDao.class);</span><br><span class="line"></span><br><span class="line">        UserServiceImpl userService = <span class="keyword">new</span> UserServiceImpl(userDao, bookDao, historyDao);</span><br><span class="line">        assertThat(userService.rent(<span class="number">0</span>, <span class="number">0</span>)).isFalse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> BOOK의_RENTUSERID가_NULL이_아닌경우_테스트() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">int</span> targetUserId = <span class="number">0</span>;</span><br><span class="line">        Book book = <span class="keyword">new</span> Book();</span><br><span class="line">        book.setBookStatus(BookStatus.CanRent);</span><br><span class="line">        book.setRentUserId(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        BookDao bookDao = mock(BookDao.class);</span><br><span class="line">        when(bookDao.getById(any())).thenReturn(book);</span><br><span class="line">        UserDao userDao = mock(UserDao.class);</span><br><span class="line">        HistoryDao historyDao = mock(HistoryDao.class);</span><br><span class="line"></span><br><span class="line">        UserServiceImpl userService = <span class="keyword">new</span> UserServiceImpl(userDao, bookDao, historyDao);</span><br><span class="line">        assertThat(userService.rent(targetUserId, <span class="number">0</span>)).isFalse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> 정상적인_RENT가_되는_경우_사용자Level이_READER가_되는_경우() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//User.point = 90, level이 1로 변경되는 것 확인</span></span><br><span class="line">        testRentWithUserCondition(<span class="number">90</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">//User.point = 290, level이 2로 변경되는 것 확인</span></span><br><span class="line">        testRentWithUserCondition(<span class="number">290</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="comment">//User.point = 50, level이 0으로 유지되는 것 확인</span></span><br><span class="line">        testRentWithUserCondition(<span class="number">50</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">testRentWithUserCondition</span><span class="params">(<span class="keyword">int</span> currentPoint, <span class="keyword">int</span> currentLevel, <span class="keyword">int</span> expectLevel)</span> </span>&#123;</span><br><span class="line">        Book book = <span class="keyword">new</span> Book();</span><br><span class="line">        book.setBookStatus(BookStatus.CanRent);</span><br><span class="line">        book.setRentUserId(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setPoint(currentPoint);</span><br><span class="line">        user.setLevel(currentLevel);</span><br><span class="line"></span><br><span class="line">        BookDao bookDao = mock(BookDao.class);</span><br><span class="line">        when(bookDao.getById(any())).thenReturn(book);</span><br><span class="line">        UserDao userDao = mock(UserDao.class);</span><br><span class="line">        when(userDao.getById(any())).thenReturn(user);</span><br><span class="line">        HistoryDao historyDao = mock(HistoryDao.class);</span><br><span class="line"></span><br><span class="line">        UserServiceImpl userService = <span class="keyword">new</span> UserServiceImpl(userDao, bookDao, historyDao);</span><br><span class="line">        <span class="comment">//Rent가 정상적으로 진행되는 것을 확인</span></span><br><span class="line">        assertThat(userService.rent(<span class="number">0</span>, <span class="number">0</span>)).isTrue();</span><br><span class="line">        <span class="comment">//Rent가 진행된 후, 사용자의 Level이 바뀐것을 확인</span></span><br><span class="line">        assertThat(user.getLevel()).isEqualTo(expectLevel);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//book, user가 update되는 코드가 호출되는 것을 확인</span></span><br><span class="line">        verify(bookDao, times(<span class="number">1</span>)).update(book);</span><br><span class="line">        verify(userDao, times(<span class="number">1</span>)).update(user);</span><br><span class="line">        <span class="comment">//History가 추가 되는것을 확인</span></span><br><span class="line">        verify(historyDao, times(<span class="number">1</span>)).add(any());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mockTest</code>는 의존성을 제거하고 로직을 테스트할 수 있는 좋은 방법입니다. 그렇다고 <code>Repository</code>를 직접 이용하는 테스트 코드가 필요없다는 것은 아닙니다. 어떤 항목을 테스트해야될지 개발자들이 확인할 필요가 있습니다.</p>
<h2 id="Transaction"><a href="#Transaction" class="headerlink" title="Transaction"></a>Transaction</h2><p>지금까지 구현된 Service, Repository Layer는 결정적인 문제를 가지고 있습니다. 예를 들어, rentBook action에서 book의 상태를 업데이트 한 후에, DB의 문제나 application의 exception이 발생했다면 어떤 문제가 발생할까요?<br>지금의 JdbcTemplate은 각 Repository Layer단으로 Connection이 분리 되어 있습니다. 따라서 한쪽에서 Exception이 발생하더라도, 기존 update 사항에 대해서는 DB에 그대로 반영이 되어버립니다. 이건 엄청난 문제를 발생시킵니다. Repository는 우리가 서비스를 만드는 도구이고, 결국은 사용자나 BL의 한개의 action으로 DB의 Transaction이 적용이 되어야지 되는데, 이러한 규칙을 모두 날려버리게 되는 것입니다.</p>
<p>다시 한번 정리하도록 하겠습니다. Service의 method는 BL의 기본 단위가 됩니다. 따라서, Transaction의 단위가 Service의 method 단위가 되어야지 됩니다. 간단히 sudo 코드를 작성한다면 rent method는 다음과 같이 작성되어야지 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">    Transaction.begin();</span><br><span class="line">    User user = userDao.get(userId);</span><br><span class="line">    Book book = bookDao.get(bookId);</span><br><span class="line"></span><br><span class="line">    user.setPoint(user.getPoint() + <span class="number">10</span>);</span><br><span class="line">    user.setLevel(getUserLevel(user.getPoint()));</span><br><span class="line">    book.setRentUserId(user.getId());</span><br><span class="line">    book.setStatus(BookStatus.RentNow);</span><br><span class="line"></span><br><span class="line">    UserHistory history = <span class="keyword">new</span> UserHistory();</span><br><span class="line">    history.setUserId(userId);</span><br><span class="line">    history.setBookId(book.getId());</span><br><span class="line">    history.setAction(HistoryActionType.RENT);</span><br><span class="line"></span><br><span class="line">    userDao.update(user);</span><br><span class="line">    bookDao.update(book);</span><br><span class="line">    userHistoryDao.add(history);</span><br><span class="line"></span><br><span class="line">    Transaction.commit();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Transaction은 매우 골치아픈 개념입니다. 먼저 지금 사용중인 DataSource는 직접적으로 JDBC에 연결되는 Connection입니다. 그런데, 이를 Hibernate의 session 또는 iBatis의 ObjectMapper들을 사용한다면 완전히 다른 Transaction 기술을 사용해야지 됩니다. 지금까지 기술에 종속적이지 않은 <code>Service</code>를 작성하고 있는데, 이제 Transaction에 의한 기술 종속적 코드로 변경이 되어야지 되는 상황이 되어버린것입니다. 그래서, 이 경우를 해결하기 위해서 Transaction의 기술들에 대한 interface를 spring은 제안하고 있습니다. 바로 <code>org.springframework.transaction.PlatformTransactionManager</code>가 바로 그 interface입니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PlatformTransactionManager</span> </span>&#123;</span><br><span class="line">    <span class="function">TransactionStatus <span class="title">getTransaction</span><span class="params">(@Nullable TransactionDefinition definition)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">(TransactionStatus status)</span> <span class="keyword">throws</span> TransactionException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Transaction을 얻어내고, Transaction을 commit, rollback하는 간단한 구조로 되어 있습니다. 이러한 기본 구조는 우리가 Dao Layer를 이용해서 Transaction을 사용하는데 충분합니다.<br>PlatformTransactionManager를 이용한 Transaction 구현을 간단한 sudo code로 구현하면 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TransactionStatus status = transactionManager.getTransaction(definition);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ..do something</span></span><br><span class="line">        transactionManager.commit(status);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Exception ex) &#123;</span><br><span class="line">        transactionManager.rollback(status)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>전에 보던 Template-callback pattern과 동일한 패턴의 코드가 완성됩니다. TransactionManager의 생성자에는 DataSource interface를 구현하고 있기 때문에 Dao Layer에서 사용하는 Connection을 한번에 묶어서 처리가 가능합니다. Spring Transaction을 이용한 코드는 다음과 같이 구현되어야지 됩니다.</p>
<p>먼저 <code>@Configuration</code>에 다음과 같이 등록합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserService는 다음과 같이 변경되어야지 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">    TransactionStatus transaction = transactionManager.getTransaction(<span class="keyword">new</span> DefaultTransactionDefinition());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        User user = userDao.getById(userId);</span><br><span class="line">        Book book = bookDao.getById(bookId);</span><br><span class="line">        <span class="keyword">if</span> (book.getBookStatus() != BookStatus.CanRent || book.getRentUserId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        user.setPoint(user.getPoint() + <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (user.getPoint() &gt;= <span class="number">100</span> &amp;&amp; user.getPoint() &lt; <span class="number">300</span>) &#123;</span><br><span class="line">            user.setLevel(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (user.getPoint() &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">            user.setLevel(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            user.setLevel(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        book.setRentUserId(userId);</span><br><span class="line">        book.setBookStatus(BookStatus.RentNow);</span><br><span class="line"></span><br><span class="line">        userDao.update(user);</span><br><span class="line">        bookDao.update(book);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//<span class="doctag">NOTE:</span> History 기록</span></span><br><span class="line">        History history = <span class="keyword">new</span> History();</span><br><span class="line">        history.setDate(<span class="keyword">new</span> Date());</span><br><span class="line">        history.setActionType(HistoryActionType.RENT_BOOK);</span><br><span class="line">        history.setUserId(userId);</span><br><span class="line">        history.setBookId(bookId);</span><br><span class="line">        historyDao.add(history);</span><br><span class="line">        transactionManager.commit(transaction);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        transactionManager.rollback(transaction);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 Transaction이 적용된 코드가 완성되었습니다.</p>
<h2 id="annotation을-이용한-Transaction의-구현"><a href="#annotation을-이용한-Transaction의-구현" class="headerlink" title="annotation을 이용한 Transaction의 구현"></a>annotation을 이용한 Transaction의 구현</h2><p>그런데, 지금까지 구현된 코드에는 한가지 문제가 있습니다. Transaction은 기술적인 영역으로 Service 객체에는 어울리지 않는 내용입니다. Service는 BL의 집합이라는 것을 다시 한번 상기해주시길 바랍니다. BL에 기술적인 요소가 들어가게 되면, 기술적인 요소에 따른 BL의 수정이 가해질 수 있습니다. 따라서, Spring에서는 이를 분리하는 것을 제안하고 있으며, 특히 Transaction에서는 @Transactional annotaion을 이용한 분리를 제안하고 있습니다.</p>
<p>@Transactional은 method, class에 모두 적용 가능한 annotation입니다. @Transactional을 사용하기 위해서는 <code>@Configuration</code>이 다음과 같이 변경이 필요합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = &#123;</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.dao"</span>,</span><br><span class="line">    <span class="string">"com.xyzlast.bookstore.service"</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookStoreConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">"org.mariadb.jdbc.Driver"</span>);</span><br><span class="line">        dataSource.setJdbcUrl(<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>);</span><br><span class="line">        dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">"qwer12#$"</span>);</span><br><span class="line">        dataSource.setMaximumPoolSize(<span class="number">10</span>);</span><br><span class="line">        dataSource.setMinimumIdle(<span class="number">10</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcTemplate <span class="title">jdbcTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTemplate(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(dataSource());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@EnableTransactionManagement</code>에 주의해주시길 바랍니다. 이제 Transaction을 다음과 같이 적용하면 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">rent</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> bookId)</span> </span>&#123;</span><br><span class="line">    User user = userDao.getById(userId);</span><br><span class="line">    Book book = bookDao.getById(bookId);</span><br><span class="line">    <span class="keyword">if</span> (book.getBookStatus() != BookStatus.CanRent || book.getRentUserId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"BOOK의 상태가 정상적이지 않습니다."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    user.setPoint(user.getPoint() + <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (user.getPoint() &gt;= <span class="number">100</span> &amp;&amp; user.getPoint() &lt; <span class="number">300</span>) &#123;</span><br><span class="line">        user.setLevel(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (user.getPoint() &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">        user.setLevel(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        user.setLevel(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    book.setRentUserId(userId);</span><br><span class="line">    book.setBookStatus(BookStatus.RentNow);</span><br><span class="line"></span><br><span class="line">    userDao.update(user);</span><br><span class="line">    bookDao.update(book);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//<span class="doctag">NOTE:</span> History 기록</span></span><br><span class="line">    History history = <span class="keyword">new</span> History();</span><br><span class="line">    history.setDate(<span class="keyword">new</span> Date());</span><br><span class="line">    history.setActionType(HistoryActionType.RENT_BOOK);</span><br><span class="line">    history.setUserId(userId);</span><br><span class="line">    history.setBookId(bookId);</span><br><span class="line">    historyDao.add(history);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>이번에는 Spring JDBC를 이용한 DB 접근 방법에 대해서 알아봤습니다. Spring을 사용중이지만, 외부 Library의 도움을 받지 못하는 경우에 매우 좋은 선택입니다. 그리고 DataSource에 대해서도 알아봤습니다. DataSource는 매우 중요한 Library입니다. DB Connection을 관리하고 있기 때문에 이에 대한 세부설정은 전체 솔루션 성능에 큰 영향을 미치게 됩니다. Transaction은 DB를 다룰때 매우 중요한 이슈입니다.</p>
<p>마지막으로 <code>Repository Pattern</code>에 대해서 알아봤습니다. <code>Service</code>, <code>Repository</code>로 만들어지는 구조는 Spring을 사용한 BL Logic을 구성하는 application의 기본 구조이기도합니다. 그리고, <code>Repository Pattern</code>을 테스트하는 방법들 중에서 <code>mockTest</code>에 대해서도 알아봤습니다.</p>
<p>하나하나가 매우 중요한 개념입니다. 몸으로도 개념으로도 익히는 것이 중요합니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/study-java-spring/">study,java,spring</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/02/05/05-04-sample-app/"><span>05-04.SampleApplication(4)</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/02/05/05-04-sample-app/" rel="bookmark">
        <time class="entry-date published" datetime="2018-02-04T23:58:40.000Z">
          2018-02-05
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="SampleApplication-4-TemplateCallback-pattern"><a href="#SampleApplication-4-TemplateCallback-pattern" class="headerlink" title="SampleApplication(4) - TemplateCallback pattern"></a>SampleApplication(4) - TemplateCallback pattern</h1><h2 id="코드-정리-객체간의-중복-코드-정리"><a href="#코드-정리-객체간의-중복-코드-정리" class="headerlink" title="코드 정리 - 객체간의 중복 코드 정리"></a>코드 정리 - 객체간의 중복 코드 정리</h2><p>지금까지 우리는 books라는 한개의 table에 CRUD action을 진행해왔습니다. 그렇지만, 개발에서는 한개의 Table만에 CRUD를 하는 경우보다, 한 Action에 대하여 여러개의 Table을 CRUD 하게 되는 것이 일반적입니다.</p>
<p>그래서, 이 두개의 개념을 나누게 되는데요.<br>하나의 Action이라는 것은 Business Logic이라고 할 수 있고, 한 Table에 대한 CRUD는 DB에 종속적인 작업이라고 할 수 있습니다.<br>전자를 일반적으로 Service라고 지칭하고, 후자를 DAO (Data Access Object)라고 지칭하는 것이 일반적입니다. 그리고, DB를 통해서 처리되는 Table 단위 또는 Query 단위의 Object들을 Entity(or model)라고 명명합니다.</p>
<p>이와 같은 이름으로 package로 나누게 되는 것이 일반적입니다. dao, entities, service package를 나누것과 같이 이런 식으로 나눠주는 것이 좋습니다.</p>
<p>1개의 Service는 여러개의 DAO를 가지고 있고, DAO를 이용한 BL을 서술하는 것이 일반적입니다. DAO는 최대한 단순하게 Table에 대한 Query들로 구성이 되고, 그 Query를 통해서 결과를 얻어내는 수단으로 주로 사용됩니다. bookstore에 Business Logic(BL)을 추가하기 전에 book의 상태를 서술할수 있는 property와 현재 책을 빌려간 사용자의 정보를 저장할 수 있는 Column을 두개 추가하고, users table을 추가해서 Dao를 좀더 구성해보도록 하겠습니다.</p>
<p>변경된 table의 구조가 반영된 것으로 docker에 새로운 image를 올려뒀습니다. 기존 container를 삭제시키고, 새로운 docker container를 실행시켜주세요.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p <span class="number">4306</span>:<span class="number">3306</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">94</span>.<span class="number">18</span>:<span class="number">15000</span>/study-container:<span class="number">003</span> mysqld_safe</span><br></pre></td></tr></table></figure>
<p>새로운 Docker Image안에 들어있는 db의 table 구조는 다음과 같습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show tables;</span><br><span class="line">+---------------------+</span><br><span class="line">| Tables_in_bookstore |</span><br><span class="line">+---------------------+</span><br><span class="line">| books               |</span><br><span class="line">| histories           |</span><br><span class="line">| users               |</span><br><span class="line">+---------------------+</span><br><span class="line"><span class="number">3</span> rows <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0</span>.<span class="number">01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; describe books;</span><br><span class="line">+-------------+--------------+------+-----+-------------------+-----------------------------+</span><br><span class="line">| Field       | <span class="built_in">Type</span>         | Null | Key | Default           | Extra                       |</span><br><span class="line">+-------------+--------------+------+-----+-------------------+-----------------------------+</span><br><span class="line">| id          | int(<span class="number">11</span>)      | NO   | PRI | NULL              | auto_increment              |</span><br><span class="line">| name        | varchar(<span class="number">255</span>) | NO   |     | NULL              |                             |</span><br><span class="line">| author      | varchar(<span class="number">50</span>)  | NO   |     | NULL              |                             |</span><br><span class="line">| publishDate | timestamp    | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |</span><br><span class="line">| comment     | varchar(<span class="number">255</span>) | YES  |     | NULL              |                             |</span><br><span class="line">| status      | int(<span class="number">11</span>)      | NO   |     | NULL              |                             |</span><br><span class="line">| rentUserId  | int(<span class="number">11</span>)      | YES  | MUL | NULL              |                             |</span><br><span class="line">+-------------+--------------+------+-----+-------------------+-----------------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; describe users;</span><br><span class="line">+----------+-------------+------+-----+---------+----------------+</span><br><span class="line">| Field    | <span class="built_in">Type</span>        | Null | Key | Default | Extra          |</span><br><span class="line">+----------+-------------+------+-----+---------+----------------+</span><br><span class="line">| id       | int(<span class="number">11</span>)     | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name     | varchar(<span class="number">50</span>) | NO   |     | NULL    |                |</span><br><span class="line">| password | varchar(<span class="number">12</span>) | NO   |     | NULL    |                |</span><br><span class="line">| point    | int(<span class="number">11</span>)     | NO   |     | NULL    |                |</span><br><span class="line">| level    | int(<span class="number">11</span>)     | NO   |     | NULL    |                |</span><br><span class="line">+----------+-------------+------+-----+---------+----------------+</span><br><span class="line"><span class="number">5</span> rows <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0</span>.<span class="number">00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; describe histories;</span><br><span class="line">+------------+-----------+------+-----+-------------------+-----------------------------+</span><br><span class="line">| Field      | <span class="built_in">Type</span>      | Null | Key | Default           | Extra                       |</span><br><span class="line">+------------+-----------+------+-----+-------------------+-----------------------------+</span><br><span class="line">| id         | int(<span class="number">11</span>)   | NO   | PRI | NULL              | auto_increment              |</span><br><span class="line">| userId     | int(<span class="number">11</span>)   | NO   | MUL | NULL              |                             |</span><br><span class="line">| bookId     | int(<span class="number">11</span>)   | NO   | MUL | NULL              |                             |</span><br><span class="line">| actionType | int(<span class="number">11</span>)   | NO   |     | NULL              |                             |</span><br><span class="line">| insertDate | timestamp | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |</span><br><span class="line">+------------+-----------+------+-----+-------------------+-----------------------------+</span><br><span class="line"><span class="number">5</span> rows <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0</span>.<span class="number">00</span> sec)</span><br></pre></td></tr></table></figure>
<p>위 <code>Service</code>와 <code>DAO</code>에 대한 정의를 보면 지금까지 작성된 <code>BookService</code>는 <code>DAO</code>의 성격이 더 강한 것을 알 수 있습니다. 그렇다면 package에 대한 전체적인 변경을 해보도록 하겠습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">├── dao</span><br><span class="line">├── entity</span><br><span class="line">└── service</span><br></pre></td></tr></table></figure>
<p>이 구조는 <code>Business Logic</code>을 다루는 package의 일반적인 구조가 될 수 있습니다. 추후에 <code>WebApplication</code>에서 package에 대한 구조를 좀 더 깊게 다뤄보도록 하겠습니다.</p>
<p>그리고 3개의 Table에 해당되는 <code>DAO</code>인 <code>BookDao</code>, <code>UserDao</code>, <code>HistoryDao</code>를 추가합니다. 그리고, 각 <code>Dao</code>에서 해당되는 <code>Entity</code>들을 모두 추가하면 일단 기본 포멧은 꾸며질 수 있게 됩니다.</p>
<h2 id="Entity-or-Model"><a href="#Entity-or-Model" class="headerlink" title="Entity (or Model)"></a>Entity (or Model)</h2><p>Table 단위의 접근 객체를 의미합니다. 이는 DAO에서 처리하는 객체 단위가 될 수 있습니다. 조금 더 깊은 내용들은 <code>ORM(Oriented Relation Model)</code>에서 좀 더 깊게 다루도록 하겠습니다.</p>
<p>기존 Book의 경우, <code>status</code>와 <code>rentUserId</code>가 추가되었습니다. 이를 단순히 <code>int</code> 값으로 처리가 가능합니다. 그런데, 이렇게 int 값으로 처리를 하게 되면 int 값에 대한 내용 서술이 되지 않습니다. 이런 경우 이 값을 <code>enum</code> 형태로 만들어서 처리해주면 좋습니다. 이 부분에 대해서는 논쟁이 조금 있습니다. 상태의 경우 <code>code table</code>을 통해서 처리가 되는 것이 일반적입니다. 이렇게 <code>enum</code>을 이용할 때의 장점은 무엇이 있을까요? 이 부분에 대해서는 각 개발자들이 한번 공부를 해보는 것이 어떨까 생각을 하고 있습니다. 약간의 논쟁이 되는 부분중 하나라고 생각합니다. (<a href="http://woowabros.github.io/tools/2017/07/10/java-enum-uses.html" target="_blank" rel="noopener">http://woowabros.github.io/tools/2017/07/10/java-enum-uses.html</a>)</p>
<p>BookStatus를 enum으로 정의하면 다음 코드로 표현이 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> BookStatus &#123;</span><br><span class="line">    CanRent(<span class="number">0</span>),</span><br><span class="line">    RentNow(<span class="number">1</span>),</span><br><span class="line">    Missing(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value;</span><br><span class="line">    BookStatus(<span class="keyword">int</span> value) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">value</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BookStatus <span class="title">parse</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span>(value) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span> : <span class="keyword">return</span> CanRent;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span> : <span class="keyword">return</span> RentNow;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span> : <span class="keyword">return</span> Missing;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>BookStatus</code>를 반영한 <code>Book</code> 코드는 다음과 같이 구성됩니다. (lombok을 찬양합시다.)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String comment;</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line">    <span class="keyword">private</span> Date publishDate;</span><br><span class="line">    <span class="keyword">private</span> BookStatus bookStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 <code>User</code>, <code>History</code>에 대한 <code>Entity</code>를 구성해보도록 합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> point;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> level;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">History</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> bookId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> userId;</span><br><span class="line">    <span class="keyword">private</span> HistoryActionType actionType;</span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="DAO의-기능"><a href="#DAO의-기능" class="headerlink" title="DAO의 기능"></a>DAO의 기능</h2><p><code>DAO</code>는 일반적으로 Data에 접근하고 처리할 수 있는 기능들을 제공합니다. 이는 Table의 CRUD기능을 의미하게 됩니다. 이제 일반적인 CRUD의 경우, 다음 Code로 정의가 가능할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookStoreDao</span>&lt;<span class="title">T</span>, <span class="title">K</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">countAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;T&gt; <span class="title">getAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    <span class="function">T <span class="title">getById</span><span class="params">(K id)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">update</span><span class="params">(T entity)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">add</span><span class="params">(T entity)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(T entity)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이렇게 <code>interface</code>를 제공하게 되면, 객체들을 만들때 어떤 객체들을 다 만들어줘야지 되는지를 좀 더 명확히 해줄 수 있습니다. 그리고 구현이 되는 객체가 어떤 일을 할 수 있는지에 대한 선언을 해줄 수 있습니다. 이제 구현되는 <code>BookDao</code>를 한번 구현해 보도록 하겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDao</span> <span class="keyword">implements</span> <span class="title">BookStoreDao</span>&lt;<span class="title">Book</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectionFactory connectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookDao</span><span class="params">(ConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connectionFactory = connectionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection conn = connectionFactory.getConnection();</span><br><span class="line">        PreparedStatement st = conn.prepareStatement(<span class="string">"select count(*) from books"</span>);</span><br><span class="line">        ResultSet rs = st.executeQuery();</span><br><span class="line">        rs.next();</span><br><span class="line"></span><br><span class="line">        Long count = rs.getLong(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        rs.close();</span><br><span class="line">        st.close();</span><br><span class="line">        conn.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> count.intValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection conn = connectionFactory.getConnection();</span><br><span class="line">        PreparedStatement st = conn.prepareStatement(<span class="string">"delete from books"</span>);</span><br><span class="line">        st.execute();</span><br><span class="line">        st.close();</span><br><span class="line">        conn.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection conn = connectionFactory.getConnection();</span><br><span class="line">        PreparedStatement st = conn.prepareStatement(<span class="string">"select id, name, author, status, rentUserId, comment, publishDate from books"</span>);</span><br><span class="line">        ResultSet rs = st.executeQuery();</span><br><span class="line"></span><br><span class="line">        List&lt;Book&gt; books = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">            Book book = <span class="keyword">new</span> Book();</span><br><span class="line">            book.setId(rs.getInt(<span class="string">"id"</span>));</span><br><span class="line">            book.setName(rs.getString(<span class="string">"name"</span>));</span><br><span class="line">            book.setAuthor(rs.getString(<span class="string">"author"</span>));</span><br><span class="line">            java.util.Date date = <span class="keyword">new</span> java.util.Date(rs.getDate(<span class="string">"publishDate"</span>).getTime());</span><br><span class="line">            book.setPublishDate(date);</span><br><span class="line">            book.setBookStatus(BookStatus.parse(rs.getInt(<span class="string">"status"</span>)));</span><br><span class="line">            Integer rentUserId = (Integer) rs.getObject(<span class="string">"rentUserId"</span>);</span><br><span class="line">            book.setRentUserId(rentUserId);</span><br><span class="line">            book.setComment(rs.getString(<span class="string">"comment"</span>));</span><br><span class="line">            books.add(book);</span><br><span class="line">        &#125;</span><br><span class="line">        rs.close();</span><br><span class="line">        st.close();</span><br><span class="line">        conn.close();</span><br><span class="line">        <span class="keyword">return</span> books;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getById</span><span class="params">(Integer id)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection conn = connectionFactory.getConnection();</span><br><span class="line">        PreparedStatement st = conn.prepareStatement(<span class="string">"select id, name, author, publishDate, comment, status, rentUserId from books where id=?"</span>);</span><br><span class="line">        st.setInt(<span class="number">1</span>, id);</span><br><span class="line">        ResultSet rs = st.executeQuery();</span><br><span class="line"></span><br><span class="line">        Book book = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (rs.next()) &#123;</span><br><span class="line">            book = <span class="keyword">new</span> Book();</span><br><span class="line">            book.setId(rs.getInt(<span class="string">"id"</span>));</span><br><span class="line">            book.setName(rs.getString(<span class="string">"name"</span>));</span><br><span class="line">            book.setAuthor(rs.getString(<span class="string">"author"</span>));</span><br><span class="line">            java.util.Date date = <span class="keyword">new</span> java.util.Date(rs.getDate(<span class="string">"publishDate"</span>).getTime());</span><br><span class="line">            book.setPublishDate(date);</span><br><span class="line">            book.setPublishDate(date);</span><br><span class="line">            book.setBookStatus(BookStatus.parse(rs.getInt(<span class="string">"status"</span>)));</span><br><span class="line">            Integer rentUserId = (Integer) rs.getObject(<span class="string">"rentUserId"</span>);</span><br><span class="line">            book.setRentUserId(rentUserId);</span><br><span class="line">            book.setComment(rs.getString(<span class="string">"comment"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        rs.close();</span><br><span class="line">        st.close();</span><br><span class="line">        conn.close();</span><br><span class="line">        <span class="keyword">return</span> book;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">update</span><span class="params">(Book book)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection conn = connectionFactory.getConnection();</span><br><span class="line">        PreparedStatement st = conn.prepareStatement(<span class="string">"update books set name = ?, author = ?, publishDate = ?, comment = ?, status = ?, rentUserId =? where id = ?"</span>);</span><br><span class="line">        st.setString(<span class="number">1</span>, book.getName());</span><br><span class="line">        st.setString(<span class="number">2</span>, book.getAuthor());</span><br><span class="line">        st.setDate(<span class="number">3</span>, <span class="keyword">new</span> java.sql.Date(book.getPublishDate().getTime()));</span><br><span class="line">        st.setString(<span class="number">4</span>, book.getComment());</span><br><span class="line">        st.setInt(<span class="number">5</span>, book.getBookStatus().value());</span><br><span class="line">        st.setObject(<span class="number">6</span>, book.getRentUserId());</span><br><span class="line">        st.setInt(<span class="number">7</span>, book.getId());</span><br><span class="line">        st.execute();</span><br><span class="line"></span><br><span class="line">        st.close();</span><br><span class="line">        conn.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(Book book)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection conn = connectionFactory.getConnection();</span><br><span class="line">        PreparedStatement st = conn.prepareStatement(<span class="string">"insert books(name, author, publishDate, comment, status, rentUserId) values(?, ?, ?, ?, ?, ?)"</span>);</span><br><span class="line">        st.setString(<span class="number">1</span>, book.getName());</span><br><span class="line">        st.setString(<span class="number">2</span>, book.getAuthor());</span><br><span class="line">        java.sql.Date sqlDate = <span class="keyword">new</span> java.sql.Date(book.getPublishDate().getTime());</span><br><span class="line">        st.setDate(<span class="number">3</span>, sqlDate);</span><br><span class="line">        st.setString(<span class="number">4</span>, book.getComment());</span><br><span class="line">        st.setInt(<span class="number">5</span>, book.getBookStatus().value());</span><br><span class="line">        st.setObject(<span class="number">6</span>, book.getRentUserId());</span><br><span class="line">        st.execute();</span><br><span class="line">        st.close();</span><br><span class="line">        conn.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(Book entity)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection conn = connectionFactory.getConnection();</span><br><span class="line">        PreparedStatement st = conn.prepareStatement(<span class="string">"delete from books where id = ?"</span>);</span><br><span class="line">        st.setInt(<span class="number">1</span>, entity.getId());</span><br><span class="line">        st.execute();</span><br><span class="line"></span><br><span class="line">        st.close();</span><br><span class="line">        conn.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 여기서 중복 코드를 제거해보는 절차를 진행해보고자 합니다. 먼저 계속해서나오는 <code>ResultSet</code>을 <code>Book</code>으로 변환시키는 코드가 계속해서 중복되고 있는 것을 볼 수 있습니다.</p>
<p>이를 따로 뽑아내면 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Book <span class="title">convertFromResultSet</span><span class="params">(ResultSet rs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Book book = <span class="keyword">new</span> Book();</span><br><span class="line">    book.setId(rs.getInt(<span class="string">"id"</span>));</span><br><span class="line">    book.setName(rs.getString(<span class="string">"name"</span>));</span><br><span class="line">    book.setAuthor(rs.getString(<span class="string">"author"</span>));</span><br><span class="line">    java.util.Date date = <span class="keyword">new</span> java.util.Date(rs.getDate(<span class="string">"publishDate"</span>).getTime());</span><br><span class="line">    book.setPublishDate(date);</span><br><span class="line">    book.setPublishDate(date);</span><br><span class="line">    book.setBookStatus(BookStatus.parse(rs.getInt(<span class="string">"status"</span>)));</span><br><span class="line">    Integer rentUserId = (Integer) rs.getObject(<span class="string">"rentUserId"</span>);</span><br><span class="line">    book.setRentUserId(rentUserId);</span><br><span class="line">    book.setComment(rs.getString(<span class="string">"comment"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> book;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DB에서 Query를 실행시키는 코드는 두가지의 패턴을 가지고 있습니다. <code>add</code>, <code>update</code>, <code>delete</code>와 같이 query를 실행시키는 코드와 <code>getById</code>, <code>getAll</code>과 같이 query의 실행 후 그 결과(<code>ResultSet</code>)를 이용해서 객체를 만들어주는 코드로 나눌 수 있습니다.</p>
<h3 id="Query를-단순-실행하는-코드"><a href="#Query를-단순-실행하는-코드" class="headerlink" title="Query를 단순 실행하는 코드"></a>Query를 단순 실행하는 코드</h3><p>DB에서 값을 처리하는 과정은 다음과 같습니다.  <code>Connection</code>을 얻어내고 <code>PreparedStatement</code>를 구성하고, <code>PreparedStatement</code>를 <code>Close</code>시켜주고, <code>Connection</code>을 <code>Close</code>시켜주게 됩니다. 이는 정해진 패턴이고 계속되는 중복 코드를 가지고 오게 됩니다.</p>
<p>이제 이 코드는 다음과 같이 보여줄 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">InnerPreparedStatementProcess</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doProcess</span><span class="params">(PreparedStatement st)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeProcess</span><span class="params">(String sql, InnerPreparedStatementProcess process)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Connection conn = connectionFactory.getConnection();</span><br><span class="line">    PreparedStatement st = conn.prepareStatement(sql);</span><br><span class="line">    process.doProcess(st);</span><br><span class="line">    st.execute();</span><br><span class="line">    st.close();</span><br><span class="line">    conn.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이렇게 수정하면 다음 코드들은 다음과 같이 수정이 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">update</span><span class="params">(Book book)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    executeProcess(<span class="string">"update books set name = ?, author = ?, publishDate = ?, comment = ?, status = ?, rentUserId =? where id = ?"</span>, (st) -&gt; &#123;</span><br><span class="line">        st.setString(<span class="number">1</span>, book.getName());</span><br><span class="line">        st.setString(<span class="number">2</span>, book.getAuthor());</span><br><span class="line">        st.setDate(<span class="number">3</span>, <span class="keyword">new</span> java.sql.Date(book.getPublishDate().getTime()));</span><br><span class="line">        st.setString(<span class="number">4</span>, book.getComment());</span><br><span class="line">        st.setInt(<span class="number">5</span>, book.getBookStatus().value());</span><br><span class="line">        st.setObject(<span class="number">6</span>, book.getRentUserId());</span><br><span class="line">        st.setInt(<span class="number">7</span>, book.getId());</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(Book book)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    executeProcess(<span class="string">"insert books(name, author, publishDate, comment, status, rentUserId) values(?, ?, ?, ?, ?, ?)"</span>, (st) -&gt; &#123;</span><br><span class="line">        st.setString(<span class="number">1</span>, book.getName());</span><br><span class="line">        st.setString(<span class="number">2</span>, book.getAuthor());</span><br><span class="line">        java.sql.Date sqlDate = <span class="keyword">new</span> java.sql.Date(book.getPublishDate().getTime());</span><br><span class="line">        st.setDate(<span class="number">3</span>, sqlDate);</span><br><span class="line">        st.setString(<span class="number">4</span>, book.getComment());</span><br><span class="line">        st.setInt(<span class="number">5</span>, book.getBookStatus().value());</span><br><span class="line">        st.setObject(<span class="number">6</span>, book.getRentUserId());</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(Book entity)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    executeProcess(<span class="string">"delete from books where id = ?"</span>, (st) -&gt; &#123;</span><br><span class="line">        st.setInt(<span class="number">1</span>, entity.getId());</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>기존 코드와 비교해서 어느정도 코드가 줄어드는지 확인해보시길 바랍니다. 이렇게 시작 Process와 종료 Process가 동일한데 중간 Action 만이 변경되는 코드를 위와 같이 구성하는 패턴을 <code>Template Pattern</code>이라고 합니다.</p>
<h3 id="Query의-실행결과를-이용하는-경우"><a href="#Query의-실행결과를-이용하는-경우" class="headerlink" title="Query의 실행결과를 이용하는 경우"></a>Query의 실행결과를 이용하는 경우</h3><p>Query를 단순 실행하는 패턴과 거의 동일합니다. 패턴의 코드는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">executeProcess</span><span class="params">(String sql, InnerPreparedStatementAndResultSetProcess&lt;T&gt; process)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Connection conn = connectionFactory.getConnection();</span><br><span class="line">    PreparedStatement st = conn.prepareStatement(sql);</span><br><span class="line"></span><br><span class="line">    process.doProcess(st);</span><br><span class="line"></span><br><span class="line">    ResultSet rs = st.executeQuery();</span><br><span class="line"></span><br><span class="line">    T result = process.convertFromResultSet(rs);</span><br><span class="line"></span><br><span class="line">    rs.close();</span><br><span class="line">    st.close();</span><br><span class="line">    conn.close();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>적용된 Pattern을 적용하면 <code>BookDao</code>는 다음과 같이 변경할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookDao</span> <span class="keyword">implements</span> <span class="title">BookStoreDao</span>&lt;<span class="title">Book</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectionFactory connectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookDao</span><span class="params">(ConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connectionFactory = connectionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String sql = <span class="string">"select count(*) from books"</span>;</span><br><span class="line">        <span class="keyword">return</span> executeProcess(sql, <span class="keyword">new</span> InnerPreparedStatementAndResultSetProcess&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doProcess</span><span class="params">(PreparedStatement st)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Integer <span class="title">convertFromResultSet</span><span class="params">(ResultSet rs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                Long count = rs.getLong(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> count.intValue();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        executeProcess(<span class="string">"delete from books"</span>, (st) -&gt; &#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String sql = <span class="string">"select id, name, author, status, rentUserId, comment, publishDate from books"</span>;</span><br><span class="line">        <span class="keyword">return</span> executeProcess(sql, <span class="keyword">new</span> InnerPreparedStatementAndResultSetProcess&lt;List&lt;Book&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doProcess</span><span class="params">(PreparedStatement st)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">convertFromResultSet</span><span class="params">(ResultSet rs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                List&lt;Book&gt; books = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                    books.add(convertBookFromResultSet(rs));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> books;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">getById</span><span class="params">(Integer id)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String sql = <span class="string">"select id, name, author, publishDate, comment, status, rentUserId from books where id=?"</span>;</span><br><span class="line">        <span class="keyword">return</span> executeProcess(sql, <span class="keyword">new</span> InnerPreparedStatementAndResultSetProcess&lt;Book&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doProcess</span><span class="params">(PreparedStatement st)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                st.setInt(<span class="number">1</span>, id);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Book <span class="title">convertFromResultSet</span><span class="params">(ResultSet rs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                Book book = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (rs.next()) &#123;</span><br><span class="line">                    book = convertBookFromResultSet(rs);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> book;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">update</span><span class="params">(Book book)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        executeProcess(<span class="string">"update books set name = ?, author = ?, publishDate = ?, comment = ?, status = ?, rentUserId =? where id = ?"</span>, (st) -&gt; &#123;</span><br><span class="line">            st.setString(<span class="number">1</span>, book.getName());</span><br><span class="line">            st.setString(<span class="number">2</span>, book.getAuthor());</span><br><span class="line">            st.setDate(<span class="number">3</span>, <span class="keyword">new</span> java.sql.Date(book.getPublishDate().getTime()));</span><br><span class="line">            st.setString(<span class="number">4</span>, book.getComment());</span><br><span class="line">            st.setInt(<span class="number">5</span>, book.getBookStatus().value());</span><br><span class="line">            st.setObject(<span class="number">6</span>, book.getRentUserId());</span><br><span class="line">            st.setInt(<span class="number">7</span>, book.getId());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(Book book)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        executeProcess(<span class="string">"insert books(name, author, publishDate, comment, status, rentUserId) values(?, ?, ?, ?, ?, ?)"</span>, (st) -&gt; &#123;</span><br><span class="line">            st.setString(<span class="number">1</span>, book.getName());</span><br><span class="line">            st.setString(<span class="number">2</span>, book.getAuthor());</span><br><span class="line">            java.sql.Date sqlDate = <span class="keyword">new</span> java.sql.Date(book.getPublishDate().getTime());</span><br><span class="line">            st.setDate(<span class="number">3</span>, sqlDate);</span><br><span class="line">            st.setString(<span class="number">4</span>, book.getComment());</span><br><span class="line">            st.setInt(<span class="number">5</span>, book.getBookStatus().value());</span><br><span class="line">            st.setObject(<span class="number">6</span>, book.getRentUserId());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(Book entity)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        executeProcess(<span class="string">"delete from books where id = ?"</span>, (st) -&gt; &#123;</span><br><span class="line">            st.setInt(<span class="number">1</span>, entity.getId());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">InnerPreparedStatementProcess</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">doProcess</span><span class="params">(PreparedStatement st)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">InnerPreparedStatementAndResultSetProcess</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">doProcess</span><span class="params">(PreparedStatement st)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">        <span class="function">T <span class="title">convertFromResultSet</span><span class="params">(ResultSet rs)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">executeProcess</span><span class="params">(String sql, InnerPreparedStatementAndResultSetProcess&lt;T&gt; process)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection conn = connectionFactory.getConnection();</span><br><span class="line">        PreparedStatement st = conn.prepareStatement(sql);</span><br><span class="line">        process.doProcess(st);</span><br><span class="line">        ResultSet rs = st.executeQuery();</span><br><span class="line">        T result = process.convertFromResultSet(rs);</span><br><span class="line">        rs.close();</span><br><span class="line">        st.close();</span><br><span class="line">        conn.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeProcess</span><span class="params">(String sql, InnerPreparedStatementProcess process)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection conn = connectionFactory.getConnection();</span><br><span class="line">        PreparedStatement st = conn.prepareStatement(sql);</span><br><span class="line">        process.doProcess(st);</span><br><span class="line">        st.execute();</span><br><span class="line">        st.close();</span><br><span class="line">        conn.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Book <span class="title">convertBookFromResultSet</span><span class="params">(ResultSet rs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Book book = <span class="keyword">new</span> Book();</span><br><span class="line">        book.setId(rs.getInt(<span class="string">"id"</span>));</span><br><span class="line">        book.setName(rs.getString(<span class="string">"name"</span>));</span><br><span class="line">        book.setAuthor(rs.getString(<span class="string">"author"</span>));</span><br><span class="line">        java.util.Date date = <span class="keyword">new</span> java.util.Date(rs.getDate(<span class="string">"publishDate"</span>).getTime());</span><br><span class="line">        book.setPublishDate(date);</span><br><span class="line">        book.setPublishDate(date);</span><br><span class="line">        book.setBookStatus(BookStatus.parse(rs.getInt(<span class="string">"status"</span>)));</span><br><span class="line">        Integer rentUserId = (Integer) rs.getObject(<span class="string">"rentUserId"</span>);</span><br><span class="line">        book.setRentUserId(rentUserId);</span><br><span class="line">        book.setComment(rs.getString(<span class="string">"comment"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> book;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>여기서 반영된 코드는 이제 <code>Query</code>를 실행시키는 역활만을 담당하게 됩니다. 이제 좀더 <code>OOP</code>적인 코드가 될 수 있게 됩니다.<br><code>DAO</code>는 DB에 <code>CRUD</code>를 행합니다. <code>DAO</code>에서 <code>CRUD</code>를 처리할 때, 이제 DB에 대한 연결, Query의 전달만을 처리하는 것으로 역활을 담당하면 이 역활을 타 DAO(UserDao, HistoryDao)가 같이 사용할 수 있게 됩니다.</p>
<h2 id="Refactoring-SQL-실행부"><a href="#Refactoring-SQL-실행부" class="headerlink" title="Refactoring SQL 실행부"></a>Refactoring SQL 실행부</h2><p>이제 DB에서의 실행부를 분리해보도록 하겠습니다. <code>SqlExecutor</code>라는 객체로 만들어서 따로 뽑아주고, 그에 대한 interface 역시 정리해줍니다. 그럼 코드는 다음과 같은 형태가 될 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlExecutor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectionFactory connectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SqlExecutor</span><span class="params">(ConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connectionFactory = connectionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">executeProcess</span><span class="params">(String sql, InnerPreparedStatementAndResultSetProcess&lt;T&gt; process)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection conn = connectionFactory.getConnection();</span><br><span class="line">        PreparedStatement st = conn.prepareStatement(sql);</span><br><span class="line">        process.doProcess(st);</span><br><span class="line">        ResultSet rs = st.executeQuery();</span><br><span class="line">        T result = process.convertFromResultSet(rs);</span><br><span class="line">        rs.close();</span><br><span class="line">        st.close();</span><br><span class="line">        conn.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeProcess</span><span class="params">(String sql, InnerPreparedStatementProcess process)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Connection conn = connectionFactory.getConnection();</span><br><span class="line">        PreparedStatement st = conn.prepareStatement(sql);</span><br><span class="line">        process.doProcess(st);</span><br><span class="line">        st.execute();</span><br><span class="line">        st.close();</span><br><span class="line">        conn.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 <code>DAO</code>에서는 <code>ConnectionFactory</code>가 아닌 <code>SqlExecutor</code>를 이용해서 처리하도록 변경합니다. 생성자가 다음과 같이 변경될 필요가 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SqlExecutor sqlExecutor;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BookDao</span><span class="params">(SqlExecutor sqlExecutor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sqlExecutor = sqlExecutor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countAll</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String sql = <span class="string">"select count(*) from books"</span>;</span><br><span class="line">    <span class="keyword">return</span> sqlExecutor.executeProcess(sql, <span class="keyword">new</span> InnerPreparedStatementAndResultSetProcess&lt;Integer&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doProcess</span><span class="params">(PreparedStatement st)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">convertFromResultSet</span><span class="params">(ResultSet rs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            Long count = rs.getLong(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> count.intValue();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 구성된 <code>BookDao</code>, <code>UserDao</code>, <code>HistoryDao</code>를 구성하는 <code>applicaiton-context.xml</code>은 다음과 같습니다. <code>@Configuration</code>도 같이 첨부합니다. 참고해보시길 바랍니다.</p>
<h2 id="코드-정리-Exception의-처리"><a href="#코드-정리-Exception의-처리" class="headerlink" title="코드 정리 - Exception의 처리"></a>코드 정리 - Exception의 처리</h2><p>지금까지 보시면 SqlExecutor를 이용한 코드의 간결화를 해온것을 알 수 있습니다.</p>
<p>마지막으로, 지금 저희 코드에 중복이 되는 코드를 찾아보도록 합시다.<br>딱히 문제가 특출나게 보이지는 않습니다. 지금까지 상당한 refactoring을 통해서 변경시킨 코드에 문제가 쉽게 보이면 그것 역시 문제가 될 수 있습니다.</p>
<p>지금 모든 코드에 나타나 있는 Exception이 선언되어 있습니다. DB access 코드에 원래 일괄적으로 들어가 있어야할 Exception들은 다음과 같습니다.</p>
<ul>
<li>InstantiationException : Class.forName 에서 객체의 이름이 아닌, interface의 이름이 들어간 경우에 발생하는 에러.</li>
<li>IllegalAccessException : Db Connection시, 권한이 없거나 id/password가 틀린 경우에 발생하는 에러</li>
<li>ClassNotFoundException : Class.forName 을 이용, DB Connection 객체를 생성할 때 객체의 이름이 틀린 경우에 발생하는 에러</li>
<li>SQLException : SQL query가 잘못된 Exception입니다.</li>
</ul>
<p>Java는 2개의 Exception type을 가지고 있습니다. checked exception과 Runtime Exception인데요. checked exception의 경우, 이 exception이 발생하는 경우에는 반드시 exception을 처리해줘야지 됩니다. 또는 상위 method로 throw를 해줘야지 됩니다.</p>
<p>Runtime exception은 상위에서 처리를 안해줘도 되고요. 대표적인 것은 NullPointerException, UnsupportedOperationException, IllegalArgumentException 등이 있습니다.</p>
<p>이 부분은 매우 중요한 개념입니다. java에서의 exception은 사용자가 처리해줘야지 될 것(체크 해야지 될 exception)과 Runtime 시(실행시에) 확인되어야지 될 것들로 나뉘게 됩니다. exception에 대하여 보다더 확실한 처리를 해주길 바란 java의 설계 원칙이지만, 근간에는 비판이 좀 많은 부분이기도 합니다. java의 exception에 대한 정리를 한번 해주시는 것이 필요합니다.</p>
<p>그럼, 지금 저희가 사용한 코드중에서 getConnection() method를 확인해보겠습니다. Exception은 원래 이렇게 처리가 되어야지 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> InstantiationException, IllegalAccessException, ClassNotFoundException, SQLException </span>&#123;</span><br><span class="line">    Connection conn = DriverManager.getConnection (<span class="keyword">this</span>.connectionString, <span class="keyword">this</span>.username, <span class="keyword">this</span>.password);</span><br><span class="line">    <span class="keyword">return</span> conn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이 method는 이 4개의 exception을 반드시 처리하도록 되어 있습니다. 또는 이 4개의 exception을 사용한 method로 던져줘서 상위 method에서 처리하도록 되어 있는데요. DB 접속과 SQL query가 잘못된 경우에 대한 exception 처리는 과연 할 수 있을까요? 이 Exception은 처리할 수 없는 Exception을 넘겨줘서 되는 것이 아닌가. 라는 생각을 할 수 있습니다. 잘 보면 대부분의 DB 접속시에 나오는 대부분의 Exception은 처리가 불가능한 Exception이라고 할 수 있습니다. 에러의 내용은 도움이 될 수 있지만, 이 에러가 발생했을 때 어떠한 처리를 하지를 못하는 경우가 대다수라는거지요.</p>
<p>어떤 방법으로 Exception을 처리할지는 이 코드를 사용하는 곳에서 어떻게 할지를 정해보는것이 좋습니다. 예를 들어, <code>SqlExecutor</code>에서 발생하는 에러를 모두 <code>DaoException</code>으로 만들어서 처리하고, log를 남기는 것도 방법입니다.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><ul>
<li>객체간의 코드중복은 최대한 줄여야지 됩니다. 이를 남겨두면 결국은 코드의 기술부채로서 남습니다.</li>
<li>코드중복을 없애는 방법중에서 유용하지만, 어렵지만 좋은 Pattern이 Template Pattern을 이용해서 처리하는 것입니다.</li>
<li>Java의 Exception은 Check-Exception과 Runtime-Exception으로 구분되고 있습니다. java나 library들에서 제공되는 객체들의 Check-Exception은 남겨두는 것이 좋지만, BL Logic에서의 Check-Exception은 독이 되는 것이 대부분입니다. Runtime-Exception 으로 변경시켜서 처리하는 것이 좋습니다.</li>
</ul>
<p>다음은 지금까지 구성된 코드를 <code>Spring</code>으로 구성되는 BookStore를 만나보실 수 있을 것입니다.</p>
<p>ps: UserDao, HistoryDao 코드를 모두 만들어서 와주시길 바랍니다.</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/study-java-refactoring/">study, java, refactoring</a>
    </span>
    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2018/02/01/05-03-sample-app-md/"><span>05-03.SampleApplication(3)</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2018/02/01/05-03-sample-app-md/" rel="bookmark">
        <time class="entry-date published" datetime="2018-02-01T03:48:40.000Z">
          2018-02-01
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="SampleApplication-3-DIP"><a href="#SampleApplication-3-DIP" class="headerlink" title="SampleApplication(3) - DIP"></a>SampleApplication(3) - DIP</h1><p>지금까지 간단한 코드와 그 코드에 대한 테스트를 행하는 방법에 대해서 알아봤습니다. 그리고 간단한 table의 CRUD를 하는 방법에 대해서 조금 깊게 들어가봤습니다. 또한 저번 시간의 최대 포인트는 테스트입니다. 테스트를 어떻게 작성을 하는지에 대한 논의와 테스트 코드를 직접 사용해보는 시간을 가져봤습니다. 이번 시간에는 드디어 Spring을 이용한 코드에 대해서 논의해보도록 하겠습니다.기존 코드의 가장 큰 문제는 무엇인가요?</p>
<ul>
<li>DB connection이 변경되는 경우, compile을 다시 해줘야지 된다.</li>
<li>DB connection의 open/close가 모든 method에서 반복된다.</li>
</ul>
<p>크게 보면 이 두가지의 문제가 나오게 됩니다.</p>
<p>Connection은 외부에서 설정할 수 있는 영역입니다. 특히 이런 부분은 config file로 관리가 되는 것이 일반적이고, Enterprise 구성환경에서는 JNDI를 이용한 DB Connection이 제공되는 경우도 많습니다. 따라서, 외부에서 설정이 가능한 것이라고 생각해도 좋습니다. 또한, BookApp은 books table에 CRUD를 하는 것을 목적으로 하는 객체입니다. 객체에 대한 가장 큰 원칙인 단일 책임의 원칙에 의해서, BookApp에서 Connection까지 관리가 되는 것은 영역을 넘어가게 됩니다. 또한, books 이외의 table이 존재할 때, Connection에 대한 코드는 중복될 수 밖에 없는 코드가 됩니다. 따라서 Connection을 제공하는 객체로 따로 분리를 해줍시다.</p>
<p>Connection을 관리, 생성하는 객체이기 때문에 ConnectionFactory라고 명명하고, 객체를 구성합니다. 객체의 코드는 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String connectionString;</span><br><span class="line">    <span class="keyword">private</span> String driverName;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> InstantiationException, IllegalAccessException,</span></span><br><span class="line"><span class="function">                                             ClassNotFoundException, SQLException </span>&#123;</span><br><span class="line">        Class.forName(<span class="keyword">this</span>.driverName).newInstance();</span><br><span class="line">        <span class="keyword">return</span> DriverManager.getConnection(<span class="keyword">this</span>.connectionString, <span class="keyword">this</span>.username, <span class="keyword">this</span>.password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConnectionString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> connectionString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConnectionString</span><span class="params">(String connectionString)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connectionString = connectionString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDriverName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> driverName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDriverName</span><span class="params">(String driverName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.driverName = driverName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DB의 connection을 관리하는 객체입니다. conneciton만을 관리하기 때문에 <code>단일책임원칙</code>에 맞는 코드라고 할 수 있을 것입니다. 여기서 잠시 다른 곳으로 가서 코드를 좀 더 편하게 적을 방법을 찾아봅시다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compileOnly group: 'org.projectlombok', name: 'lombok', version: '<span class="number">1</span>.<span class="number">16</span>.<span class="number">18</span>'</span><br></pre></td></tr></table></figure>
<p>를 추가합시다.</p>
<p>이제 추가 한 후에는 다음과 같이 코드를 작성할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> String connectionString;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> String driverName;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> InstantiationException, IllegalAccessException,</span></span><br><span class="line"><span class="function">                                             ClassNotFoundException, SQLException </span>&#123;</span><br><span class="line">        Class.forName(<span class="keyword">this</span>.driverName).newInstance();</span><br><span class="line">        <span class="keyword">return</span> DriverManager.getConnection(<span class="keyword">this</span>.connectionString, <span class="keyword">this</span>.username, <span class="keyword">this</span>.password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@Getter</code>, <code>@Setter</code>라는 annotation으로 원 코드를 대신해서 사용할 수 있습니다. 코드의 가독성을 높일 수 있는 장점을 갖습니다. 개인적으로 추천하는 library입니다.<br>그리고, 이 객체는 <code>connectionString</code>, <code>driverName</code>, <code>username</code>, <code>password</code> 중 하나라도 없다면 실행할 수 없는 객체입니다. 따라서 생성자에 전 값을 다 추가하는 것이 좋습니다. 이는 객체의 사용방법을 명확히 지정할 수 있습니다.</p>
<p>이제 간략화된 코드를 다시 구성합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionFactory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String driverName;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String connectionString;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String username;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> InstantiationException, IllegalAccessException,</span></span><br><span class="line"><span class="function">        ClassNotFoundException, SQLException </span>&#123;</span><br><span class="line">        Class.forName(<span class="keyword">this</span>.driverName).newInstance();</span><br><span class="line">        <span class="keyword">return</span> DriverManager.getConnection(<span class="keyword">this</span>.connectionString, <span class="keyword">this</span>.username, <span class="keyword">this</span>.password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>그리고, 이에 대한 테스트 코드를 작성합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doConnectionFactoryTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory(<span class="string">"org.mariadb.jdbc.Driver"</span>,</span><br><span class="line">        <span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>, <span class="string">"root"</span>, <span class="string">"qwer12#$"</span>);</span><br><span class="line">    assertThat(connectionFactory).isNotNull();</span><br><span class="line">    assertThat(connectionFactory.getConnection()).isNotNull();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>를 이용해서 테스트를 진행합니다.</p>
<p><code>ConnectionFactory</code>를 적용한 <code>BookService</code>를 만들어보도록 합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectionFactory connectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookService</span><span class="params">(ConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connectionFactory = connectionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Book book)</span> <span class="keyword">throws</span> InstantiationException, IllegalAccessException, ClassNotFoundException, SQLException </span>&#123;</span><br><span class="line">        Connection conn = connectionFactory.getConnection();</span><br><span class="line">        PreparedStatement st = conn.prepareStatement(<span class="string">"insert books(name, author, publishDate, comment) values(?, ?, ?, ?)"</span>);</span><br><span class="line">        st.setString(<span class="number">1</span>, book.getName());</span><br><span class="line">        st.setString(<span class="number">2</span>, book.getAuthor());</span><br><span class="line">        java.sql.Date sqlDate = <span class="keyword">new</span> java.sql.Date(book.getPublishDate().getTime());</span><br><span class="line">        st.setDate(<span class="number">3</span>, sqlDate);</span><br><span class="line">        st.setString(<span class="number">4</span>, book.getComment());</span><br><span class="line">        st.execute();</span><br><span class="line"></span><br><span class="line">        st.close();</span><br><span class="line">        conn.close();</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 테스트 코드 역시 같이 업데이트 시켜야지 됩니다. 우리가 만든 코드를 테스트할 수 있어야지 되니까요.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory(<span class="string">"org.mariadb.jdbc.Driver"</span>,</span><br><span class="line">        <span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>, <span class="string">"root"</span>, <span class="string">"qwer12#$"</span>);</span><br><span class="line">    bookService = <span class="keyword">new</span> BookService(connectionFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="IoC-DI"><a href="#IoC-DI" class="headerlink" title="IoC, DI"></a>IoC, DI</h2><p>지금 우리는 테스트 코드내에서 코드가 실행되고 있습니다. 테스트 코드입장에서 생각해보도록 하겠습니다.</p>
<p>우리는 지금 테스트 코드에서 <code>BookService</code>를 실행시키고 있습니다. 그리고 <code>BookService</code>에서 사용할 <code>ConnectionFactory</code>를 <code>BookServiceTest</code>에서 구성해서 사용하고 있습니다.<br>조금 말을 바꿔보면 <code>사용하는 Instance에서 사용할 Instance의 구성을 결정하고 있습니다.</code> 이를 <code>IoC</code>라고 합니다.</p>
<p>여기서, Spring의 가장 주요한 기능을 사용할 때가 되었습니다.</p>
<p>Spring은 <code>IoC</code>를 지원하는 <code>light container</code>입니다.</p>
<p>조금 더 말을 풀어서 표현하면 <strong>Spring은 <code>IoC</code>를 <code>DI(dependency injection)</code>를 통해 지원하는 <code>light container</code>입니다.</strong><br>말이 어려워서 예시를 이용해서 이야기한다면 다음과 같습니다.</p>
<ul>
<li>BookService은 ConnectionFactory에 의존한다.</li>
<li>BookServiceTest는 BookService에 의존한다.</li>
<li>BookServiceTest는 BookService의 ConnectionFactory를 어떻게 바꾸어서 사용할지까지 결정이 가능하다.</li>
</ul>
<p>이는 <code>BookServiceTest</code>는 <code>BookService</code>를 사용하고 있지만, <code>BookService</code>가 의존하고 있는 <code>ConnectionFactory</code>를 자신이 결정해서 사용하고 있습니다. 이때, 의존하는 객체를 변경하는 행위를 <code>DI</code>라고 합니다. 따라서 이 경우를 조금더 어렵게 말하면 다음과 같습니다.</p>
<p><strong>BookServiceTest는 BookService를 DI를 통해 ConnectionFactory를 주입(inject)하여 사용하는 코드입니다.</strong></p>
<p>지금 이야기드린 <code>IoC</code>와 <code>DI</code>는 Spring에서 굉장히 중요한 개념입니다. Spring의 본질이라고 할 수 있습니다. 단순히 <code>WebMvc</code>를 제공하고 있는 것이 Spring이 아닙니다.<br>좀 더 깊게 들어가보도록 하겠습니다.</p>
<h3 id="IoC-Inversion-of-Control"><a href="#IoC-Inversion-of-Control" class="headerlink" title="IoC(Inversion of Control)"></a>IoC(Inversion of Control)</h3><p>IoC는 전통적인 방식에 반대되는 흐름으로 코드가 진행되는 것을 말하는 일반적인 용어입니다. Dependency Injection과 많이 혼동되는데 다른 개념입니다. 오히려 Dependency Inversion Principle이 IoC의 한 형태입니다.</p>
<p>라이브러리와 프레임워크의 관계는 IoC를 설명하는 단골 예입니다. 라이브러리를 사용할 때는 내 코드가 라이브러리 코드(외부 코드)를 호출하지만 프레임워크를 사용할 때는 프레임워크(외부 코드)가 내 코드를 호출합니다. 상호작용(interactive) 프로그래밍 모델과 반응형(reactive) 프로그래밍 모델도 하나의 예입니다.</p>
<p>IoC는 헐리웃에서 오디션이 끝난 후 오디션 참가자에게 하는 말때문에 <code>Hollywood Principle</code>로 불리기도 합니다</p>
<h3 id="DIP-Depencency-Inversion-Principal"><a href="#DIP-Depencency-Inversion-Principal" class="headerlink" title="DIP(Depencency Inversion Principal)"></a>DIP(Depencency Inversion Principal)</h3><p><code>IoC</code>는 <code>DIP</code> 원칙을 구현하는 대표적인 방법입니다. 이는 의존관계를 갖는 모듈 인스턴스의 구성이 추상화에 의존하는 것을 뜻합니다.</p>
<p>좀 더 풀어서 설명하면 추상성이 높고 안정적인 의존 주체 클래스는 구체적이고 불안정한 의존 대상 클래스에 의존해서는 안된다는 원칙으로서, 일반적으로 객체지향의 인터페이스를 통해서 이 원칙을 준수할 수 있게 된다. (상대적으로 고수준인) 클라이언트는 저수준의 클래스에서 추상화한 인터페이스만을 바라보기 때문에, 이 인터페이스를 구현한 클래스는 클라이언트에 어떤 변경도 없이 얼마든지 나중에 교체될 수 있다는 원칙입니다.</p>
<p>말이 계속해서 어려워집니다. 사전적 정의는 더 어렵습니다. 참고로 <code>DIP</code>는 객체지향 프로그래밍의 5대 원칙중 하나입니다.</p>
<blockquote>
<p>SOLID - SRP(단일 책임원칙), OCP(개방-폐쇄 원칙), LSP(리스코치환원칙), ISP(인터페이스분리원칙), DIP(의존성 역전 원칙)</p>
<p>High-level modules should not depend on low-level modules. Both should depend on abstractions.<br>Abstractions should not depend on details. Details should depend on abstractions.</p>
</blockquote>
<p>우리가 개발하는 의존 주체 모듈 인스턴스(BookStore)가 의존 대상 모듈 인스턴스(ConnectionFactory)를 직접 생성하는 것을 전통적 흐름이라고 하면 이 전통적 흐름에서는 의존 대상 코드의 형식이 의존 주체 코드에 의해 결정되기 때문에 의존 대상 코드의 다형성이 동작하기 어렵습니다. 반면 <code>DIP</code> 원칙이 적용되면 구체적인 의존 관계가 추상화에 의해 사용시에 결정되기 때문에 다형성을 적극적으로 활용할 수 있으며 모듈의 재사용성이 높아집니다.</p>
<p>기본적으로 <code>DIP</code>를 따르기 위해서는 의존 주체 모듈 인스턴스와 의존 대상 모듈 인스턴스간의 직접적인 연결이 아닌 중간단계의 <code>interface</code>를 통해서 구현하게 됩니다.</p>
<p>말이 어렵습니다. 코드로서 보면서 이해하는 것이 더 쉽습니다. <code>BookService</code>에 <code>DIP</code>가 적용되지 않을때, 다음과 같이 사용되게 됩니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ConnectionFactory connectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory(<span class="string">"org.mariadb.jdbc.Driver"</span>,</span><br><span class="line">            <span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>, <span class="string">"root"</span>, <span class="string">"qwer12#$"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드에서 <code>DIP</code>가 적용되지 않은 <code>BookService</code>는 <code>ConnectionFactory</code>에 의존적이게 됩니다. 만약에 <code>ConnectionFactory</code>가 변경이 되게 되면 이는 <code>BookService</code>에 영향을 미치게 됩니다. 이는 세부사항(detail)이 구현(Abstractions)를 변경시키는 영향을 미치게 됩니다. <code>DIP</code>를 적용하기 위한 방법으로 <code>DI(Dependency Injection)</code>와 <code>Service Locator</code> 방법이 있습니다.</p>
<h3 id="DI-Dependency-Injection"><a href="#DI-Dependency-Injection" class="headerlink" title="DI(Dependency Injection)"></a>DI(Dependency Injection)</h3><p>많은 사람들이 <code>DI</code>와 <code>DIP</code>를 혼동합니다. <code>DI</code>는 <code>DIP</code>를 구현하는 기법 중 하나입니다. 의존 주체 모듈의 노출된 멤버를 통해 의존 대상 모듈 인스턴스가 제공됩니다. Dependency Injection은 다시 세부적으로 구분될 수 있습니다.</p>
<h4 id="Constructor-Injection"><a href="#Constructor-Injection" class="headerlink" title="Constructor Injection"></a>Constructor Injection</h4><p>Dependency Injection 중 가장 많이 사용되는 방법입니다. 의존 주체 모듈의 생성자 매개변수로 의존 대상 모듈 인스턴스가 주입됩니다. 의존 주체 인스턴스가 생성됨과 동시에 의존성이 해결되기 때문에 일단 의존 주체 인스턴스가 생성되면 의존성 해결 여부를 검사할 필요가 없습니다. 정적 언어의 경우 의존성이 해결되지 않으면 의존 주체 인스턴스를 생성할 수 없기 때문에 모듈간 의존 관계가 문법적으로 명확하게 드러나며 의존성이 누락될 위험이 컴파일러에 의해 차단됩니다.</p>
<h4 id="Property-Injection"><a href="#Property-Injection" class="headerlink" title="Property Injection"></a>Property Injection</h4><p>공용으로 노출된 쓰기 가능한 속성을 통해 의존성을 주입하는 방법입니다. Setter Injection이라고도 부릅니다. 속성이 외부에 노출된 정보를 의미하는지 의존 대상 모듈을 의미하는지 별도의 설명이 없으면 구분하기 어렵습니다. 속성 설정은 의존 주체 인스턴스가 생성된 후에 진행되기 때문에 의존 주체 인스턴스는 필요한 의존성이 해결되지 않은 상태일 수 있습니다.</p>
<h4 id="DI를-이용한-코드-구성"><a href="#DI를-이용한-코드-구성" class="headerlink" title="DI를 이용한 코드 구성"></a>DI를 이용한 코드 구성</h4><p><code>Constructor Injection</code>과 <code>Property Injection</code> 중에서, 예전에는 <code>Property Injection</code>을 권장했습니다. 지금은 압도적으로 <code>Constructor Injection</code>을 선호합니다.<br><code>Constructor Injection</code>을 이용해서 <code>BookService</code>를 구성하면 다음과 같이 구성이 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConnectionFactory</span> </span>&#123;</span><br><span class="line">    <span class="function">Connnection <span class="title">getConnection</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ConnectionFactory connectionFactory;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookService</span><span class="params">(ConnectionFactory connectionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connectionFactory = connectionFactory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySqlConnectionFactoryImpl</span> <span class="keyword">implements</span> <span class="title">ConnectionFactory</span> </span>&#123;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OracleSqlConnectionFactoryImpl</span> <span class="keyword">implements</span> <span class="title">ConnectionFactory</span> </span>&#123;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        BookService bookServiceWithMySql = <span class="keyword">new</span> BookService(<span class="keyword">new</span> MySqlConnectionFactoryImpl());</span><br><span class="line">        BookService bookServiceWithOracle = <span class="keyword">new</span> BookService(<span class="keyword">new</span> OracleMySqlConnectionFactoryImpl());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위와 같이 구성하게 되면, <code>BookService</code>는 의존성이 <code>interface</code>만 연결이 되게 되며 이는 결합성이 매우 낮은 코드로 사용할 수 있게 됩니다.</p>
<h3 id="Service-Locator"><a href="#Service-Locator" class="headerlink" title="Service Locator"></a>Service Locator</h3><p>Service Locator는 Dependency Injection과는 다른 Dependency Inversion Principle 적용법입니다. Dependency Injection에서 의존 주체 모듈은 의존성을 외부의 주입에 의해 수동적으로 해결하는 반면 Service Locator를 사용하는 의존 주체 모듈은 의존성이 필요한 시점에 능동적으로 의존성 해결을 Service Locator에 요청합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConnectionFactory</span> </span>&#123;</span><br><span class="line">    <span class="function">Connnection <span class="title">getConnection</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IServiceLocator serviceLocator = IServiceLocator.current();</span><br><span class="line">        <span class="keyword">return</span> serviceLocator.resolve(ConnectionFactory.class).getConnection();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        IServiceLocator serviceLocator = IServiceLocator.current();</span><br><span class="line">        serviceLocator.add(<span class="keyword">new</span> MySqlConnectionFactoryImpl());</span><br><span class="line">        BookService bookServiceWithMySql = <span class="keyword">new</span> BookService();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Service Locator는 의존 주체 모듈이 <code>Service Locator</code>를 통해 능동적으로 자신이 사용할 객체들을 찾아서 사용합니다.</p>
<p>Dependency Injection과의 차이점은 다음과 같습니다.</p>
<ul>
<li><code>Service Locator</code>가 적용된 의존 주체 모듈은 외부 모듈 의존관계가 노출되지 않습니다. 위 코드에서는 <code>ConnectionFactory</code>를 사용하는 것을 알아낼 수 없습니다.</li>
<li>의존 주체 모듈은 <code>Service Locator</code>를 직접 사용하기 때문에 <code>Service Locator</code>의 존재를 알고 있으며 필수적으로 의존합니다.</li>
<li><code>Service Locator</code>가 정적인(static) 코드를 통해 제공되기 때문에 병렬(parallel) 테스팅이 어렵습니다.</li>
</ul>
<hr>
<h2 id="Spring을-이용한-IoC-DI"><a href="#Spring을-이용한-IoC-DI" class="headerlink" title="Spring을 이용한 IoC/DI"></a>Spring을 이용한 IoC/DI</h2><p>Spring에서는 <code>IoC</code>를 제공하기 위해서 <code>DI</code>를 이용합니다.<br>Spring을 이용하는 방법을 알아보도록 하겠습니다. 먼저 Spring의 Core만을 추가해서 진행해보도록 하겠습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">compile group: 'org.springframework', name: 'spring-context', version: '<span class="number">5</span>.<span class="number">0</span>.<span class="number">2</span>.RELEASE'</span><br><span class="line">testCompile group: 'org.springframework', name: 'spring-test', version: '<span class="number">5</span>.<span class="number">0</span>.<span class="number">2</span>.RELEASE'</span><br></pre></td></tr></table></figure>
<p>Spring에서는 <code>IoC</code>를 위한 <code>DI</code> 구성을 <code>Configuration</code>이라고 합니다. 이는 <code>xml</code>과 <code>class</code>로 처리가 가능합니다. 먼저 옛날부터 사용하고 있던 <code>xml</code>을 우선 알아보도록 하겠습니다.</p>
<h3 id="xml"><a href="#xml" class="headerlink" title="xml"></a>xml</h3><p><code>xml</code>파일을 다음과 같이 선언합니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version = "1.0" encoding = "UTF-8"?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.bookstore.ConnectionFactory"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">type</span>=<span class="string">"String"</span> <span class="attr">value</span>=<span class="string">"org.mariadb.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">type</span>=<span class="string">"String"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"2"</span> <span class="attr">type</span>=<span class="string">"String"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"3"</span> <span class="attr">type</span>=<span class="string">"String"</span> <span class="attr">value</span>=<span class="string">"qwer12#$"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"bookService"</span> <span class="attr">class</span>=<span class="string">"com.xyzlast.bookstore.BookService"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">ref</span>=<span class="string">"connectionFactory"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Spring은 <code>ApplicationContext</code>라는 개념을 가지고 있습니다. <code>ApplicationContext</code>는 이름 그대로 Application에서 사용되는 내용들을 정의하는 역활을 담당합니다. 전에 설명했던 <code>IoC</code>를 위한 <code>DI</code>구성을 정의합니다. 그리고, 정의된 파일을 이용해서 객체를 사용하는 방법은 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBookServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        context = <span class="keyword">new</span> GenericXmlApplicationContext(<span class="string">"/application-context.xml"</span>);</span><br><span class="line">        assertThat(context).isNotNull();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkBeans</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConnectionFactory connectionFactory01 = (ConnectionFactory) context.getBean(<span class="string">"connectionFactory"</span>);</span><br><span class="line">        ConnectionFactory connectionFactory02 = (ConnectionFactory) context.getBean(<span class="string">"connectionFactory"</span>);</span><br><span class="line">        assertThat(connectionFactory01).isEqualTo(connectionFactory02);</span><br><span class="line"></span><br><span class="line">        BookService bookService = context.getBean(BookService.class);</span><br><span class="line">        assertThat(bookService).isNotNull();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>checkBeans</code> 내부를 보면 <code>new</code>를 이용하지 않고, 모든 객체를 사용할 수 있는 것을 볼 수 있습니다. 특이한점이 <code>ConnectionFactory</code>입니다. 두번 객체를 얻어내도 같은 객체로 얻어지는 것을 볼 수 있습니다. 여기서 <code>BookService</code>를 보면 <code>ref</code> 키워드를 이용해서 기존에 만들어진 <code>ConnectionFactory</code>를 <code>BookService</code>에 주입할 수 있는것을 볼 수 있습니다.</p>
<h3 id="Configuration을-이용"><a href="#Configuration을-이용" class="headerlink" title="@Configuration을 이용"></a>@Configuration을 이용</h3><p>Spring에서는 <code>xml</code> 파일이 아닌, <code>@Configuration</code>을 이용하는 것을 좀 더 권장하는 편입니다. <code>@Configuration</code>으로 구성하는 방법은 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookServiceConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConnectionFactory <span class="title">connectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory(<span class="string">"org.mariadb.jdbc.Driver"</span>,</span><br><span class="line">            <span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>, <span class="string">"root"</span>, <span class="string">"qwer12#$"</span>);</span><br><span class="line">        <span class="keyword">return</span>  connectionFactory;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BookService <span class="title">bookService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BookService(connectionFactory());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>구성한 <code>@Configuration</code>은 다음과 같이 활용 가능합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkBeansWithConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(BookServiceConfiguration.class);</span><br><span class="line">    assertThat(context).isNotNull();</span><br><span class="line"></span><br><span class="line">    ConnectionFactory connectionFactory01 = (ConnectionFactory) context.getBean(<span class="string">"connectionFactory"</span>);</span><br><span class="line">    ConnectionFactory connectionFactory02 = (ConnectionFactory) context.getBean(<span class="string">"connectionFactory"</span>);</span><br><span class="line">    assertThat(connectionFactory01).isEqualTo(connectionFactory02);</span><br><span class="line"></span><br><span class="line">    BookService bookService = context.getBean(BookService.class);</span><br><span class="line">    assertThat(bookService).isNotNull();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="xml-vs-Configuration"><a href="#xml-vs-Configuration" class="headerlink" title="xml vs @Configuration"></a>xml vs @Configuration</h3><p>이 방법들중에서 어떤 방법이 더 좋을지는 개발자들의 취향에 따라서 다르게 할 수도 있습니다. 그런데, 지금 Spring에서 제공되는 Sample이나 강의 대부분이 이젠 <code>@Configuration</code>을 사용하고 있습니다.</p>
<p>예전 코드에 대한 유지보수의 경우에는 ‘xml’을 사용하는 것이 좋겠지만, 신규 Application이나 <code>SpringBoot</code>를 이용하는 Application은 <code>@Configuration</code>을 이용하는것이 좋습니다.</p>
<h3 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h3><p>Spring을 사용한 객체의 사용의 장점은 크게 3가지로 볼 수 있습니다.</p>
<ol>
<li>정해진 규칙에 따른 객체의 선언</li>
<li>정의된 객체의 dependency 파악이 가능</li>
<li>테스트의 편의성</li>
</ol>
<p>먼저 정해진 규칙에 따른 객체의 선언은 팀단위의 개발자들에게 일정한 개발 패턴을 만들어줍니다. 정해진 개발 패턴은 정형화된 코드를 만들고, 서로간에 코드의 공유가 원활하게 할 수 있습니다. 그리고, xml을 통한 객체의 의존성 관리는 객체들이 어떠한 구조를 가지고 있는지를 파악하는데 도움을 줍니다. 마지막으로 테스트의 편의성을 들 수 있습니다. spring은 테스트 코드를 작성하는데, 지금까지 보던 코드보다 더욱 깔끔하고 쉬운 테스트 패턴을 제공하고 있습니다. Spring을 사용한 테스트 코드를 다시 한번 알아보도록 하겠습니다.</p>
<p>Spring은 spring-test를 통해 테스트를 구성할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(classes = BookServiceConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBookServiceTest2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        assertThat(context).isNotNull();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkBeansWithConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConnectionFactory connectionFactory01 = (ConnectionFactory) context.getBean(<span class="string">"connectionFactory"</span>);</span><br><span class="line">        ConnectionFactory connectionFactory02 = (ConnectionFactory) context.getBean(<span class="string">"connectionFactory"</span>);</span><br><span class="line">        assertThat(connectionFactory01).isEqualTo(connectionFactory02);</span><br><span class="line"></span><br><span class="line">        BookService bookService = context.getBean(BookService.class);</span><br><span class="line">        assertThat(bookService).isNotNull();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@RunWith</code>와 <code>@ContextConfiguration</code>을 통해 로드된 <code>application-context</code>를 재사용이 됩니다. 여러개의 테스트코드를 작성할때, 속도를 위해 꼭 사용되어야지 되는 코드입니다.</p>
<h2 id="객체의-생명주기"><a href="#객체의-생명주기" class="headerlink" title="객체의 생명주기"></a>객체의 생명주기</h2><p>spring에서의 객체의 생명 주기는 기본적으로 한번 사용된 객체를 재사용합니다. 테스트 코드를 통해서 이를 확인해보도록 하겠습니다.<br>구성된 코드에 System.out.println 을 이용해서 bookApp 객체의 instance id를 확인해보도록 하겠습니다.</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Dec <span class="number">23</span>, <span class="number">2017</span> <span class="number">1</span>:<span class="number">23</span>:<span class="number">48</span> PM org.springframework.context.support.AbstractApplicationContext prepareRefresh</span><br><span class="line"><span class="function">INFO: <span class="title">Refreshing</span> <span class="title">org.springframework.context.support.GenericApplicationContext</span>@59<span class="title">f99ea</span>: <span class="title">startup</span> <span class="title">date</span> [<span class="title">Sat</span> <span class="title">Dec</span> 23 13:23:48 <span class="title">KST</span> 2017]; <span class="title">root</span> <span class="title">of</span> <span class="title">context</span> <span class="title">hierarchy</span></span></span><br><span class="line"><span class="function"><span class="title">com.xyzlast.bookstore.ConnectionFactory</span>@4802796<span class="title">d</span></span></span><br><span class="line"><span class="function"><span class="title">com.xyzlast.bookstore.ConnectionFactory</span>@4802796<span class="title">d</span></span></span><br><span class="line"><span class="function"><span class="title">com.xyzlast.bookstore.ConnectionFactory</span>@4802796<span class="title">d</span></span></span><br><span class="line"><span class="function"><span class="title">Dec</span> 23, 2017 1:23:49 <span class="title">PM</span> <span class="title">org.springframework.context.support.AbstractApplicationContext</span> <span class="title">doClose</span></span></span><br></pre></td></tr></table></figure>
<p>보시면 ConnectionFactory의 모든 객체 Id가 동일함을 알 수 있습니다. ApplictionContext에 저장된 객체를 얻을 때, 새로 생성하는 것이 아닌 기존의 객체를 계속해서 사용하는 것을 알 수 있습니다.<br>왜 모든 객체들을 기본적으로 재사용하게 될까요? 기본적으로 spring은 enterprise development framework입니다. enterprise급의 대규모 시스템에서는 객체의 생성/삭제가 많은 부담을 주게 됩니다. 이에 대한 해결 방법으로 spring은 application context가 로드 될 때, 기본 객체들을 모두 생성, 로드 하는 것을 기본으로 하고 있습니다. 물론, 다른 방법역시 가능합니다.</p>
<p>Spring에서의 객체의 생명주기는 scope로 불리고, 다음 4가지로 관리가 가능합니다.</p>
<p>1.singleton<br>2.prototype<br>3.session<br>4.request</p>
<p>singleton은 default 값입니다. scope를 따로 설정하지 않으면 모두 singleton으로 동작합니다. 이는 객체를 static object와 동일하게 사용하게 됩니다.</p>
<p>prototype은 일반적으로 저희가 사용하던 객체의 생성방법과 동일합니다. new 를 통해서 객체를 생성하고, property 값을 모두 설정시킨 후, 그 객체를 넘겨주게 됩니다.</p>
<p>session과 request는 web programming에서 사용되는 scope입니다. 새로운 session이 생성될 때, 새로운 request가 생성이 될때 사용될 수 있는 scope 입니다.</p>
<p>크게는 singleton과 prototype을 이용하면 대부분의 객체 생명주기 관리는 가능합니다. 생명주기선언은 다음과 같습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Scope</span>(value = BeanDefinition.SCOPE_SINGLETON)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ConnectionFactory <span class="title">connectionFactoryWithSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory(<span class="string">"org.mariadb.jdbc.Driver"</span>,</span><br><span class="line">        <span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>, <span class="string">"root"</span>, <span class="string">"qwer12#$"</span>);</span><br><span class="line">    <span class="keyword">return</span>  connectionFactory;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Scope</span>(value = BeanDefinition.SCOPE_PROTOTYPE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ConnectionFactory <span class="title">connectionFactoryWithProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory(<span class="string">"org.mariadb.jdbc.Driver"</span>,</span><br><span class="line">        <span class="string">"jdbc:mysql://127.0.0.1:4306/bookstore"</span>, <span class="string">"root"</span>, <span class="string">"qwer12#$"</span>);</span><br><span class="line">    <span class="keyword">return</span>  connectionFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 생성된 코드에 대한 테스트는 다음과 같이 진행할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkBeanLifeCycle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ConnectionFactory singleton01 = (ConnectionFactory) context.getBean(<span class="string">"connectionFactoryWithSingleton"</span>);</span><br><span class="line">    ConnectionFactory singleton02 = (ConnectionFactory) context.getBean(<span class="string">"connectionFactoryWithSingleton"</span>);</span><br><span class="line">    assertThat(singleton01.hashCode()).isEqualTo(singleton02.hashCode());</span><br><span class="line"></span><br><span class="line">    ConnectionFactory proxy01 = (ConnectionFactory) context.getBean(<span class="string">"connectionFactoryWithProxy"</span>);</span><br><span class="line">    ConnectionFactory proxy02 = (ConnectionFactory) context.getBean(<span class="string">"connectionFactoryWithProxy"</span>);</span><br><span class="line">    assertThat(proxy01.hashCode()).isNotEqualTo(proxy02.hashCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이 코드를 확인해보시면 아시겠지만 Factory Pattern에서의 Factory와 동일한 기능을 가지게 되는 것을 알 수 있는데요. <strong>ApplicationContext는 bean의 Map과 Factory를 지원한다.</strong> 라고 할 수 있습니다.<br>spring을 사용하게 되면, 객체들을 new로 새롭게 할당하는 일들이 얼마 없습니다. 아니 new를 안쓰고 만들 수 있어야지 됩니다. 모든 객체 bean들은 spring을 통해서 관리가 되고, bean들간의 데이터 교환을 위한 POJO(Plain Old Java Object)들만 new로 생성되어서 데이터 교환이 되는 것이 일반적인 패턴입니다.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>이번 장에서는 Spring을 이용한 객체의 관리를 위주로 Simple Application을 작성해봤습니다. 다음 개념들은 반드시 다시 정리해보시는 것이 좋습니다.</p>
<ul>
<li>ApplicationContext : Spring에서 제공하는 bean의 Map/ObjectFactory</li>
<li>property, constructor, init-method를 이용한 객체 초기화 방법</li>
<li>IoC, DIP, DI</li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/study-java-DIP-SOLID/">study,java,DIP,SOLID</a>
    </span>
    

    </div>

    
  </div>
</article>




<nav class="pagination">
  
  
  <a href="/page/2/" class="pagination-next">Next</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2018 ykyoon
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>